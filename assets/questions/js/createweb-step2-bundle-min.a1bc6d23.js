!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Spinner=t()}(this,function(){"use strict";function e(e,t){var i,n=document.createElement(e||"div");for(i in t)n[i]=t[i];return n}function t(e){for(var t=1,i=arguments.length;i>t;t++)e.appendChild(arguments[t]);return e}function i(e,t,i,n){var a=["opacity",t,~~(100*e),i,n].join("-"),o=.01+i/n*100,s=Math.max(1-(1-e)/t*(100-o),e),r=d.substring(0,d.indexOf("Animation")).toLowerCase(),l=r&&"-"+r+"-"||"";return f[a]||(u.insertRule("@"+l+"keyframes "+a+"{0%{opacity:"+s+"}"+o+"%{opacity:"+e+"}"+(o+.01)+"%{opacity:1}"+(o+t)%100+"%{opacity:"+e+"}100%{opacity:"+s+"}}",u.cssRules.length),f[a]=1),a}function n(e,t){var i,n,a=e.style;if(t=t.charAt(0).toUpperCase()+t.slice(1),void 0!==a[t])return t;for(n=0;n<c.length;n++)if(i=c[n]+t,void 0!==a[i])return i}function a(e,t){for(var i in t)e.style[n(e,i)||i]=t[i];return e}function o(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)void 0===e[n]&&(e[n]=i[n])}return e}function s(e,t){return"string"==typeof e?e:e[t%e.length]}function r(e){this.opts=o(e||{},r.defaults,p)}function l(){function i(t,i){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',i)}u.addRule(".spin-vml","behavior:url(#default#VML)"),r.prototype.lines=function(e,n){function o(){return a(i("group",{coordsize:u+" "+u,coordorigin:-d+" "+-d}),{width:u,height:u})}function r(e,r,l){t(f,t(a(o(),{rotation:360/n.lines*e+"deg",left:~~r}),t(a(i("roundrect",{arcsize:n.corners}),{width:d,height:n.scale*n.width,left:n.scale*n.radius,top:-n.scale*n.width>>1,filter:l}),i("fill",{color:s(n.color,e),opacity:n.opacity}),i("stroke",{opacity:0}))))}var l,d=n.scale*(n.length+n.width),u=2*n.scale*d,c=-(n.width+n.length)*n.scale*2+"px",f=a(o(),{position:"absolute",top:c,left:c});if(n.shadow)for(l=1;l<=n.lines;l++)r(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=n.lines;l++)r(l);return t(e,f)},r.prototype.opacity=function(e,t,i,n){var a=e.firstChild;n=n.shadow&&n.lines||0,a&&t+n<a.childNodes.length&&(a=a.childNodes[t+n],a=a&&a.firstChild,a=a&&a.firstChild,a&&(a.opacity=i))}}var d,u,c=["webkit","Moz","ms","O"],f={},p={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",opacity:.25,rotate:0,direction:1,speed:1,trail:100,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:!1,hwaccel:!1,position:"absolute"};if(r.defaults={},o(r.prototype,{spin:function(t){this.stop();var i=this,n=i.opts,o=i.el=e(null,{className:n.className});if(a(o,{position:n.position,width:0,zIndex:n.zIndex,left:n.left,top:n.top}),t&&t.insertBefore(o,t.firstChild||null),o.setAttribute("role","progressbar"),i.lines(o,i.opts),!d){var s,r=0,l=(n.lines-1)*(1-n.direction)/2,u=n.fps,c=u/n.speed,f=(1-n.opacity)/(c*n.trail/100),p=c/n.lines;!function e(){r++;for(var t=0;t<n.lines;t++)s=Math.max(1-(r+(n.lines-t)*p)%c*f,n.opacity),i.opacity(o,t*n.direction+l,s,n);i.timeout=i.el&&setTimeout(e,~~(1e3/u))}()}return i},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(n,o){function r(t,i){return a(e(),{position:"absolute",width:o.scale*(o.length+o.width)+"px",height:o.scale*o.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/o.lines*u+o.rotate)+"deg) translate("+o.scale*o.radius+"px,0)",borderRadius:(o.corners*o.scale*o.width>>1)+"px"})}for(var l,u=0,c=(o.lines-1)*(1-o.direction)/2;u<o.lines;u++)l=a(e(),{position:"absolute",top:1+~(o.scale*o.width/2)+"px",transform:o.hwaccel?"translate3d(0,0,0)":"",opacity:o.opacity,animation:d&&i(o.opacity,o.trail,c+u*o.direction,o.lines)+" "+1/o.speed+"s linear infinite"}),o.shadow&&t(l,a(r("#000","0 0 4px #000"),{top:"2px"})),t(n,t(l,r(s(o.color,u),"0 0 1px rgba(0,0,0,.1)")));return n},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}}),"undefined"!=typeof document){u=function(){var i=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],i),i.sheet||i.styleSheet}();var g=a(e("group"),{behavior:"url(#default#VML)"});!n(g,"transform")&&g.adj?l():d=n(g,"animation")}return r});(function(e){if(typeof exports==="object"){e(require("jquery"),require("spin.js"))}else if(typeof define==="function"&&define.amd){define(["jquery","spin"],e)}else{if(!window.Spinner){throw new Error("Spin.js not present")}e(window.jQuery,window.Spinner)}})(function(e,t){e.fn.spin=function(i,n){return this.each(function(){var a=e(this),o=a.data();if(o.spinner){o.spinner.stop();delete o.spinner}if(i!==false){i=e.extend({color:n||a.css("color")},e.fn.spin.presets[i]||i);o.spinner=new t(i).spin(this)}})};e.fn.spin.presets={tiny:{lines:8,length:2,width:2,radius:3},small:{lines:8,length:4,width:3,radius:5},large:{lines:10,length:8,width:4,radius:8}}});SM.AutocompleteMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"AutocompleteMenuView",__templateID:"autocomplete-menu-template",__defaults:{results:[]},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick)},__afterRender:function(){this._refreshOptionData()},__setters:{results:function(e,t){e.__settings.results=t;e.render();e.set("currentIndex",-1)}},_onOptionClick:function(e){var t=e.data.self,i=$(this);e.preventDefault();e.stopPropagation();if(i.hasClass("disabled")){return}t.trigger({type:"selected",text:i.text(),value:i.attr("data-value")})}});SM.Autocomplete=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"autocomplete",__defaults:{minLength:2,delay:0,maxResults:50,autocompleteOnPaste:true,source:[],search:function(e){var t=this.__settings.source,i=this.__settings.maxResults,n=0,a;a=$.map(t,function(t,a){var o=t.toLowerCase(),s=e.toLowerCase();if(n>=i){return false}if(o.indexOf(s)!==-1){n++;return{value:t,text:t}}});this.set("results",a)},position:{collision:"none"},enabled:true,setInputOnSelect:true,matchInputWidth:true},_timeout:undefined,__getters:{input:function(e){return e._getInput()},results:function(e){var t=e.get("menuView");return t.get("results")}},__setters:{input:function(e,t){e._setInput(t)},results:function(e,t){var i=e.get("menuView");if(t.length>e.__settings.maxResults){t=t.slice(0,e.__settings.maxResults)}i.set("results",t);if(t.length>0){e.open()}else{e.close()}},enabled:function(e,t){if(t&&!e.__settings.enabled){e._bindEvents()}else if(!t&&e.__settings.enabled){e.close();e.$el.off("keydown",e._onKeydown).off("keyup",e._onKeyup).off("paste",e._onPaste)}e.__settings.enabled=t}},__init:function(e){var t=this.el.tagName.toLowerCase();if(this.__settings.enabled){this._bindEvents()}if(this.__settings.menuView){this._menuView=this.__settings.menuView}this._hasVal=t==="input"||t==="textarea";this._height=this.$el.height();this._width=this.$el.outerWidth()},__onMenuInit:function(){this.bindMenu("selected",this._onOptionSelected)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this)},__onMenuAddedToPage:function(){SM.BaseMenu.__onMenuAddedToPage.call(this);if(this.__settings.matchInputWidth){this._matchInputSize()}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this._menu.set("currentIndex",-1)},__onWindowResize:function(){this._matchInputSize();SM.BaseMenu.__onWindowResize.call(this)},_matchInputSize:function(){var e=this.get("menuView"),t=this.$el,i=t.outerWidth(),n=parseInt(e.$el.css("border-left-width"),10),a=parseInt(e.$el.css("border-right-width"),10);e.$el.css("width",i-n-a)},_bindEvents:function(){this.bind("keydown",this._onKeydown).bind("keyup",this._onKeyup);if(this.__settings.autocompleteOnPaste){this.bind("paste",this._onPaste)}},_menuView:"AutocompleteMenuView",_pipeInput:function(){var e=this._getInput();if(e.length>=this.__settings.minLength){this._checkHeight();this._checkSearch()}else{this.close()}},_checkHeight:function(){var e=this.$el.height();if(this._height!==e&&this.isOpen()){this.position();this._height=e}},_debounceSearch:function(){var e=this;clearTimeout(e._timeout);e._timeout=setTimeout(function(){e._pipeInput()},e.__settings.delay)},_checkSearch:function(){var e=this._getInput();this.__settings.search.call(this,e)},_getInput:function(){var e=this.$el;return $.trim(this._hasVal?e.val():e.text())},_setInput:function(e){var t=this.$el;if(this._hasVal){t.val(e)}else{t.text(e)}},_onOptionSelected:function(e){var t=e.data.self;if(t.__settings.setInputOnSelect){t._setInput(e.text)}t.trigger({type:"selected",text:e.text,value:e.value});t.close()},_onKeyup:function(e){var t=e.data.self,i=e.which;if(i===SM.KeyCodes.DOWN||i===SM.KeyCodes.UP||i===SM.KeyCodes.ENTER||i===SM.KeyCodes.ESCAPE){e.preventDefault();return}if(i===SM.KeyCodes.SHIFT||i===SM.KeyCodes.CTRL||i===SM.KeyCodes.CAPS||i===SM.KeyCodes.ALT||i===SM.KeyCodes.HOME||i===SM.KeyCodes.END||i===SM.KeyCodes.LEFT||i===SM.KeyCodes.RIGHT||i===SM.KeyCodes.LEFT_WINDOW||i===SM.KeyCodes.RIGHT_WINDOW||i===SM.KeyCodes.RIGHT_WINDOW||i===SM.KeyCodes.SELECT){return}if((e.ctrlKey||e.metaKey)&&i===SM.KeyCodes.V){return}if(t.__settings.delay>0){t._debounceSearch()}else{t._pipeInput()}},_onPaste:function(e){var t=e.data.self;setTimeout(function(){t._pipeInput()},0)},_onKeydown:function(e){var t=e.data.self,i=e.which;if(t.isOpen()){if(i===SM.KeyCodes.DOWN){t._menu.nextCurrent();e.preventDefault()}else if(i===SM.KeyCodes.UP){t._menu.prevCurrent();e.preventDefault()}else if(i===SM.KeyCodes.ENTER){t._menu.selectCurrent();e.preventDefault()}}}});SM.Tooltips={init:function(e){this.enable(e)},enable:function(e){e=SM.Object.extend({selector:"[title]",delay:1500,fadeIn:false,fadeOut:false,fadeTime:250},e);if(!SM.Browser.isOldIE){$(document).on("mouseenter.smtooltips",e.selector,{self:this,delay:e.delay,fadeIn:e.fadeIn,fadeOut:e.fadeOut,fadeTime:e.fadeTime},this._onMouseenter)}},disable:function(e){var t=e?e:"[title]";if(!SM.Browser.isOldIE){$(document).off("mouseenter.smtooltips",t)}},_onMouseenter:function(e){var t=e.data.self,i=e.data.delay,n=e.data.fadeTime,a=e.data.fadeIn,o=e.data.fadeOut,s=$(e.currentTarget),r;if(!s.data("tooltip")){r=t._getAttrs(s);if(!r.text){return}s.data("tooltip",r);s.removeAttr("title");s.on("click.smtooltips mouseleave.smtooltips remove.smtooltips",{self:t,fadeOut:o,fadeTime:n},t._destroy);setTimeout(function(){var e=s.data("tooltip");if(e&&!e.isShown){t._showTipOn(s,a,n)}},i)}},_destroy:function(e){var t=e.data.self,i=$(this),n=e.data.fadeOut,a=e.data.fadeTime,o;o=i.data("tooltip");if(!o){return}if(o.$el){if(n){o.$el.fadeOut(a,function(){o.$el.remove()})}else{o.$el.remove()}}i.off("mouseleave.smtooltips");i.off("remove.smtooltips");i.off("click.smtooltips");i.attr("title",o.text);i.data("tooltip",null)},_showTipOn:function(e,t,i){var n=e.data("tooltip"),a=SM.Object.copy(this._sides[n.side].position),o=this._build(n);n.$el=o;n.isShown=true;if(t){o.hide().appendTo(document.body).fadeIn(i)}else{document.body.appendChild(o[0])}a.of=e;o.position($.migrationFixPosition(a))},_build:function(e){var t=document.createElement("div"),i="tool-tip ";i+=this._sides[e.side].className;if(e.classes){i+=" "+e.classes}t.className=i;t.textContent=e.text;return $(t)},_sides:{left:{className:"tool-tip-left",position:{my:"right center",at:"left center",offset:"-5 0",collision:"none"}},right:{className:"tool-tip-right",position:{my:"left center",at:"right center",offset:"5 0",collision:"none"}},top:{className:"tool-tip-top",position:{my:"center bottom",at:"center top",offset:"0 -5",collision:"none"}},bottom:{className:"tool-tip-bottom",position:{my:"center top",at:"center bottom",offset:"0 5",collision:"none"}}},_getAttrs:function(e){return{text:e.attr("title"),side:e.attr("sm-tooltip-side")||"top",classes:e.attr("sm-tooltip-classes")}}};(function(e){var t=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks){for(var i=t.length;i;){e.event.fixHooks[t[--i]]=e.event.mouseHooks}}e.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var e=t.length;e;){this.addEventListener(t[--e],n,false)}}else{this.onmousewheel=n}},teardown:function(){if(this.removeEventListener){for(var e=t.length;e;){this.removeEventListener(t[--e],n,false)}}else{this.onmousewheel=null}}};e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}});function n(t){var i=t||window.event,n=[].slice.call(arguments,1),a=0,o=true,s=0,r=0;t=e.event.fix(i);t.type="mousewheel";if(i.wheelDelta){a=i.wheelDelta/120}if(i.detail){a=-i.detail/3}r=a;if(i.axis!==undefined&&i.axis===i.HORIZONTAL_AXIS){r=0;s=-1*a}if(i.wheelDeltaY!==undefined){r=i.wheelDeltaY/120}if(i.wheelDeltaX!==undefined){s=-1*i.wheelDeltaX/120}n.unshift(t,a,s,r);return(e.event.dispatch||e.event.handle).apply(this,n)}})(jQuery);(function(e,t,n){var a={beforeShow:m,move:m,change:m,show:m,hide:m,color:false,flat:false,showInput:false,allowEmpty:false,showButtons:true,clickoutFiresChange:false,showInitial:false,showPalette:false,showPaletteOnly:false,showSelectionPalette:true,localStorageKey:false,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",clearText:"Clear Color Selection",preferredFormat:false,className:"",containerClassName:"",replacerClassName:"",showAlpha:false,theme:"sp-light",palette:[["#ffffff","#000000","#ff0000","#ff8000","#ffff00","#008000","#0000ff","#4b0082","#9400d3"]],selectionPalette:[],disabled:false},o=[],s=!!/msie/i.exec(e.navigator.userAgent),r=function(){function e(e,t){return!!~(""+e).indexOf(t)}var t=document.createElement("div");var i=t.style;i.cssText="background-color:rgba(0,0,0,.5)";return e(i.backgroundColor,"rgba")||e(i.backgroundColor,"hsla")}(),l=function(){var e=t("<input type='color' value='!' />")[0];return e.type==="color"&&e.value!=="!"}(),d=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),u=function(){var e="";if(s){for(var t=1;t<=6;t++){e+="<div class='sp-"+t+"'></div>"}}return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-clear sp-clear-display'>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",e,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button type='button' class='sp-choose'></button>","</div>","</div>","</div>"].join("")}();function c(e,t,i,n){var a=[];for(var o=0;o<e.length;o++){var s=e[o];if(s){var l=tinycolor(s);var d=l.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";d+=tinycolor.equals(t,s)?" sp-thumb-active":"";var u=l.toString(n||"rgb");var c=r?"background-color:"+l.toRgbString():"filter:"+l.toFilter();a.push('<span title="'+u+'" data-color="'+l.toRgbString()+'" class="'+d+'"><span class="sp-thumb-inner" style="'+c+';" /></span>')}else{var f="sp-clear-display";a.push('<span title="No Color Selected" data-color="" style="background-color:transparent;" class="'+f+'"></span>')}}return"<div class='sp-cf "+i+"'>"+a.join("")+"</div>"}function f(){for(var e=0;e<o.length;e++){if(o[e]){o[e].hide()}}}function p(e,i){var n=t.extend({},a,e);n.callbacks={move:v(n.move,i),change:v(n.change,i),show:v(n.show,i),hide:v(n.hide,i),beforeShow:v(n.beforeShow,i)};return n}function g(a,g){var m=p(g,a),v=m.flat,q=m.showSelectionPalette,b=m.localStorageKey,y=m.theme,T=m.callbacks,w=C(Ve,10),R=false,A=0,S=0,$=0,x=0,k=0,P=0,M=0,D=0,I=0,L=0,F=0,Q=1,N=[],B=[],U={},O=m.selectionPalette.slice(0),z=m.maxSelectionSize,V="sp-dragging",H=null;var j=a.ownerDocument,W=j.body,G=t(a),K=false,X=t(u,j).addClass(y),Y=X.find(".sp-color"),J=X.find(".sp-dragger"),Z=X.find(".sp-hue"),ee=X.find(".sp-slider"),te=X.find(".sp-alpha-inner"),ie=X.find(".sp-alpha"),ne=X.find(".sp-alpha-handle"),ae=X.find(".sp-input"),oe=X.find(".sp-palette"),se=X.find(".sp-initial"),re=X.find(".sp-cancel"),le=X.find(".sp-clear"),de=X.find(".sp-choose"),ue=G.is("input"),ce=ue&&l&&G.attr("type")==="color",fe=ue&&!v,pe=fe?t(d).addClass(y).addClass(m.className).addClass(m.replacerClassName):t([]),ge=fe?pe:G,he=pe.find(".sp-preview-inner"),me=m.color||ue&&G.val(),_e=false,ve=m.preferredFormat,Ee=ve,Ce=!m.showButtons||m.clickoutFiresChange,qe=!me,be=m.allowEmpty&&!ce;function ye(){if(m.showPaletteOnly){m.showPalette=true}if(m.palette){N=m.palette.slice(0);B=t.isArray(N[0])?N:[N];U={};for(var e=0;e<B.length;e++){for(var i=0;i<B[e].length;i++){var n=tinycolor(B[e][i]).toRgbString();U[n]=true}}}X.toggleClass("sp-flat",v);X.toggleClass("sp-input-disabled",!m.showInput);X.toggleClass("sp-alpha-enabled",m.showAlpha);X.toggleClass("sp-clear-enabled",be);X.toggleClass("sp-buttons-disabled",!m.showButtons);X.toggleClass("sp-palette-disabled",!m.showPalette);X.toggleClass("sp-palette-only",m.showPaletteOnly);X.toggleClass("sp-initial-disabled",!m.showInitial);X.addClass(m.className).addClass(m.containerClassName);Ve()}function Te(){if(s){X.find("*:not(input)").attr("unselectable","on")}ye();if(fe){G.after(pe).hide()}if(!be){le.hide()}if(v){G.after(X).hide()}else{var e=m.appendTo==="parent"?G.parent():t(m.appendTo);if(e.length!==1){e=t("body")}e.append(X)}we();ge.bind("click.spectrum touchstart.spectrum",function(e){if(!K){Me()}e.stopPropagation();if(!t(e.target).is("input")){e.preventDefault()}});if(G.is(":disabled")||m.disabled===true){Ge()}X.click(_);ae.change(Pe);ae.bind("paste",function(){setTimeout(Pe,1)});ae.keydown(function(e){if(e.keyCode==13){Pe()}});re.text(m.cancelText);re.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();Ie("cancel")});le.attr("title",m.clearText);le.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();qe=true;Be();if(v){ze(true)}});de.text(m.chooseText);de.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();if(Ne()){ze(true);Ie()}});E(ie,function(e,t,i){Q=e/P;qe=false;if(i.shiftKey){Q=Math.round(Q*10)/10}Be()},xe,ke);E(Z,function(e,t){I=parseFloat(t/x);qe=false;if(!m.showAlpha){Q=1}Be()},xe,ke);E(Y,function(e,t,i){if(!i.shiftKey){H=null}else if(!H){var n=L*A;var a=S-F*S;var o=Math.abs(e-n)>Math.abs(t-a);H=o?"x":"y"}var s=!H||H==="x";var r=!H||H==="y";if(s){L=parseFloat(e/A)}if(r){F=parseFloat((S-t)/S)}qe=false;if(!m.showAlpha){Q=1}Be()},xe,ke);if(!!me){Fe(me);Ue();Ee=ve||tinycolor(me).format;Re(me)}else{Ue()}if(v){De()}function i(e){if(e.data&&e.data.ignore){Fe(t(this).data("color"));Be()}else{Fe(t(this).data("color"));Be();ze(true);Ie()}return false}var n=s?"mousedown.spectrum":"click.spectrum touchstart.spectrum";oe.delegate(".sp-thumb-el",n,i);se.delegate(".sp-thumb-el:nth-child(1)",n,{ignore:true},i)}function we(){if(b&&e.localStorage){try{var i=e.localStorage[b].split(",#");if(i.length>1){delete e.localStorage[b];t.each(i,function(e,t){Re(t)})}}catch(e){}try{O=e.localStorage[b].split(";")}catch(e){}}}function Re(i){if(q){var n=tinycolor(i).toRgbString();if(!U[n]&&t.inArray(n,O)===-1){O.push(n);while(O.length>z){O.shift()}}if(b&&e.localStorage){try{e.localStorage[b]=O.join(";")}catch(e){}}}}function Ae(){var e=[];if(m.showPalette){for(i=0;i<O.length;i++){var t=tinycolor(O[i]).toRgbString();if(!U[t]){e.push(O[i])}}}return e.reverse().slice(0,m.maxSelectionSize)}function Se(){var e=Qe();var i=t.map(B,function(t,i){return c(t,e,"sp-palette-row sp-palette-row-"+i,m.preferredFormat)});we();if(O){i.push(c(Ae(),e,"sp-palette-row sp-palette-row-selection",m.preferredFormat))}oe.html(i.join(""))}function $e(){if(m.showInitial){var e=_e;var t=Qe();se.html(c([e,t],t,"sp-palette-row-initial",m.preferredFormat))}}function xe(){if(S<=0||A<=0||x<=0){Ve()}X.addClass(V);H=null;G.trigger("dragstart.spectrum",[Qe()])}function ke(){X.removeClass(V);G.trigger("dragstop.spectrum",[Qe()])}function Pe(){var e=ae.val();if((e===null||e==="")&&be){Fe(null);ze(true)}else{var t=tinycolor(e);if(t.ok){Fe(t);ze(true)}else{ae.addClass("sp-validation-error")}}}function Me(){if(R){Ie()}else{De()}}function De(){var i=t.Event("beforeShow.spectrum");if(R){Ve();return}G.trigger(i,[Qe()]);if(T.beforeShow(Qe())===false||i.isDefaultPrevented()){return}f();R=true;t(j).bind("click.spectrum",Ie);t(e).bind("resize.spectrum",w);pe.addClass("sp-active");X.removeClass("sp-hidden");Ve();Ue();_e=Qe();$e();T.show(_e);G.trigger("show.spectrum",[_e])}function Ie(i){if(i&&i.type=="click"&&i.button==2){return}if(!R||v){return}R=false;t(j).unbind("click.spectrum",Ie);t(e).unbind("resize.spectrum",w);pe.removeClass("sp-active");X.addClass("sp-hidden");var n=!tinycolor.equals(Qe(),_e);if(n){if(Ce&&i!=="cancel"){ze(true)}else{Le()}}T.hide(Qe());G.trigger("hide.spectrum",[Qe()])}function Le(){Fe(_e,true)}function Fe(e,t){if(tinycolor.equals(e,Qe())){Ue();return}var i,n;if(!e&&be){qe=true}else{qe=false;i=tinycolor(e);n=i.toHsv();I=n.h%360/360;L=n.s;F=n.v;Q=n.a}Ue();if(i&&i.ok&&!t){Ee=ve||i.format}}function Qe(e){e=e||{};if(be&&qe){return null}return tinycolor.fromRatio({h:I,s:L,v:F,a:Math.round(Q*100)/100},{format:e.format||Ee})}function Ne(){return!ae.hasClass("sp-validation-error")}function Be(){Ue();T.move(Qe());G.trigger("move.spectrum",[Qe()])}function Ue(){ae.removeClass("sp-validation-error");Oe();var e=tinycolor.fromRatio({h:I,s:1,v:1});Y.css("background-color",e.toHexString());var t=Ee;if(Q<1&&!(Q===0&&t==="name")){if(t==="hex"||t==="hex3"||t==="hex6"||t==="name"){t="rgb"}}var i=Qe({format:t}),n="";he.removeClass("sp-clear-display");he.css("background-color","transparent");if(!i&&be){he.addClass("sp-clear-display")}else{var a=i.toHexString(),o=i.toRgbString();if(r||i.alpha===1){he.css("background-color",o)}else{he.css("background-color","transparent");he.css("filter",i.toFilter())}if(m.showAlpha){var l=i.toRgb();l.a=0;var d=tinycolor(l).toRgbString();var u="linear-gradient(left, "+d+", "+a+")";if(s){te.css("filter",tinycolor(d).toFilter({gradientType:1},a))}else{te.css("background","-webkit-"+u);te.css("background","-moz-"+u);te.css("background","-ms-"+u);te.css("background","linear-gradient(to right, "+d+", "+a+")")}}n=i.toString(t)}if(m.showInput){ae.val(n)}if(m.showPalette){Se()}$e()}function Oe(){var e=L;var t=F;if(be&&qe){ne.hide();ee.hide();J.hide()}else{ne.show();ee.show();J.show();var i=e*A;var n=S-t*S;i=Math.max(-$,Math.min(A-$,i-$));n=Math.max(-$,Math.min(S-$,n-$));J.css({top:n+"px",left:i+"px"});var a=Q*P;ne.css({left:a-M/2+"px"});var o=I*x;ee.css({top:o-D+"px"})}}function ze(e){var t=Qe(),i="",n=!tinycolor.equals(t,_e);if(t){i=t.toString(Ee);Re(t)}if(ue){G.val(i)}_e=t;if(e&&n){T.change(t);G.trigger("change",[t])}}function Ve(){A=Y.width();S=Y.height();$=J.height();k=Z.width();x=Z.height();D=ee.height();P=ie.width();M=ne.width();if(!v){X.css("position","absolute");X.offset(h(X,ge))}Oe();if(m.showPalette){Se()}G.trigger("reflow.spectrum")}function He(){G.show();ge.unbind("click.spectrum touchstart.spectrum");X.remove();pe.remove();o[Ke.id]=null}function je(e,i){if(e===n){return t.extend({},m)}if(i===n){return m[e]}m[e]=i;ye()}function We(){K=false;G.attr("disabled",false);ge.removeClass("sp-disabled")}function Ge(){Ie();K=true;G.attr("disabled",true);ge.addClass("sp-disabled")}Te();var Ke={show:De,hide:Ie,toggle:Me,reflow:Ve,option:je,enable:We,disable:Ge,set:function(e){Fe(e);ze()},get:Qe,destroy:He,container:X};Ke.id=o.push(Ke)-1;return Ke}function h(e,i){var n=0;var a=e.outerWidth();var o=e.outerHeight();var s=i.outerHeight();var r=e[0].ownerDocument;var l=r.documentElement;var d=l.clientWidth+t(r).scrollLeft();var u=l.clientHeight+t(r).scrollTop();var c=i.offset();c.top+=s;c.left-=Math.min(c.left,c.left+a>d&&d>a?Math.abs(c.left+a-d):0);c.top-=Math.min(c.top,c.top+o>u&&u>o?Math.abs(o+s-n):n);return c}function m(){}function _(e){e.stopPropagation()}function v(e,t){var i=Array.prototype.slice;var n=i.call(arguments,2);return function(){return e.apply(t,n.concat(i.call(arguments)))}}function E(i,n,a,o){n=n||function(){};a=a||function(){};o=o||function(){};var r=i.ownerDocument||document;var l=false;var d={};var u=0;var c=0;var f="ontouchstart"in e;var p={};p["selectstart"]=g;p["dragstart"]=g;p["touchmove mousemove"]=h;p["touchend mouseup"]=_;function g(e){if(e.stopPropagation){e.stopPropagation()}if(e.preventDefault){e.preventDefault()}e.returnValue=false}function h(e){if(l){if(s&&document.documentMode<9&&!e.button){return _()}var t=e.originalEvent.touches;var a=t?t[0].pageX:e.pageX;var o=t?t[0].pageY:e.pageY;var r=Math.max(0,Math.min(a-d.left,c));var p=Math.max(0,Math.min(o-d.top,u));if(f){g(e)}n.apply(i,[r,p,e])}}function m(e){var n=e.which?e.which==3:e.button==2;var o=e.originalEvent.touches;if(!n&&!l){if(a.apply(i,arguments)!==false){l=true;u=t(i).height();c=t(i).width();d=t(i).offset();t(r).bind(p);t(r.body).addClass("sp-dragging");if(!f){h(e)}g(e)}}}function _(){if(l){t(r).unbind(p);t(r.body).removeClass("sp-dragging");o.apply(i,arguments)}l=false}t(i).bind("touchstart mousedown",m)}function C(e,t,i){var n;return function(){var a=this,o=arguments;var s=function(){n=null;e.apply(a,o)};if(i)clearTimeout(n);if(i||!n)n=setTimeout(s,t)}}function q(){if(e.console){if(Function.prototype.bind)q=Function.prototype.bind.call(console.log,console);else q=function(){Function.prototype.apply.call(console.log,console,arguments)};q.apply(this,arguments)}}var b="spectrum.id";t.fn.spectrum=function(e,i){if(typeof e=="string"){var n=this;var a=Array.prototype.slice.call(arguments,1);this.each(function(){var i=o[t(this).data(b)];if(i){var s=i[e];if(!s){throw new Error("Spectrum: no such method: '"+e+"'")}if(e=="get"){n=i.get()}else if(e=="container"){n=i.container}else if(e=="option"){n=i.option.apply(i,a)}else if(e=="destroy"){i.destroy();t(this).removeData(b)}else{s.apply(i,a)}}});return n}return this.spectrum("destroy").each(function(){var i=t.extend({},e,t(this).data());var n=g(this,i);t(this).data(b,n.id)})};t.fn.spectrum.load=true;t.fn.spectrum.loadOpts={};t.fn.spectrum.draggable=E;t.fn.spectrum.defaults=a;t.spectrum={};t.spectrum.localization={};t.spectrum.palettes={};t.fn.spectrum.processNativeColorInputs=function(){if(!l){t("input[type=color]").spectrum({preferredFormat:"hex6"})}};(function(){var t=/^[\s,#]+/,i=/\s+$/,n=0,a=Math,o=a.round,s=a.min,r=a.max,l=a.random;function d(e,t){e=e?e:"";t=t||{};if(typeof e=="object"&&e.hasOwnProperty("_tc_id")){return e}var i=u(e);var a=i.r,s=i.g,r=i.b,l=i.a,c=o(100*l)/100,p=t.format||i.format;if(a<1){a=o(a)}if(s<1){s=o(s)}if(r<1){r=o(r)}return{ok:i.ok,format:p,_tc_id:n++,alpha:l,getAlpha:function(){return l},setAlpha:function(e){l=q(e);c=o(100*l)/100},toHsv:function(){var e=g(a,s,r);return{h:e.h*360,s:e.s,v:e.v,a:l}},toHsvString:function(){var e=g(a,s,r);var t=o(e.h*360),i=o(e.s*100),n=o(e.v*100);return l==1?"hsv("+t+", "+i+"%, "+n+"%)":"hsva("+t+", "+i+"%, "+n+"%, "+c+")"},toHsl:function(){var e=f(a,s,r);return{h:e.h*360,s:e.s,l:e.l,a:l}},toHslString:function(){var e=f(a,s,r);var t=o(e.h*360),i=o(e.s*100),n=o(e.l*100);return l==1?"hsl("+t+", "+i+"%, "+n+"%)":"hsla("+t+", "+i+"%, "+n+"%, "+c+")"},toHex:function(e){return m(a,s,r,e)},toHexString:function(e){return"#"+this.toHex(e)},toHex8:function(){return _(a,s,r,l)},toHex8String:function(){return"#"+this.toHex8()},toRgb:function(){return{r:o(a),g:o(s),b:o(r),a:l}},toRgbString:function(){return l==1?"rgb("+o(a)+", "+o(s)+", "+o(r)+")":"rgba("+o(a)+", "+o(s)+", "+o(r)+", "+c+")"},toPercentageRgb:function(){return{r:o(b(a,255)*100)+"%",g:o(b(s,255)*100)+"%",b:o(b(r,255)*100)+"%",a:l}},toPercentageRgbString:function(){return l==1?"rgb("+o(b(a,255)*100)+"%, "+o(b(s,255)*100)+"%, "+o(b(r,255)*100)+"%)":"rgba("+o(b(a,255)*100)+"%, "+o(b(s,255)*100)+"%, "+o(b(r,255)*100)+"%, "+c+")"},toName:function(){if(l===0){return"transparent"}return E[m(a,s,r,true)]||false},toFilter:function(e){var i="#"+_(a,s,r,l);var n=i;var o=t&&t.gradientType?"GradientType = 1, ":"";if(e){var u=d(e);n=u.toHex8String()}return"progid:DXImageTransform.Microsoft.gradient("+o+"startColorstr="+i+",endColorstr="+n+")"},toString:function(e){var t=!!e;e=e||this.format;var i=false;var n=!t&&l<1&&l>0;var a=n&&(e==="hex"||e==="hex6"||e==="hex3"||e==="name");if(e==="rgb"){i=this.toRgbString()}if(e==="prgb"){i=this.toPercentageRgbString()}if(e==="hex"||e==="hex6"){i=this.toHexString()}if(e==="hex3"){i=this.toHexString(true)}if(e==="hex8"){i=this.toHex8String()}if(e==="name"){i=this.toName()}if(e==="hsl"){i=this.toHslString()}if(e==="hsv"){i=this.toHsvString()}if(a){return this.toRgbString()}return i||this.toHexString()}}}d.fromRatio=function(e,t){if(typeof e=="object"){var i={};for(var n in e){if(e.hasOwnProperty(n)){if(n==="a"){i[n]=e[n]}else{i[n]=S(e[n])}}}e=i}return d(e,t)};function u(e){var t={r:0,g:0,b:0};var i=1;var n=false;var a=false;if(typeof e=="string"){e=P(e)}if(typeof e=="object"){if(e.hasOwnProperty("r")&&e.hasOwnProperty("g")&&e.hasOwnProperty("b")){t=c(e.r,e.g,e.b);n=true;a=String(e.r).substr(-1)==="%"?"prgb":"rgb"}else if(e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("v")){e.s=S(e.s);e.v=S(e.v);t=h(e.h,e.s,e.v);n=true;a="hsv"}else if(e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("l")){e.s=S(e.s);e.l=S(e.l);t=p(e.h,e.s,e.l);n=true;a="hsl"}if(e.hasOwnProperty("a")){i=e.a}}i=q(i);return{ok:n,format:e.format||a,r:s(255,r(t.r,0)),g:s(255,r(t.g,0)),b:s(255,r(t.b,0)),a:i}}function c(e,t,i){return{r:b(e,255)*255,g:b(t,255)*255,b:b(i,255)*255}}function f(e,t,i){e=b(e,255);t=b(t,255);i=b(i,255);var n=r(e,t,i),a=s(e,t,i);var o,l,d=(n+a)/2;if(n==a){o=l=0}else{var u=n-a;l=d>.5?u/(2-n-a):u/(n+a);switch(n){case e:o=(t-i)/u+(t<i?6:0);break;case t:o=(i-e)/u+2;break;case i:o=(e-t)/u+4;break}o/=6}return{h:o,s:l,l:d}}function p(e,t,i){var n,a,o;e=b(e,360);t=b(t,100);i=b(i,100);function s(e,t,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(t-e)*6*i;if(i<1/2)return t;if(i<2/3)return e+(t-e)*(2/3-i)*6;return e}if(t===0){n=a=o=i}else{var r=i<.5?i*(1+t):i+t-i*t;var l=2*i-r;n=s(l,r,e+1/3);a=s(l,r,e);o=s(l,r,e-1/3)}return{r:n*255,g:a*255,b:o*255}}function g(e,t,i){e=b(e,255);t=b(t,255);i=b(i,255);var n=r(e,t,i),a=s(e,t,i);var o,l,d=n;var u=n-a;l=n===0?0:u/n;if(n==a){o=0}else{switch(n){case e:o=(t-i)/u+(t<i?6:0);break;case t:o=(i-e)/u+2;break;case i:o=(e-t)/u+4;break}o/=6}return{h:o,s:l,v:d}}function h(e,t,i){e=b(e,360)*6;t=b(t,100);i=b(i,100);var n=a.floor(e),o=e-n,s=i*(1-t),r=i*(1-o*t),l=i*(1-(1-o)*t),d=n%6,u=[i,r,s,s,l,i][d],c=[l,i,i,r,s,s][d],f=[s,s,l,i,i,r][d];return{r:u*255,g:c*255,b:f*255}}function m(e,t,i,n){var a=[A(o(e).toString(16)),A(o(t).toString(16)),A(o(i).toString(16))];if(n&&a[0].charAt(0)==a[0].charAt(1)&&a[1].charAt(0)==a[1].charAt(1)&&a[2].charAt(0)==a[2].charAt(1)){return a[0].charAt(0)+a[1].charAt(0)+a[2].charAt(0)}return a.join("")}function _(e,t,i,n){var a=[A($(n)),A(o(e).toString(16)),A(o(t).toString(16)),A(o(i).toString(16))];return a.join("")}d.equals=function(e,t){if(!e||!t){return false}return d(e).toRgbString()==d(t).toRgbString()};d.random=function(){return d.fromRatio({r:l(),g:l(),b:l()})};d.desaturate=function(e,t){t=t===0?0:t||10;var i=d(e).toHsl();i.s-=t/100;i.s=y(i.s);return d(i)};d.saturate=function(e,t){t=t===0?0:t||10;var i=d(e).toHsl();i.s+=t/100;i.s=y(i.s);return d(i)};d.greyscale=function(e){return d.desaturate(e,100)};d.lighten=function(e,t){t=t===0?0:t||10;var i=d(e).toHsl();i.l+=t/100;i.l=y(i.l);return d(i)};d.darken=function(e,t){t=t===0?0:t||10;var i=d(e).toHsl();i.l-=t/100;i.l=y(i.l);return d(i)};d.complement=function(e){var t=d(e).toHsl();t.h=(t.h+180)%360;return d(t)};d.triad=function(e){var t=d(e).toHsl();var i=t.h;return[d(e),d({h:(i+120)%360,s:t.s,l:t.l}),d({h:(i+240)%360,s:t.s,l:t.l})]};d.tetrad=function(e){var t=d(e).toHsl()
;var i=t.h;return[d(e),d({h:(i+90)%360,s:t.s,l:t.l}),d({h:(i+180)%360,s:t.s,l:t.l}),d({h:(i+270)%360,s:t.s,l:t.l})]};d.splitcomplement=function(e){var t=d(e).toHsl();var i=t.h;return[d(e),d({h:(i+72)%360,s:t.s,l:t.l}),d({h:(i+216)%360,s:t.s,l:t.l})]};d.analogous=function(e,t,i){t=t||6;i=i||30;var n=d(e).toHsl();var a=360/i;var o=[d(e)];for(n.h=(n.h-(a*t>>1)+720)%360;--t;){n.h=(n.h+a)%360;o.push(d(n))}return o};d.monochromatic=function(e,t){t=t||6;var i=d(e).toHsv();var n=i.h,a=i.s,o=i.v;var s=[];var r=1/t;while(t--){s.push(d({h:n,s:a,v:o}));o=(o+r)%1}return s};d.readability=function(e,t){var i=d(e).toRgb();var n=d(t).toRgb();var a=(i.r*299+i.g*587+i.b*114)/1e3;var o=(n.r*299+n.g*587+n.b*114)/1e3;var s=Math.max(i.r,n.r)-Math.min(i.r,n.r)+Math.max(i.g,n.g)-Math.min(i.g,n.g)+Math.max(i.b,n.b)-Math.min(i.b,n.b);return{brightness:Math.abs(a-o),color:s}};d.readable=function(e,t){var i=d.readability(e,t);return i.brightness>125&&i.color>500};d.mostReadable=function(e,t){var i=null;var n=0;var a=false;for(var o=0;o<t.length;o++){var s=d.readability(e,t[o]);var r=s.brightness>125&&s.color>500;var l=3*(s.brightness/125)+s.color/500;if(r&&!a||r&&a&&l>n||!r&&!a&&l>n){a=r;n=l;i=d(t[o])}}return i};var v=d.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};var E=d.hexNames=C(v);function C(e){var t={};for(var i in e){if(e.hasOwnProperty(i)){t[e[i]]=i}}return t}function q(e){e=parseFloat(e);if(isNaN(e)||e<0||e>1){e=1}return e}function b(e,t){if(w(e)){e="100%"}var i=R(e);e=s(t,r(0,parseFloat(e)));if(i){e=parseInt(e*t,10)/100}if(a.abs(e-t)<1e-6){return 1}return e%t/parseFloat(t)}function y(e){return s(1,r(0,e))}function T(e){return parseInt(e,16)}function w(e){return typeof e=="string"&&e.indexOf(".")!=-1&&parseFloat(e)===1}function R(e){return typeof e==="string"&&e.indexOf("%")!=-1}function A(e){return e.length==1?"0"+e:""+e}function S(e){if(e<=1){e=e*100+"%"}return e}function $(e){return Math.round(parseFloat(e)*255).toString(16)}function x(e){return T(e)/255}var k=function(){var e="[-\\+]?\\d+%?";var t="[-\\+]?\\d*\\.\\d+%?";var i="(?:"+t+")|(?:"+e+")";var n="[\\s|\\(]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")\\s*\\)?";var a="[\\s|\\(]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")\\s*\\)?";return{rgb:new RegExp("rgb"+n),rgba:new RegExp("rgba"+a),hsl:new RegExp("hsl"+n),hsla:new RegExp("hsla"+a),hsv:new RegExp("hsv"+n),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex8:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();function P(e){e=e.replace(t,"").replace(i,"").toLowerCase();var n=false;if(v[e]){e=v[e];n=true}else if(e=="transparent"){return{r:0,g:0,b:0,a:0,format:"name"}}var a;if(a=k.rgb.exec(e)){return{r:a[1],g:a[2],b:a[3]}}if(a=k.rgba.exec(e)){return{r:a[1],g:a[2],b:a[3],a:a[4]}}if(a=k.hsl.exec(e)){return{h:a[1],s:a[2],l:a[3]}}if(a=k.hsla.exec(e)){return{h:a[1],s:a[2],l:a[3],a:a[4]}}if(a=k.hsv.exec(e)){return{h:a[1],s:a[2],v:a[3]}}if(a=k.hex8.exec(e)){return{a:x(a[1]),r:T(a[2]),g:T(a[3]),b:T(a[4]),format:n?"name":"hex8"}}if(a=k.hex6.exec(e)){return{r:T(a[1]),g:T(a[2]),b:T(a[3]),format:n?"name":"hex"}}if(a=k.hex3.exec(e)){return{r:T(a[1]+""+a[1]),g:T(a[2]+""+a[2]),b:T(a[3]+""+a[3]),format:n?"name":"hex"}}return false}e.tinycolor=d})();t(function(){if(t.fn.spectrum.load){t.fn.spectrum.processNativeColorInputs()}})})(window,jQuery);SM.Tabs=SM.Widgets.register({__NAME:"tabs",__defaults:{requireOpenTab:true},__setters:{selectedTab:function(e,t){e.open(t)}},__getters:{selectedTab:function(e){return e._selectedTab}},__init:function(){this._cacheData()._initTab()._bindEvents()},open:function(e){var t,i=this._selectedTab;if(typeof e!=="string"){e=this._getKeyFromIndex(e)}t=this._tabs[e];if(!t){return this}if(t.$tab.hasClass("disabled")||i===e){return this}this._opening=t;this._closeOpenTab();if(!this._selectedTab){this._open(t)}this._opening=undefined;return this},close:function(e){var t,i=this._selectedTab;if(e===undefined&&!this.__settings.requireOpenTab){this._closeOpenTab();return this}if(typeof e!=="string"){e=this._getKeyFromIndex(e)}t=this._tabs[e];if(t&&i===t.key&&!this.__settings.requireOpenTab){this._close(t)}return this},_selectedTab:undefined,_tabs:undefined,_close:function(e){var t=$.Event("beforeClose",{tab:e,opening:this._opening});this.__trigger(t);if(t.isDefaultPrevented()){return this}e.$panel.removeClass("open");e.$tab.removeClass("active");this._selectedTab=undefined;this.__trigger({type:"afterClose",tab:e});return this},_open:function(e){this.__trigger({type:"beforeOpen",tab:e});this._setOpenView(e);return this},_setOpenView:function(e){this._selectedTab=e.key;e.$tab.addClass("active");e.$panel.addClass("open")},_bindEvents:function(){this.$el.children("nav").find(".tab").on("click",{tabs:this},this._onTabClick);return this},_initTab:function(){var e=this.$el.children("nav").find(".tab.active"),t,i;if(e.length){t=e.attr("tab-target");i=this._tabs[t];this._setOpenView(i)}return this},_closeOpenTab:function(){var e=this._selectedTab,t;if(e===undefined){return this}t=this._tabs[e];this._close(t);return this},_cacheData:function(){var e,t,i=0,n,a,o;o=this.$el.children("nav").find(".tab");t=o.length;this._tabs={};for(;i<t;i++){n=o.eq(i);e=n.attr("tab-target");a=this.$el.find(".panel[tab="+e+"]");this._tabs[e]={index:i,$tab:n,key:e,$panel:a}}return this},_getKeyFromIndex:function(e){var t,i=this._tabs;for(t in i){if(i[t].index===e){return i[t].key}}},_onTabClick:function(e){var t=e.data.tabs,i=$(this),n;e.preventDefault();n=i.attr("tab-target");if(t.__settings.noClickTab===n){return}if(t._selectedTab===n){t.close(n)}else{t.open(n)}}});(function(){"use strict";var e=/(\{.*\})/.exec(document.body.innerHTML);if(e){parent.postMessage(e[1],"*")}})();var qq=function(e){"use strict";return{hide:function(){e.style.display="none";return this},attach:function(t,i){if(e.addEventListener){e.addEventListener(t,i,false)}else if(e.attachEvent){e.attachEvent("on"+t,i)}return function(){qq(e).detach(t,i)}},detach:function(t,i){if(e.removeEventListener){e.removeEventListener(t,i,false)}else if(e.attachEvent){e.detachEvent("on"+t,i)}return this},contains:function(t){if(!t){return false}if(e===t){return true}if(e.contains){return e.contains(t)}else{return!!(t.compareDocumentPosition(e)&8)}},insertBefore:function(t){t.parentNode.insertBefore(e,t);return this},remove:function(){e.parentNode.removeChild(e);return this},css:function(t){if(e.style==null){throw new qq.Error("Can't apply style to node as it is not on the HTMLElement prototype chain!")}if(t.opacity!=null){if(typeof e.style.opacity!=="string"&&typeof e.filters!=="undefined"){t.filter="alpha(opacity="+Math.round(100*t.opacity)+")"}}qq.extend(e.style,t);return this},hasClass:function(t){var i=new RegExp("(^| )"+t+"( |$)");return i.test(e.className)},addClass:function(t){if(!qq(e).hasClass(t)){e.className+=" "+t}return this},removeClass:function(t){var i=new RegExp("(^| )"+t+"( |$)");e.className=e.className.replace(i," ").replace(/^\s+|\s+$/g,"");return this},getByClass:function(t){var i,n=[];if(e.querySelectorAll){return e.querySelectorAll("."+t)}i=e.getElementsByTagName("*");qq.each(i,function(e,i){if(qq(i).hasClass(t)){n.push(i)}});return n},children:function(){var t=[],i=e.firstChild;while(i){if(i.nodeType===1){t.push(i)}i=i.nextSibling}return t},setText:function(t){e.innerText=t;e.textContent=t;return this},clearText:function(){return qq(e).setText("")},hasAttribute:function(t){var i;if(e.hasAttribute){if(!e.hasAttribute(t)){return false}return/^false$/i.exec(e.getAttribute(t))==null}else{i=e[t];if(i===undefined){return false}return/^false$/i.exec(i)==null}}}};(function(){"use strict";qq.log=function(e,t){if(window.console){if(!t||t==="info"){window.console.log(e)}else{if(window.console[t]){window.console[t](e)}else{window.console.log("<"+t+"> "+e)}}}};qq.isObject=function(e){return e&&!e.nodeType&&Object.prototype.toString.call(e)==="[object Object]"};qq.isFunction=function(e){return typeof e==="function"};qq.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"||e&&window.ArrayBuffer&&e.buffer&&e.buffer.constructor===ArrayBuffer};qq.isItemList=function(e){return Object.prototype.toString.call(e)==="[object DataTransferItemList]"};qq.isNodeList=function(e){return Object.prototype.toString.call(e)==="[object NodeList]"||e.item&&e.namedItem};qq.isString=function(e){return Object.prototype.toString.call(e)==="[object String]"};qq.trimStr=function(e){if(String.prototype.trim){return e.trim()}return e.replace(/^\s+|\s+$/g,"")};qq.format=function(e){var t=Array.prototype.slice.call(arguments,1),i=e,n=i.indexOf("{}");qq.each(t,function(e,t){var a=i.substring(0,n),o=i.substring(n+2);i=a+t+o;n=i.indexOf("{}",n+t.length);if(n<0){return false}});return i};qq.isFile=function(e){return window.File&&Object.prototype.toString.call(e)==="[object File]"};qq.isFileList=function(e){return window.FileList&&Object.prototype.toString.call(e)==="[object FileList]"};qq.isFileOrInput=function(e){return qq.isFile(e)||qq.isInput(e)};qq.isInput=function(e,t){var i=function(e){var i=e.toLowerCase();if(t){return i!=="file"}return i==="file"};if(window.HTMLInputElement){if(Object.prototype.toString.call(e)==="[object HTMLInputElement]"){if(e.type&&i(e.type)){return true}}}if(e.tagName){if(e.tagName.toLowerCase()==="input"){if(e.type&&i(e.type)){return true}}}return false};qq.isBlob=function(e){if(window.Blob&&Object.prototype.toString.call(e)==="[object Blob]"){return true}};qq.isXhrUploadSupported=function(){var e=document.createElement("input");e.type="file";return e.multiple!==undefined&&typeof File!=="undefined"&&typeof FormData!=="undefined"&&typeof qq.createXhrInstance().upload!=="undefined"};qq.createXhrInstance=function(){if(window.XMLHttpRequest){return new XMLHttpRequest}try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(e){qq.log("Neither XHR or ActiveX are supported!","error");return null}};qq.isFolderDropSupported=function(e){return e.items&&e.items.length>0&&e.items[0].webkitGetAsEntry};qq.isFileChunkingSupported=function(){return!qq.androidStock()&&qq.isXhrUploadSupported()&&(File.prototype.slice!==undefined||File.prototype.webkitSlice!==undefined||File.prototype.mozSlice!==undefined)};qq.sliceBlob=function(e,t,i){var n=e.slice||e.mozSlice||e.webkitSlice;return n.call(e,t,i)};qq.arrayBufferToHex=function(e){var t="",i=new Uint8Array(e);qq.each(i,function(e,i){var n=i.toString(16);if(n.length<2){n="0"+n}t+=n});return t};qq.readBlobToHex=function(e,t,i){var n=qq.sliceBlob(e,t,t+i),a=new FileReader,o=new qq.Promise;a.onload=function(){o.success(qq.arrayBufferToHex(a.result))};a.onerror=o.failure;a.readAsArrayBuffer(n);return o};qq.extend=function(e,t,i){qq.each(t,function(t,n){if(i&&qq.isObject(n)){if(e[t]===undefined){e[t]={}}qq.extend(e[t],n,true)}else{e[t]=n}});return e};qq.override=function(e,t){var i={},n=t(i);qq.each(n,function(t,n){if(e[t]!==undefined){i[t]=e[t]}e[t]=n});return e};qq.indexOf=function(e,t,i){if(e.indexOf){return e.indexOf(t,i)}i=i||0;var n=e.length;if(i<0){i+=n}for(;i<n;i+=1){if(e.hasOwnProperty(i)&&e[i]===t){return i}}return-1};qq.getUniqueId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)})};qq.ie=function(){return navigator.userAgent.indexOf("MSIE")!==-1};qq.ie7=function(){return navigator.userAgent.indexOf("MSIE 7")!==-1};qq.ie10=function(){return navigator.userAgent.indexOf("MSIE 10")!==-1};qq.ie11=function(){return navigator.userAgent.indexOf("Trident")!==-1&&navigator.userAgent.indexOf("rv:11")!==-1};qq.safari=function(){return navigator.vendor!==undefined&&navigator.vendor.indexOf("Apple")!==-1};qq.chrome=function(){return navigator.vendor!==undefined&&navigator.vendor.indexOf("Google")!==-1};qq.opera=function(){return navigator.vendor!==undefined&&navigator.vendor.indexOf("Opera")!==-1};qq.firefox=function(){return!qq.ie11()&&navigator.userAgent.indexOf("Mozilla")!==-1&&navigator.vendor!==undefined&&navigator.vendor===""};qq.windows=function(){return navigator.platform==="Win32"};qq.android=function(){return navigator.userAgent.toLowerCase().indexOf("android")!==-1};qq.androidStock=function(){return qq.android()&&navigator.userAgent.toLowerCase().indexOf("chrome")<0};qq.ios7=function(){return qq.ios()&&navigator.userAgent.indexOf(" OS 7_")!==-1};qq.ios=function(){return navigator.userAgent.indexOf("iPad")!==-1||navigator.userAgent.indexOf("iPod")!==-1||navigator.userAgent.indexOf("iPhone")!==-1};qq.preventDefault=function(e){if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}};qq.toElement=function(){var e=document.createElement("div");return function(t){e.innerHTML=t;var i=e.firstChild;e.removeChild(i);return i}}();qq.each=function(e,t){var i,n;if(e){if(window.Storage&&e.constructor===window.Storage){for(i=0;i<e.length;i++){n=t(e.key(i),e.getItem(e.key(i)));if(n===false){break}}}else if(qq.isArray(e)||qq.isItemList(e)||qq.isNodeList(e)){for(i=0;i<e.length;i++){n=t(i,e[i]);if(n===false){break}}}else if(qq.isString(e)){for(i=0;i<e.length;i++){n=t(i,e.charAt(i));if(n===false){break}}}else{for(i in e){if(Object.prototype.hasOwnProperty.call(e,i)){n=t(i,e[i]);if(n===false){break}}}}}};qq.bind=function(e,t){if(qq.isFunction(e)){var i=Array.prototype.slice.call(arguments,2);return function(){var n=qq.extend([],i);if(arguments.length){n=n.concat(Array.prototype.slice.call(arguments))}return e.apply(t,n)}}throw new Error("first parameter must be a function!")};qq.obj2url=function(e,t,i){var n=[],a="&",o=function(e,i){var a=t?/\[\]$/.test(t)?t:t+"["+i+"]":i;if(a!=="undefined"&&i!=="undefined"){n.push(typeof e==="object"?qq.obj2url(e,a,true):Object.prototype.toString.call(e)==="[object Function]"?encodeURIComponent(a)+"="+encodeURIComponent(e()):encodeURIComponent(a)+"="+encodeURIComponent(e))}};if(!i&&t){a=/\?/.test(t)?/\?$/.test(t)?"":"&":"?";n.push(t);n.push(qq.obj2url(e))}else if(Object.prototype.toString.call(e)==="[object Array]"&&typeof e!=="undefined"){qq.each(e,function(e,t){o(t,e)})}else if(typeof e!=="undefined"&&e!==null&&typeof e==="object"){qq.each(e,function(e,t){o(t,e)})}else{n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}if(t){return n.join(a)}else{return n.join(a).replace(/^&/,"").replace(/%20/g,"+")}};qq.obj2FormData=function(e,t,i){if(!t){t=new FormData}qq.each(e,function(e,n){e=i?i+"["+e+"]":e;if(qq.isObject(n)){qq.obj2FormData(n,t,e)}else if(qq.isFunction(n)){t.append(e,n())}else{t.append(e,n)}});return t};qq.obj2Inputs=function(e,t){var i;if(!t){t=document.createElement("form")}qq.obj2FormData(e,{append:function(e,n){i=document.createElement("input");i.setAttribute("name",e);i.setAttribute("value",n);t.appendChild(i)}});return t};qq.parseJson=function(json){if(window.JSON&&qq.isFunction(JSON.parse)){return JSON.parse(json)}else{return eval("("+json+")")}};qq.getExtension=function(e){var t=e.lastIndexOf(".")+1;if(t>0){return e.substr(t,e.length-t)}};qq.getFilename=function(e){if(qq.isInput(e)){return e.value.replace(/.*(\/|\\)/,"")}else if(qq.isFile(e)){if(e.fileName!==null&&e.fileName!==undefined){return e.fileName}}return e.name};qq.DisposeSupport=function(){var e=[];return{dispose:function(){var t;do{t=e.shift();if(t){t()}}while(t)},attach:function(){var e=arguments;this.addDisposer(qq(e[0]).attach.apply(this,Array.prototype.slice.call(arguments,1)))},addDisposer:function(t){e.push(t)}}}})();(function(){"use strict";qq.Error=function(e){this.message="[Fine Uploader "+qq.version+"] "+e};qq.Error.prototype=new Error})();qq.version="5.0.4";qq.supportedFeatures=function(){"use strict";var e,t,i,n,a,o,s,r,l,d,u,c,f,p;function g(){var e=true,t;try{t=document.createElement("input");t.type="file";qq(t).hide();if(t.disabled){e=false}}catch(t){e=false}return e}function h(){return(qq.chrome()||qq.opera())&&navigator.userAgent.match(/Chrome\/[2][1-9]|Chrome\/[3-9][0-9]/)!==undefined}function m(){return(qq.chrome()||qq.opera())&&navigator.userAgent.match(/Chrome\/[1][4-9]|Chrome\/[2-9][0-9]/)!==undefined}function _(){if(window.XMLHttpRequest){var e=qq.createXhrInstance();return e.withCredentials!==undefined}return false}function v(){return window.XDomainRequest!==undefined}function E(){if(_()){return true}return v()}function C(){return document.createElement("input").webkitdirectory!==undefined}e=g();i=e&&qq.isXhrUploadSupported();t=i&&!qq.androidStock();n=i&&h();a=i&&qq.isFileChunkingSupported();o=i&&a&&!!window.localStorage;s=i&&m();r=e&&(window.postMessage!==undefined||i);d=_();l=v();u=E();c=C();f=i&&window.FileReader!==undefined;p=function(){if(i){return!qq.androidStock()&&!(qq.ios()&&navigator.userAgent.indexOf("CriOS")>=0)}return false}();return{ajaxUploading:i,blobUploading:t,canDetermineSize:i,chunking:a,deleteFileCors:u,deleteFileCorsXdr:l,deleteFileCorsXhr:d,fileDrop:i,folderDrop:n,folderSelection:c,imagePreviews:f,imageValidation:f,itemSizeValidation:i,pause:a,progressBar:p,resume:o,scaling:f&&t,tiffPreviews:qq.safari(),unlimitedScaledImageSize:!qq.ios(),uploading:e,uploadCors:r,uploadCustomHeaders:i,uploadNonMultipart:i,uploadViaPaste:s}}();qq.isGenericPromise=function(e){"use strict";return!!(e&&e.then&&qq.isFunction(e.then))};qq.Promise=function(){"use strict";var e,t,i=[],n=[],a=[],o=0;qq.extend(this,{then:function(a,s){if(o===0){if(a){i.push(a)}if(s){n.push(s)}}else if(o===-1){s&&s.apply(null,t)}else if(a){a.apply(null,e)}return this},done:function(i){if(o===0){a.push(i)}else{i.apply(null,t===undefined?e:t)}return this},success:function(){o=1;e=arguments;if(i.length){qq.each(i,function(t,i){i.apply(null,e)})}if(a.length){qq.each(a,function(t,i){i.apply(null,e)})}return this},failure:function(){o=-1;t=arguments;if(n.length){qq.each(n,function(e,i){i.apply(null,t)})}if(a.length){qq.each(a,function(e,i){i.apply(null,t)})}return this}})};qq.BlobProxy=function(e,t){"use strict";qq.extend(this,{referenceBlob:e,create:function(){return t(e)}})};qq.UploadButton=function(e){"use strict";var t=new qq.DisposeSupport,i={element:null,multiple:false,acceptFiles:null,folders:false,name:"qqfile",onChange:function(e){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"},n,a;qq.extend(i,e);a=qq.getUniqueId();function o(){var e=document.createElement("input");e.setAttribute(qq.UploadButton.BUTTON_ID_ATTR_NAME,a);if(i.multiple){e.setAttribute("multiple","")}if(i.folders&&qq.supportedFeatures.folderSelection){e.setAttribute("webkitdirectory","")}if(i.acceptFiles){e.setAttribute("accept",i.acceptFiles)}e.setAttribute("type","file");e.setAttribute("name",i.name);qq(e).css({position:"absolute",right:0,top:0,fontFamily:"Arial",margin:0,padding:0,cursor:"pointer",opacity:0});i.element.appendChild(e);t.attach(e,"change",function(){i.onChange(e)});t.attach(e,"mouseover",function(){qq(i.element).addClass(i.hoverClass)});t.attach(e,"mouseout",function(){qq(i.element).removeClass(i.hoverClass)});t.attach(e,"focus",function(){qq(i.element).addClass(i.focusClass)});t.attach(e,"blur",function(){qq(i.element).removeClass(i.focusClass)});if(window.attachEvent){e.setAttribute("tabIndex","-1")}return e}qq(i.element).css({position:"relative",overflow:"hidden",direction:"ltr"});n=o();qq.extend(this,{getInput:function(){return n},getButtonId:function(){return a},setMultiple:function(e){if(e!==i.multiple){if(e){n.setAttribute("multiple","")}else{n.removeAttribute("multiple")}}},setAcceptFiles:function(e){if(e!==i.acceptFiles){n.setAttribute("accept",e)}},reset:function(){if(n.parentNode){qq(n).remove()}qq(i.element).removeClass(i.focusClass);n=o()}})};qq.UploadButton.BUTTON_ID_ATTR_NAME="qq-button-id";qq.UploadData=function(e){"use strict";var t=[],i={},n={},a={},o={};function s(e){if(qq.isArray(e)){var i=[];qq.each(e,function(e,n){i.push(t[n])});return i}return t[e]}function r(e){if(qq.isArray(e)){var n=[];qq.each(e,function(e,a){n.push(t[i[a]])});return n}return t[i[e]]}function l(e){var i=[],a=[].concat(e);qq.each(a,function(e,a){var o=n[a];if(o!==undefined){qq.each(o,function(e,n){i.push(t[n])})}});return i}qq.extend(this,{addFile:function(s){var r=s.status||qq.status.SUBMITTING;var l=t.push({name:s.name,originalName:s.name,uuid:s.uuid,size:s.size||-1,status:r})-1;if(s.batchId){t[l].batchId=s.batchId;if(o[s.batchId]===undefined){o[s.batchId]=[]}o[s.batchId].push(l)}if(s.proxyGroupId){t[l].proxyGroupId=s.proxyGroupId;if(a[s.proxyGroupId]===undefined){a[s.proxyGroupId]=[]}a[s.proxyGroupId].push(l)}t[l].id=l;i[s.uuid]=l;if(n[r]===undefined){n[r]=[]}n[r].push(l);e.onStatusChange(l,null,r);return l},retrieve:function(e){if(qq.isObject(e)&&t.length){if(e.id!==undefined){return s(e.id)}else if(e.uuid!==undefined){return r(e.uuid)}else if(e.status){return l(e.status)}}else{return qq.extend([],t,true)}},reset:function(){t=[];i={};n={};o={}},setStatus:function(i,a){var o=t[i].status,s=qq.indexOf(n[o],i);n[o].splice(s,1);t[i].status=a;if(n[a]===undefined){n[a]=[]}n[a].push(i);e.onStatusChange(i,o,a)},uuidChanged:function(e,n){var a=t[e].uuid;t[e].uuid=n;i[n]=e;delete i[a]},updateName:function(e,i){t[e].name=i},updateSize:function(e,i){t[e].size=i},setParentId:function(e,i){t[e].parentId=i},getIdsInProxyGroup:function(e){var i=t[e].proxyGroupId;if(i){return a[i]}return[]},getIdsInBatch:function(e){var i=t[e].batchId;return o[i]}})};qq.status={SUBMITTING:"submitting",SUBMITTED:"submitted",REJECTED:"rejected",QUEUED:"queued",CANCELED:"canceled",PAUSED:"paused",UPLOADING:"uploading",UPLOAD_RETRYING:"retrying upload",UPLOAD_SUCCESSFUL:"upload successful",UPLOAD_FAILED:"upload failed",DELETE_FAILED:"delete failed",DELETING:"deleting",DELETED:"deleted"};(function(){"use strict";qq.basePublicApi={addBlobs:function(e,t,i){if(!qq.supportedFeatures.blobUploading){throw new qq.Error("Blob uploading is not supported in this browser!")}if(e){var n=[].concat(e),a=[],o=this._storedIds.length===0?qq.getUniqueId():this._currentBatchId,s=this;this._currentBatchId=o;qq.each(n,function(e,t){var i;if(qq.isBlob(t)&&!qq.isFileOrInput(t)){i={blob:t,name:s._options.blobs.defaultName}}else if(qq.isObject(t)&&t.blob&&t.name){i=t}else{s.log("addBlobs: entry at index "+e+" is not a Blob or a BlobData object","error")}i&&s._handleNewFile(i,o,a)});this._prepareItemsForUpload(a,t,i)}else{this.log("undefined or non-array parameter passed into addBlobs","error")}},addFiles:function(e,t,i){var n=[],a=this._storedIds.length===0?qq.getUniqueId():this._currentBatchId,o,s,r;this._currentBatchId=a;if(e){if(!qq.isFileList(e)){e=[].concat(e)}for(o=0;o<e.length;o+=1){s=e[o];if(qq.isFileOrInput(s)){if(qq.isInput(s)&&qq.supportedFeatures.ajaxUploading){for(r=0;r<s.files.length;r++){this._handleNewFile(s.files[r],a,n)}}else{this._handleNewFile(s,a,n)}}else{this.log(s+" is not a File or INPUT element!  Ignoring!","warn")}}this.log("Received "+n.length+" files or inputs.");this._prepareItemsForUpload(n,t,i)}},cancel:function(e){this._handler.cancel(e)},cancelAll:function(){var e=[],t=this;qq.extend(e,this._storedIds);qq.each(e,function(e,i){t.cancel(i)});this._handler.cancelAll()},clearStoredFiles:function(){this._storedIds=[]},continueUpload:function(e){var t=this._uploadData.retrieve({id:e});if(!qq.supportedFeatures.pause||!this._options.chunking.enabled){return false}if(t.status===qq.status.PAUSED){this.log(qq.format("Paused file ID {} ({}) will be continued.  Not paused.",e,this.getName(e)));this._uploadFile(e);return true}else{this.log(qq.format("Ignoring continue for file ID {} ({}).  Not paused.",e,this.getName(e)),"error")}return false},deleteFile:function(e){return this._onSubmitDelete(e)},doesExist:function(e){return this._handler.isValid(e)},drawThumbnail:function(e,t,i,n){var a=new qq.Promise;if(this._imageGenerator){var o=this._thumbnailUrls[e],s={scale:i>0,maxSize:i>0?i:null};if(!n&&qq.supportedFeatures.imagePreviews){o=this.getFile(e)}if(o==null){a.failure({container:t,error:"File or URL not found."})}else{this._imageGenerator.generate(o,t,s).then(function e(t){a.success(t)},function e(t,i){a.failure({container:t,error:i||"Problem generating thumbnail"})})}}else{a.failure({container:t,error:"Missing image generator module"})}return a},getButton:function(e){return this._getButton(this._buttonIdsForFileIds[e])},getFile:function(e){return this._handler.getFile(e)||null},getInProgress:function(){return this._uploadData.retrieve({status:[qq.status.UPLOADING,qq.status.UPLOAD_RETRYING,qq.status.QUEUED]}).length},getName:function(e){return this._uploadData.retrieve({id:e}).name},getParentId:function(e){var t=this.getUploads({id:e}),i=null;if(t){if(t.parentId!==undefined){i=t.parentId}}return i},getResumableFilesData:function(){return this._handler.getResumableFilesData()},getSize:function(e){return this._uploadData.retrieve({id:e}).size},getNetUploads:function(){return this._netUploaded},getRemainingAllowedItems:function(){var e=this._options.validation.itemLimit;if(e>0){return this._options.validation.itemLimit-this._netUploadedOrQueued}return null},getUploads:function(e){return this._uploadData.retrieve(e)},getUuid:function(e){return this._uploadData.retrieve({id:e}).uuid},log:function(e,t){if(this._options.debug&&(!t||t==="info")){qq.log("[Fine Uploader "+qq.version+"] "+e)}else if(t&&t!=="info"){qq.log("[Fine Uploader "+qq.version+"] "+e,t)}},pauseUpload:function(e){var t=this._uploadData.retrieve({id:e});if(!qq.supportedFeatures.pause||!this._options.chunking.enabled){return false}if(qq.indexOf([qq.status.UPLOADING,qq.status.UPLOAD_RETRYING],t.status)>=0){if(this._handler.pause(e)){this._uploadData.setStatus(e,qq.status.PAUSED);return true}else{this.log(qq.format("Unable to pause file ID {} ({}).",e,this.getName(e)),"error")}}else{this.log(qq.format("Ignoring pause for file ID {} ({}).  Not in progress.",e,this.getName(e)),"error")}return false},reset:function(){this.log("Resetting uploader...");this._handler.reset();this._storedIds=[];this._autoRetries=[];this._retryTimeouts=[];this._preventRetries=[];this._thumbnailUrls=[];qq.each(this._buttons,function(e,t){t.reset()});this._paramsStore.reset();this._endpointStore.reset();this._netUploadedOrQueued=0;this._netUploaded=0;this._uploadData.reset();this._buttonIdsForFileIds=[];this._pasteHandler&&this._pasteHandler.reset();this._options.session.refreshOnReset&&this._refreshSessionData();this._succeededSinceLastAllComplete=[];this._failedSinceLastAllComplete=[];this._totalProgress&&this._totalProgress.reset()},retry:function(e){return this._manualRetry(e)},scaleImage:function(e,t){var i=this;return qq.Scaler.prototype.scaleImage(e,t,{log:qq.bind(i.log,i),getFile:qq.bind(i.getFile,i),uploadData:i._uploadData})},setCustomHeaders:function(e,t){this._customHeadersStore.set(e,t)},setDeleteFileCustomHeaders:function(e,t){this._deleteFileCustomHeadersStore.set(e,t)},setDeleteFileEndpoint:function(e,t){this._deleteFileEndpointStore.set(e,t)},setDeleteFileParams:function(e,t){this._deleteFileParamsStore.set(e,t)},setEndpoint:function(e,t){this._endpointStore.set(e,t)},setName:function(e,t){this._uploadData.updateName(e,t)},setParams:function(e,t){this._paramsStore.set(e,t)},setUuid:function(e,t){return this._uploadData.uuidChanged(e,t)},uploadStoredFiles:function(){var e;if(this._storedIds.length===0){this._itemError("noFilesError")}else{while(this._storedIds.length){e=this._storedIds.shift();this._uploadFile(e)}}}};qq.basePrivateApi={_addCannedFile:function(e){var t=this._uploadData.addFile({uuid:e.uuid,name:e.name,size:e.size,status:qq.status.UPLOAD_SUCCESSFUL});e.deleteFileEndpoint&&this.setDeleteFileEndpoint(e.deleteFileEndpoint,t);e.deleteFileParams&&this.setDeleteFileParams(e.deleteFileParams,t);if(e.thumbnailUrl){this._thumbnailUrls[t]=e.thumbnailUrl}this._netUploaded++;this._netUploadedOrQueued++;return t},_annotateWithButtonId:function(e,t){if(qq.isFile(e)){e.qqButtonId=this._getButtonId(t)}},_batchError:function(e){this._options.callbacks.onError(null,null,e,undefined)},_createDeleteHandler:function(){var e=this;return new qq.DeleteFileAjaxRequester({method:this._options.deleteFile.method.toUpperCase(),maxConnections:this._options.maxConnections,uuidParamName:this._options.request.uuidName,customHeaders:this._deleteFileCustomHeadersStore,paramsStore:this._deleteFileParamsStore,endpointStore:this._deleteFileEndpointStore,demoMode:this._options.demoMode,cors:this._options.cors,log:qq.bind(e.log,e),onDelete:function(t){e._onDelete(t);e._options.callbacks.onDelete(t)},onDeleteComplete:function(t,i,n){e._onDeleteComplete(t,i,n);e._options.callbacks.onDeleteComplete(t,i,n)}})},_createPasteHandler:function(){var e=this;return new qq.PasteSupport({targetElement:this._options.paste.targetElement,callbacks:{log:qq.bind(e.log,e),pasteReceived:function(t){e._handleCheckedCallback({name:"onPasteReceived",callback:qq.bind(e._options.callbacks.onPasteReceived,e,t),onSuccess:qq.bind(e._handlePasteSuccess,e,t),identifier:"pasted image"})}}})},_createStore:function(e,t){var i={},n=e,a={},o=function(e){if(qq.isObject(e)){return qq.extend({},e)}return e},s=function(){if(qq.isFunction(t)){return t()}return t},r=function(e,i){if(t&&qq.isObject(i)){qq.extend(i,s())}if(a[e]){qq.extend(i,a[e])}};return{set:function(e,t){if(t==null){i={};n=o(e)}else{i[t]=o(e)}},get:function(e){var t;if(e!=null&&i[e]){t=i[e]}else{t=o(n)}r(e,t);return o(t)},addReadOnly:function(e,t){if(qq.isObject(i)){a[e]=a[e]||{};qq.extend(a[e],t)}},remove:function(e){
return delete i[e]},reset:function(){i={};a={};n=e}}},_createUploadDataTracker:function(){var e=this;return new qq.UploadData({getName:function(t){return e.getName(t)},getUuid:function(t){return e.getUuid(t)},getSize:function(t){return e.getSize(t)},onStatusChange:function(t,i,n){e._onUploadStatusChange(t,i,n);e._options.callbacks.onStatusChange(t,i,n);e._maybeAllComplete(t,n);if(e._totalProgress){setTimeout(function(){e._totalProgress.onStatusChange(t,i,n)},0)}}})},_createUploadButton:function(e){var t=this,i=e.accept||this._options.validation.acceptFiles,n=e.allowedExtensions||this._options.validation.allowedExtensions;function a(){if(qq.supportedFeatures.ajaxUploading){if(qq.ios7()&&t._isAllowedExtension(n,".mov")){return false}if(e.multiple===undefined){return t._options.multiple}return e.multiple}return false}var o=new qq.UploadButton({element:e.element,folders:e.folders,name:this._options.request.inputName,multiple:a(),acceptFiles:i,onChange:function(e){t._onInputChange(e)},hoverClass:this._options.classes.buttonHover,focusClass:this._options.classes.buttonFocus});this._disposeSupport.addDisposer(function(){o.dispose()});t._buttons.push(o);return o},_createUploadHandler:function(e,t){var i=this,n={},a={debug:this._options.debug,maxConnections:this._options.maxConnections,cors:this._options.cors,demoMode:this._options.demoMode,paramsStore:this._paramsStore,endpointStore:this._endpointStore,chunking:this._options.chunking,resume:this._options.resume,blobs:this._options.blobs,log:qq.bind(i.log,i),preventRetryParam:this._options.retry.preventRetryResponseProperty,onProgress:function(e,t,a,o){if(a<0||o<0){return}if(n[e]){if(n[e].loaded!==a||n[e].total!==o){i._onProgress(e,t,a,o);i._options.callbacks.onProgress(e,t,a,o)}}else{i._onProgress(e,t,a,o);i._options.callbacks.onProgress(e,t,a,o)}n[e]={loaded:a,total:o}},onComplete:function(e,t,a,o){delete n[e];var s=i.getUploads({id:e}).status;if(s===qq.status.UPLOAD_SUCCESSFUL||s===qq.status.UPLOAD_FAILED){return}var r=i._onComplete(e,t,a,o);if(r instanceof qq.Promise){r.done(function(){i._options.callbacks.onComplete(e,t,a,o)})}else{i._options.callbacks.onComplete(e,t,a,o)}},onCancel:function(e,t,n){var a=new qq.Promise;i._handleCheckedCallback({name:"onCancel",callback:qq.bind(i._options.callbacks.onCancel,i,e,t),onFailure:a.failure,onSuccess:function(){n.then(function(){i._onCancel(e,t)});a.success()},identifier:e});return a},onUploadPrep:qq.bind(this._onUploadPrep,this),onUpload:function(e,t){i._onUpload(e,t);i._options.callbacks.onUpload(e,t)},onUploadChunk:function(e,t,n){i._onUploadChunk(e,n);i._options.callbacks.onUploadChunk(e,t,n)},onUploadChunkSuccess:function(e,t,n,a){i._options.callbacks.onUploadChunkSuccess.apply(i,arguments)},onResume:function(e,t,n){return i._options.callbacks.onResume(e,t,n)},onAutoRetry:function(e,t,n,a){return i._onAutoRetry.apply(i,arguments)},onUuidChanged:function(e,t){i.log("Server requested UUID change from '"+i.getUuid(e)+"' to '"+t+"'");i.setUuid(e,t)},getName:qq.bind(i.getName,i),getUuid:qq.bind(i.getUuid,i),getSize:qq.bind(i.getSize,i),setSize:qq.bind(i._setSize,i),getDataByUuid:function(e){return i.getUploads({uuid:e})},isQueued:function(e){var t=i.getUploads({id:e}).status;return t===qq.status.QUEUED||t===qq.status.SUBMITTED||t===qq.status.UPLOAD_RETRYING||t===qq.status.PAUSED},getIdsInProxyGroup:i._uploadData.getIdsInProxyGroup,getIdsInBatch:i._uploadData.getIdsInBatch};qq.each(this._options.request,function(e,t){a[e]=t});a.customHeaders=this._customHeadersStore;if(e){qq.each(e,function(e,t){a[e]=t})}return new qq.UploadHandlerController(a,t)},_fileOrBlobRejected:function(e){this._netUploadedOrQueued--;this._uploadData.setStatus(e,qq.status.REJECTED)},_formatSize:function(e){var t=-1;do{e=e/1e3;t++}while(e>999);return Math.max(e,.1).toFixed(1)+this._options.text.sizeSymbols[t]},_generateExtraButtonSpecs:function(){var e=this;this._extraButtonSpecs={};qq.each(this._options.extraButtons,function(t,i){var n=i.multiple,a=qq.extend({},e._options.validation,true),o=qq.extend({},i);if(n===undefined){n=e._options.multiple}if(o.validation){qq.extend(a,i.validation,true)}qq.extend(o,{multiple:n,validation:a},true);e._initExtraButton(o)})},_getButton:function(e){var t=this._extraButtonSpecs[e];if(t){return t.element}else if(e===this._defaultButtonId){return this._options.button}},_getButtonId:function(e){var t,i,n=e;if(n instanceof qq.BlobProxy){n=n.referenceBlob}if(n&&!qq.isBlob(n)){if(qq.isFile(n)){return n.qqButtonId}else if(n.tagName.toLowerCase()==="input"&&n.type.toLowerCase()==="file"){return n.getAttribute(qq.UploadButton.BUTTON_ID_ATTR_NAME)}t=n.getElementsByTagName("input");qq.each(t,function(e,t){if(t.getAttribute("type")==="file"){i=t;return false}});if(i){return i.getAttribute(qq.UploadButton.BUTTON_ID_ATTR_NAME)}}},_getNotFinished:function(){return this._uploadData.retrieve({status:[qq.status.UPLOADING,qq.status.UPLOAD_RETRYING,qq.status.QUEUED,qq.status.SUBMITTING,qq.status.SUBMITTED,qq.status.PAUSED]}).length},_getValidationBase:function(e){var t=this._extraButtonSpecs[e];return t?t.validation:this._options.validation},_getValidationDescriptor:function(e){if(e.file instanceof qq.BlobProxy){return{name:qq.getFilename(e.file.referenceBlob),size:e.file.referenceBlob.size}}return{name:this.getUploads({id:e.id}).name,size:this.getUploads({id:e.id}).size}},_getValidationDescriptors:function(e){var t=this,i=[];qq.each(e,function(e,n){i.push(t._getValidationDescriptor(n))});return i},_handleCameraAccess:function(){if(this._options.camera.ios&&qq.ios()){var e="image/*;capture=camera",t=this._options.camera.button,i=t?this._getButtonId(t):this._defaultButtonId,n=this._options;if(i&&i!==this._defaultButtonId){n=this._extraButtonSpecs[i]}n.multiple=false;if(n.validation.acceptFiles===null){n.validation.acceptFiles=e}else{n.validation.acceptFiles+=","+e}qq.each(this._buttons,function(e,t){if(t.getButtonId()===i){t.setMultiple(n.multiple);t.setAcceptFiles(n.acceptFiles);return false}})}},_handleCheckedCallback:function(e){var t=this,i=e.callback();if(qq.isGenericPromise(i)){this.log(e.name+" - waiting for "+e.name+" promise to be fulfilled for "+e.identifier);return i.then(function(i){t.log(e.name+" promise success for "+e.identifier);e.onSuccess(i)},function(){if(e.onFailure){t.log(e.name+" promise failure for "+e.identifier);e.onFailure()}else{t.log(e.name+" promise failure for "+e.identifier)}})}if(i!==false){e.onSuccess(i)}else{if(e.onFailure){this.log(e.name+" - return value was 'false' for "+e.identifier+".  Invoking failure callback.");e.onFailure()}else{this.log(e.name+" - return value was 'false' for "+e.identifier+".  Will not proceed.")}}return i},_handleNewFile:function(e,t,i){var n=this,a=qq.getUniqueId(),o=-1,s=qq.getFilename(e),r=e.blob||e,l=this._customNewFileHandler?this._customNewFileHandler:qq.bind(n._handleNewFileGeneric,n);if(!qq.isInput(r)&&r.size>=0){o=r.size}l(r,s,a,o,i,t,this._options.request.uuidName,{uploadData:n._uploadData,paramsStore:n._paramsStore,addFileToHandler:function(e,t){n._handler.add(e,t);n._netUploadedOrQueued++;n._trackButton(e)}})},_handleNewFileGeneric:function(e,t,i,n,a,o){var s=this._uploadData.addFile({uuid:i,name:t,size:n,batchId:o});this._handler.add(s,e);this._trackButton(s);this._netUploadedOrQueued++;a.push({id:s,file:e})},_handlePasteSuccess:function(e,t){var i=e.type.split("/")[1],n=t;if(n==null){n=this._options.paste.defaultName}n+="."+i;this.addBlobs({name:n,blob:e})},_initExtraButton:function(e){var t=this._createUploadButton({element:e.element,multiple:e.multiple,accept:e.validation.acceptFiles,folders:e.folders,allowedExtensions:e.validation.allowedExtensions});this._extraButtonSpecs[t.getButtonId()]=e},_initFormSupportAndParams:function(){this._formSupport=qq.FormSupport&&new qq.FormSupport(this._options.form,qq.bind(this.uploadStoredFiles,this),qq.bind(this.log,this));if(this._formSupport&&this._formSupport.attachedToForm){this._paramsStore=this._createStore(this._options.request.params,this._formSupport.getFormInputsAsObject);this._options.autoUpload=this._formSupport.newAutoUpload;if(this._formSupport.newEndpoint){this._options.request.endpoint=this._formSupport.newEndpoint}}else{this._paramsStore=this._createStore(this._options.request.params)}},_isDeletePossible:function(){if(!qq.DeleteFileAjaxRequester||!this._options.deleteFile.enabled){return false}if(this._options.cors.expected){if(qq.supportedFeatures.deleteFileCorsXhr){return true}if(qq.supportedFeatures.deleteFileCorsXdr&&this._options.cors.allowXdr){return true}return false}return true},_isAllowedExtension:function(e,t){var i=false;if(!e.length){return true}qq.each(e,function(e,n){if(qq.isString(n)){var a=new RegExp("\\."+n+"$","i");if(t.match(a)!=null){i=true;return false}}});return i},_itemError:function(e,t,i){var n=this._options.messages[e],a=[],o=[].concat(t),s=o[0],r=this._getButtonId(i),l=this._getValidationBase(r),d,u;function c(e,t){n=n.replace(e,t)}qq.each(l.allowedExtensions,function(e,t){if(qq.isString(t)){a.push(t)}});d=a.join(", ").toLowerCase();c("{file}",this._options.formatFileName(s));c("{extensions}",d);c("{sizeLimit}",this._formatSize(l.sizeLimit));c("{minSizeLimit}",this._formatSize(l.minSizeLimit));u=n.match(/(\{\w+\})/g);if(u!==null){qq.each(u,function(e,t){c(t,o[e])})}this._options.callbacks.onError(null,s,n,undefined);return n},_manualRetry:function(e,t){if(this._onBeforeManualRetry(e)){this._netUploadedOrQueued++;this._uploadData.setStatus(e,qq.status.UPLOAD_RETRYING);if(t){t(e)}else{this._handler.retry(e)}return true}},_maybeAllComplete:function(e,t){var i=this,n=this._getNotFinished();if(t===qq.status.UPLOAD_SUCCESSFUL){this._succeededSinceLastAllComplete.push(e)}else if(t===qq.status.UPLOAD_FAILED){this._failedSinceLastAllComplete.push(e)}if(n===0&&(this._succeededSinceLastAllComplete.length||this._failedSinceLastAllComplete.length)){setTimeout(function(){i._onAllComplete(i._succeededSinceLastAllComplete,i._failedSinceLastAllComplete)},0)}},_maybeParseAndSendUploadError:function(e,t,i,n){if(!i.success){if(n&&n.status!==200&&!i.error){this._options.callbacks.onError(e,t,"XHR returned response code "+n.status,n)}else{var a=i.error?i.error:this._options.text.defaultResponseError;this._options.callbacks.onError(e,t,a,n)}}},_maybeProcessNextItemAfterOnValidateCallback:function(e,t,i,n,a){var o=this;if(t.length>i){if(e||!this._options.validation.stopOnFirstInvalidFile){setTimeout(function(){var e=o._getValidationDescriptor(t[i]),s=o._getButtonId(t[i].file),r=o._getButton(s);o._handleCheckedCallback({name:"onValidate",callback:qq.bind(o._options.callbacks.onValidate,o,e,r),onSuccess:qq.bind(o._onValidateCallbackSuccess,o,t,i,n,a),onFailure:qq.bind(o._onValidateCallbackFailure,o,t,i,n,a),identifier:"Item '"+e.name+"', size: "+e.size})},0)}else if(!e){for(;i<t.length;i++){o._fileOrBlobRejected(t[i].id)}}}},_onAllComplete:function(e,t){this._totalProgress&&this._totalProgress.onAllComplete(e,t,this._preventRetries);this._options.callbacks.onAllComplete(qq.extend([],e),qq.extend([],t));this._succeededSinceLastAllComplete=[];this._failedSinceLastAllComplete=[]},_onAutoRetry:function(e,t,i,n,a){var o=this;o._preventRetries[e]=i[o._options.retry.preventRetryResponseProperty];if(o._shouldAutoRetry(e,t,i)){o._maybeParseAndSendUploadError.apply(o,arguments);o._options.callbacks.onAutoRetry(e,t,o._autoRetries[e]);o._onBeforeAutoRetry(e,t);o._retryTimeouts[e]=setTimeout(function(){o.log("Retrying "+t+"...");o._uploadData.setStatus(e,qq.status.UPLOAD_RETRYING);if(a){a(e)}else{o._handler.retry(e)}},o._options.retry.autoAttemptDelay*1e3);return true}},_onBeforeAutoRetry:function(e,t){this.log("Waiting "+this._options.retry.autoAttemptDelay+" seconds before retrying "+t+"...")},_onBeforeManualRetry:function(e){var t=this._options.validation.itemLimit;if(this._preventRetries[e]){this.log("Retries are forbidden for id "+e,"warn");return false}else if(this._handler.isValid(e)){var i=this.getName(e);if(this._options.callbacks.onManualRetry(e,i)===false){return false}if(t>0&&this._netUploadedOrQueued+1>t){this._itemError("retryFailTooManyItems");return false}this.log("Retrying upload for '"+i+"' (id: "+e+")...");return true}else{this.log("'"+e+"' is not a valid file ID","error");return false}},_onCancel:function(e,t){this._netUploadedOrQueued--;clearTimeout(this._retryTimeouts[e]);var i=qq.indexOf(this._storedIds,e);if(!this._options.autoUpload&&i>=0){this._storedIds.splice(i,1)}this._uploadData.setStatus(e,qq.status.CANCELED)},_onComplete:function(e,t,i,n){if(!i.success){this._netUploadedOrQueued--;this._uploadData.setStatus(e,qq.status.UPLOAD_FAILED);if(i[this._options.retry.preventRetryResponseProperty]===true){this._preventRetries[e]=true}}else{if(i.thumbnailUrl){this._thumbnailUrls[e]=i.thumbnailUrl}this._netUploaded++;this._uploadData.setStatus(e,qq.status.UPLOAD_SUCCESSFUL)}this._maybeParseAndSendUploadError(e,t,i,n);return i.success?true:false},_onDelete:function(e){this._uploadData.setStatus(e,qq.status.DELETING)},_onDeleteComplete:function(e,t,i){var n=this.getName(e);if(i){this._uploadData.setStatus(e,qq.status.DELETE_FAILED);this.log("Delete request for '"+n+"' has failed.","error");if(t.withCredentials===undefined){this._options.callbacks.onError(e,n,"Delete request failed",t)}else{this._options.callbacks.onError(e,n,"Delete request failed with response code "+t.status,t)}}else{this._netUploadedOrQueued--;this._netUploaded--;this._handler.expunge(e);this._uploadData.setStatus(e,qq.status.DELETED);this.log("Delete request for '"+n+"' has succeeded.")}},_onInputChange:function(e){var t;if(qq.supportedFeatures.ajaxUploading){for(t=0;t<e.files.length;t++){this._annotateWithButtonId(e.files[t],e)}this.addFiles(e.files)}else if(e.value.length>0){this.addFiles(e)}qq.each(this._buttons,function(e,t){t.reset()})},_onProgress:function(e,t,i,n){this._totalProgress&&this._totalProgress.onIndividualProgress(e,i,n)},_onSubmit:function(e,t){},_onSubmitCallbackSuccess:function(e,t){this._onSubmit.apply(this,arguments);this._uploadData.setStatus(e,qq.status.SUBMITTED);this._onSubmitted.apply(this,arguments);this._options.callbacks.onSubmitted.apply(this,arguments);if(this._options.autoUpload){this._uploadFile(e)}else{this._storeForLater(e)}},_onSubmitDelete:function(e,t,i){var n=this.getUuid(e),a;if(t){a=qq.bind(t,this,e,n,i)}if(this._isDeletePossible()){this._handleCheckedCallback({name:"onSubmitDelete",callback:qq.bind(this._options.callbacks.onSubmitDelete,this,e),onSuccess:a||qq.bind(this._deleteHandler.sendDelete,this,e,n,i),identifier:e});return true}else{this.log("Delete request ignored for ID "+e+", delete feature is disabled or request not possible "+"due to CORS on a user agent that does not support pre-flighting.","warn");return false}},_onSubmitted:function(e){},_onTotalProgress:function(e,t){this._options.callbacks.onTotalProgress(e,t)},_onUploadPrep:function(e){},_onUpload:function(e,t){this._uploadData.setStatus(e,qq.status.UPLOADING)},_onUploadChunk:function(e,t){},_onUploadStatusChange:function(e,t,i){if(i===qq.status.PAUSED){clearTimeout(this._retryTimeouts[e])}},_onValidateBatchCallbackFailure:function(e){var t=this;qq.each(e,function(e,i){t._fileOrBlobRejected(i.id)})},_onValidateBatchCallbackSuccess:function(e,t,i,n,a){var o,s=this._options.validation.itemLimit,r=this._netUploadedOrQueued;if(s===0||r<=s){if(t.length>0){this._handleCheckedCallback({name:"onValidate",callback:qq.bind(this._options.callbacks.onValidate,this,e[0],a),onSuccess:qq.bind(this._onValidateCallbackSuccess,this,t,0,i,n),onFailure:qq.bind(this._onValidateCallbackFailure,this,t,0,i,n),identifier:"Item '"+t[0].file.name+"', size: "+t[0].file.size})}else{this._itemError("noFilesError")}}else{this._onValidateBatchCallbackFailure(t);o=this._options.messages.tooManyItemsError.replace(/\{netItems\}/g,r).replace(/\{itemLimit\}/g,s);this._batchError(o)}},_onValidateCallbackFailure:function(e,t,i,n){var a=t+1;this._fileOrBlobRejected(e[0].id,e[0].file.name);this._maybeProcessNextItemAfterOnValidateCallback(false,e,a,i,n)},_onValidateCallbackSuccess:function(e,t,i,n){var a=this,o=t+1,s=this._getValidationDescriptor(e[t]);this._validateFileOrBlobData(e[t],s).then(function(){a._upload(e[t].id,i,n);a._maybeProcessNextItemAfterOnValidateCallback(true,e,o,i,n)},function(){a._maybeProcessNextItemAfterOnValidateCallback(false,e,o,i,n)})},_prepareItemsForUpload:function(e,t,i){if(e.length===0){this._itemError("noFilesError");return}var n=this._getValidationDescriptors(e),a=this._getButtonId(e[0].file),o=this._getButton(a);this._handleCheckedCallback({name:"onValidateBatch",callback:qq.bind(this._options.callbacks.onValidateBatch,this,n,o),onSuccess:qq.bind(this._onValidateBatchCallbackSuccess,this,n,e,t,i,o),onFailure:qq.bind(this._onValidateBatchCallbackFailure,this,e),identifier:"batch validation"})},_preventLeaveInProgress:function(){var e=this;this._disposeSupport.attach(window,"beforeunload",function(t){if(e.getInProgress()){t=t||window.event;t.returnValue=e._options.messages.onLeave;return e._options.messages.onLeave}})},_refreshSessionData:function(){var e=this,t=this._options.session;if(qq.Session&&this._options.session.endpoint!=null){if(!this._session){qq.extend(t,this._options.cors);t.log=qq.bind(this.log,this);t.addFileRecord=qq.bind(this._addCannedFile,this);this._session=new qq.Session(t)}setTimeout(function(){e._session.refresh().then(function(t,i){e._options.callbacks.onSessionRequestComplete(t,true,i)},function(t,i){e._options.callbacks.onSessionRequestComplete(t,false,i)})},0)}},_setSize:function(e,t){this._uploadData.updateSize(e,t);this._totalProgress&&this._totalProgress.onNewSize(e)},_shouldAutoRetry:function(e,t,i){var n=this._uploadData.retrieve({id:e});if(!this._preventRetries[e]&&this._options.retry.enableAuto&&n.status!==qq.status.PAUSED){if(this._autoRetries[e]===undefined){this._autoRetries[e]=0}if(this._autoRetries[e]<this._options.retry.maxAutoAttempts){this._autoRetries[e]+=1;return true}}return false},_storeForLater:function(e){this._storedIds.push(e)},_trackButton:function(e){var t;if(qq.supportedFeatures.ajaxUploading){t=this._handler.getFile(e).qqButtonId}else{t=this._getButtonId(this._handler.getInput(e))}if(t){this._buttonIdsForFileIds[e]=t}},_upload:function(e,t,i){var n=this.getName(e);if(t){this.setParams(t,e)}if(i){this.setEndpoint(i,e)}this._handleCheckedCallback({name:"onSubmit",callback:qq.bind(this._options.callbacks.onSubmit,this,e,n),onSuccess:qq.bind(this._onSubmitCallbackSuccess,this,e,n),onFailure:qq.bind(this._fileOrBlobRejected,this,e,n),identifier:e})},_uploadFile:function(e){if(!this._handler.upload(e)){this._uploadData.setStatus(e,qq.status.QUEUED)}},_validateFileOrBlobData:function(e,t){var i=this,n=function(){if(e.file instanceof qq.BlobProxy){return e.file.referenceBlob}return e.file}(),a=t.name,o=t.size,s=this._getButtonId(e.file),r=this._getValidationBase(s),l=new qq.Promise;l.then(function(){},function(){i._fileOrBlobRejected(e.id,a)});if(qq.isFileOrInput(n)&&!this._isAllowedExtension(r.allowedExtensions,a)){this._itemError("typeError",a,n);return l.failure()}if(o===0){this._itemError("emptyError",a,n);return l.failure()}if(o>0&&r.sizeLimit&&o>r.sizeLimit){this._itemError("sizeError",a,n);return l.failure()}if(o>0&&o<r.minSizeLimit){this._itemError("minSizeError",a,n);return l.failure()}if(qq.ImageValidation&&qq.supportedFeatures.imagePreviews&&qq.isFile(n)){new qq.ImageValidation(n,qq.bind(i.log,i)).validate(r.image).then(l.success,function(e){i._itemError(e+"ImageError",a,n);l.failure()})}else{l.success()}return l},_wrapCallbacks:function(){var e,t;e=this;t=function(t,i,n){var a;try{return i.apply(e,n)}catch(i){a=i.message||i.toString();e.log("Caught exception in '"+t+"' callback - "+a,"error")}};for(var i in this._options.callbacks){(function(){var n,a;n=i;a=e._options.callbacks[n];e._options.callbacks[n]=function(){return t(n,a,arguments)}})()}}}})();(function(){"use strict";qq.FineUploaderBasic=function(e){var t=this;this._options={debug:false,button:null,multiple:true,maxConnections:3,disableCancelForFormUploads:false,autoUpload:true,request:{endpoint:"/server/upload",params:{},paramsInBody:true,customHeaders:{},forceMultipart:true,inputName:"qqfile",uuidName:"qquuid",totalFileSizeName:"qqtotalfilesize",filenameParam:"qqfilename"},validation:{allowedExtensions:[],sizeLimit:0,minSizeLimit:0,itemLimit:0,stopOnFirstInvalidFile:true,acceptFiles:null,image:{maxHeight:0,maxWidth:0,minHeight:0,minWidth:0}},callbacks:{onSubmit:function(e,t){},onSubmitted:function(e,t){},onComplete:function(e,t,i,n){},onAllComplete:function(e,t){},onCancel:function(e,t){},onUpload:function(e,t){},onUploadChunk:function(e,t,i){},onUploadChunkSuccess:function(e,t,i,n){},onResume:function(e,t,i){},onProgress:function(e,t,i,n){},onTotalProgress:function(e,t){},onError:function(e,t,i,n){},onAutoRetry:function(e,t,i){},onManualRetry:function(e,t){},onValidateBatch:function(e){},onValidate:function(e){},onSubmitDelete:function(e){},onDelete:function(e){},onDeleteComplete:function(e,t,i){},onPasteReceived:function(e){},onStatusChange:function(e,t,i){},onSessionRequestComplete:function(e,t,i){}},messages:{typeError:"{file} has an invalid extension. Valid extension(s): {extensions}.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",noFilesError:"No files to upload.",tooManyItemsError:"Too many items ({netItems}) would be uploaded.  Item limit is {itemLimit}.",maxHeightImageError:"Image is too tall.",maxWidthImageError:"Image is too wide.",minHeightImageError:"Image is not tall enough.",minWidthImageError:"Image is not wide enough.",retryFailTooManyItems:"Retry failed - you have reached your file limit.",onLeave:"The files are being uploaded, if you leave now the upload will be canceled."},retry:{enableAuto:false,maxAutoAttempts:3,autoAttemptDelay:5,preventRetryResponseProperty:"preventRetry"},classes:{buttonHover:"qq-upload-button-hover",buttonFocus:"qq-upload-button-focus"},chunking:{enabled:false,concurrent:{enabled:false},paramNames:{partIndex:"qqpartindex",partByteOffset:"qqpartbyteoffset",chunkSize:"qqchunksize",totalFileSize:"qqtotalfilesize",totalParts:"qqtotalparts"},partSize:2e6,success:{endpoint:null}},resume:{enabled:false,recordsExpireIn:7,paramNames:{resuming:"qqresume"}},formatFileName:function(e){if(e!==undefined&&e.length>33){e=e.slice(0,19)+"..."+e.slice(-14)}return e},text:{defaultResponseError:"Upload failure reason unknown",sizeSymbols:["kB","MB","GB","TB","PB","EB"]},deleteFile:{enabled:false,method:"DELETE",endpoint:"/server/upload",customHeaders:{},params:{}},cors:{expected:false,sendCredentials:false,allowXdr:false},blobs:{defaultName:"misc_data"},paste:{targetElement:null,defaultName:"pasted_image"},camera:{ios:false,button:null},extraButtons:[],session:{endpoint:null,params:{},customHeaders:{},refreshOnReset:true},form:{element:"qq-form",autoUpload:false,interceptSubmit:true},scaling:{sendOriginal:true,orient:true,defaultType:null,defaultQuality:80,failureText:"Failed to scale",includeExif:false,sizes:[]}};qq.extend(this._options,e,true);this._buttons=[];this._extraButtonSpecs={};this._buttonIdsForFileIds=[];this._wrapCallbacks();this._disposeSupport=new qq.DisposeSupport;this._storedIds=[];this._autoRetries=[];this._retryTimeouts=[];this._preventRetries=[];this._thumbnailUrls=[];this._netUploadedOrQueued=0;this._netUploaded=0;this._uploadData=this._createUploadDataTracker();this._initFormSupportAndParams();this._customHeadersStore=this._createStore(this._options.request.customHeaders);this._deleteFileCustomHeadersStore=this._createStore(this._options.deleteFile.customHeaders);this._deleteFileParamsStore=this._createStore(this._options.deleteFile.params);this._endpointStore=this._createStore(this._options.request.endpoint);this._deleteFileEndpointStore=this._createStore(this._options.deleteFile.endpoint);this._handler=this._createUploadHandler();this._deleteHandler=qq.DeleteFileAjaxRequester&&this._createDeleteHandler();if(this._options.button){this._defaultButtonId=this._createUploadButton({element:this._options.button}).getButtonId()}this._generateExtraButtonSpecs();this._handleCameraAccess();if(this._options.paste.targetElement){if(qq.PasteSupport){this._pasteHandler=this._createPasteHandler()}else{this.log("Paste support module not found","error")}}this._preventLeaveInProgress();this._imageGenerator=qq.ImageGenerator&&new qq.ImageGenerator(qq.bind(this.log,this));this._refreshSessionData();this._succeededSinceLastAllComplete=[];this._failedSinceLastAllComplete=[];this._scaler=qq.Scaler&&new qq.Scaler(this._options.scaling,qq.bind(this.log,this))||{};if(this._scaler.enabled){this._customNewFileHandler=qq.bind(this._scaler.handleNewFile,this._scaler)}if(qq.TotalProgress&&qq.supportedFeatures.progressBar){this._totalProgress=new qq.TotalProgress(qq.bind(this._onTotalProgress,this),function(e){var i=t._uploadData.retrieve({id:e});return i&&i.size||0})}};qq.FineUploaderBasic.prototype=qq.basePublicApi;qq.extend(qq.FineUploaderBasic.prototype,qq.basePrivateApi)})();qq.AjaxRequester=function(e){"use strict";var t,i,n=[],a={},o={acceptHeader:null,validMethods:["POST"],method:"POST",contentType:"application/x-www-form-urlencoded",maxConnections:3,customHeaders:{},endpointStore:{},paramsStore:{},mandatedParams:{},allowXRequestedWithAndCacheControl:true,successfulResponseCodes:{DELETE:[200,202,204],POST:[200,204],GET:[200]},cors:{expected:false,sendCredentials:false},log:function(e,t){},onSend:function(e){},onComplete:function(e,t,i){},onProgress:null};qq.extend(o,e);t=o.log;if(qq.indexOf(o.validMethods,o.method)<0){throw new Error("'"+o.method+"' is not a supported method for this type of request!")}function s(){return qq.indexOf(["GET","POST","HEAD"],o.method)>=0}function r(e){var t=false;qq.each(t,function(e,i){if(qq.indexOf(["Accept","Accept-Language","Content-Language","Content-Type"],i)<0){t=true;return false}});return t}function l(e){return o.cors.expected&&e.withCredentials===undefined}function d(){var e;if(window.XMLHttpRequest||window.ActiveXObject){e=qq.createXhrInstance();if(e.withCredentials===undefined){e=new XDomainRequest}}return e}function u(e,t){var i=a[e].xhr;if(!i){if(t){i=t}else{if(o.cors.expected){i=d()}else{i=qq.createXhrInstance()}}a[e].xhr=i}return i}function c(e){var t=qq.indexOf(n,e),i=o.maxConnections,s;delete a[e];n.splice(t,1);if(n.length>=i&&t<i){s=n[i-1];g(s)}}function f(e,i){var n=u(e),a=o.method,s=i===true;c(e);if(s){t(a+" request for "+e+" has failed","error")}else if(!l(n)&&!q(n.status)){s=true;t(a+" request for "+e+" has failed - response code "+n.status,"error")}o.onComplete(e,n,s)}function p(e){var t=a[e].additionalParams,i=o.mandatedParams,n;if(o.paramsStore.get){n=o.paramsStore.get(e)}if(t){qq.each(t,function(e,t){n=n||{};n[e]=t})}if(i){qq.each(i,function(e,t){n=n||{};n[e]=t})}return n}function g(e,n){var s=u(e,n),r=o.method,d=p(e),c=a[e].payload,f;o.onSend(e);f=h(e,d);if(l(s)){s.onload=v(e);s.onerror=E(e)}else{s.onreadystatechange=m(e)}_(e);s.open(r,f,true);if(o.cors.expected&&o.cors.sendCredentials&&!l(s)){s.withCredentials=true}C(e);t("Sending "+r+" request for "+e);if(c){s.send(c)}else if(i||!d){s.send()}else if(d&&o.contentType&&o.contentType.toLowerCase().indexOf("application/x-www-form-urlencoded")>=0){s.send(qq.obj2url(d,""))}else if(d&&o.contentType&&o.contentType.toLowerCase().indexOf("application/json")>=0){s.send(JSON.stringify(d))}else{s.send(d)}return s}function h(e,t){var n=o.endpointStore.get(e),s=a[e].addToPath;if(s!=undefined){n+="/"+s}if(i&&t){return qq.obj2url(t,n)}else{return n}}function m(e){return function(){if(u(e).readyState===4){f(e)}}}function _(e){var t=o.onProgress;if(t){u(e).upload.onprogress=function(i){if(i.lengthComputable){t(e,i.loaded,i.total)}}}}function v(e){return function(){f(e)}}function E(e){return function(){f(e,true)}}function C(e){var t=u(e),i=o.customHeaders,n=a[e].additionalHeaders||{},d=o.method,c={};if(!l(t)){o.acceptHeader&&t.setRequestHeader("Accept",o.acceptHeader);if(o.allowXRequestedWithAndCacheControl){if(!o.cors.expected||(!s()||r(i))){t.setRequestHeader("X-Requested-With","XMLHttpRequest");t.setRequestHeader("Cache-Control","no-cache")}}if(o.contentType&&(d==="POST"||d==="PUT")){t.setRequestHeader("Content-Type",o.contentType)}qq.extend(c,qq.isFunction(i)?i(e):i);qq.extend(c,n);qq.each(c,function(e,i){t.setRequestHeader(e,i)})}}function q(e){return qq.indexOf(o.successfulResponseCodes[o.method],e)>=0}function b(e,t,i,s,r,l){a[e]={addToPath:i,additionalParams:s,additionalHeaders:r,payload:l};var d=n.push(e);if(d<=o.maxConnections){return g(e,t)}}i=o.method==="GET"||o.method==="DELETE";qq.extend(this,{initTransport:function(e){var t,i,n,a,s;return{withPath:function(e){t=e;return this},withParams:function(e){i=e;return this},withHeaders:function(e){n=e;return this},withPayload:function(e){a=e;return this},withCacheBuster:function(){s=true;return this},send:function(r){if(s&&qq.indexOf(["GET","DELETE"],o.method)>=0){i.qqtimestamp=(new Date).getTime()}return b(e,r,t,i,n,a)}}},canceled:function(e){c(e)}})};qq.UploadHandler=function(e){"use strict";var t=e.proxy,i={},n=t.onCancel,a=t.getName;qq.extend(this,{add:function(e,t){i[e]=t;i[e].temp={}},cancel:function(e){var t=this,o=new qq.Promise,s=n(e,a(e),o);s.then(function(){if(t.isValid(e)){i[e].canceled=true;t.expunge(e)}o.success()})},expunge:function(e){delete i[e]},getThirdPartyFileId:function(e){return i[e].key},isValid:function(e){return i[e]!==undefined},reset:function(){i={}},_getFileState:function(e){return i[e]},_setThirdPartyFileId:function(e,t){i[e].key=t},_wasCanceled:function(e){return!!i[e].canceled}})};qq.UploadHandlerController=function(e,t){"use strict";var i=this,n=false,a=false,o,s,r,l,d={paramsStore:{},maxConnections:3,chunking:{enabled:false,multiple:{enabled:false}},log:function(e,t){},onProgress:function(e,t,i,n){},onComplete:function(e,t,i,n){},onCancel:function(e,t){},onUploadPrep:function(e){},onUpload:function(e,t){},onUploadChunk:function(e,t,i){},onUploadChunkSuccess:function(e,t,i,n){},onAutoRetry:function(e,t,i,n){},onResume:function(e,t,i){},onUuidChanged:function(e,t){},getName:function(e){},setSize:function(e,t){},isQueued:function(e){},getIdsInProxyGroup:function(e){},getIdsInBatch:function(e){}},u={done:function(e,t,i,n){var a=l._getChunkData(e,t);l._getFileState(e).attemptingResume=false;delete l._getFileState(e).temp.chunkProgress[t];l._getFileState(e).loaded+=a.size;d.onUploadChunkSuccess(e,l._getChunkDataForCallback(a),i,n)},finalize:function(e){var t=d.getSize(e),i=d.getName(e);r("All chunks have been uploaded for "+e+" - finalizing....");l.finalizeChunks(e).then(function(n,a){r("Finalize successful for "+e);var o=p.normalizeResponse(n,true);d.onProgress(e,i,t,t);l._maybeDeletePersistedChunkData(e);p.cleanup(e,o,a)},function(t,n){var a=p.normalizeResponse(t,false);r("Problem finalizing chunks for file ID "+e+" - "+a.error,"error");if(a.reset){u.reset(e)}if(!d.onAutoRetry(e,i,a,n)){p.cleanup(e,a,n)}})},hasMoreParts:function(e){return!!l._getFileState(e).chunking.remaining.length},nextPart:function(e){var t=l._getFileState(e).chunking.remaining.shift();if(t>=l._getTotalChunks(e)){t=null}return t},reset:function(e){r("Server or callback has ordered chunking effort to be restarted on next attempt for item ID "+e,"error");l._maybeDeletePersistedChunkData(e);l.reevaluateChunking(e);l._getFileState(e).loaded=0},sendNext:function(e){var t=d.getSize(e),i=d.getName(e),n=u.nextPart(e),o=l._getChunkData(e,n),s=l._getFileState(e).attemptingResume,f=l._getFileState(e).chunking.inProgress||[];if(l._getFileState(e).loaded==null){l._getFileState(e).loaded=0}if(s&&d.onResume(e,i,o)===false){u.reset(e);n=u.nextPart(e);o=l._getChunkData(e,n);s=false}if(n==null&&f.length===0){u.finalize(e)}else{r("Sending chunked upload request for item "+e+": bytes "+(o.start+1)+"-"+o.end+" of "+t);d.onUploadChunk(e,i,l._getChunkDataForCallback(o))
;f.push(n);l._getFileState(e).chunking.inProgress=f;if(a){c.open(e,n)}if(a&&c.available()&&l._getFileState(e).chunking.remaining.length){u.sendNext(e)}l.uploadChunk(e,n,s).then(function t(i,a){r("Chunked upload request succeeded for "+e+", chunk "+n);l.clearCachedChunk(e,n);var o=l._getFileState(e).chunking.inProgress||[],s=p.normalizeResponse(i,true),d=qq.indexOf(o,n);r(qq.format("Chunk {} for file {} uploaded successfully.",n,e));u.done(e,n,s,a);if(d>=0){o.splice(d,1)}l._maybePersistChunkedState(e);if(!u.hasMoreParts(e)&&o.length===0){u.finalize(e)}else if(u.hasMoreParts(e)){u.sendNext(e)}},function t(o,s){r("Chunked upload request failed for "+e+", chunk "+n);l.clearCachedChunk(e,n);var f=p.normalizeResponse(o,false);if(f.reset){u.reset(e)}else{var g=qq.indexOf(l._getFileState(e).chunking.inProgress,n);if(g>=0){l._getFileState(e).chunking.inProgress.splice(g,1);l._getFileState(e).chunking.remaining.unshift(n)}}if(!l._getFileState(e).temp.ignoreFailure){if(a){l._getFileState(e).temp.ignoreFailure=true;qq.each(l._getXhrs(e),function(e,t){t.abort()});l.moveInProgressToRemaining(e);c.free(e,true)}if(!d.onAutoRetry(e,i,f,s)){p.cleanup(e,f,s)}}}).done(function(){l.clearXhr(e,n)})}}},c={_open:[],_openChunks:{},_waiting:[],available:function(){var e=d.maxConnections,t=0,i=0;qq.each(c._openChunks,function(e,n){t++;i+=n.length});return e-(c._open.length-t+i)},free:function(e,t){var i=!t,n=qq.indexOf(c._waiting,e),a=qq.indexOf(c._open,e),o;delete c._openChunks[e];if(p.getProxyOrBlob(e)instanceof qq.BlobProxy){r("Generated blob upload has ended for "+e+", disposing generated blob.");delete l._getFileState(e).file}if(n>=0){c._waiting.splice(n,1)}else if(i&&a>=0){c._open.splice(a,1);o=c._waiting.shift();if(o>=0){c._open.push(o);p.start(o)}}},getWaitingOrConnected:function(){var e=[];qq.each(c._openChunks,function(t,i){if(i&&i.length){e.push(parseInt(t))}});qq.each(c._open,function(t,i){if(!c._openChunks[i]){e.push(parseInt(i))}});e=e.concat(c._waiting);return e},isUsingConnection:function(e){return qq.indexOf(c._open,e)>=0},open:function(e,t){if(t==null){c._waiting.push(e)}if(c.available()){if(t==null){c._waiting.pop();c._open.push(e)}else{(function(){var i=c._openChunks[e]||[];i.push(t);c._openChunks[e]=i})()}return true}return false},reset:function(){c._waiting=[];c._open=[]}},f={send:function(e,t){l._getFileState(e).loaded=0;r("Sending simple upload request for "+e);l.uploadFile(e).then(function(i,n){r("Simple upload request succeeded for "+e);var a=p.normalizeResponse(i,true);var o=d.getSize(e);d.onProgress(e,t,o,o);p.maybeNewUuid(e,a);p.cleanup(e,a,n)},function(i,n){r("Simple upload request failed for "+e);var a=p.normalizeResponse(i,false);if(!d.onAutoRetry(e,t,a,n)){p.cleanup(e,a,n)}})}},p={cancel:function(e){r("Cancelling "+e);d.paramsStore.remove(e);c.free(e)},cleanup:function(e,t,i){var n=d.getName(e);d.onComplete(e,n,t,i);if(l._getFileState(e)){l._clearXhrs&&l._clearXhrs(e)}c.free(e)},getProxyOrBlob:function(e){return l.getProxy&&l.getProxy(e)||l.getFile&&l.getFile(e)},initHandler:function(){var e=t?qq[t]:qq.traditional,i=qq.supportedFeatures.ajaxUploading?"Xhr":"Form";l=new e[i+"UploadHandler"](d,{getDataByUuid:d.getDataByUuid,getName:d.getName,getSize:d.getSize,getUuid:d.getUuid,log:r,onCancel:d.onCancel,onProgress:d.onProgress,onUuidChanged:d.onUuidChanged});if(l._removeExpiredChunkingRecords){l._removeExpiredChunkingRecords()}},isDeferredEligibleForUpload:function(e){return d.isQueued(e)},maybeDefer:function(e,t){if(t&&!l.getFile(e)&&t instanceof qq.BlobProxy){d.onUploadPrep(e);r("Attempting to generate a blob on-demand for "+e);t.create().then(function(t){r("Generated an on-demand blob for "+e);l.updateBlob(e,t);d.setSize(e,t.size);l.reevaluateChunking(e);p.maybeSendDeferredFiles(e)},function(t){var i={};if(t){i.error=t}r(qq.format("Failed to generate blob for ID {}.  Error message: {}.",e,t),"error");d.onComplete(e,d.getName(e),qq.extend(i,s),null);p.maybeSendDeferredFiles(e);c.free(e)})}else{return p.maybeSendDeferredFiles(e)}return false},maybeSendDeferredFiles:function(e){var t=d.getIdsInProxyGroup(e),i=false;if(t&&t.length){r("Maybe ready to upload proxy group file "+e);qq.each(t,function(t,n){if(p.isDeferredEligibleForUpload(n)&&!!l.getFile(n)){i=n===e;p.now(n)}else if(p.isDeferredEligibleForUpload(n)){return false}})}else{i=true;p.now(e)}return i},maybeNewUuid:function(e,t){if(t.newUuid!==undefined){d.onUuidChanged(e,t.newUuid)}},normalizeResponse:function(e,t){var i=e;if(!qq.isObject(e)){i={};if(qq.isString(e)&&!t){i.error=e}}i.success=t;return i},now:function(e){var t=d.getName(e);if(!i.isValid(e)){throw new qq.Error(e+" is not a valid file ID to upload!")}d.onUpload(e,t);if(n&&l._shouldChunkThisFile(e)){u.sendNext(e)}else{f.send(e,t)}},start:function(e){var t=p.getProxyOrBlob(e);if(t){return p.maybeDefer(e,t)}else{p.now(e);return true}}};qq.extend(this,{add:function(e,t){l.add.apply(this,arguments)},upload:function(e){if(c.open(e)){return p.start(e)}return false},retry:function(e){if(a){l._getFileState(e).temp.ignoreFailure=false}if(c.isUsingConnection(e)){return p.start(e)}else{return i.upload(e)}},cancel:function(e){var t=l.cancel(e);if(qq.isGenericPromise(t)){t.then(function(){p.cancel(e)})}else if(t!==false){p.cancel(e)}},cancelAll:function(){var e=c.getWaitingOrConnected();if(e.length){for(var t=e.length-1;t>=0;t--){i.cancel(e[t])}}c.reset()},getFile:function(e){if(l.getProxy&&l.getProxy(e)){return l.getProxy(e).referenceBlob}return l.getFile&&l.getFile(e)},isProxied:function(e){return!!(l.getProxy&&l.getProxy(e))},getInput:function(e){if(l.getInput){return l.getInput(e)}},reset:function(){r("Resetting upload handler");i.cancelAll();c.reset();l.reset()},expunge:function(e){if(i.isValid(e)){return l.expunge(e)}},isValid:function(e){return l.isValid(e)},getResumableFilesData:function(){if(l.getResumableFilesData){return l.getResumableFilesData()}return[]},getThirdPartyFileId:function(e){if(i.isValid(e)){return l.getThirdPartyFileId(e)}},pause:function(e){if(i.isResumable(e)&&l.pause&&i.isValid(e)&&l.pause(e)){c.free(e);l.moveInProgressToRemaining(e);return true}return false},isResumable:function(e){return!!l.isResumable&&l.isResumable(e)}});qq.extend(d,e);r=d.log;n=d.chunking.enabled&&qq.supportedFeatures.chunking;a=n&&d.chunking.concurrent.enabled;s=function(){var e={};e[d.preventRetryParam]=true;return e}();p.initHandler()};qq.FormUploadHandler=function(e){"use strict";var t=e.options,i=this,n=e.proxy,a=qq.getUniqueId(),o={},s={},r={},l=t.isCors,d=t.inputName,u=n.getUuid,c=n.log,f=new qq.WindowReceiveMessage({log:c});function p(e){delete s[e];if(l){clearTimeout(r[e]);delete r[e];f.stopReceivingMessages(e)}var t=document.getElementById(i._getIframeName(e));if(t){t.setAttribute("src","javascript:false;");qq(t).remove()}}function g(e){return e.split("_")[0]}function h(e){var t=qq.toElement("<iframe src='javascript:false;' name='"+e+"' />");t.setAttribute("id",e);t.style.display="none";document.body.appendChild(t);return t}function m(e,t){var n=e.id,a=g(n),l=u(a);o[l]=t;s[a]=qq(e).attach("load",function(){if(i.getInput(a)){c("Received iframe load event for CORS upload request (iframe name "+n+")");r[n]=setTimeout(function(){var e="No valid message received from loaded iframe for iframe name "+n;c(e,"error");t({error:e})},1e3)}});f.receiveMessage(n,function(e){c("Received the following window message: '"+e+"'");var t=g(n),a=i._parseJsonResponse(t,e),s=a.uuid,l;if(s&&o[s]){c("Handling response for iframe name "+n);clearTimeout(r[n]);delete r[n];i._detachLoadEvent(n);l=o[s];delete o[s];f.stopReceivingMessages(n);l(a)}else if(!s){c("'"+e+"' does not contain a UUID - ignoring.")}})}qq.extend(this,new qq.UploadHandler(e));qq.override(this,function(e){return{add:function(t,i){e.add(t,{input:i});i.setAttribute("name",d);if(i.parentNode){qq(i).remove()}},expunge:function(t){p(t);e.expunge(t)},isValid:function(t){return e.isValid(t)&&i._getFileState(t).input!==undefined}}});qq.extend(this,{_attachLoadEvent:function(e,t){var i;if(l){m(e,t)}else{s[e.id]=qq(e).attach("load",function(){c("Received response for "+e.id);if(!e.parentNode){return}try{if(e.contentDocument&&e.contentDocument.body&&e.contentDocument.body.innerHTML=="false"){return}}catch(e){c("Error when attempting to access iframe during handling of upload response ("+e.message+")","error");i={success:false}}t(i)})}},_createIframe:function(e){var t=i._getIframeName(e);return h(t)},_detachLoadEvent:function(e){if(s[e]!==undefined){s[e]();delete s[e]}},_getIframeName:function(e){return e+"_"+a},getInput:function(e){return i._getFileState(e).input},_initFormForUpload:function(e){var t=e.method,i=e.endpoint,n=e.params,a=e.paramsInBody,o=e.targetName,s=qq.toElement("<form method='"+t+"' enctype='multipart/form-data'></form>"),r=i;if(a){qq.obj2Inputs(n,s)}else{r=qq.obj2url(n,i)}s.setAttribute("action",r);s.setAttribute("target",o);s.style.display="none";document.body.appendChild(s);return s}})};qq.XhrUploadHandler=function(e){"use strict";var t=this,i=e.options.namespace,n=e.proxy,a=e.options.chunking,o=e.options.resume,s=a&&e.options.chunking.enabled&&qq.supportedFeatures.chunking,r=o&&e.options.resume.enabled&&s&&qq.supportedFeatures.resume,l=n.getName,d=n.getSize,u=n.getUuid,c=n.getEndpoint,f=n.getDataByUuid,p=n.onUuidChanged,g=n.onProgress,h=n.log;function m(e){qq.each(t._getXhrs(e),function(i,n){var a=t._getAjaxRequester(e,i);n.onreadystatechange=null;n.upload.onprogress=null;n.abort();a&&a.canceled&&a.canceled(e)})}qq.extend(this,new qq.UploadHandler(e));qq.override(this,function(e){return{add:function(i,n){if(qq.isFile(n)||qq.isBlob(n)){e.add(i,{file:n})}else if(n instanceof qq.BlobProxy){e.add(i,{proxy:n})}else{throw new Error("Passed obj is not a File, Blob, or proxy")}t._initTempState(i);r&&t._maybePrepareForResume(i)},expunge:function(i){m(i);t._maybeDeletePersistedChunkData(i);t._clearXhrs(i);e.expunge(i)}}});qq.extend(this,{clearCachedChunk:function(e,i){delete t._getFileState(e).temp.cachedChunks[i]},clearXhr:function(e,i){var n=t._getFileState(e).temp;if(n.xhrs){delete n.xhrs[i]}if(n.ajaxRequesters){delete n.ajaxRequesters[i]}},finalizeChunks:function(e,i){var n=t._getTotalChunks(e)-1,a=t._getXhr(e,n);if(i){return(new qq.Promise).success(i(a),a)}return(new qq.Promise).success({},a)},getFile:function(e){return t.isValid(e)&&t._getFileState(e).file},getProxy:function(e){return t.isValid(e)&&t._getFileState(e).proxy},getResumableFilesData:function(){var e=[];t._iterateResumeRecords(function(i,n){t.moveInProgressToRemaining(null,n.chunking.inProgress,n.chunking.remaining);var a={name:n.name,remaining:n.chunking.remaining,size:n.size,uuid:n.uuid};if(n.key){a.key=n.key}e.push(a)});return e},isResumable:function(e){return!!a&&t.isValid(e)&&!t._getFileState(e).notResumable},moveInProgressToRemaining:function(e,i,n){var a=i||t._getFileState(e).chunking.inProgress,o=n||t._getFileState(e).chunking.remaining;if(a){a.reverse();qq.each(a,function(e,t){o.unshift(t)});a.length=0}},pause:function(e){if(t.isValid(e)){h(qq.format("Aborting XHR upload for {} '{}' due to pause instruction.",e,l(e)));t._getFileState(e).paused=true;m(e);return true}},reevaluateChunking:function(e){if(a&&t.isValid(e)){var i=t._getFileState(e),n;delete i.chunking;i.chunking={};n=t._getTotalChunks(e);if(n>1){i.chunking.enabled=true;i.chunking.parts=n;i.chunking.remaining=[];for(var o=0;o<n;o++){i.chunking.remaining.push(o)}t._initTempState(e)}else{i.chunking.enabled=false}}},updateBlob:function(e,i){if(t.isValid(e)){t._getFileState(e).file=i}},_clearXhrs:function(e){var i=t._getFileState(e).temp;qq.each(i.ajaxRequesters,function(e){delete i.ajaxRequesters[e]});qq.each(i.xhrs,function(e){delete i.xhrs[e]})},_createXhr:function(e,i){return t._registerXhr(e,i,qq.createXhrInstance())},_getAjaxRequester:function(e,i){var n=i==null?-1:i;return t._getFileState(e).temp.ajaxRequesters[n]},_getChunkData:function(e,i){var n=a.partSize,o=d(e),s=t.getFile(e),r=n*i,l=r+n>=o?o:r+n,u=t._getTotalChunks(e),c=this._getFileState(e).temp.cachedChunks,f=c[i]||qq.sliceBlob(s,r,l);c[i]=f;return{part:i,start:r,end:l,count:u,blob:f,size:l-r}},_getChunkDataForCallback:function(e){return{partIndex:e.part,startByte:e.start+1,endByte:e.end,totalParts:e.count}},_getLocalStorageId:function(e){var t="5.0",n=l(e),o=d(e),s=a.partSize,r=c(e);return qq.format("qq{}resume{}-{}-{}-{}-{}",i,t,n,o,s,r)},_getMimeType:function(e){return t.getFile(e).type},_getPersistableData:function(e){return t._getFileState(e).chunking},_getTotalChunks:function(e){if(a){var t=d(e),i=a.partSize;return Math.ceil(t/i)}},_getXhr:function(e,i){var n=i==null?-1:i;return t._getFileState(e).temp.xhrs[n]},_getXhrs:function(e){return t._getFileState(e).temp.xhrs},_iterateResumeRecords:function(e){if(r){qq.each(localStorage,function(t,n){if(t.indexOf(qq.format("qq{}resume-",i))===0){var a=JSON.parse(n);e(t,a)}})}},_initTempState:function(e){t._getFileState(e).temp={ajaxRequesters:{},chunkProgress:{},xhrs:{},cachedChunks:{}}},_markNotResumable:function(e){t._getFileState(e).notResumable=true},_maybeDeletePersistedChunkData:function(e){var i;if(r&&t.isResumable(e)){i=t._getLocalStorageId(e);if(i&&localStorage.getItem(i)){localStorage.removeItem(i);return true}}return false},_maybePrepareForResume:function(e){var i=t._getFileState(e),n,a;if(r&&i.key===undefined){n=t._getLocalStorageId(e);a=localStorage.getItem(n);if(a){a=JSON.parse(a);if(f(a.uuid)){t._markNotResumable(e)}else{h(qq.format("Identified file with ID {} and name of {} as resumable.",e,l(e)));p(e,a.uuid);i.key=a.key;i.chunking=a.chunking;i.loaded=a.loaded;i.attemptingResume=true;t.moveInProgressToRemaining(e)}}}},_maybePersistChunkedState:function(e){var i=t._getFileState(e),n,a;if(r&&t.isResumable(e)){n=t._getLocalStorageId(e);a={name:l(e),size:d(e),uuid:u(e),key:i.key,chunking:i.chunking,loaded:i.loaded,lastUpdated:Date.now()};localStorage.setItem(n,JSON.stringify(a))}},_registerProgressHandler:function(e,i,n){var a=t._getXhr(e,i),o=l(e),s={simple:function(t,i){var n=d(e);if(t===i){g(e,o,n,n)}else{g(e,o,t>=n?n-1:t,n)}},chunked:function(a,s){var r=t._getFileState(e).temp.chunkProgress,l=t._getFileState(e).loaded,u=a,c=s,f=d(e),p=u-(c-n),h=l;r[i]=p;qq.each(r,function(e,t){h+=t});g(e,o,h,f)}};a.upload.onprogress=function(e){if(e.lengthComputable){var t=n==null?"simple":"chunked";s[t](e.loaded,e.total)}}},_registerXhr:function(e,i,n,a){var o=i==null?-1:i,s=t._getFileState(e).temp;s.xhrs=s.xhrs||{};s.ajaxRequesters=s.ajaxRequesters||{};s.xhrs[o]=n;if(a){s.ajaxRequesters[o]=a}return n},_removeExpiredChunkingRecords:function(){var e=o.recordsExpireIn;t._iterateResumeRecords(function(t,i){var n=new Date(i.lastUpdated);n.setDate(n.getDate()+e);if(n.getTime()<=Date.now()){h("Removing expired resume record with key "+t);localStorage.removeItem(t)}})},_shouldChunkThisFile:function(e){var i=t._getFileState(e);if(!i.chunking){t.reevaluateChunking(e)}return i.chunking.enabled}})};qq.WindowReceiveMessage=function(e){"use strict";var t={log:function(e,t){}},i={};qq.extend(t,e);qq.extend(this,{receiveMessage:function(e,t){var n=function(e){t(e.data)};if(window.postMessage){i[e]=qq(window).attach("message",n)}else{log("iframe message passing not supported in this browser!","error")}},stopReceivingMessages:function(e){if(window.postMessage){var t=i[e];if(t){t()}}}})};(function(){"use strict";qq.uiPublicApi={clearStoredFiles:function(){this._parent.prototype.clearStoredFiles.apply(this,arguments);this._templating.clearFiles()},addExtraDropzone:function(e){this._dnd&&this._dnd.setupExtraDropzone(e)},removeExtraDropzone:function(e){if(this._dnd){return this._dnd.removeDropzone(e)}},getItemByFileId:function(e){return this._templating.getFileContainer(e)},reset:function(){this._parent.prototype.reset.apply(this,arguments);this._templating.reset();if(!this._options.button&&this._templating.getButton()){this._defaultButtonId=this._createUploadButton({element:this._templating.getButton()}).getButtonId()}if(this._dnd){this._dnd.dispose();this._dnd=this._setupDragAndDrop()}this._totalFilesInBatch=0;this._filesInBatchAddedToUi=0;this._setupClickAndEditEventHandlers()},setName:function(e,t){var i=this._options.formatFileName(t);this._parent.prototype.setName.apply(this,arguments);this._templating.updateFilename(e,i)},pauseUpload:function(e){var t=this._parent.prototype.pauseUpload.apply(this,arguments);t&&this._templating.uploadPaused(e);return t},continueUpload:function(e){var t=this._parent.prototype.continueUpload.apply(this,arguments);t&&this._templating.uploadContinued(e);return t},getId:function(e){return this._templating.getFileId(e)},getDropTarget:function(e){var t=this.getFile(e);return t.qqDropTarget}};qq.uiPrivateApi={_getButton:function(e){var t=this._parent.prototype._getButton.apply(this,arguments);if(!t){if(e===this._defaultButtonId){t=this._templating.getButton()}}return t},_removeFileItem:function(e){this._templating.removeFile(e)},_setupClickAndEditEventHandlers:function(){this._fileButtonsClickHandler=qq.FileButtonsClickHandler&&this._bindFileButtonsClickEvent();this._focusinEventSupported=!qq.firefox();if(this._isEditFilenameEnabled()){this._filenameClickHandler=this._bindFilenameClickEvent();this._filenameInputFocusInHandler=this._bindFilenameInputFocusInEvent();this._filenameInputFocusHandler=this._bindFilenameInputFocusEvent()}},_setupDragAndDrop:function(){var e=this,t=this._options.dragAndDrop.extraDropzones,i=this._templating,n=i.getDropZone();n&&t.push(n);return new qq.DragAndDrop({dropZoneElements:t,allowMultipleItems:this._options.multiple,classes:{dropActive:this._options.classes.dropActive},callbacks:{processingDroppedFiles:function(){i.showDropProcessing()},processingDroppedFilesComplete:function(t,n){i.hideDropProcessing();qq.each(t,function(e,t){t.qqDropTarget=n});if(t.length){e.addFiles(t,null,null)}},dropError:function(t,i){e._itemError(t,i)},dropLog:function(t,i){e.log(t,i)}}})},_bindFileButtonsClickEvent:function(){var e=this;return new qq.FileButtonsClickHandler({templating:this._templating,log:function(t,i){e.log(t,i)},onDeleteFile:function(t){e.deleteFile(t)},onCancel:function(t){e.cancel(t)},onRetry:function(t){qq(e._templating.getFileContainer(t)).removeClass(e._classes.retryable);e._templating.hideRetry(t);e.retry(t)},onPause:function(t){e.pauseUpload(t)},onContinue:function(t){e.continueUpload(t)},onGetName:function(t){return e.getName(t)}})},_isEditFilenameEnabled:function(){return this._templating.isEditFilenamePossible()&&!this._options.autoUpload&&qq.FilenameClickHandler&&qq.FilenameInputFocusHandler&&qq.FilenameInputFocusHandler},_filenameEditHandler:function(){var e=this,t=this._templating;return{templating:t,log:function(t,i){e.log(t,i)},onGetUploadStatus:function(t){return e.getUploads({id:t}).status},onGetName:function(t){return e.getName(t)},onSetName:function(t,i){e.setName(t,i)},onEditingStatusChange:function(e,i){var n=qq(t.getEditInput(e)),a=qq(t.getFileContainer(e));if(i){n.addClass("qq-editing");t.hideFilename(e);t.hideEditIcon(e)}else{n.removeClass("qq-editing");t.showFilename(e);t.showEditIcon(e)}a.addClass("qq-temp").removeClass("qq-temp")}}},_onUploadStatusChange:function(e,t,i){this._parent.prototype._onUploadStatusChange.apply(this,arguments);if(this._isEditFilenameEnabled()){if(this._templating.getFileContainer(e)&&i!==qq.status.SUBMITTED){this._templating.markFilenameEditable(e);this._templating.hideEditIcon(e)}}},_bindFilenameInputFocusInEvent:function(){var e=qq.extend({},this._filenameEditHandler());return new qq.FilenameInputFocusInHandler(e)},_bindFilenameInputFocusEvent:function(){var e=qq.extend({},this._filenameEditHandler());return new qq.FilenameInputFocusHandler(e)},_bindFilenameClickEvent:function(){var e=qq.extend({},this._filenameEditHandler());return new qq.FilenameClickHandler(e)},_storeForLater:function(e){this._parent.prototype._storeForLater.apply(this,arguments);this._templating.hideSpinner(e)},_onAllComplete:function(e,t){this._parent.prototype._onAllComplete.apply(this,arguments);this._templating.resetTotalProgress()},_onSubmit:function(e,t){var i=this.getFile(e);if(i&&i.qqPath&&this._options.dragAndDrop.reportDirectoryPaths){this._paramsStore.addReadOnly(e,{qqpath:i.qqPath})}this._parent.prototype._onSubmit.apply(this,arguments);this._addToList(e,t)},_onSubmitted:function(e){if(this._isEditFilenameEnabled()){this._templating.markFilenameEditable(e);this._templating.showEditIcon(e);if(!this._focusinEventSupported){this._filenameInputFocusHandler.addHandler(this._templating.getEditInput(e))}}},_onProgress:function(e,t,i,n){this._parent.prototype._onProgress.apply(this,arguments);this._templating.updateProgress(e,i,n);if(Math.round(i/n*100)===100){this._templating.hideCancel(e);this._templating.hidePause(e);this._templating.hideProgress(e);this._templating.setStatusText(e,this._options.text.waitingForResponse);this._displayFileSize(e)}else{this._displayFileSize(e,i,n)}},_onTotalProgress:function(e,t){this._parent.prototype._onTotalProgress.apply(this,arguments);this._templating.updateTotalProgress(e,t)},_onComplete:function(e,t,i,n){var a=this._parent.prototype._onComplete.apply(this,arguments),o=this._templating,s=o.getFileContainer(e),r=this;function l(t){if(!s){return}o.setStatusText(e);qq(s).removeClass(r._classes.retrying);o.hideProgress(e);if(!r._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading){o.hideCancel(e)}o.hideSpinner(e);if(t.success){r._markFileAsSuccessful(e)}else{qq(s).addClass(r._classes.fail);if(o.isRetryPossible()&&!r._preventRetries[e]){qq(s).addClass(r._classes.retryable);o.showRetry(e)}r._controlFailureTextDisplay(e,t)}}if(a instanceof qq.Promise){a.done(function(e){l(e)})}else{l(i)}return a},_markFileAsSuccessful:function(e){var t=this._templating;if(this._isDeletePossible()){t.showDeleteButton(e)}qq(t.getFileContainer(e)).addClass(this._classes.success);this._maybeUpdateThumbnail(e)},_onUploadPrep:function(e){this._parent.prototype._onUploadPrep.apply(this,arguments);this._templating.showSpinner(e)},_onUpload:function(e,t){var i=this._parent.prototype._onUpload.apply(this,arguments);this._templating.showSpinner(e);return i},_onUploadChunk:function(e,t){this._parent.prototype._onUploadChunk.apply(this,arguments);if(t.partIndex>0&&this._handler.isResumable(e)){this._templating.allowPause(e)}},_onCancel:function(e,t){this._parent.prototype._onCancel.apply(this,arguments);this._removeFileItem(e);if(this._getNotFinished()===0){this._templating.resetTotalProgress()}},_onBeforeAutoRetry:function(e){var t,i,n;this._parent.prototype._onBeforeAutoRetry.apply(this,arguments);this._showCancelLink(e);if(this._options.retry.showAutoRetryNote){t=this._autoRetries[e];i=this._options.retry.maxAutoAttempts;n=this._options.retry.autoRetryNote.replace(/\{retryNum\}/g,t);n=n.replace(/\{maxAuto\}/g,i);this._templating.setStatusText(e,n);qq(this._templating.getFileContainer(e)).addClass(this._classes.retrying)}},_onBeforeManualRetry:function(e){if(this._parent.prototype._onBeforeManualRetry.apply(this,arguments)){this._templating.resetProgress(e);qq(this._templating.getFileContainer(e)).removeClass(this._classes.fail);this._templating.setStatusText(e);this._templating.showSpinner(e);this._showCancelLink(e);return true}else{qq(this._templating.getFileContainer(e)).addClass(this._classes.retryable);this._templating.showRetry(e);return false}},_onSubmitDelete:function(e){var t=qq.bind(this._onSubmitDeleteSuccess,this);this._parent.prototype._onSubmitDelete.call(this,e,t)},_onSubmitDeleteSuccess:function(e,t,i){if(this._options.deleteFile.forceConfirm){this._showDeleteConfirm.apply(this,arguments)}else{this._sendDeleteRequest.apply(this,arguments)}},_onDeleteComplete:function(e,t,i){this._parent.prototype._onDeleteComplete.apply(this,arguments);this._templating.hideSpinner(e);if(i){this._templating.setStatusText(e,this._options.deleteFile.deletingFailedText);this._templating.showDeleteButton(e)}else{this._removeFileItem(e)}},_sendDeleteRequest:function(e,t,i){this._templating.hideDeleteButton(e);this._templating.showSpinner(e);this._templating.setStatusText(e,this._options.deleteFile.deletingStatusText);this._deleteHandler.sendDelete.apply(this,arguments)},_showDeleteConfirm:function(e,t,i){var n=this.getName(e),a=this._options.deleteFile.confirmMessage.replace(/\{filename\}/g,n),t=this.getUuid(e),o=arguments,s=this,r;r=this._options.showConfirm(a);if(qq.isGenericPromise(r)){r.then(function(){s._sendDeleteRequest.apply(s,o)})}else if(r!==false){s._sendDeleteRequest.apply(s,o)}},_addToList:function(e,t,i){var n,a=0,o=this._handler.isProxied(e)&&this._options.scaling.hideScaled;if(o){return}if(this._options.display.prependFiles){if(this._totalFilesInBatch>1&&this._filesInBatchAddedToUi>0){a=this._filesInBatchAddedToUi-1}n={index:a}}if(!i){if(this._options.disableCancelForFormUploads&&!qq.supportedFeatures.ajaxUploading){this._templating.disableCancel()}if(!this._options.multiple){this._handler.cancelAll();this._clearList()}}this._templating.addFile(e,this._options.formatFileName(t),n);if(i){this._thumbnailUrls[e]&&this._templating.updateThumbnail(e,this._thumbnailUrls[e],true)}else{this._templating.generatePreview(e,this.getFile(e))}this._filesInBatchAddedToUi+=1;if(i||this._options.display.fileSizeOnSubmit&&qq.supportedFeatures.ajaxUploading){this._displayFileSize(e)}},_clearList:function(){this._templating.clearFiles();this.clearStoredFiles()},_displayFileSize:function(e,t,i){var n=this.getSize(e),a=this._formatSize(n);if(n>=0){if(t!==undefined&&i!==undefined){a=this._formatProgress(t,i)}this._templating.updateSize(e,a)}},_formatProgress:function(e,t){var i=this._options.text.formatProgress;function n(e,t){i=i.replace(e,t)}n("{percent}",Math.round(e/t*100));n("{total_size}",this._formatSize(t));return i},_controlFailureTextDisplay:function(e,t){var i,n,a,o,s;i=this._options.failedUploadTextDisplay.mode;n=this._options.failedUploadTextDisplay.maxChars;a=this._options.failedUploadTextDisplay.responseProperty;if(i==="custom"){o=t[a];if(o){if(o.length>n){s=o.substring(0,n)+"..."}}else{o=this._options.text.failUpload}this._templating.setStatusText(e,s||o);if(this._options.failedUploadTextDisplay.enableTooltip){this._showTooltip(e,o)}}else if(i==="default"){this._templating.setStatusText(e,this._options.text.failUpload)}else if(i!=="none"){this.log("failedUploadTextDisplay.mode value of '"+i+"' is not valid","warn")}},_showTooltip:function(e,t){this._templating.getFileContainer(e).title=t},_showCancelLink:function(e){if(!this._options.disableCancelForFormUploads||qq.supportedFeatures.ajaxUploading){this._templating.showCancel(e)}},_itemError:function(e,t,i){var n=this._parent.prototype._itemError.apply(this,arguments);this._options.showMessage(n)},_batchError:function(e){this._parent.prototype._batchError.apply(this,arguments);this._options.showMessage(e)},_setupPastePrompt:function(){var e=this;this._options.callbacks.onPasteReceived=function(){var t=e._options.paste.namePromptMessage,i=e._options.paste.defaultName;return e._options.showPrompt(t,i)}},_fileOrBlobRejected:function(e,t){this._totalFilesInBatch-=1;this._parent.prototype._fileOrBlobRejected.apply(this,arguments)},_prepareItemsForUpload:function(e,t,i){this._totalFilesInBatch=e.length;this._filesInBatchAddedToUi=0;this._parent.prototype._prepareItemsForUpload.apply(this,arguments)},_maybeUpdateThumbnail:function(e){var t=this._thumbnailUrls[e];this._templating.updateThumbnail(e,t)},_addCannedFile:function(e){var t=this._parent.prototype._addCannedFile.apply(this,arguments);this._addToList(t,this.getName(t),true);this._templating.hideSpinner(t);this._templating.hideCancel(t);this._markFileAsSuccessful(t);return t},_setSize:function(e,t){this._parent.prototype._setSize.apply(this,arguments);this._templating.updateSize(e,this._formatSize(t))}}})();qq.FineUploader=function(e,t){"use strict";this._parent=t?qq[t].FineUploaderBasic:qq.FineUploaderBasic;this._parent.apply(this,arguments);qq.extend(this._options,{element:null,button:null,listElement:null,dragAndDrop:{extraDropzones:[],reportDirectoryPaths:false},text:{formatProgress:"{percent}% of {total_size}",failUpload:"Upload failed",waitingForResponse:"Processing...",paused:"Paused"},template:"qq-template",classes:{retrying:"qq-upload-retrying",retryable:"qq-upload-retryable",success:"qq-upload-success",fail:"qq-upload-fail",editable:"qq-editable",hide:"qq-hide",dropActive:"qq-upload-drop-area-active"},failedUploadTextDisplay:{mode:"default",maxChars:50,responseProperty:"error",enableTooltip:true},messages:{tooManyFilesError:"You may only drop one file",unsupportedBrowser:"Unrecoverable error - this browser does not permit file uploading of any kind."},retry:{showAutoRetryNote:true,autoRetryNote:"Retrying {retryNum}/{maxAuto}..."},deleteFile:{forceConfirm:false,confirmMessage:"Are you sure you want to delete {filename}?",deletingStatusText:"Deleting...",deletingFailedText:"Delete failed"},display:{fileSizeOnSubmit:false,prependFiles:false},paste:{promptForName:false,namePromptMessage:"Please name this image"},thumbnails:{placeholders:{waitUntilResponse:false,notAvailablePath:null,waitingPath:null}},scaling:{hideScaled:false},showMessage:function(e){setTimeout(function(){window.alert(e)},0)},showConfirm:function(e){return window.confirm(e)},showPrompt:function(e,t){return window.prompt(e,t)}},true);qq.extend(this._options,e,true);this._templating=new qq.Templating({log:qq.bind(this.log,this),templateIdOrEl:this._options.template,containerEl:this._options.element,fileContainerEl:this._options.listElement,button:this._options.button,imageGenerator:this._imageGenerator,classes:{hide:this._options.classes.hide,editable:this._options.classes.editable},placeholders:{waitUntilUpdate:this._options.thumbnails.placeholders.waitUntilResponse,thumbnailNotAvailable:this._options.thumbnails.placeholders.notAvailablePath,waitingForThumbnail:this._options.thumbnails.placeholders.waitingPath},text:this._options.text});if(!qq.supportedFeatures.uploading||this._options.cors.expected&&!qq.supportedFeatures.uploadCors){this._templating.renderFailure(this._options.messages.unsupportedBrowser)}else{this._wrapCallbacks();this._templating.render();this._classes=this._options.classes;if(!this._options.button&&this._templating.getButton()){this._defaultButtonId=this._createUploadButton({element:this._templating.getButton()}).getButtonId()}this._setupClickAndEditEventHandlers();if(qq.DragAndDrop&&qq.supportedFeatures.fileDrop){this._dnd=this._setupDragAndDrop()}if(this._options.paste.targetElement&&this._options.paste.promptForName){if(qq.PasteSupport){this._setupPastePrompt()}else{this.log("Paste support module not found.","error")}}this._totalFilesInBatch=0;this._filesInBatchAddedToUi=0}};qq.extend(qq.FineUploader.prototype,qq.basePublicApi);qq.extend(qq.FineUploader.prototype,qq.basePrivateApi);qq.extend(qq.FineUploader.prototype,qq.uiPublicApi);qq.extend(qq.FineUploader.prototype,qq.uiPrivateApi);qq.Templating=function(e){"use strict";var t="qq-file-id",i="qq-file-id-",n="qq-max-size",a="qq-server-scale",o="qq-hide-dropzone",s=false,r=-1,l={log:null,templateIdOrEl:"qq-template",containerEl:null,fileContainerEl:null,button:null,imageGenerator:null,classes:{hide:"qq-hide",editable:"qq-editable"},placeholders:{waitUntilUpdate:false,thumbnailNotAvailable:null,waitingForThumbnail:null},text:{paused:"Paused"}},d={button:"qq-upload-button-selector",drop:"qq-upload-drop-area-selector",list:"qq-upload-list-selector",progressBarContainer:"qq-progress-bar-container-selector",progressBar:"qq-progress-bar-selector",totalProgressBarContainer:"qq-total-progress-bar-container-selector",totalProgressBar:"qq-total-progress-bar-selector",file:"qq-upload-file-selector",spinner:"qq-upload-spinner-selector",size:"qq-upload-size-selector",cancel:"qq-upload-cancel-selector",pause:"qq-upload-pause-selector",continueButton:"qq-upload-continue-selector",deleteButton:"qq-upload-delete-selector",retry:"qq-upload-retry-selector",statusText:"qq-upload-status-text-selector",editFilenameInput:"qq-edit-filename-selector",
editNameIcon:"qq-edit-filename-icon-selector",dropProcessing:"qq-drop-processing-selector",dropProcessingSpinner:"qq-drop-processing-spinner-selector",thumbnail:"qq-thumbnail-selector"},u={},c=new qq.Promise,f=new qq.Promise,p,g,h,m,_,v,E,C;function q(){var e,t,i,s,u,c,f,m,_;p("Parsing template");if(l.templateIdOrEl==null){throw new Error("You MUST specify either a template element or ID!")}if(qq.isString(l.templateIdOrEl)){e=document.getElementById(l.templateIdOrEl);if(e===null){throw new Error(qq.format("Cannot find template script at ID '{}'!",l.templateIdOrEl))}t=e.innerHTML}else{if(l.templateIdOrEl.innerHTML===undefined){throw new Error("You have specified an invalid value for the template option!  "+"It must be an ID or an Element.")}t=l.templateIdOrEl.innerHTML}t=qq.trimStr(t);s=document.createElement("div");s.appendChild(qq.toElement(t));if(l.button){c=qq(s).getByClass(d.button)[0];if(c){qq(c).remove()}}if(!qq.DragAndDrop||!qq.supportedFeatures.fileDrop){_=qq(s).getByClass(d.dropProcessing)[0];if(_){qq(_).remove()}}f=qq(s).getByClass(d.drop)[0];if(f&&!qq.DragAndDrop){p("DnD module unavailable.","info");qq(f).remove()}if(f&&!qq.supportedFeatures.fileDrop&&qq(f).hasAttribute(o)){qq(f).css({display:"none"})}m=qq(s).getByClass(d.thumbnail)[0];if(!E){m&&qq(m).remove()}else if(m){r=parseInt(m.getAttribute(n));r=r>0?r:null;C=qq(m).hasAttribute(a)}E=E&&m;g=qq(s).getByClass(d.editFilenameInput).length>0;h=qq(s).getByClass(d.retry).length>0;i=qq(s).getByClass(d.list)[0];if(i==null){throw new Error("Could not find the file list container in the template!")}u=i.innerHTML;i.innerHTML="";p("Template parsing complete");return{template:qq.trimStr(s.innerHTML),fileTemplate:qq.trimStr(u)}}function b(e){return qq(v).getByClass(i+e)[0]}function y(e,t){return e&&qq(e).getByClass(t)[0]}function T(e,t){var i=v,n=i.firstChild;if(t>0){n=qq(i).children()[t].nextSibling}i.insertBefore(e,n)}function w(e){return y(b(e),d.cancel)}function R(e){return y(b(e),d.pause)}function A(e){return y(b(e),d.continueButton)}function S(e){if(e==null){return y(_,d.totalProgressBarContainer)||y(_,d.totalProgressBar)}return y(b(e),d.progressBarContainer)||y(b(e),d.progressBar)}function $(e){return y(b(e),d.spinner)}function x(e){return y(b(e),d.editNameIcon)}function k(e){return y(b(e),d.size)}function P(e){return y(b(e),d.deleteButton)}function M(e){return y(b(e),d.retry)}function D(e){return y(b(e),d.file)}function I(){return y(_,d.dropProcessing)}function L(e){return E&&y(b(e),d.thumbnail)}function F(e){e&&qq(e).addClass(l.classes.hide)}function Q(e){e&&qq(e).removeClass(l.classes.hide)}function N(e,t){var i=S(e),n=e==null?d.totalProgressBar:d.progressBar;if(i&&!qq(i).hasClass(n)){i=qq(i).getByClass(n)[0]}i&&qq(i).css({width:t+"%"})}function B(){var e=l.placeholders.thumbnailNotAvailable,t=l.placeholders.waitingForThumbnail,i={maxSize:r,scale:C};if(E){if(e){l.imageGenerator.generate(e,new Image,i).then(function(e){c.success(e)},function(){c.failure();p("Problem loading 'not available' placeholder image at "+e,"error")})}else{c.failure()}if(t){l.imageGenerator.generate(t,new Image,i).then(function(e){f.success(e)},function(){f.failure();p("Problem loading 'waiting for thumbnail' placeholder image at "+t,"error")})}else{f.failure()}}}function U(e){var t=new qq.Promise;f.then(function(i){z(i,e);if(!e.src){e.src=i.src;e.onload=function(){Q(e);t.success()}}else{t.success()}},function(){F(e);t.success()});return t}function O(e,t){var i=u[e]||(new qq.Promise).failure(),n=new qq.Promise;c.then(function(e){i.then(function(){n.success()},function(){z(e,t);t.onload=function(){n.success()};t.src=e.src;Q(t)})});return n}function z(e,t){var i=e.style.maxWidth,n=e.style.maxHeight;if(n&&i&&!t.style.maxWidth&&!t.style.maxHeight){qq(t).css({maxWidth:i,maxHeight:n})}}function V(e,t){var i=L(e),n=L(t);p(qq.format("ID {} is the same file as ID {}.  Will use generated thumbnail from ID {} instead.",e,t,t));u[t].then(function(){u[e].success();p(qq.format("Now using previously generated thumbnail created for ID {} on ID {}.",t,e));i.src=n.src;Q(i)},function(){u[e].failure();if(!l.placeholders.waitUntilUpdate){O(e,i)}})}function H(e,t,i){var n=L(e);p("Generating new thumbnail for "+e);t.qqThumbnailId=e;return l.imageGenerator.generate(t,n,i).then(function(){Q(n);u[e].success()},function(){u[e].failure();if(!l.placeholders.waitUntilUpdate){O(e,n)}})}qq.extend(l,e);p=l.log;_=l.containerEl;E=l.imageGenerator!==undefined;m=q();B();qq.extend(this,{render:function(){p("Rendering template in DOM.");_.innerHTML=m.template;F(I());this.hideTotalProgress();v=l.fileContainerEl||y(_,d.list);p("Template rendering complete")},renderFailure:function(e){var t=qq.toElement(e);_.innerHTML="";_.appendChild(t)},reset:function(){this.render()},clearFiles:function(){v.innerHTML=""},disableCancel:function(){s=true},addFile:function(e,n,a){var o=qq.toElement(m.fileTemplate),r=y(o,d.file);qq(o).addClass(i+e);r&&qq(r).setText(n);o.setAttribute(t,e);if(a){T(o,a.index)}else{v.appendChild(o)}F(S(e));F(k(e));F(P(e));F(M(e));F(R(e));F(A(e));if(s){this.hideCancel(e)}},removeFile:function(e){qq(b(e)).remove()},getFileId:function(e){var i=e;if(i){while(i.getAttribute(t)==null){i=i.parentNode}return parseInt(i.getAttribute(t))}},getFileList:function(){return v},markFilenameEditable:function(e){var t=D(e);t&&qq(t).addClass(l.classes.editable)},updateFilename:function(e,t){var i=D(e);i&&qq(i).setText(t)},hideFilename:function(e){F(D(e))},showFilename:function(e){Q(D(e))},isFileName:function(e){return qq(e).hasClass(d.file)},getButton:function(){return l.button||y(_,d.button)},hideDropProcessing:function(){F(I())},showDropProcessing:function(){Q(I())},getDropZone:function(){return y(_,d.drop)},isEditFilenamePossible:function(){return g},hideRetry:function(e){F(M(e))},isRetryPossible:function(){return h},showRetry:function(e){Q(M(e))},getFileContainer:function(e){return b(e)},showEditIcon:function(e){var t=x(e);t&&qq(t).addClass(l.classes.editable)},hideEditIcon:function(e){var t=x(e);t&&qq(t).removeClass(l.classes.editable)},isEditIcon:function(e){return qq(e).hasClass(d.editNameIcon)},getEditInput:function(e){return y(b(e),d.editFilenameInput)},isEditInput:function(e){return qq(e).hasClass(d.editFilenameInput)},updateProgress:function(e,t,i){var n=S(e),a;if(n){a=Math.round(t/i*100);if(a===100){F(n)}else{Q(n)}N(e,a)}},updateTotalProgress:function(e,t){this.updateProgress(null,e,t)},hideProgress:function(e){var t=S(e);t&&F(t)},hideTotalProgress:function(){this.hideProgress()},resetProgress:function(e){N(e,0)},resetTotalProgress:function(){this.resetProgress()},showCancel:function(e){if(!s){var t=w(e);t&&qq(t).removeClass(l.classes.hide)}},hideCancel:function(e){F(w(e))},isCancel:function(e){return qq(e).hasClass(d.cancel)},allowPause:function(e){Q(R(e));F(A(e))},uploadPaused:function(e){this.setStatusText(e,l.text.paused);this.allowContinueButton(e);F($(e))},hidePause:function(e){F(R(e))},isPause:function(e){return qq(e).hasClass(d.pause)},isContinueButton:function(e){return qq(e).hasClass(d.continueButton)},allowContinueButton:function(e){Q(A(e));F(R(e))},uploadContinued:function(e){this.setStatusText(e,"");this.allowPause(e);Q($(e))},showDeleteButton:function(e){Q(P(e))},hideDeleteButton:function(e){F(P(e))},isDeleteButton:function(e){return qq(e).hasClass(d.deleteButton)},isRetry:function(e){return qq(e).hasClass(d.retry)},updateSize:function(e,t){var i=k(e);if(i){Q(i);qq(i).setText(t)}},setStatusText:function(e,t){var i=y(b(e),d.statusText);if(i){if(t==null){qq(i).clearText()}else{qq(i).setText(t)}}},hideSpinner:function(e){F($(e))},showSpinner:function(e){Q($(e))},generatePreview:function(e,t){var i=t&&t.qqThumbnailId,n=L(e),a={maxSize:r,scale:true,orient:true};if(qq.supportedFeatures.imagePreviews){if(n){U(n).done(function(){u[e]=new qq.Promise;if(i!=null){V(e,i)}else{H(e,t,a)}})}}else if(n){U(n)}},updateThumbnail:function(e,t,i){var n=L(e),a={maxSize:r,scale:C};if(n){if(t){if(i){U(n)}return l.imageGenerator.generate(t,n,a).then(function(){Q(n)},function(){O(e,n)})}else{O(e,n)}}}})};qq.s3=qq.s3||{};qq.s3.util=qq.s3.util||function(){"use strict";return{AWS_PARAM_PREFIX:"x-amz-meta-",SESSION_TOKEN_PARAM_NAME:"x-amz-security-token",REDUCED_REDUNDANCY_PARAM_NAME:"x-amz-storage-class",REDUCED_REDUNDANCY_PARAM_VALUE:"REDUCED_REDUNDANCY",SERVER_SIDE_ENCRYPTION_PARAM_NAME:"x-amz-server-side-encryption",SERVER_SIDE_ENCRYPTION_PARAM_VALUE:"AES256",getBucket:function(e){var t=[/^(?:https?:\/\/)?([a-z0-9.\-_]+)\.s3(?:-[a-z0-9\-]+)?\.amazonaws\.com/i,/^(?:https?:\/\/)?s3(?:-[a-z0-9\-]+)?\.amazonaws\.com\/([a-z0-9.\-_]+)/i,/^(?:https?:\/\/)?([a-z0-9.\-_]+)/i],i;qq.each(t,function(t,n){var a=n.exec(e);if(a){i=a[1];return false}});return i},getPolicy:function(e){var t={},i=[],n=qq.s3.util.getBucket(e.endpoint),a=e.key,o=e.acl,s=e.type,r=new Date,l=e.expectedStatus,d=e.sessionToken,u=e.params,c=qq.s3.util.getSuccessRedirectAbsoluteUrl(e.successRedirectUrl),f=e.minFileSize,p=e.maxFileSize,g=e.reducedRedundancy,h=e.serverSideEncryption;t.expiration=qq.s3.util.getPolicyExpirationDate(r);i.push({acl:o});i.push({bucket:n});if(s){i.push({"Content-Type":s})}if(l){i.push({success_action_status:l.toString()})}if(c){i.push({success_action_redirect:c})}if(g){i.push({});i[i.length-1][qq.s3.util.REDUCED_REDUNDANCY_PARAM_NAME]=qq.s3.util.REDUCED_REDUNDANCY_PARAM_VALUE}if(d){i.push({});i[i.length-1][qq.s3.util.SESSION_TOKEN_PARAM_NAME]=d}if(h){i.push({});i[i.length-1][qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_NAME]=qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_VALUE}i.push({key:a});qq.each(u,function(e,t){var n=qq.s3.util.AWS_PARAM_PREFIX+e,a={};a[n]=encodeURIComponent(t);i.push(a)});t.conditions=i;qq.s3.util.enforceSizeLimits(t,f,p);return t},refreshPolicyCredentials:function(e,t){var i=false;qq.each(e.conditions,function(e,n){qq.each(n,function(e,a){if(e===qq.s3.util.SESSION_TOKEN_PARAM_NAME){n[e]=t;i=true}})});if(!i){e.conditions.push({});e.conditions[e.conditions.length-1][qq.s3.util.SESSION_TOKEN_PARAM_NAME]=t}},generateAwsParams:function(e,t){var i={},n=e.params,a=new qq.Promise,o=qq.s3.util.getPolicy(e),s=e.sessionToken,r=e.type,l=e.key,d=e.accessKey,u=e.acl,c=e.expectedStatus,f=qq.s3.util.getSuccessRedirectAbsoluteUrl(e.successRedirectUrl),p=e.reducedRedundancy,g=e.serverSideEncryption,h=e.log;i.key=l;i.AWSAccessKeyId=d;if(r){i["Content-Type"]=r}if(c){i.success_action_status=c}if(f){i.success_action_redirect=f}if(p){i[qq.s3.util.REDUCED_REDUNDANCY_PARAM_NAME]=qq.s3.util.REDUCED_REDUNDANCY_PARAM_VALUE}if(g){i[qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_NAME]=qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_VALUE}if(s){i[qq.s3.util.SESSION_TOKEN_PARAM_NAME]=s}i.acl=u;qq.each(n,function(e,t){var n=qq.s3.util.AWS_PARAM_PREFIX+e;i[n]=encodeURIComponent(t)});t(o).then(function(e,t,n){i.policy=e.policy;i.signature=e.signature;if(t){i.AWSAccessKeyId=t}if(n){i[qq.s3.util.SESSION_TOKEN_PARAM_NAME]=n}a.success(i)},function(e){e=e||"Can't continue further with request to S3 as we did not receive "+"a valid signature and policy from the server.";h("Policy signing failed.  "+e,"error");a.failure(e)});return a},enforceSizeLimits:function(e,t,i){var n=t<0?0:t,a=i<=0?9007199254740992:i;if(t>0||i>0){e.conditions.push(["content-length-range",n.toString(),a.toString()])}},getPolicyExpirationDate:function(e){e.setMinutes(e.getMinutes()+5);if(Date.prototype.toISOString){return e.toISOString()}else{var t=function(e){var t=String(e);if(t.length===1){t="0"+t}return t};return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}},parseIframeResponse:function(e){var t=e.contentDocument||e.contentWindow.document,i=t.location.search,n=/bucket=(.+)&key=(.+)&etag=(.+)/.exec(i);if(n){return{bucket:n[1],key:n[2],etag:n[3].replace(/%22/g,"")}}},getSuccessRedirectAbsoluteUrl:function(e){if(e){var t=document.createElement("div"),i;if(qq.ie7()){t.innerHTML="<a href='"+e+"'></a>";i=t.firstChild;return i.href}else{i=document.createElement("a");i.href=e;i.href=i.href;return i.href}}},encodeQueryStringParam:function(e){var t=encodeURIComponent(e);t=t.replace(/[!'()]/g,escape);t=t.replace(/\*/g,"%2A");return t.replace(/%20/g,"+")}}}();(function(){"use strict";qq.nonTraditionalBasePublicApi={setUploadSuccessParams:function(e,t){this._uploadSuccessParamsStore.set(e,t)}};qq.nonTraditionalBasePrivateApi={_onComplete:function(e,t,i,n){var a=i.success?true:false,o=this,s=arguments,r=this._options.uploadSuccess.endpoint,l=this._options.uploadSuccess.customHeaders,d=this._options.cors,u=new qq.Promise,c=this._uploadSuccessParamsStore.get(e),f=function(t){delete o._failedSuccessRequestCallbacks[e];qq.extend(i,t);qq.FineUploaderBasic.prototype._onComplete.apply(o,s);u.success(t)},p=function(a){var r=g;qq.extend(i,a);if(i&&i.reset){r=null}if(!r){delete o._failedSuccessRequestCallbacks[e]}else{o._failedSuccessRequestCallbacks[e]=r}if(!o._onAutoRetry(e,t,i,n,r)){qq.FineUploaderBasic.prototype._onComplete.apply(o,s);u.failure(a)}},g,h;if(a&&r){h=new qq.UploadSuccessAjaxRequester({endpoint:r,customHeaders:l,cors:d,log:qq.bind(this.log,this)});qq.extend(c,o._getEndpointSpecificParams(e,i,n),true);g=qq.bind(function(){h.sendSuccessRequest(e,c).then(f,p)},o);g();return u}return qq.FineUploaderBasic.prototype._onComplete.apply(this,arguments)},_manualRetry:function(e){var t=this._failedSuccessRequestCallbacks[e];return qq.FineUploaderBasic.prototype._manualRetry.call(this,e,t)}}})();(function(){"use strict";qq.s3.FineUploaderBasic=function(e){var t={request:{accessKey:null},objectProperties:{acl:"private",key:"uuid",reducedRedundancy:false,serverSideEncryption:false},credentials:{accessKey:null,secretKey:null,expiration:null,sessionToken:null},signature:{endpoint:null,customHeaders:{}},uploadSuccess:{endpoint:null,params:{},customHeaders:{}},iframeSupport:{localBlankPagePath:null},chunking:{partSize:5242880},cors:{allowXdr:true},callbacks:{onCredentialsExpired:function(){}}};qq.extend(t,e,true);if(!this.setCredentials(t.credentials,true)){this._currentCredentials.accessKey=t.request.accessKey}this._aclStore=this._createStore(t.objectProperties.acl);qq.FineUploaderBasic.call(this,t);this._uploadSuccessParamsStore=this._createStore(this._options.uploadSuccess.params);this._failedSuccessRequestCallbacks={};this._cannedKeys={}};qq.extend(qq.s3.FineUploaderBasic.prototype,qq.basePublicApi);qq.extend(qq.s3.FineUploaderBasic.prototype,qq.basePrivateApi);qq.extend(qq.s3.FineUploaderBasic.prototype,qq.nonTraditionalBasePublicApi);qq.extend(qq.s3.FineUploaderBasic.prototype,qq.nonTraditionalBasePrivateApi);qq.extend(qq.s3.FineUploaderBasic.prototype,{getKey:function(e){if(this._cannedKeys[e]==null){return this._handler.getThirdPartyFileId(e)}return this._cannedKeys[e]},reset:function(){qq.FineUploaderBasic.prototype.reset.call(this);this._failedSuccessRequestCallbacks=[]},setUploadSuccessParams:function(e,t){this._uploadSuccessParamsStore.set(e,t)},setCredentials:function(e,t){if(e&&e.secretKey){if(!e.accessKey){throw new qq.Error("Invalid credentials: no accessKey")}else if(!e.expiration){throw new qq.Error("Invalid credentials: no expiration")}else{this._currentCredentials=qq.extend({},e);if(qq.isString(e.expiration)){this._currentCredentials.expiration=new Date(e.expiration)}}return true}else if(!t){throw new qq.Error("Invalid credentials parameter!")}else{this._currentCredentials={}}},setAcl:function(e,t){this._aclStore.set(e,t)},_createUploadHandler:function(){var e=this,t={objectProperties:this._options.objectProperties,aclStore:this._aclStore,signature:this._options.signature,iframeSupport:this._options.iframeSupport,getKeyName:qq.bind(this._determineKeyName,this),validation:{minSizeLimit:this._options.validation.minSizeLimit,maxSizeLimit:this._options.validation.sizeLimit}};qq.override(this._endpointStore,function(e){return{get:function(t){var i=e.get(t);if(i.indexOf("http")<0){return"http://"+i}return i}}});qq.override(this._paramsStore,function(e){return{get:function(t){var i=e.get(t),n={};qq.each(i,function(e,t){n[e.toLowerCase()]=qq.isFunction(t)?t():t});return n}}});t.signature.credentialsProvider={get:function(){return e._currentCredentials},onExpired:function(){var t=new qq.Promise,i=e._options.callbacks.onCredentialsExpired();if(qq.isGenericPromise(i)){i.then(function(i){try{e.setCredentials(i);t.success()}catch(i){e.log("Invalid credentials returned from onCredentialsExpired callback! ("+i.message+")","error");t.failure("onCredentialsExpired did not return valid credentials.")}},function(i){e.log("onCredentialsExpired callback indicated failure! ("+i+")","error");t.failure("onCredentialsExpired callback failed.")})}else{e.log("onCredentialsExpired callback did not return a promise!","error");t.failure("Unexpected return value for onCredentialsExpired.")}return t}};return qq.FineUploaderBasic.prototype._createUploadHandler.call(this,t,"s3")},_determineKeyName:function(e,t){var i=new qq.Promise,n=this._options.objectProperties.key,a=qq.getExtension(t),o=i.failure,s=function(e,t){var n=e;if(t!==undefined){n+="."+t}i.success(n)};switch(n){case"uuid":s(this.getUuid(e),a);break;case"filename":s(t);break;default:if(qq.isFunction(n)){this._handleKeynameFunction(n,e,s,o)}else{this.log(n+" is not a valid value for the s3.keyname option!","error");o()}}return i},_handleKeynameFunction:function(e,t,i,n){var a=this,o=function(e){i(e)},s=function(e){a.log(qq.format("Failed to retrieve key name for {}.  Reason: {}",t,e||"null"),"error");n(e)},r=e.call(this,t);if(qq.isGenericPromise(r)){r.then(o,s)}else if(r==null){s()}else{o(r)}},_getEndpointSpecificParams:function(e,t,i){var n={key:this.getKey(e),uuid:this.getUuid(e),name:this.getName(e),bucket:qq.s3.util.getBucket(this._endpointStore.get(e))};if(i&&i.getResponseHeader("ETag")){n.etag=i.getResponseHeader("ETag")}else if(t.etag){n.etag=t.etag}return n},_onSubmitDelete:function(e,t){var i={key:this.getKey(e),bucket:qq.s3.util.getBucket(this._endpointStore.get(e))};return qq.FineUploaderBasic.prototype._onSubmitDelete.call(this,e,t,i)},_addCannedFile:function(e){var t;if(e.s3Key==null){throw new qq.Error("Did not find s3Key property in server session response.  This is required!")}else{t=qq.FineUploaderBasic.prototype._addCannedFile.apply(this,arguments);this._cannedKeys[t]=e.s3Key}return t}})})();qq.s3.RequestSigner=function(e){"use strict";var t,i=this,n={},a={expectingPolicy:false,method:"POST",signatureSpec:{credentialsProvider:{},endpoint:null,customHeaders:{}},maxConnections:3,paramsStore:{},cors:{expected:false,sendCredentials:false},log:function(e,t){}},o;qq.extend(a,e,true);o=a.signatureSpec.credentialsProvider;function s(e,t,i){var o=t.responseText,s=n[e],r=s.promise,l,d;delete n[e];if(o){try{d=qq.parseJson(o)}catch(e){a.log("Error attempting to parse signature response: "+e,"error")}}if(d&&d.invalid){i=true;l="Invalid policy document or request headers!"}else if(d){if(a.expectingPolicy&&!d.policy){i=true;l="Response does not include the base64 encoded policy!"}else if(!d.signature){i=true;l="Response does not include the signature!"}}else{i=true;l="Received an empty or invalid response from the server!"}if(i){if(l){a.log(l,"error")}r.failure(l)}else{r.success(d)}}function r(e,t,n,a,o,s,r){var l="POST",d=[],u="",c;switch(e){case i.REQUEST_TYPE.MULTIPART_ABORT:l="DELETE";c=qq.format("uploadId={}",s);break;case i.REQUEST_TYPE.MULTIPART_INITIATE:c="uploads";break;case i.REQUEST_TYPE.MULTIPART_COMPLETE:c=qq.format("uploadId={}",s);break;case i.REQUEST_TYPE.MULTIPART_UPLOAD:l="PUT";c=qq.format("partNumber={}&uploadId={}",r,s);break}c=n+"?"+c;qq.each(o,function(e){d.push(e)});d.sort();qq.each(d,function(e,t){u+=t+":"+o[t]+"\n"});return{toSign:qq.format("{}\n\n{}\n\n{}/{}/{}",l,a||"",u||"\n",t,c),endOfUrl:c}}function l(e,t,i,n){var a;if(e.signatureConstructor){if(n){a=e.signatureConstructor.getHeaders();a[qq.s3.util.SESSION_TOKEN_PARAM_NAME]=n;e.signatureConstructor.withHeaders(a)}u(e.signatureConstructor.getToSign().stringToSign,t)}else{n&&qq.s3.util.refreshPolicyCredentials(e,n);d(e,t,i,n)}}function d(e,t,i,n){var a=JSON.stringify(e),s=CryptoJS.enc.Utf8.parse(a),r=CryptoJS.enc.Base64.stringify(s),l=CryptoJS.HmacSHA1(r,o.get().secretKey),d=CryptoJS.enc.Base64.stringify(l);t.success({policy:r,signature:d},i,n)}function u(e,t){var i=CryptoJS.enc.Utf8.parse(e),n=CryptoJS.HmacSHA1(i,o.get().secretKey),a=CryptoJS.enc.Base64.stringify(n);t.success({signature:a})}t=qq.extend(this,new qq.AjaxRequester({acceptHeader:"application/json",method:a.method,contentType:"application/json; charset=utf-8",endpointStore:{get:function(){return a.signatureSpec.endpoint}},paramsStore:a.paramsStore,maxConnections:a.maxConnections,customHeaders:a.signatureSpec.customHeaders,log:a.log,onComplete:s,cors:a.cors,successfulResponseCodes:{POST:[200]}}));qq.extend(this,{getSignature:function(e,i){var s=i,r=new qq.Promise;if(o.get().secretKey&&window.CryptoJS){if(o.get().expiration.getTime()>Date.now()){l(i,r)}else{o.onExpired().then(function(){l(i,r,o.get().accessKey,o.get().sessionToken)},function(e){a.log("Attempt to update expired credentials apparently failed! Unable to sign request.  ","error");r.failure("Unable to sign request - expired credentials.")})}}else{a.log("Submitting S3 signature request for "+e);if(s.signatureConstructor){s={headers:s.signatureConstructor.getToSign().stringToSign}}t.initTransport(e).withParams(s).send();n[e]={promise:r}}return r},constructStringToSign:function(e,t,i){var n={},a,s,l,d;return{withHeaders:function(e){n=e;return this},withUploadId:function(e){a=e;return this},withContentType:function(e){s=e;return this},withPartNum:function(e){l=e;return this},getToSign:function(){var u=o.get().sessionToken;n["x-amz-date"]=(new Date).toUTCString();if(u){n[qq.s3.util.SESSION_TOKEN_PARAM_NAME]=u}d=r(e,t,i,s,n,a,l);return{headers:function(){if(s){n["Content-Type"]=s}return n}(),endOfUrl:d.endOfUrl,stringToSign:d.toSign}},getHeaders:function(){return qq.extend({},n)},getEndOfUrl:function(){return d&&d.endOfUrl}}}})};qq.s3.RequestSigner.prototype.REQUEST_TYPE={MULTIPART_INITIATE:"multipart_initiate",MULTIPART_COMPLETE:"multipart_complete",MULTIPART_ABORT:"multipart_abort",MULTIPART_UPLOAD:"multipart_upload"};qq.UploadSuccessAjaxRequester=function(e){"use strict";var t,i=[],n={method:"POST",endpoint:null,maxConnections:3,customHeaders:{},paramsStore:{},cors:{expected:false,sendCredentials:false},log:function(e,t){}};qq.extend(n,e);function a(e,t,a){var o=i[e],s=t.responseText,r={success:true},l={success:false},d;delete i[e];n.log(qq.format("Received the following response body to an upload success request for id {}: {}",e,s));try{d=qq.parseJson(s);if(a||d&&(d.error||d.success===false)){n.log("Upload success request was rejected by the server.","error");o.failure(qq.extend(d,l))}else{n.log("Upload success was acknowledged by the server.");o.success(qq.extend(d,r))}}catch(t){if(a){n.log(qq.format("Your server indicated failure in its upload success request response for id {}!",e),"error");o.failure(l)}else{n.log("Upload success was acknowledged by the server.");o.success(r)}}}t=qq.extend(this,new qq.AjaxRequester({acceptHeader:"application/json",method:n.method,endpointStore:{get:function(){return n.endpoint}},paramsStore:n.paramsStore,maxConnections:n.maxConnections,customHeaders:n.customHeaders,log:n.log,onComplete:a,cors:n.cors,successfulResponseCodes:{POST:[200]}}));qq.extend(this,{sendSuccessRequest:function(e,a){var o=new qq.Promise;n.log("Submitting upload success request/notification for "+e);t.initTransport(e).withParams(a).send();i[e]=o;return o}})};qq.s3.InitiateMultipartAjaxRequester=function(e){"use strict";var t,i={},n={filenameParam:"qqfilename",method:"POST",endpointStore:null,paramsStore:null,signatureSpec:null,aclStore:null,reducedRedundancy:false,serverSideEncryption:false,maxConnections:3,getContentType:function(e){},getKey:function(e){},getName:function(e){},log:function(e,t){}},a;qq.extend(n,e);a=new qq.s3.RequestSigner({signatureSpec:n.signatureSpec,cors:n.cors,log:n.log});function o(e){var t=qq.s3.util.getBucket(n.endpointStore.get(e)),i={},o=new qq.Promise,s=n.getKey(e),r;i["x-amz-acl"]=n.aclStore.get(e);if(n.reducedRedundancy){i[qq.s3.util.REDUCED_REDUNDANCY_PARAM_NAME]=qq.s3.util.REDUCED_REDUNDANCY_PARAM_VALUE}if(n.serverSideEncryption){i[qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_NAME]=qq.s3.util.SERVER_SIDE_ENCRYPTION_PARAM_VALUE}i[qq.s3.util.AWS_PARAM_PREFIX+n.filenameParam]=encodeURIComponent(n.getName(e));qq.each(n.paramsStore.get(e),function(e,t){i[qq.s3.util.AWS_PARAM_PREFIX+e]=encodeURIComponent(t)});r=a.constructStringToSign(a.REQUEST_TYPE.MULTIPART_INITIATE,t,s).withContentType(n.getContentType(e)).withHeaders(i);a.getSignature(e,{signatureConstructor:r}).then(function(e){i=r.getHeaders();i.Authorization="AWS "+n.signatureSpec.credentialsProvider.get().accessKey+":"+e.signature;o.success(i,r.getEndOfUrl())},o.failure);return o}function s(e,t,a){var o=i[e],s=new DOMParser,r=s.parseFromString(t.responseText,"application/xml"),l,d,u,c,f;delete i[e];if(a){f=t.status;d=r.getElementsByTagName("Message");if(d.length>0){c=d[0].textContent}}else{l=r.getElementsByTagName("UploadId");if(l.length>0){u=l[0].textContent}else{c="Upload ID missing from request"}}if(u===undefined){if(c){n.log(qq.format("Specific problem detected initiating multipart upload request for {}: '{}'.",e,c),"error")}else{n.log(qq.format("Unexplained error with initiate multipart upload request for {}.  Status code {}.",e,f),"error")}o.failure("Problem initiating upload request with Amazon.",t)}else{n.log(qq.format("Initiate multipart upload request successful for {}.  Upload ID is {}",e,u));o.success(u,t)}}t=qq.extend(this,new qq.AjaxRequester({method:n.method,contentType:null,endpointStore:n.endpointStore,maxConnections:n.maxConnections,allowXRequestedWithAndCacheControl:false,log:n.log,onComplete:s,successfulResponseCodes:{POST:[200]}}));qq.extend(this,{send:function(e){var a=new qq.Promise;o(e).then(function(o,s){n.log("Submitting S3 initiate multipart upload request for "+e);i[e]=a;t.initTransport(e).withPath(s).withHeaders(o).send()},a.failure);return a}})};qq.s3.CompleteMultipartAjaxRequester=function(e){"use strict";var t,i={},n={method:"POST",contentType:"text/xml",endpointStore:null,signatureSpec:null,maxConnections:3,getKey:function(e){},log:function(e,t){}},a;qq.extend(n,e);a=new qq.s3.RequestSigner({signatureSpec:n.signatureSpec,cors:n.cors,log:n.log});function o(e,t){var i={},o=new qq.Promise,s=n.endpointStore.get(e),r=qq.s3.util.getBucket(s),l=a.constructStringToSign(a.REQUEST_TYPE.MULTIPART_COMPLETE,r,n.getKey(e)).withUploadId(t).withContentType("application/xml; charset=UTF-8");a.getSignature(e,{signatureConstructor:l}).then(function(e){i=l.getHeaders();i.Authorization="AWS "+n.signatureSpec.credentialsProvider.get().accessKey+":"+e.signature;o.success(i,l.getEndOfUrl())},o.failure);return o}function s(e,t,a){var o=i[e],s=new DOMParser,r=n.endpointStore.get(e),l=qq.s3.util.getBucket(r),d=n.getKey(e),u=s.parseFromString(t.responseText,"application/xml"),c=u.getElementsByTagName("Bucket"),f=u.getElementsByTagName("Key");delete i[e];n.log(qq.format("Complete response status {}, body = {}",t.status,t.responseText));if(a){n.log(qq.format("Complete Multipart Upload request for {} failed with status {}.",e,t.status),"error")}else{if(c.length&&f.length){if(c[0].textContent!==l){a=true;n.log(qq.format("Wrong bucket in response to Complete Multipart Upload request for {}.",e),"error")}}else{a=true;n.log(qq.format("Missing bucket and/or key in response to Complete Multipart Upload request for {}.",e),"error")}}if(a){o.failure("Problem asking Amazon to combine the parts!",t)}else{o.success({},t)}}function r(e){var t=document.implementation.createDocument(null,"CompleteMultipartUpload",null);e.sort(function(e,t){return e.part-t.part});qq.each(e,function(e,i){var n=i.part,a=i.etag,o=t.createElement("Part"),s=t.createElement("PartNumber"),r=t.createTextNode(n),l=t.createTextNode(a),d=t.createElement("ETag");d.appendChild(l);s.appendChild(r);o.appendChild(s);o.appendChild(d);qq(t).children()[0].appendChild(o)});return(new XMLSerializer).serializeToString(t)}t=qq.extend(this,new qq.AjaxRequester({method:n.method,contentType:"application/xml; charset=UTF-8",endpointStore:n.endpointStore,maxConnections:n.maxConnections,allowXRequestedWithAndCacheControl:false,log:n.log,onComplete:s,successfulResponseCodes:{POST:[200]}}));qq.extend(this,{send:function(e,a,s){var l=new qq.Promise;o(e,a).then(function(a,o){var d=r(s);n.log("Submitting S3 complete multipart upload request for "+e);i[e]=l;delete a["Content-Type"];t.initTransport(e).withPath(o).withHeaders(a).withPayload(d).send()},l.failure);return l}})};qq.s3.AbortMultipartAjaxRequester=function(e){"use strict";var t,i={method:"DELETE",endpointStore:null,signatureSpec:null,maxConnections:3,getKey:function(e){},log:function(e,t){}},n;qq.extend(i,e);n=new qq.s3.RequestSigner({signatureSpec:i.signatureSpec,cors:i.cors,log:i.log});function a(e,t){var a={},o=new qq.Promise,s=i.endpointStore.get(e),r=qq.s3.util.getBucket(s),l=n.constructStringToSign(n.REQUEST_TYPE.MULTIPART_ABORT,r,i.getKey(e)).withUploadId(t);n.getSignature(e,{signatureConstructor:l}).then(function(e){a=l.getHeaders();a.Authorization="AWS "+i.signatureSpec.credentialsProvider.get().accessKey+":"+e.signature;o.success(a,l.getEndOfUrl())},o.failure);return o}function o(e,t,n){var a=new DOMParser,o=a.parseFromString(t.responseText,"application/xml"),s=o.getElementsByTagName("Error"),r;i.log(qq.format("Abort response status {}, body = {}",t.status,t.responseText));if(n){i.log(qq.format("Abort Multipart Upload request for {} failed with status {}.",e,t.status),"error")}else{if(s.length){n=true;r=o.getElementsByTagName("Message")[0].textContent;i.log(qq.format("Failed to Abort Multipart Upload request for {}.  Error: {}",e,r),"error")}else{i.log(qq.format("Abort MPU request succeeded for file ID {}.",e))}}}t=qq.extend(this,new qq.AjaxRequester({validMethods:["DELETE"],method:i.method,contentType:null,endpointStore:i.endpointStore,maxConnections:i.maxConnections,allowXRequestedWithAndCacheControl:false,log:i.log,onComplete:o,successfulResponseCodes:{DELETE:[204]}}));qq.extend(this,{send:function(e,n){a(e,n).then(function(n,a){i.log("Submitting S3 Abort multipart upload request for "+e);t.initTransport(e).withPath(a).withHeaders(n).send()})}})};qq.s3.XhrUploadHandler=function(e,t){"use strict";var i=t.getName,n=t.log,a=200,o=e.getKeyName,s=e.filenameParam,r=e.paramsStore,l=e.endpointStore,d=e.aclStore,u=e.objectProperties.reducedRedundancy,c=e.objectProperties.serverSideEncryption,f=e.validation,p=e.signature,g=this,h=e.signature.credentialsProvider,m={combine:function(e){var t=g._getPersistableData(e).uploadId,i=g._getPersistableData(e).etags,n=new qq.Promise;_.completeMultipart.send(e,t,i).then(n.success,function t(i,a){n.failure(E.done(e,a).response,a)});return n},done:function(e,t,i){var n=E.response.parse(e,t),a;if(n.success){a=t.getResponseHeader("ETag");if(!g._getPersistableData(e).etags){g._getPersistableData(e).etags=[]}g._getPersistableData(e).etags.push({part:i+1,etag:a})}},initHeaders:function(t,i){var n={},a=e.endpointStore.get(t),o=qq.s3.util.getBucket(a),s=E.key.urlSafe(t),r=new qq.Promise,l=_.restSignature.constructStringToSign(_.restSignature.REQUEST_TYPE.MULTIPART_UPLOAD,o,s).withPartNum(i+1).withUploadId(g._getPersistableData(t).uploadId);_.restSignature.getSignature(t+"."+i,{signatureConstructor:l}).then(function(e){n=l.getHeaders();n.Authorization="AWS "+h.get().accessKey+":"+e.signature;r.success(n,l.getEndOfUrl())},r.failure);return r},put:function(t,i){var n=g._createXhr(t,i),a=g._getChunkData(t,i),o=e.endpointStore.get(t),s=new qq.Promise;m.initHeaders(t,i).then(function(e,r){var l=o+"/"+r;g._registerProgressHandler(t,i,a.size);E.track(t,n,i).then(s.success,s.failure);n.open("PUT",l,true);qq.each(e,function(e,t){n.setRequestHeader(e,t)});n.send(a.blob)},function(){s.failure({
error:"Problem signing the chunk!"},n)});return s},send:function(e,t){var i=new qq.Promise;m.setup(e).then(function(){m.put(e,t).then(i.success,i.failure)},function(e,t){i.failure({error:e},t)});return i},setup:function(e){var t=new qq.Promise,i=g._getPersistableData(e).uploadId,n=new qq.Promise;if(!i){g._getPersistableData(e).uploadId=n;_.initiateMultipart.send(e).then(function(i){g._getPersistableData(e).uploadId=i;n.success(i);t.success(i)},function(i){g._getPersistableData(e).uploadId=null;t.failure(i);n.failure(i)})}else if(i instanceof qq.Promise){i.then(function(e){t.success(e)})}else{t.success(i)}return t}},_={abortMultipart:new qq.s3.AbortMultipartAjaxRequester({endpointStore:l,signatureSpec:p,cors:e.cors,log:n,getKey:function(e){return E.key.urlSafe(e)}}),completeMultipart:new qq.s3.CompleteMultipartAjaxRequester({endpointStore:l,signatureSpec:p,cors:e.cors,log:n,getKey:function(e){return E.key.urlSafe(e)}}),initiateMultipart:new qq.s3.InitiateMultipartAjaxRequester({filenameParam:s,endpointStore:l,paramsStore:r,signatureSpec:p,aclStore:d,reducedRedundancy:u,serverSideEncryption:c,cors:e.cors,log:n,getContentType:function(e){return g._getMimeType(e)},getKey:function(e){return E.key.urlSafe(e)},getName:function(e){return i(e)}}),policySignature:new qq.s3.RequestSigner({expectingPolicy:true,signatureSpec:p,cors:e.cors,log:n}),restSignature:new qq.s3.RequestSigner({signatureSpec:p,cors:e.cors,log:n})},v={initParams:function(e){var t=r.get(e);t[s]=i(e);return qq.s3.util.generateAwsParams({endpoint:l.get(e),params:t,type:g._getMimeType(e),key:g.getThirdPartyFileId(e),accessKey:h.get().accessKey,sessionToken:h.get().sessionToken,acl:d.get(e),expectedStatus:a,minFileSize:f.minSizeLimit,maxFileSize:f.maxSizeLimit,reducedRedundancy:u,serverSideEncryption:c,log:n},qq.bind(_.policySignature.getSignature,this,e))},send:function(e){var t=new qq.Promise,i=g._createXhr(e),a=g.getFile(e);g._registerProgressHandler(e);E.track(e,i).then(t.success,t.failure);v.setup(e,i,a).then(function(t){n("Sending upload request for "+e);i.send(t)},t.failure);return t},setup:function(e,t,i){var n=new FormData,a=l.get(e),o=a,s=new qq.Promise;v.initParams(e).then(function(e){t.open("POST",o,true);qq.obj2FormData(e,n);n.append("file",i);s.success(n)},function(e){s.failure({error:e})});return s}},E={done:function(e,t){var i=E.response.parse(e,t),a=i.success!==true;if(a&&E.response.shouldReset(i.code)){n("This is an unrecoverable error, we must restart the upload entirely on the next retry attempt.","error");i.reset=true}return{success:!a,response:i}},key:{promise:function(e){var t=new qq.Promise,n=g.getThirdPartyFileId(e);if(n==null){n=new qq.Promise;g._setThirdPartyFileId(e,n);o(e,i(e)).then(function(i){g._setThirdPartyFileId(e,i);t.success(i)},function(i){g._setThirdPartyFileId(e,null);t.failure(i)})}else if(qq.isGenericPromise(n)){t.then(n.success,n.failure)}else{t.success(n)}return t},urlSafe:function(e){return encodeURIComponent(g.getThirdPartyFileId(e))}},response:{parse:function(e,t){var i={},o;try{n(qq.format("Received response status {} with body: {}",t.status,t.responseText));if(t.status===a){i.success=true}else{o=E.response.parseError(t.responseText);if(o){i.error=o.message;i.code=o.code}}}catch(e){n("Error when attempting to parse xhr response text ("+e.message+")","error")}return i},parseError:function(e){var t=new DOMParser,i=t.parseFromString(e,"application/xml"),n=i.getElementsByTagName("Error"),a={},o,s;if(n.length){o=i.getElementsByTagName("Code");s=i.getElementsByTagName("Message");if(s.length){a.message=s[0].textContent}if(o.length){a.code=o[0].textContent}return a}},shouldReset:function(e){return e==="EntityTooSmall"||e==="InvalidPart"||e==="InvalidPartOrder"||e==="NoSuchUpload"}},start:function(e,t){var i=new qq.Promise;E.key.promise(e).then(function(){if(t==null){v.send(e).then(i.success,i.failure)}else{m.send(e,t).then(i.success,i.failure)}},function(e){i.failure({error:e})});return i},track:function(e,t,i){var n=new qq.Promise;t.onreadystatechange=function(){if(t.readyState===4){var a;if(i==null){a=E.done(e,t);n[a.success?"success":"failure"](a.response,t)}else{m.done(e,t,i);a=E.done(e,t);n[a.success?"success":"failure"](a.response,t)}}};return n}};qq.extend(this,{uploadChunk:E.start,uploadFile:E.start});qq.extend(this,new qq.XhrUploadHandler({options:qq.extend({namespace:"s3"},e),proxy:qq.extend({getEndpoint:e.endpointStore.get},t)}));qq.override(this,function(e){return{expunge:function(t){var i=g._getPersistableData(t)&&g._getPersistableData(t).uploadId,n=g._maybeDeletePersistedChunkData(t);if(i!==undefined&&n){_.abortMultipart.send(t,i)}e.expunge(t)},finalizeChunks:function(e){return m.combine(e)},_getLocalStorageId:function(t){var i=e._getLocalStorageId(t),n=l.get(t),a=qq.s3.util.getBucket(n);return i+"-"+a}}})};qq.s3.FormUploadHandler=function(e,t){"use strict";var i=this,n=t.onUuidChanged,a=t.getName,o=t.getUuid,s=t.log,r=e.getKeyName,l=e.filenameParam,d=e.paramsStore,u=e.endpointStore,c=e.aclStore,f=e.objectProperties.reducedRedundancy,p=e.objectProperties.serverSideEncryption,g=e.validation,h=e.signature,m=e.iframeSupport.localBlankPagePath,_=e.signature.credentialsProvider,v=new qq.s3.RequestSigner({signatureSpec:h,cors:e.cors,log:s});if(m===undefined){throw new Error("successRedirectEndpoint MUST be defined if you intend to use browsers that do not support the File API!")}function E(t,n){var a,o=e.endpointStore.get(t),r=qq.s3.util.getBucket(o);try{var l=n.contentDocument||n.contentWindow.document,d=l.body.innerHTML;var u=qq.s3.util.parseIframeResponse(n);if(u.bucket===r&&u.key===qq.s3.util.encodeQueryStringParam(i.getThirdPartyFileId(t))){return true}s("Response from AWS included an unexpected bucket or key name.","error")}catch(e){s("Error when attempting to parse form upload response ("+e.message+")","error")}return false}function C(e){var t=d.get(e);t[l]=a(e);return qq.s3.util.generateAwsParams({endpoint:u.get(e),params:t,key:i.getThirdPartyFileId(e),accessKey:_.get().accessKey,sessionToken:_.get().sessionToken,acl:c.get(e),minFileSize:g.minSizeLimit,maxFileSize:g.maxSizeLimit,successRedirectUrl:m,reducedRedundancy:f,serverSideEncryption:p,log:s},qq.bind(v.getSignature,this,e))}function q(t,n){var o=new qq.Promise,s=e.demoMode?"GET":"POST",r=e.endpointStore.get(t),l=a(t);C(t).then(function(e){var t=i._initFormForUpload({method:s,endpoint:r,params:e,paramsInBody:true,targetName:n.name});o.success(t)},function(e){o.failure(e);y(t,n,l,{error:e})});return o}function b(e){var t=i._createIframe(e),n=i.getInput(e),a=new qq.Promise;q(e,t).then(function(o){o.appendChild(n);i._attachLoadEvent(t,function(i){s("iframe loaded");if(i){if(i.success===false){s("Amazon likely rejected the upload request","error");a.failure(i)}}else{i={};i.success=E(e,t);if(i.success===false){s("A success response was received by Amazon, but it was invalid in some way.","error");a.failure(i)}else{qq.extend(i,qq.s3.util.parseIframeResponse(t));a.success(i)}}y(e,t)});s("Sending upload request for "+e);o.submit();qq(o).remove()},a.failure);return a}function y(e,t){i._detachLoadEvent(e);t&&qq(t).remove()}qq.extend(this,new qq.FormUploadHandler({options:{isCors:false,inputName:"file"},proxy:{onCancel:e.onCancel,onUuidChanged:n,getName:a,getUuid:o,log:s}}));qq.extend(this,{uploadFile:function(e){var t=a(e),n=new qq.Promise;if(i.getThirdPartyFileId(e)){b(e).then(n.success,n.failure)}else{r(e,t).then(function(t){i._setThirdPartyFileId(e,t);b(e).then(n.success,n.failure)},function(e){n.failure({error:e})})}return n}})};(function(){"use strict";qq.s3.FineUploader=function(e){var t={failedUploadTextDisplay:{mode:"custom"}};qq.extend(t,e,true);qq.FineUploader.call(this,t,"s3");if(!qq.supportedFeatures.ajaxUploading&&t.iframeSupport.localBlankPagePath===undefined){this._options.element.innerHTML="<div>You MUST set the <code>localBlankPagePath</code> property "+"of the <code>iframeSupport</code> option since this browser does not support the File API!</div>"}};qq.extend(qq.s3.FineUploader.prototype,qq.s3.FineUploaderBasic.prototype);qq.extend(qq.s3.FineUploader.prototype,qq.uiPublicApi);qq.extend(qq.s3.FineUploader.prototype,qq.uiPrivateApi)})();qq.PasteSupport=function(e){"use strict";var t,i;t={targetElement:null,callbacks:{log:function(e,t){},pasteReceived:function(e){}}};function n(e){return e.type&&e.type.indexOf("image/")===0}function a(){qq(t.targetElement).attach("paste",function(e){var i=e.clipboardData;if(i){qq.each(i.items,function(e,i){if(n(i)){var a=i.getAsFile();t.callbacks.pasteReceived(a)}})}})}function o(){if(i){i()}}qq.extend(t,e);a();qq.extend(this,{reset:function(){o()}})};qq.DragAndDrop=function(e){"use strict";var t,i="qq-hidezones",n="qq-hide-dropzone",a=[],o=[],s=new qq.DisposeSupport;t={dropZoneElements:[],allowMultipleItems:true,classes:{dropActive:null},callbacks:new qq.DragAndDrop.callbacks};qq.extend(t,e,true);function r(e,i){var n=Array.prototype.slice.call(e);t.callbacks.dropLog("Grabbed "+e.length+" dropped files.");i.dropDisabled(false);t.callbacks.processingDroppedFilesComplete(n,i.getElement())}function l(e){var i=new qq.Promise;if(e.isFile){e.file(function(t){var n=e.name,a=e.fullPath,s=a.indexOf(n);a=a.substr(0,s);if(a.charAt(0)==="/"){a=a.substr(1)}t.qqPath=a;o.push(t);i.success()},function(n){t.callbacks.dropLog("Problem parsing '"+e.fullPath+"'.  FileError code "+n.code+".","error");i.failure()})}else if(e.isDirectory){d(e).then(function e(t){var n=t.length;qq.each(t,function(e,t){l(t).done(function(){n-=1;if(n===0){i.success()}})});if(!t.length){i.success()}},function n(a){t.callbacks.dropLog("Problem parsing '"+e.fullPath+"'.  FileError code "+a.code+".","error");i.failure()})}return i}function d(e,t,i,n){var a=n||new qq.Promise,o=t||e.createReader();o.readEntries(function t(n){var s=i?i.concat(n):n;if(n.length){setTimeout(function(){d(e,o,s,a)},0)}else{a.success(s)}},a.failure);return a}function u(e,i){var n=[],a=new qq.Promise;t.callbacks.processingDroppedFiles();i.dropDisabled(true);if(e.files.length>1&&!t.allowMultipleItems){t.callbacks.processingDroppedFilesComplete([]);t.callbacks.dropError("tooManyFilesError","");i.dropDisabled(false);a.failure()}else{o=[];if(qq.isFolderDropSupported(e)){qq.each(e.items,function(e,t){var i=t.webkitGetAsEntry();if(i){if(i.isFile){o.push(t.getAsFile())}else{n.push(l(i).done(function(){n.pop();if(n.length===0){a.success()}}))}}})}else{o=e.files}if(n.length===0){a.success()}}return a}function c(e){var l=new qq.UploadDropZone({HIDE_ZONES_EVENT_NAME:i,element:e,onEnter:function(i){qq(e).addClass(t.classes.dropActive);i.stopPropagation()},onLeaveNotDescendants:function(i){qq(e).removeClass(t.classes.dropActive)},onDrop:function(e){u(e.dataTransfer,l).then(function(){r(o,l)},function(){t.callbacks.dropLog("Drop event DataTransfer parsing failed.  No files will be uploaded.","error")})}});s.addDisposer(function(){l.dispose()});qq(e).hasAttribute(n)&&qq(e).hide();a.push(l);return l}function f(e){var t;qq.each(e.dataTransfer.types,function(e,i){if(i==="Files"){t=true;return false}});return t}function p(e){if(qq.firefox()){return!e.relatedTarget}if(qq.safari()){return e.x<0||e.y<0}return e.x===0&&e.y===0}function g(){var e=t.dropZoneElements,a=function(){setTimeout(function(){qq.each(e,function(e,i){qq(i).hasAttribute(n)&&qq(i).hide();qq(i).removeClass(t.classes.dropActive)})},10)};qq.each(e,function(t,i){var n=c(i);if(e.length&&(!qq.ie()||qq.ie10())){s.attach(document,"dragenter",function(t){if(!n.dropDisabled()&&f(t)){qq.each(e,function(e,t){if(t instanceof HTMLElement){qq(t).css({display:"block"})}})}})}});s.attach(document,"dragleave",function(e){if(p(e)){a()}});s.attach(qq(document).children()[0],"mouseenter",function(e){a()});s.attach(document,"drop",function(e){e.preventDefault();a()});s.attach(document,i,a)}g();qq.extend(this,{setupExtraDropzone:function(e){t.dropZoneElements.push(e);c(e)},removeDropzone:function(e){var i,n=t.dropZoneElements;for(i in n){if(n[i]===e){return n.splice(i,1)}}},dispose:function(){s.dispose();qq.each(a,function(e,t){t.dispose()})}})};qq.DragAndDrop.callbacks=function(){"use strict";return{processingDroppedFiles:function(){},processingDroppedFilesComplete:function(e,t){},dropError:function(e,t){qq.log("Drag & drop error code '"+e+" with these specifics: '"+t+"'","error")},dropLog:function(e,t){qq.log(e,t)}}};qq.UploadDropZone=function(e){"use strict";var t=new qq.DisposeSupport,i,n,a,o;i={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}};qq.extend(i,e);n=i.element;function s(){return qq.safari()||qq.firefox()&&qq.windows()}function r(e){if(!o){if(s){t.attach(document,"dragover",function(e){e.preventDefault()})}else{t.attach(document,"dragover",function(e){if(e.dataTransfer){e.dataTransfer.dropEffect="none";e.preventDefault()}})}o=true}}function l(e){if(qq.ie()&&!qq.ie10()){return false}var t,i=e.dataTransfer,n=qq.safari();t=qq.ie10()||qq.ie11()?true:i.effectAllowed!=="none";return i&&t&&(i.files||!n&&i.types.contains&&i.types.contains("Files"))}function d(e){if(e!==undefined){a=e}return a}function u(){var e;function t(){e=document.createEvent("Event");e.initEvent(i.HIDE_ZONES_EVENT_NAME,true,true)}if(window.CustomEvent){try{e=new CustomEvent(i.HIDE_ZONES_EVENT_NAME)}catch(e){t()}}else{t()}document.dispatchEvent(e)}function c(){t.attach(n,"dragover",function(e){if(!l(e)){return}var t=qq.ie()||qq.ie11()?null:e.dataTransfer.effectAllowed;if(t==="move"||t==="linkMove"){e.dataTransfer.dropEffect="move"}else{e.dataTransfer.dropEffect="copy"}e.stopPropagation();e.preventDefault()});t.attach(n,"dragenter",function(e){if(!d()){if(!l(e)){return}i.onEnter(e)}});t.attach(n,"dragleave",function(e){if(!l(e)){return}i.onLeave(e);var t=document.elementFromPoint(e.clientX,e.clientY);if(qq(this).contains(t)){return}i.onLeaveNotDescendants(e)});t.attach(n,"drop",function(e){if(!d()){if(!l(e)){return}e.preventDefault();e.stopPropagation();i.onDrop(e);u()}})}r();c();qq.extend(this,{dropDisabled:function(e){return d(e)},dispose:function(){t.dispose()},getElement:function(){return n}})};qq.DeleteFileAjaxRequester=function(e){"use strict";var t,i={method:"DELETE",uuidParamName:"qquuid",endpointStore:{},maxConnections:3,customHeaders:function(e){return{}},paramsStore:{},demoMode:false,cors:{expected:false,sendCredentials:false},log:function(e,t){},onDelete:function(e){},onDeleteComplete:function(e,t,i){}};qq.extend(i,e);function n(){if(i.method.toUpperCase()==="POST"){return{_method:"DELETE"}}return{}}t=qq.extend(this,new qq.AjaxRequester({acceptHeader:"application/json",validMethods:["POST","DELETE"],method:i.method,endpointStore:i.endpointStore,paramsStore:i.paramsStore,mandatedParams:n(),maxConnections:i.maxConnections,customHeaders:function(e){return i.customHeaders.get(e)},demoMode:i.demoMode,log:i.log,onSend:i.onDelete,onComplete:i.onDeleteComplete,cors:i.cors}));qq.extend(this,{sendDelete:function(e,n,a){var o=a||{};i.log("Submitting delete file request for "+e);if(i.method==="DELETE"){t.initTransport(e).withPath(n).withParams(o).send()}else{o[i.uuidParamName]=n;t.initTransport(e).withParams(o).send()}}})};(function(){function e(e){var t=e.naturalWidth,i=e.naturalHeight;if(t*i>1024*1024){var n=document.createElement("canvas");n.width=n.height=1;var a=n.getContext("2d");a.drawImage(e,-t+1,0);return a.getImageData(0,0,1,1).data[3]===0}else{return false}}function t(e,t,i){var n=document.createElement("canvas");n.width=1;n.height=i;var a=n.getContext("2d");a.drawImage(e,0,0);var o=a.getImageData(0,0,1,i).data;var s=0;var r=i;var l=i;while(l>s){var d=o[(l-1)*4+3];if(d===0){r=l}else{s=l}l=r+s>>1}var u=l/i;return u===0?1:u}function i(e,t,i){var n=document.createElement("canvas"),o=t.mime||"image/jpeg";a(e,n,t,i);return n.toDataURL(o,t.quality||.8)}function n(e){var t=5241e3;if(!qq.ios()){throw new qq.Error("Downsampled dimensions can only be reliably calculated for iOS!")}if(e.origHeight*e.origWidth>t){return{newHeight:Math.round(Math.sqrt(t*(e.origHeight/e.origWidth))),newWidth:Math.round(Math.sqrt(t*(e.origWidth/e.origHeight)))}}}function a(i,a,s,r){var l=i.naturalWidth,d=i.naturalHeight;var u=s.width,c=s.height;var f=a.getContext("2d");f.save();if(!qq.supportedFeatures.unlimitedScaledImageSize){var p=n({origWidth:u,origHeight:c});if(p){qq.log(qq.format("Had to reduce dimensions due to device limitations from {}w / {}h to {}w / {}h",u,c,p.newWidth,p.newHeight),"warn");u=p.newWidth;c=p.newHeight}}o(a,u,c,s.orientation);if(qq.ios()){var g=e(i);if(g){l/=2;d/=2}var h=1024;var m=document.createElement("canvas");m.width=m.height=h;var _=m.getContext("2d");var v=r?t(i,l,d):1;var E=Math.ceil(h*u/l);var C=Math.ceil(h*c/d/v);var q=0;var b=0;while(q<d){var y=0;var T=0;while(y<l){_.clearRect(0,0,h,h);_.drawImage(i,-y,-q);f.drawImage(m,0,0,h,h,T,b,E,C);y+=h;T+=E}q+=h;b+=C}f.restore();m=_=null}else{f.drawImage(i,0,0,u,c)}a.qqImageRendered&&a.qqImageRendered()}function o(e,t,i,n){switch(n){case 5:case 6:case 7:case 8:e.width=i;e.height=t;break;default:e.width=t;e.height=i}var a=e.getContext("2d");switch(n){case 2:a.translate(t,0);a.scale(-1,1);break;case 3:a.translate(t,i);a.rotate(Math.PI);break;case 4:a.translate(0,i);a.scale(1,-1);break;case 5:a.rotate(.5*Math.PI);a.scale(1,-1);break;case 6:a.rotate(.5*Math.PI);a.translate(0,-i);break;case 7:a.rotate(.5*Math.PI);a.translate(t,-i);a.scale(-1,1);break;case 8:a.rotate(-.5*Math.PI);a.translate(-t,0);break;default:break}}function s(e,t){if(window.Blob&&e instanceof Blob){var i=new Image;var n=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!n){throw Error("No createObjectURL function found to create blob url")}i.src=n.createObjectURL(e);this.blob=e;e=i}if(!e.naturalWidth&&!e.naturalHeight){var a=this;e.onload=function(){var e=a.imageLoadListeners;if(e){a.imageLoadListeners=null;setTimeout(function(){for(var t=0,i=e.length;t<i;t++){e[t]()}},0)}};e.onerror=t;this.imageLoadListeners=[]}this.srcImage=e}s.prototype.render=function(e,t){if(this.imageLoadListeners){var n=this;this.imageLoadListeners.push(function(){n.render(e,t)});return}t=t||{};var o=this.srcImage.naturalWidth,s=this.srcImage.naturalHeight,r=t.width,l=t.height,d=t.maxWidth,u=t.maxHeight,c=!this.blob||this.blob.type==="image/jpeg";if(r&&!l){l=s*r/o<<0}else if(l&&!r){r=o*l/s<<0}else{r=o;l=s}if(d&&r>d){r=d;l=s*r/o<<0}if(u&&l>u){l=u;r=o*l/s<<0}var f={width:r,height:l};for(var p in t)f[p]=t[p];var g=e.tagName.toLowerCase();if(g==="img"){e.src=i(this.srcImage,f,c)}else if(g==="canvas"){a(this.srcImage,e,f,c)}if(typeof this.onrender==="function"){this.onrender(e)}};qq.MegaPixImage=s})();qq.ImageGenerator=function(e){"use strict";function t(e){return e.tagName.toLowerCase()==="img"}function i(e){return e.tagName.toLowerCase()==="canvas"}function n(){return(new Image).crossOrigin!==undefined}function a(){var e=document.createElement("canvas");return e.getContext&&e.getContext("2d")}function o(e){var t=e.split("/"),i=t[t.length-1],n=qq.getExtension(i);n=n&&n.toLowerCase();switch(n){case"jpeg":case"jpg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";case"gif":return"image/gif";case"tiff":case"tif":return"image/tiff"}}function s(e){var t=document.createElement("a"),i,n,a;t.href=e;i=t.protocol;a=t.port;n=t.hostname;if(i.toLowerCase()!==window.location.protocol.toLowerCase()){return true}if(n.toLowerCase()!==window.location.hostname.toLowerCase()){return true}if(a!==window.location.port&&!qq.ie()){return true}return false}function r(t,i){t.onload=function(){t.onload=null;t.onerror=null;i.success(t)};t.onerror=function(){t.onload=null;t.onerror=null;e("Problem drawing thumbnail!","error");i.failure(t,"Problem drawing thumbnail!")}}function l(e,t){e.qqImageRendered=function(){t.success(e)}}function d(n,a){var o=t(n)||i(n);if(t(n)){r(n,a)}else if(i(n)){l(n,a)}else{a.failure(n);e(qq.format("Element container of type {} is not supported!",n.tagName),"error")}return o}function u(t,i,n){var a=new qq.Promise,o=new qq.Identify(t,e),s=n.maxSize,r=n.orient==null?true:n.orient,l=function(){i.onerror=null;i.onload=null;e("Could not render preview, file may be too large!","error");a.failure(i,"Browser cannot render image!")};o.isPreviewable().then(function(n){var o={parse:function(){return(new qq.Promise).success()}},u=r?new qq.Exif(t,e):o,c=new qq.MegaPixImage(t,l);if(d(i,a)){u.parse().then(function(e){var t=e&&e.Orientation;c.render(i,{maxWidth:s,maxHeight:s,orientation:t,mime:n})},function(t){e(qq.format("EXIF data could not be parsed ({}).  Assuming orientation = 1.",t));c.render(i,{maxWidth:s,maxHeight:s,mime:n})})}},function(){e("Not previewable");a.failure(i,"Not previewable")});return a}function c(e,t,i,n){var a=new Image,r=new qq.Promise;d(a,r);if(s(e)){a.crossOrigin="anonymous"}a.src=e;r.then(function(){d(t,i);var s=new qq.MegaPixImage(a);s.render(t,{maxWidth:n,maxHeight:n,mime:o(e)})})}function f(e,t,i,n){d(t,i);qq(t).css({maxWidth:n+"px",maxHeight:n+"px"});t.src=e}function p(e,o,r){var l=new qq.Promise,u=r.scale,p=u?r.maxSize:null;if(u&&t(o)){if(a()){if(s(e)&&!n()){f(e,o,l,p)}else{c(e,o,l,p)}}else{f(e,o,l,p)}}else if(i(o)){c(e,o,l,p)}else if(d(o,l)){o.src=e}return l}qq.extend(this,{generate:function(t,i,n){if(qq.isString(t)){e("Attempting to update thumbnail based on server response.");return p(t,i,n||{})}else{e("Attempting to draw client-side image preview.");return u(t,i,n||{})}}});this._testing={};this._testing.isImg=t;this._testing.isCanvas=i;this._testing.isCrossOrigin=s;this._testing.determineMimeOfFileName=o};qq.Exif=function(e,t){"use strict";var i=[274],n={274:{name:"Orientation",bytes:2}};function a(e){var t=0,i=0;while(e.length>0){t+=parseInt(e.substring(0,2),16)*Math.pow(2,i);e=e.substring(2,e.length);i+=8}return t}function o(t,i){var n=t,a=i;if(n===undefined){n=2;a=new qq.Promise}qq.readBlobToHex(e,n,4).then(function(e){var t=/^ffe([0-9])/.exec(e);if(t){if(t[1]!=="1"){var i=parseInt(e.slice(4,8),16);o(n+i+2,a)}else{a.success(n)}}else{a.failure("No EXIF header to be found!")}});return a}function s(){var t=new qq.Promise;qq.readBlobToHex(e,0,6).then(function(e){if(e.indexOf("ffd8")!==0){t.failure("Not a valid JPEG!")}else{o().then(function(e){t.success(e)},function(e){t.failure(e)})}});return t}function r(t){var i=new qq.Promise;qq.readBlobToHex(e,t+10,2).then(function(e){i.success(e==="4949")});return i}function l(t,i){var n=new qq.Promise;qq.readBlobToHex(e,t+18,2).then(function(e){if(i){return n.success(a(e))}else{n.success(parseInt(e,16))}});return n}function d(t,i){var n=t+20,a=i*12;return qq.readBlobToHex(e,n,a)}function u(e){var t=[],i=0;while(i+24<=e.length){t.push(e.slice(i,i+24));i+=24}return t}function c(e,t){var o=16,s=qq.extend([],i),r={};qq.each(t,function(t,i){var l=i.slice(0,4),d=e?a(l):parseInt(l,16),u=s.indexOf(d),c,f,p;if(u>=0){f=n[d].name;p=n[d].bytes;c=i.slice(o,o+p*2);r[f]=e?a(c):parseInt(c,16);s.splice(u,1)}if(s.length===0){return false}});return r}qq.extend(this,{parse:function(){var i=new qq.Promise,n=function(e){t(qq.format("EXIF header parse failed: '{}' ",e));i.failure(e)};s().then(function(a){t(qq.format("Moving forward with EXIF header parsing for '{}'",e.name===undefined?"blob":e.name));r(a).then(function(e){t(qq.format("EXIF Byte order is {} endian",e?"little":"big"));l(a,e).then(function(o){t(qq.format("Found {} APP1 directory entries",o));d(a,o).then(function(n){var a=u(n),o=c(e,a);t("Successfully parsed some EXIF tags");i.success(o)},n)},n)},n)},n);return i}});this._testing={};this._testing.parseLittleEndian=a};qq.Identify=function(e,t){"use strict";function i(e,t){var i=false,n=[].concat(e);qq.each(n,function(e,n){if(t.indexOf(n)===0){i=true;return false}});return i}qq.extend(this,{isPreviewable:function(){var n=this,a=new qq.Promise,o=false,s=e.name===undefined?"blob":e.name;t(qq.format("Attempting to determine if {} can be rendered in this browser",s));t("First pass: check type attribute of blob object.");if(this.isPreviewableSync()){t("Second pass: check for magic bytes in file header.");qq.readBlobToHex(e,0,4).then(function(e){qq.each(n.PREVIEWABLE_MIME_TYPES,function(t,n){if(i(n,e)){if(t!=="image/tiff"||qq.supportedFeatures.tiffPreviews){o=true;a.success(t)}return false}});t(qq.format("'{}' is {} able to be rendered in this browser",s,o?"":"NOT"));if(!o){a.failure()}},function(){t("Error reading file w/ name '"+s+"'.  Not able to be rendered in this browser.");a.failure()})}else{a.failure()}return a},isPreviewableSync:function(){var i=e.type,n=qq.indexOf(Object.keys(this.PREVIEWABLE_MIME_TYPES),i)>=0,a=false,o=e.name===undefined?"blob":e.name;if(n){if(i==="image/tiff"){a=qq.supportedFeatures.tiffPreviews}else{a=true}}!a&&t(o+" is not previewable in this browser per the blob's type attr");return a}})};qq.Identify.prototype.PREVIEWABLE_MIME_TYPES={"image/jpeg":"ffd8ff","image/gif":"474946","image/png":"89504e","image/bmp":"424d","image/tiff":["49492a00","4d4d002a"]};qq.ImageValidation=function(e,t){"use strict";function i(e){var t=false;qq.each(e,function(e,i){if(i>0){t=true;return false}});return t}function n(){var i=new qq.Promise;new qq.Identify(e,t).isPreviewable().then(function(){var n=new Image,a=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(a){n.onerror=function(){t("Cannot determine dimensions for image.  May be too large.","error");i.failure()};n.onload=function(){i.success({width:this.width,height:this.height})};n.src=a.createObjectURL(e)}else{t("No createObjectURL function available to generate image URL!","error");i.failure()}},i.failure);return i}function a(e,t){var i;qq.each(e,function(e,n){if(n>0){var a=/(max|min)(Width|Height)/.exec(e),o=a[2].charAt(0).toLowerCase()+a[2].slice(1),s=t[o];switch(a[1]){case"min":if(s<n){i=e;return false}break;case"max":if(s>n){i=e;return false}break}}});return i}this.validate=function(e){var o=new qq.Promise;t("Attempting to validate image.");if(i(e)){n().then(function(t){var i=a(e,t);if(i){o.failure(i)}else{o.success()}},o.success)}else{o.success()}return o}};qq.Session=function(e){"use strict";var t={endpoint:null,params:{},customHeaders:{},cors:{},addFileRecord:function(e){},log:function(e,t){}};qq.extend(t,e,true);function i(e){if(qq.isArray(e)){return true}t.log("Session response is not an array.","error")}function n(e,n,a,o){var s=false;n=n&&i(e);if(n){qq.each(e,function(e,i){if(i.uuid==null){s=true;t.log(qq.format("Session response item {} did not include a valid UUID - ignoring.",e),"error")}else if(i.name==null){s=true;t.log(qq.format("Session response item {} did not include a valid name - ignoring.",e),"error")}else{try{t.addFileRecord(i);return true}catch(e){s=true;t.log(e.message,"error")}}return false})}o[n&&!s?"success":"failure"](e,a)}this.refresh=function(){var e=new qq.Promise,i=function(t,i,a){n(t,i,a,e)},a=qq.extend({},t),o=new qq.SessionAjaxRequester(qq.extend(a,{onComplete:i}));o.queryServer();return e}};qq.SessionAjaxRequester=function(e){"use strict";var t,i={endpoint:null,customHeaders:{},params:{},cors:{expected:false,sendCredentials:false},onComplete:function(e,t,i){},log:function(e,t){}};qq.extend(i,e);function n(e,t,n){var a=null;if(t.responseText!=null){try{a=qq.parseJson(t.responseText)}catch(e){i.log("Problem parsing session response: "+e.message,"error");n=true}}i.onComplete(a,!n,t)}t=qq.extend(this,new qq.AjaxRequester({acceptHeader:"application/json",validMethods:["GET"],method:"GET",endpointStore:{get:function(){return i.endpoint}},customHeaders:i.customHeaders,log:i.log,onComplete:n,cors:i.cors}));qq.extend(this,{queryServer:function(){var e=qq.extend({},i.params);i.log("Session query request.");t.initTransport("sessionRefresh").withParams(e).withCacheBuster().send()}})};qq.FormSupport=function(e,t,i){"use strict";var n=this,a=e.interceptSubmit,o=e.element,s=e.autoUpload;qq.extend(this,{newEndpoint:null,newAutoUpload:s,attachedToForm:false,getFormInputsAsObject:function(){if(o==null){return null}return n._form2Obj(o)}});function r(e){if(e.getAttribute("action")){n.newEndpoint=e.getAttribute("action")}}function l(e,t){if(e.checkValidity&&!e.checkValidity()){i("Form did not pass validation checks - will not upload.","error");t()}else{return true}}function d(e){var i=e.submit;qq(e).attach("submit",function(n){n=n||window.event;if(n.preventDefault){n.preventDefault()}else{n.returnValue=false}l(e,i)&&t()});e.submit=function(){l(e,i)&&t()}}function u(e){if(e){if(qq.isString(e)){e=document.getElementById(e)}if(e){i("Attaching to form element.");r(e);a&&d(e)}}return e}o=u(o);this.attachedToForm=!!o};qq.extend(qq.FormSupport.prototype,{_form2Obj:function(e){"use strict";var t={},i=function(e){var t=["button","image","reset","submit"];return qq.indexOf(t,e.toLowerCase())<0},n=function(e){return qq.indexOf(["checkbox","radio"],e.toLowerCase())>=0},a=function(e){if(n(e.type)&&!e.checked){return true}return e.disabled&&e.type.toLowerCase()!=="hidden"},o=function(e){var t=null;qq.each(qq(e).children(),function(e,i){if(i.tagName.toLowerCase()==="option"&&i.selected){t=i.value;return false}});return t};qq.each(e.elements,function(e,n){if((qq.isInput(n,true)||n.tagName.toLowerCase()==="textarea")&&i(n.type)&&!a(n)){t[n.name]=n.value}else if(n.tagName.toLowerCase()==="select"&&!a(n)){var s=o(n);if(s!==null){t[n.name]=s}}});return t}});qq.Scaler=function(e,t){"use strict";var i=this,n=e.sendOriginal,a=e.orient,o=e.defaultType,s=e.defaultQuality/100,r=e.failureText,l=e.includeExif,d=this._getSortedSizes(e.sizes);qq.extend(this,{enabled:qq.supportedFeatures.scaling&&d.length>0,getFileRecords:function(e,i,u){var c=this,f=[],p=u.blob?u.blob:u,g=new qq.Identify(p,t);if(g.isPreviewableSync()){qq.each(d,function(e,n){var d=c._determineOutputType({defaultType:o,requestedType:n.type,refType:p.type});f.push({uuid:qq.getUniqueId(),name:c._getName(i,{name:n.name,type:d,refType:p.type}),blob:new qq.BlobProxy(p,qq.bind(c._generateScaledImage,c,{maxSize:n.maxSize,orient:a,type:d,quality:s,failedText:r,includeExif:l,log:t}))})});n&&f.push({uuid:e,name:i,blob:p})}else{f.push({uuid:e,name:i,blob:p})}return f},handleNewFile:function(e,t,i,n,a,o,s,r){var l=this,d=e.qqButtonId||e.blob&&e.blob.qqButtonId,u=[],c=null,f=r.addFileToHandler,p=r.uploadData,g=r.paramsStore,h=qq.getUniqueId();qq.each(l.getFileRecords(i,t,e),function(t,i){var o=e,r=n,l;if(i.blob instanceof qq.BlobProxy){o=i.blob;r=-1}l=p.addFile({uuid:i.uuid,name:i.name,size:r,batchId:s,proxyGroupId:h});if(i.blob instanceof qq.BlobProxy){u.push(l)}else{c=l}f(l,o);a.push({id:l,file:o})});if(c!==null){qq.each(u,function(e,t){var i={qqparentuuid:p.retrieve({id:c}).uuid,qqparentsize:p.retrieve({id:c}).size};i[o]=p.retrieve({id:t}).uuid;p.setParentId(t,c);g.addReadOnly(t,i)});if(u.length){(function(){var e={};e[o]=p.retrieve({id:c}).uuid;g.addReadOnly(c,e)})()}}}})};qq.extend(qq.Scaler.prototype,{scaleImage:function(e,t,i){"use strict";if(!qq.supportedFeatures.scaling){throw new qq.Error("Scaling is not supported in this browser!")}var n=new qq.Promise,a=i.log,o=i.getFile(e),s=i.uploadData.retrieve({id:e}),r=s&&s.name,l=s&&s.uuid,d={sendOriginal:false,orient:t.orient,defaultType:t.type||null,defaultQuality:t.quality,failedToScaleText:"Unable to scale",sizes:[{name:"",maxSize:t.maxSize}]},u=new qq.Scaler(d,a);if(!qq.Scaler||!qq.supportedFeatures.imagePreviews||!o){n.failure();a("Could not generate requested scaled image for "+e+".  "+"Scaling is either not possible in this browser, or the file could not be located.","error")}else{qq.bind(function(){var t=u.getFileRecords(l,r,o)[0];if(t&&t.blob instanceof qq.BlobProxy){t.blob.create().then(n.success,n.failure)}else{a(e+" is not a scalable image!","error");n.failure()}},this)()}return n},_determineOutputType:function(e){"use strict";var t=e.requestedType,i=e.defaultType,n=e.refType;if(!i&&!t){if(n!=="image/jpeg"){return"image/png"}return n}if(!t){return i}if(qq.indexOf(Object.keys(qq.Identify.prototype.PREVIEWABLE_MIME_TYPES),t)>=0){if(t==="image/tiff"){return qq.supportedFeatures.tiffPreviews?t:i}return t}return i
},_getName:function(e,t){"use strict";var i=e.lastIndexOf("."),n=t.type||"image/png",a=t.refType,o="",s=qq.getExtension(e),r="";if(t.name&&t.name.trim().length){r=" ("+t.name+")"}if(i>=0){o=e.substr(0,i);if(a!==n){s=n.split("/")[1]}o+=r+"."+s}else{o=e+r}return o},_getSortedSizes:function(e){"use strict";e=qq.extend([],e);return e.sort(function(e,t){if(e.maxSize>t.maxSize){return 1}if(e.maxSize<t.maxSize){return-1}return 0})},_generateScaledImage:function(e,t){"use strict";var i=this,n=e.log,a=e.maxSize,o=e.orient,s=e.type,r=e.quality,l=e.failedText,d=e.includeExif&&t.type==="image/jpeg"&&s==="image/jpeg",u=new qq.Promise,c=new qq.ImageGenerator(n),f=document.createElement("canvas");n("Attempting to generate scaled version for "+t.name);c.generate(t,f,{maxSize:a,orient:o}).then(function(){var e=f.toDataURL(s,r),a=function(){n("Success generating scaled version for "+t.name);var a=i._dataUriToBlob(e);u.success(a)};if(d){i._insertExifHeader(t,e,n).then(function(t){e=t;a()},function(){n("Problem inserting EXIF header into scaled image.  Using scaled image w/out EXIF data.","error");a()})}else{a()}},function(){n("Failed attempt to generate scaled version for "+t.name,"error");u.failure(l)});return u},_insertExifHeader:function(e,t,i){"use strict";var n=new FileReader,a=new qq.Promise,o="";n.onload=function(){o=n.result;a.success(ExifRestorer.restore(o,t))};n.onerror=function(){i("Problem reading "+e.name+" during attempt to transfer EXIF data to scaled version.","error");a.failure()};n.readAsDataURL(e);return a},_dataUriToBlob:function(e){"use strict";var t,i,n,a;if(e.split(",")[0].indexOf("base64")>=0){t=atob(e.split(",")[1])}else{t=decodeURI(e.split(",")[1])}i=e.split(",")[0].split(":")[1].split(";")[0];n=new ArrayBuffer(t.length);a=new Uint8Array(n);qq.each(t,function(e,t){a[e]=t.charCodeAt(0)});return this._createBlob(n,i)},_createBlob:function(e,t){"use strict";var i=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,n=i&&new i;if(n){n.append(e);return n.getBlob(t)}else{return new Blob([e],{type:t})}}});var ExifRestorer=function(){var e={};e.KEY_STR="ABCDEFGHIJKLMNOP"+"QRSTUVWXYZabcdef"+"ghijklmnopqrstuv"+"wxyz0123456789+/"+"=";e.encode64=function(e){var t="",i,n,a="",o,s,r,l="",d=0;do{i=e[d++];n=e[d++];a=e[d++];o=i>>2;s=(i&3)<<4|n>>4;r=(n&15)<<2|a>>6;l=a&63;if(isNaN(n)){r=l=64}else if(isNaN(a)){l=64}t=t+this.KEY_STR.charAt(o)+this.KEY_STR.charAt(s)+this.KEY_STR.charAt(r)+this.KEY_STR.charAt(l);i=n=a="";o=s=r=l=""}while(d<e.length);return t};e.restore=function(e,t){var i="data:image/jpeg;base64,";if(!e.match(i)){return t}var n=this.decode64(e.replace(i,""));var a=this.slice2Segments(n);var o=this.exifManipulation(t,a);return i+this.encode64(o)};e.exifManipulation=function(e,t){var i=this.getExifArray(t),n=this.insertExif(e,i),a=new Uint8Array(n);return a};e.getExifArray=function(e){var t;for(var i=0;i<e.length;i++){t=e[i];if(t[0]==255&t[1]==225){return t}}return[]};e.insertExif=function(e,t){var i=e.replace("data:image/jpeg;base64,",""),n=this.decode64(i),a=n.indexOf(255,3),o=n.slice(0,a),s=n.slice(a),r=o;r=r.concat(t);r=r.concat(s);return r};e.slice2Segments=function(e){var t=0,i=[];while(1){if(e[t]==255&e[t+1]==218){break}if(e[t]==255&e[t+1]==216){t+=2}else{var n=e[t+2]*256+e[t+3],a=t+n+2,o=e.slice(t,a);i.push(o);t=a}if(t>e.length){break}}return i};e.decode64=function(e){var t="",i,n,a="",o,s,r,l="",d=0,u=[];var c=/[^A-Za-z0-9\+\/\=]/g;if(c.exec(e)){throw new Error("There were invalid base64 characters in the input text.  "+"Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='")}e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{o=this.KEY_STR.indexOf(e.charAt(d++));s=this.KEY_STR.indexOf(e.charAt(d++));r=this.KEY_STR.indexOf(e.charAt(d++));l=this.KEY_STR.indexOf(e.charAt(d++));i=o<<2|s>>4;n=(s&15)<<4|r>>2;a=(r&3)<<6|l;u.push(i);if(r!=64){u.push(n)}if(l!=64){u.push(a)}i=n=a="";o=s=r=l=""}while(d<e.length);return u};return e}();qq.TotalProgress=function(e,t){"use strict";var i={},n=0,a=0,o=-1,s=-1,r=function(t,i){if(t!==o||i!==s){e(t,i)}o=t;s=i},l=function(e,t){var i=true;qq.each(e,function(e,n){if(qq.indexOf(t,n)>=0){i=false;return false}});return i},d=function(e){f(e,-1,-1);delete i[e]},u=function(e,t,i){if(t.length===0||l(t,i)){r(a,a);this.reset()}},c=function(e){var n=t(e);if(n>0){f(e,0,n);i[e]={loaded:0,total:n}}},f=function(e,t,o){var s=i[e]?i[e].loaded:0,l=i[e]?i[e].total:0;if(t===-1&&o===-1){n-=s;a-=l}else{if(t){n+=t-s}if(o){a+=o-l}}r(n,a)};qq.extend(this,{onAllComplete:u,onStatusChange:function(e,t,i){if(i===qq.status.CANCELED||i===qq.status.REJECTED){d(e)}else if(i===qq.status.SUBMITTING){c(e)}},onIndividualProgress:function(e,t,n){f(e,t,n);i[e]={loaded:t,total:n}},onNewSize:function(e){c(e)},reset:function(){i={};n=0;a=0}})};qq.UiEventHandler=function(e,t){"use strict";var i=new qq.DisposeSupport,n={eventType:"click",attachTo:null,onHandled:function(e,t){}};qq.extend(this,{addHandler:function(e){a(e)},dispose:function(){i.dispose()}});function a(e){i.attach(e,n.eventType,function(e){e=e||window.event;var t=e.target||e.srcElement;n.onHandled(t,e)})}qq.extend(t,{getFileIdFromItem:function(e){return e.qqFileId},getDisposeSupport:function(){return i}});qq.extend(n,e);if(n.attachTo){a(n.attachTo)}};qq.FileButtonsClickHandler=function(e){"use strict";var t={},i={templating:null,log:function(e,t){},onDeleteFile:function(e){},onCancel:function(e){},onRetry:function(e){},onPause:function(e){},onContinue:function(e){},onGetName:function(e){}},n={cancel:function(e){i.onCancel(e)},retry:function(e){i.onRetry(e)},deleteButton:function(e){i.onDeleteFile(e)},pause:function(e){i.onPause(e)},continueButton:function(e){i.onContinue(e)}};function a(e,t){qq.each(n,function(n,a){var o=n.charAt(0).toUpperCase()+n.slice(1),s;if(i.templating["is"+o](e)){s=i.templating.getFileId(e);qq.preventDefault(t);i.log(qq.format("Detected valid file button click event on file '{}', ID: {}.",i.onGetName(s),s));a(s);return false}})}qq.extend(i,e);i.eventType="click";i.onHandled=a;i.attachTo=i.templating.getFileList();qq.extend(this,new qq.UiEventHandler(i,t))};qq.FilenameClickHandler=function(e){"use strict";var t={},i={templating:null,log:function(e,t){},classes:{file:"qq-upload-file",editNameIcon:"qq-edit-filename-icon"},onGetUploadStatus:function(e){},onGetName:function(e){}};qq.extend(i,e);function n(e,n){if(i.templating.isFileName(e)||i.templating.isEditIcon(e)){var a=i.templating.getFileId(e),o=i.onGetUploadStatus(a);if(o===qq.status.SUBMITTED){i.log(qq.format("Detected valid filename click event on file '{}', ID: {}.",i.onGetName(a),a));qq.preventDefault(n);t.handleFilenameEdit(a,e,true)}}}i.eventType="click";i.onHandled=n;qq.extend(this,new qq.FilenameEditHandler(i,t))};qq.FilenameInputFocusInHandler=function(e,t){"use strict";var i={templating:null,onGetUploadStatus:function(e){},log:function(e,t){}};if(!t){t={}}function n(e,n){if(i.templating.isEditInput(e)){var a=i.templating.getFileId(e),o=i.onGetUploadStatus(a);if(o===qq.status.SUBMITTED){i.log(qq.format("Detected valid filename input focus event on file '{}', ID: {}.",i.onGetName(a),a));t.handleFilenameEdit(a,e)}}}i.eventType="focusin";i.onHandled=n;qq.extend(i,e);qq.extend(this,new qq.FilenameEditHandler(i,t))};qq.FilenameInputFocusHandler=function(e){"use strict";e.eventType="focus";e.attachTo=null;qq.extend(this,new qq.FilenameInputFocusInHandler(e,{}))};qq.FilenameEditHandler=function(e,t){"use strict";var i={templating:null,log:function(e,t){},onGetUploadStatus:function(e){},onGetName:function(e){},onSetName:function(e,t){},onEditingStatusChange:function(e,t){}};function n(e){var t=i.onGetName(e),n=t.lastIndexOf(".");if(n>0){t=t.substr(0,n)}return t}function a(e){var t=i.onGetName(e);return qq.getExtension(t)}function o(e,t){var n=e.value,o;if(n!==undefined&&qq.trimStr(n).length>0){o=a(t);if(o!==undefined){n=n+"."+o}i.onSetName(t,n)}i.onEditingStatusChange(t,false)}function s(e,i){t.getDisposeSupport().attach(e,"blur",function(){o(e,i)})}function r(e,i){t.getDisposeSupport().attach(e,"keyup",function(t){var n=t.keyCode||t.which;if(n===13){o(e,i)}})}qq.extend(i,e);i.attachTo=i.templating.getFileList();qq.extend(this,new qq.UiEventHandler(i,t));qq.extend(t,{handleFilenameEdit:function(e,t,a){var o=i.templating.getEditInput(e);i.onEditingStatusChange(e,true);o.value=n(e);if(a){o.focus()}s(o,e);r(o,e)}})};var CryptoJS=CryptoJS||function(e,t){var i={};var n=i.lib={};var a=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var i=new e;if(t){i.mixIn(t)}if(!i.hasOwnProperty("init")){i.init=function(){i.$super.init.apply(this,arguments)}}i.init.prototype=i;i.$super=this;return i},create:function(){var e=this.extend();e.init.apply(e,arguments);return e},init:function(){},mixIn:function(e){for(var t in e){if(e.hasOwnProperty(t)){this[t]=e[t]}}if(e.hasOwnProperty("toString")){this.toString=e.toString}},clone:function(){return this.init.prototype.extend(this)}}}();var o=n.WordArray=a.extend({init:function(e,i){e=this.words=e||[];if(i!=t){this.sigBytes=i}else{this.sigBytes=e.length*4}},toString:function(e){return(e||r).stringify(this)},concat:function(e){var t=this.words;var i=e.words;var n=this.sigBytes;var a=e.sigBytes;this.clamp();if(n%4){for(var o=0;o<a;o++){var s=i[o>>>2]>>>24-o%4*8&255;t[n+o>>>2]|=s<<24-(n+o)%4*8}}else if(i.length>65535){for(var o=0;o<a;o+=4){t[n+o>>>2]=i[o>>>2]}}else{t.push.apply(t,i)}this.sigBytes+=a;return this},clamp:function(){var t=this.words;var i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8;t.length=e.ceil(i/4)},clone:function(){var e=a.clone.call(this);e.words=this.words.slice(0);return e},random:function(t){var i=[];for(var n=0;n<t;n+=4){i.push(e.random()*4294967296|0)}return new o.init(i,t)}});var s=i.enc={};var r=s.Hex={stringify:function(e){var t=e.words;var i=e.sigBytes;var n=[];for(var a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push((o>>>4).toString(16));n.push((o&15).toString(16))}return n.join("")},parse:function(e){var t=e.length;var i=[];for(var n=0;n<t;n+=2){i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4}return new o.init(i,t/2)}};var l=s.Latin1={stringify:function(e){var t=e.words;var i=e.sigBytes;var n=[];for(var a=0;a<i;a++){var o=t[a>>>2]>>>24-a%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(e){var t=e.length;var i=[];for(var n=0;n<t;n++){i[n>>>2]|=(e.charCodeAt(n)&255)<<24-n%4*8}return new o.init(i,t)}};var d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}};var u=n.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new o.init;this._nDataBytes=0},_append:function(e){if(typeof e=="string"){e=d.parse(e)}this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(t){var i=this._data;var n=i.words;var a=i.sigBytes;var s=this.blockSize;var r=s*4;var l=a/r;if(t){l=e.ceil(l)}else{l=e.max((l|0)-this._minBufferSize,0)}var d=l*s;var u=e.min(d*4,a);if(d){for(var c=0;c<d;c+=s){this._doProcessBlock(n,c)}var f=n.splice(0,d);i.sigBytes-=u}return new o.init(f,u)},clone:function(){var e=a.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});var c=n.Hasher=u.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){u.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){if(e){this._append(e)}var t=this._doFinalize();return t},blockSize:512/32,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new f.HMAC.init(e,i).finalize(t)}}});var f=i.algo={};return i}(Math);(function(){var e=CryptoJS;var t=e.lib;var i=t.WordArray;var n=e.enc;var a=n.Base64={stringify:function(e){var t=e.words;var i=e.sigBytes;var n=this._map;e.clamp();var a=[];for(var o=0;o<i;o+=3){var s=t[o>>>2]>>>24-o%4*8&255;var r=t[o+1>>>2]>>>24-(o+1)%4*8&255;var l=t[o+2>>>2]>>>24-(o+2)%4*8&255;var d=s<<16|r<<8|l;for(var u=0;u<4&&o+u*.75<i;u++){a.push(n.charAt(d>>>6*(3-u)&63))}}var c=n.charAt(64);if(c){while(a.length%4){a.push(c)}}return a.join("")},parse:function(e){var t=e.length;var n=this._map;var a=n.charAt(64);if(a){var o=e.indexOf(a);if(o!=-1){t=o}}var s=[];var r=0;for(var l=0;l<t;l++){if(l%4){var d=n.indexOf(e.charAt(l-1))<<l%4*2;var u=n.indexOf(e.charAt(l))>>>6-l%4*2;s[r>>>2]|=(d|u)<<24-r%4*8;r++}}return i.create(s,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(){var e=CryptoJS;var t=e.lib;var i=t.Base;var n=e.enc;var a=n.Utf8;var o=e.algo;var s=o.HMAC=i.extend({init:function(e,t){e=this._hasher=new e.init;if(typeof t=="string"){t=a.parse(t)}var i=e.blockSize;var n=i*4;if(t.sigBytes>n){t=e.finalize(t)}t.clamp();var o=this._oKey=t.clone();var s=this._iKey=t.clone();var r=o.words;var l=s.words;for(var d=0;d<i;d++){r[d]^=1549556828;l[d]^=909522486}o.sigBytes=s.sigBytes=n;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var t=this._hasher;var i=t.finalize(e);t.reset();var n=t.finalize(this._oKey.clone().concat(i));return n}})})();(function(){var e=CryptoJS;var t=e.lib;var i=t.WordArray;var n=t.Hasher;var a=e.algo;var o=[];var s=a.SHA1=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){var i=this._hash.words;var n=i[0];var a=i[1];var s=i[2];var r=i[3];var l=i[4];for(var d=0;d<80;d++){if(d<16){o[d]=e[t+d]|0}else{var u=o[d-3]^o[d-8]^o[d-14]^o[d-16];o[d]=u<<1|u>>>31}var c=(n<<5|n>>>27)+l+o[d];if(d<20){c+=(a&s|~a&r)+1518500249}else if(d<40){c+=(a^s^r)+1859775393}else if(d<60){c+=(a&s|a&r|s&r)-1894007588}else{c+=(a^s^r)-899497514}l=r;r=s;s=a<<30|a>>>2;a=n;n=c}i[0]=i[0]+n|0;i[1]=i[1]+a|0;i[2]=i[2]+s|0;i[3]=i[3]+r|0;i[4]=i[4]+l|0},_doFinalize:function(){var e=this._data;var t=e.words;var i=this._nDataBytes*8;var n=e.sigBytes*8;t[n>>>5]|=128<<24-n%32;t[(n+64>>>9<<4)+14]=Math.floor(i/4294967296);t[(n+64>>>9<<4)+15]=i;e.sigBytes=t.length*4;this._process();return this._hash},clone:function(){var e=n.clone.call(this);e._hash=this._hash.clone();return e}});e.SHA1=n._createHelper(s);e.HmacSHA1=n._createHmacHelper(s)})();(function(e){"use strict";var t,i=["uploaderType","endpointType"];function n(e){var i=d(e||{}),n=a(i);s(n);l(i,n);return t}function a(e){var t=r("uploaderType"),i=r("endpointType");if(t){t=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();if(i){return new qq[i]["FineUploader"+t](e)}return new qq["FineUploader"+t](e)}else{if(i){return new qq[i].FineUploader(e)}return new qq.FineUploader(e)}}function o(e,i){var n=t.data("fineuploader");if(i){if(n===undefined){n={}}n[e]=i;t.data("fineuploader",n)}else{if(n===undefined){return null}return n[e]}}function s(e){return o("uploader",e)}function r(e,t){return o(e,t)}function l(i,n){var a=i.callbacks={};e.each(n._options.callbacks,function(i,n){var o,s;o=/^on(\w+)/.exec(i)[1];o=o.substring(0,1).toLowerCase()+o.substring(1);s=t;a[i]=function(){var t=Array.prototype.slice.call(arguments),i=[],a,r;e.each(t,function(e,t){i.push(f(t))});a=n.apply(this,t);try{r=s.triggerHandler(o,i)}catch(e){qq.log("Caught error in Fine Uploader jQuery event handler: "+e.message,"error")}if(a!=null){return a}return r}});n._options.callbacks=a}function d(n,a){var o,s;if(a===undefined){if(n.uploaderType!=="basic"){o={element:t[0]}}else{o={}}}else{o=a}e.each(n,function(t,n){if(e.inArray(t,i)>=0){r(t,n)}else if(n instanceof e){o[t]=n[0]}else if(e.isPlainObject(n)){o[t]={};d(n,o[t])}else if(e.isArray(n)){s=[];e.each(n,function(t,i){var n={};if(i instanceof e){e.merge(s,i)}else if(e.isPlainObject(i)){d(i,n);s.push(n)}else{s.push(i)}});o[t]=s}else{o[t]=n}});if(a===undefined){return o}}function u(t){return e.type(t)==="string"&&!t.match(/^_/)&&s()[t]!==undefined}function c(e){var t=[],i=Array.prototype.slice.call(arguments,1),n;d(i,t);n=s()[e].apply(s(),t);return f(n)}function f(t){var i=t;if(t!=null&&typeof t==="object"&&(t.nodeType===1||t.nodeType===9)&&t.cloneNode){i=e(t)}return i}e.fn.fineUploader=function(i){var a=this,o=arguments,r=[];this.each(function(l,d){t=e(d);if(s()&&u(i)){r.push(c.apply(a,o));if(a.length===1){return false}}else if(typeof i==="object"||!i){n.apply(a,o)}else{e.error("Method "+i+" does not exist on jQuery.fineUploader")}});if(r.length===1){return r[0]}else if(r.length>1){return r}return this}})(jQuery);(function(e){"use strict";e.fn.fineUploaderS3=function(t){if(typeof t==="object"){t.endpointType="s3"}return e.fn.fineUploader.apply(this,arguments)}})(jQuery);(function(e){"use strict";var t="fineUploaderDnd",i;function n(e){if(!e){e={}}e.dropZoneElements=[i];var t=r(e);s(t);o(new qq.DragAndDrop(t));return i}function a(e,n){var a=i.data(t);if(n){if(a===undefined){a={}}a[e]=n;i.data(t,a)}else{if(a===undefined){return null}return a[e]}}function o(e){return a("dndInstance",e)}function s(t){var n=t.callbacks={};e.each(new qq.DragAndDrop.callbacks,function(e,t){var a=e,o;o=i;n[e]=function(){var e=Array.prototype.slice.call(arguments),t=o.triggerHandler(a,e);return t}})}function r(t,i){var n,a;if(i===undefined){n={}}else{n=i}e.each(t,function(t,i){if(i instanceof e){n[t]=i[0]}else if(e.isPlainObject(i)){n[t]={};r(i,n[t])}else if(e.isArray(i)){a=[];e.each(i,function(t,i){if(i instanceof e){e.merge(a,i)}else{a.push(i)}});n[t]=a}else{n[t]=i}});if(i===undefined){return n}}function l(t){return e.type(t)==="string"&&t==="dispose"&&o()[t]!==undefined}function d(e){var t=[],i=Array.prototype.slice.call(arguments,1);r(i,t);return o()[e].apply(o(),t)}e.fn.fineUploaderDnd=function(t){var a=this,s=arguments,r=[];this.each(function(u,c){i=e(c);if(o()&&l(t)){r.push(d.apply(a,s));if(a.length===1){return false}}else if(typeof t==="object"||!t){n.apply(a,s)}else{e.error("Method "+t+" does not exist in Fine Uploader's DnD module.")}});if(r.length===1){return r[0]}else if(r.length>1){return r}return this}})(jQuery);var SM=window.SM||{};function UploaderException(e){this.message=e;this.name="UserLoaderException"}SM.Uploader=function(e){var t,i={debug:false,template:"uploader",request:{endpoint:"https://sm-assets-mt3.s3.amazonaws.com",accessKey:"AKIAJYLN6ZHWH7RBRY5A"},signature:{endpoint:"/team/uploader/s3/signature/"},uploadSuccess:{endpoint:"/team/uploader/s3/success/"},iframeSupport:{localBlankPagePath:"/team/uploader/iframe-uploader.html"},retry:{enableAuto:false},deleteFile:{enabled:true,endpoint:"/s3handler"},validation:{allowedExtensions:["gif","jpeg","jpg","png"],acceptFiles:"image/gif, image/jpeg, image/png",sizeLimit:1e6,itemLimit:3},objectProperties:{acl:"public-read"},callbacks:{},multiple:false};SM.Global=SM.Global||{};function n(){if(!e.hasOwnProperty("uploader")){throw new UploaderException("Missing configuration value: uploader")}$.extend(i,e.uploader);t=$(e.container).fineUploaderS3(i)}n();return t};SM.Model={__create:function(e){},__validators:undefined,__setters:undefined,__getters:undefined,__counter:0,__defaults:undefined,__initSettings:function(e){var t,i;this.__settings={};if(e){i={};for(t in this.__defaults){if(this.__defaults.hasOwnProperty(t)&&e.hasOwnProperty(t)){i[t]=e[t]}}this.__settings=SM.Object.extend(this.__defaults,i)}else if(this.__defaults){this.__settings=SM.Object.copy(this.__defaults)}},get:function(e,t){var i=this.__getters;if(e===undefined){return}if(i&&i[e]){return i[e](this,t)}else{return this[e]}},set:function(e,t,i){var n=this.__setters,a=this[e],o={notify:false,validate:false},s;if(i){s=SM.Object.extend(o,i)}else{s=o}if(s.validate&&!this.validate(e,t)){return this}if(n&&n[e]){n[e](this,t,s)}else{this[e]=t}if(s.notify){if(t!==a){this._trigger({type:e+".changed",property:e,old:a,value:t})}this._trigger({type:e+".set",property:e,old:a,value:t})}return this},on:function(e,t,i){if(arguments.length<3){throw new Error("model.bind requires three arguments")}else if(!e||!t||!i){throw new Error("model.bind must be passed an event, data, and callback")}this._$.on(e,t,i);return this},off:function(e,t){this._$.off(e,t)},validateKeyValue:function(e,t){var i=this.__validators[e]?this.__validators[e](this,t):{isValid:true};if(!i.isValid){i.property=e;i.value=t;return i}return{isValid:true}},validateGroup:function(e){var t,i,n={isValid:true,invalids:{}};for(t in e){if(!e.hasOwnProperty(t)){continue}i=this.validateKeyValue(t,e[t]);if(!i.isValid){n.isValid=false;n.invalids[t]=i}}return n},validate:function(){var e=this,t=this.__validators,i,n,a,o;if(t){if(arguments.length===0){i=this.validateGroup(this._getValidatables())}else if(arguments.length===1){if(typeof arguments[0]==="string"){n={};o=arguments[0];a=this.state[o];n[o]=a;i=this.validateGroup(n)}else if(typeof arguments[0]==="object"){i=this.validateGroup(arguments[0])}}else if(arguments.length===2){n={};o=arguments[0];a=arguments[1];n[o]=a;i=this.validateGroup(n)}}else{i=this.validateGroup({})}if(!i.isValid){this._trigger({type:"validated",validations:i})}return i},_trigger:function(e){var t={};try{if(e===null||e===undefined){throw new Error("model._trigger: triggering a null or undefined event")}if(typeof e==="string"){t.type=e}else{if(e.type===null||e.type===undefined){throw new Error("model._trigger: triggering a null or undefined event")}t=e}this._$.trigger(t)}catch(e){SM.Error.log(e,"Error model triggering "+t.type)}return this},_getValidatables:function(){var e,t={},i=this.__validators;for(e in i){t[e]=this.get(e)}return t}};SM.Models={_models:{},_types:{},create:function(e,t){var i,n,a;if(e===undefined){throw new Error("a model name is required to create an instance")}n=e+"Model";a=SM[n];if(a===undefined){throw new Error("attempted to create an unregistered model name: "+n)}return this._create(a,t)},register:function(e,t){var i;if(arguments.length!==2){throw new Error("a string model name and model prototype is required to register a model")}if(e===undefined||typeof e!=="string"){throw new Error("a string model name is required to register a model")}i=e+"Model";if(SM[i]!==undefined){throw new Error("a model of this type has already been registered")}SM[i]=SM.Object.extend(SM.Model,t);SM[i].__counter=0;SM[i].__NAME=e;return SM[i]},extend:function(e,t,i){var n=SM.Object.deepExtend(t,i);return this.register(e,n)},_create:function(e,t){var i=SM.Object.create(e);i._$=$({});i.__initSettings(t);i.__uid=e.__counter++;t=t||{};i.__create(t);return i}};SM.InfiniteScroll=SM.Widgets.register({__NAME:"infiniteScroll",__defaults:{threshold:100,markerID:"",windowScroll:false,onReachedEnd:function(e){},isActive:true},LATENCY:200,removeMarker:function(){this._getMarker().remove()},__init:function(){var e=this;this._$window=$(window);this.__settings.markerID="#"+this.__settings.markerID;this._hasLeftThreshold=true;if(this.__settings.isActive){this._bindEvents();setTimeout(function(){if(e._isInThreshold()){e._hitThreshold()}},0)}},__setters:{isActive:function(e,t){if(t){e._activate()}else{e._deactivate()}}},_activate:function(){if(!this._hasMarker()){this._deactivate()}if(!this.__settings.isActive){this.__settings.isActive=true;this._hasLeftThreshold=true;this._bindEvents();if(this._isInThreshold()){this._hitThreshold()}}},_deactivate:function(){if(this.__settings.isActive||!this._hasMarker()){this.__settings.isActive=false;this._unbindEvents()}},__destroy:function(){this.set("isActive",false)},_bindEvents:function(){if(this.get("windowScroll")){this._$window.on("scroll",{self:this},this._onScroll)}else{this.$el.on("scroll",{self:this},this._onScroll)}this._$window.on("resize",{self:this},this._onScroll)},_unbindEvents:function(){if(this.get("windowScroll")){this._$window.off("scroll",this._onScroll)}else{this.$el.off("scroll",this._onScroll)}this._$window.off("resize",this._onScroll)},_hasMarker:function(){return this._getMarker().length>0},_hitThreshold:function(){if(this.__settings.isActive){this.set("isActive",false);this.__settings.onReachedEnd(this);this.trigger("reachedEnd")}},_getScrollBottom:function(){if(this.__settings.windowScroll){return this._$window.scrollTop()+this._$window.height()}else{return this.$el.scrollTop()+this.el.clientHeight}},_getMarker:function(){return $(this.get("markerID"))},_getMarkerTop:function(){var e=this._getMarker(),t;if(this.__settings.windowScroll){t=SM.DOM.getCoordinates(e[0])}else{t=SM.DOM.getCoordinates(e[0],this.$el[0])}return t.top},_isInThreshold:function(){var e;if(!this._hasMarker()){this.set("isActive",false);return false}e=this._getScrollBottom()>=this._getMarkerTop()-this.get("threshold");return e},_checkIfHitThreshold:function(){var e=this._isInThreshold();if(e){if(this._hasLeftThreshold){this._hitThreshold()}}this._hasLeftThreshold=!e},_onScroll:function(e){var t=e.data.self;if(!t._isThrottling&&t.__settings.isActive){t._isThrottling=true;t._checkIfHitThreshold();setTimeout(function(){if(t.__settings.isActive){t._checkIfHitThreshold()}t._isThrottling=false},t.LATENCY)}}});SM.Models.register("AssetLibrary",{IMG_PAGE_SIZE:10,__create:function(){this.resetImages();this.isEnabled=CREATE.user.hasFeature("asset_library")},resetImages:function(){this.loadedImages=[];this.imageCount=0;this.formattedImageCount="0";this.imagesNextPageIndex=0;this.imagesFailed=false;this.isLoadingFirstImagePage=false;this.isFirstImagePageLoaded=false},fetchFirstImagePage:function(){var e=this,t;e.resetImages();e.set("isLoadingFirstImagePage",true);t=CREATE.Ajax.getGroupImages({page_index:e.imagesNextPageIndex}).done(function(t){e._loadImageCount(t.total_count);e._loadImages(t.images);e.isFirstImagePageLoaded=true}).fail(function(){e.imagesFailed=true}).always(function(){e.set("isLoadingFirstImagePage",false)});return t},fetchNextImagePage:function(){var e=this,t;t=CREATE.Ajax.getGroupImages({page_index:e.imagesNextPageIndex}).done(function(t){var i=t.images.length;e._loadImageCount(t.total_count);e._loadImages(t.images);e._trigger({type:"nextImagePageLoaded",loadedImages:e.loadedImages.slice(e.loadedImages.length-i)})});return t},hasUnloadedImages:function(){return this.imageCount>this.loadedImages.length},_loadImageCount:function(e){this.imageCount=e;this.formattedImageCount=Globalize.format(e,"n0")},_loadImages:function(e){var t=this,i;e=$.map(e,function(e){return{id:e.asset_id,s3Key:e.s3_key,description:e.description,name:e.name,medium_url:e.asset_data.thumbnails.medium,dateCreated:new Date(e.date_created),formattedDateCreated:Globalize.format(new Date(e.date_created),"d"),isDefault:e["default"]}});this.loadedImages=this.loadedImages.concat(e);i=t.imageCount-t.loadedImages.length;t.imagesNextPageIndex++}});CREATE.AssetLibrary={getInstance:function(){if(!this._assetLibrary){this._assetLibrary=SM.Models.create("AssetLibrary")}return this._assetLibrary}};SM.Models.register("StockAssets",{__create:function(){this.resetImages()},resetImages:function(){this.pages={};this.totalCount=undefined;this.formattedTotalCount="";this.firstPage=undefined;this.currentPage=undefined;this.lastPage=undefined;this.imagesFailed=false;this.isLoadingFirstImagePage=false;this.buttonStates={first:false,prev:false,next:false,last:false};this.pageSize=8;this.regexStock=undefined},_fetchPage:function(e,t){var i=this,n=this.pages[e],a=$.Deferred(),o;if(n===undefined){a=CREATE.Ajax.getStockAssets({size:this.pageSize,page:e}).done(function(n){o=$.map(n.images,function(e){return{id:e.id,s3Key:e.s3key,name:e.name,full_url:n.base_url+e.s3key,md_url:e.altkeys.thumb_140===undefined?null:n.base_url+e.altkeys.thumb_140,sm_url:e.altkeys.thumb_60===undefined?null:n.base_url+e.altkeys.thumb_60,thumb60S3Key:e.altkeys.thumb_60,thumb140S3Key:e.altkeys.thumb_140,isTiled:e.properties.tiled===true}});if(i.totalCount===undefined){i.totalCount=n.total}i.pages[e]={totalImageCount:i.totalCount,size:o.length,images:o};i.pages[e].firstDisplayNum=i.pageSize*(e-1)+1;i.pages[e].lastDisplayNum=i.pages[e].firstDisplayNum+n.images.length-1;i._postFetchUpdate(e,t)}).fail(function(){i.imagesFailed=true})}else{this._postFetchUpdate(e,t);a.resolve(n)}return a.promise()},_postFetchUpdate:function(e,t){var i=this.pages[e],n,a=this,o=CREATE.survey.get("theme").variables;this.regexStock=/.*smtheme\/stock\/(.*)/i;if(o.survey_container_bg_img!==undefined){n=a.regexStock.exec(o.survey_container_bg_img);if(n!==null&&n.length>0){n=$(n).last()[0]}}if(i!==undefined&&n!==undefined){$.each(i.images,function(e,i){if(t===undefined){i.selected=n===$(a.regexStock.exec(i.s3Key)).last()[0]}else{i.selected=""+i.id===t.attr("data-image-id")}})}else{$.each(i.images,function(e,t){t.selected=false})}this.currentPage=e;this._updateButtonStates();this._trigger({type:"pageLoaded",loadedPage:this.pages[e]})},initialFetch:function(){var e=this;this.resetImages();this.firstPage=1;this.currentPage=1;this.set("isLoadingFirstImagePage",true);return this._fetchPage(this.firstPage).done(function(){if(e.totalCount>0){e.lastPage=Math.ceil(e.totalCount/e.pageSize)}}).always(function(){e.set("isLoadingFirstImagePage",false)})},getFirstPage:function(e){this._fetchPage(this.firstPage,e)},getPrevPage:function(e){if(this.currentPage>this.firstPage){this._fetchPage(this.currentPage-1,e)}},getNextPage:function(e){if(this.currentPage<this.lastPage){this._fetchPage(this.currentPage+1,e)}},getLastPage:function(e){this._fetchPage(this.lastPage,e)},getButtonStates:function(){return this.buttonStates},_updateButtonStates:function(){this.buttonStates.first=this.buttonStates.prev=this.firstPage<this.currentPage;this.buttonStates.next=this.buttonStates.last=this.lastPage>this.currentPage}});CREATE.StockAssets={getInstance:function(){if(!this._stockAssets){this._stockAssets=SM.Models.create("StockAssets")}return this._stockAssets}};SM.SurveyImagesDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"surveyImagesDialog",__templateID:"survey-images-dialog-template",__model:"assetLibrary",__defaults:{isModal:true,width:750},__afterRender:function(){var e,t,i;if(this.get("assetLibrary")===undefined){this.set("assetLibrary",this.__settings.assetLibraryModel)}if(this.get("stockAssets")===undefined){this.set("stockAssets",this.__settings.stockAssetsModel)}t=this.get("stockAssets");i=this.get("assetLibrary");SM.DialogView.__afterRender.call(this);if(t!==undefined&&t.isLoadingFirstImagePage||i.isEnabled&&i.isLoadingFirstImagePage){e=SM.Template.renderHTML("images-dialog-loader-template");$(e).spin({color:"#333333"})}else{e=SM.Views.create(SM.UploadImagesTabsView,{assetLibraryModel:i,stockAssetsModel:t,source:this.get("source"),dialogView:this}).el}this.$el.find("section").html(e)},__onBeforeOpen:function(){var e=this,t,i;t=this.get("stockAssets");i=this.get("assetLibrary");SM.DialogView.__onBeforeOpen.call(e);if(i.isEnabled){i.fetchFirstImagePage().always(function(){e.render();e.position()})}if(t!==undefined){t.initialFetch().always(function(){e.render();e.position()})}e.render();e.position();e.$el.on("imageUploaded",function(){e.close()});e.$el.on("noImageUploaded",function(){e.close()})},__onBeforeClose:function(){var e,t,i,n,a,o=this.$el.find("[data-survey-image-uploader]"),s=this.$el.find("[data-image-library-inner-panel]"),r=this.$el.find("[data-library-inner-panel]");SM.DialogView.__onBeforeClose.call(this);if(o.length){e=o.fineUploader("getUploads");if(e.length===1){t=e[0];if(t.status==="uploading"){o.fineUploader("cancel",t.id)}}}if(s.length){n=s.data("fromImageGalleryPanelView");a=n.get("copyImageRequest");if(a&&a.status===undefined){a.abort()}}if(r.length){i=r.data("fromLibraryPanelView");a=i.get("copyImageRequest");if(a&&a.status===undefined){a.abort()}}}});SM.UploadImagesTabsView=SM.Views.register({__NAME:"uploadImagesTabsView",__templateID:"upload-images-tabs-template",__init:function(){var e,t=this;this._initializedTabs={};if(this.get("source")!=="backgroundImage"){if(this.get("assetLibrary").isEnabled&&this.get("assetLibrary").imageCount>0){e="from-library"}else{e="from-computer"}}else if(this.get("source")==="backgroundImage"){e="from-image-gallery"}else{e="from-computer"}this.$el.tabs().on("tabs.beforeOpen",{self:this},this._onBeforeTabOpen)
;this.$el.data("tabs").open(e);this.$el.on("click","[data-add-from-computer-btn]",function(e){t.$el.data("tabs").open("from-computer");e.preventDefault()})},__beforeRender:function(){var e,t;if(this.get("assetLibrary")===undefined){this.set("assetLibrary",this.__settings.assetLibraryModel)}if(this.get("stockAssets")===undefined){this.set("stockAssets",this.__settings.stockAssetsModel)}e=this.get("assetLibrary");t=this.get("stockAssets");return{hasAssetLibrary:e.isEnabled,formattedImageCount:e.isEnabled?e.formattedImageCount:"",hasManyImages:e.isEnabled?e.imageCount>=3:false,isFromBackground:this.get("source")==="backgroundImage",isFromLogo:this.get("source")==="logo"}},_onBeforeTabOpen:function(e){var t=e.tab,i=e.data.self,n;if(t.key==="from-computer"&&!i._initializedTabs["from-computer"]){n=SM.Views.create(SM.FromComputerPanelView,{source:i.get("source")});t.$panel.find(".panel-asset-wrapper").append(n.$el)}else if(t.key==="from-image-gallery"&&!i._initializedTabs["from-image-gallery"]){n=SM.Views.create(SM.FromImageGalleryPanelView,{model:i.get("stockAssets"),dialogView:i.get("dialogView")});t.$panel.find(".panel-asset-wrapper").append(n.$el)}else if(t.key==="from-library"&&!i._initializedTabs["from-library"]){n=SM.Views.create(SM.FromLibraryPanelView,{model:i.get("assetLibrary"),source:i.get("source")});t.$panel.find(".panel-asset-wrapper").append(n.$el)}i._initializedTabs[t.key]=true}});SM.FromComputerPanelView=SM.Views.register({__NAME:"fromComputerPanelView",__templateID:"from-computer-panel-template",__init:function(){var e=this,t,i,n="image",a=CREATE.Translations.get("file_uploader","errors");t={typeError:a.type.message,sizeError:a.size.message,tooManyFilesError:a.tooManyFiles.message,tooManyItemsError:a.tooManyFiles.message,uploadError:a.upload.message};t.sizeError=t.sizeError+" "+__UPLOADER[n].size_limit/1e6+"MB";t.typeError=t.typeError+" "+__UPLOADER[n].extensions.join(", ");if(e.get("source")==="backgroundImage"){i=__UPLOADER.theme_key_path+CREATE.survey.get("theme").theme_id+"/"}else{i=__UPLOADER.survey_key_path}e.$uploader=SM.Uploader({uploader:{multiple:false,showMessage:function(t){e._showUploadMessage(t,"warning")},messages:t,template:"survey_image_uploader",validation:{acceptFiles:__UPLOADER[n].content_types,allowedExtensions:__UPLOADER[n].extensions,itemLimit:1,sizeLimit:__UPLOADER[n].size_limit},keyPath:i,request:{endpoint:__UPLOADER.s3_url,accessKey:__UPLOADER.public_key},signature:{endpoint:__UPLOADER.s3_signature_path,customHeaders:CREATE.Ajax.getCustomHeaders()},uploadSuccess:{endpoint:__UPLOADER.upload_success_path,customHeaders:CREATE.Ajax.getCustomHeaders()},iframeSupport:{localBlankPagePath:__UPLOADER.iframe_path},retry:{enableAuto:false},objectProperties:{acl:__UPLOADER[n].acl,key:function(e){var t=this.getUploads(),i=t[0],n=t[e].name,a=n.split("."),o=[i.uuid,".",a[a.length-1]];return this._options.keyPath+o.join("")}}},container:e.$el.find("[data-survey-image-uploader]")});e.$uploader.on("validate",function(){e._hideUploadMessage()}).on("validateBatch",function(){e._hideUploadMessage()}).on("complete",{self:e},e._onUploadComplete).on("upload",function(){e._showUploadProgress()})},_onUploadComplete:function(e,t,i,n){var a=e.data.self,o,s,r,l;if(n.success){r=a.$uploader.fineUploader("getKey",t);s=[__UPLOADER.s3_url,"/",r].join("");o=new Image;o.onload=function(){a.$el.trigger({type:"imageUploaded",imageData:{s3Key:r,url:s,source:"computer",width:o.width,height:o.height}})};o.onerror=function(){l=CREATE.Translations.get("file_uploader","errors");a._hideUploadProgress();a._showUploadMessage(l.upload.message,"error");a.$uploader.fineUploader("reset")};o.src=s}else{l=CREATE.Translations.get("file_uploader","errors");a._hideUploadProgress();a._showUploadMessage(l.upload.message,"error");a.$uploader.fineUploader("reset")}},_showUploadProgress:function(){var e=this.$uploader.width(),t=this.$uploader.height();this.$el.find(".display-progress").width(e).height(t).show()},_hideUploadProgress:function(){this.$el.find(".display-progress").hide()},_showUploadMessage:function(e,t){this.$el.find("[data-uploader-error-msg-display]").text(e).removeClass("error hidden").removeClass("warning").addClass(t).show()},_hideUploadMessage:function(){this.$el.find("[data-uploader-error-msg-display]").hide()}});SM.FromImageGalleryPanelView=SM.Views.register({__NAME:"fromImageGalleryPanelView",__templateID:"from-image-gallery-panel-template",__model:"stockAssets",__defaults:{savingEl:null},__init:function(){var e=this.get("dialogView");this.set("newSelection",undefined);e.$el.on("click",".dialog-done-btn",{self:this},this._onDoneClick);this.$el.on("click","[data-image-gallery-image-item]",{self:this},this._onItemClick);this.$el.on("click","#image-gallery-pagination-buttons",{self:this},this._onPaginationClick)},__beforeRender:function(){if(this.stockAssets.totalCount>0){this.stockAssets.on("pageLoaded",{self:this},this._onPageLoaded)}return{imagesFailed:this.stockAssets.imagesFailed,hasImages:this.stockAssets.totalCount>0,totalImages:this.stockAssets.imageCount}},__afterRender:function(){var e,t=this.stockAssets,i;if(t.totalCount>0){i=t.pages[t.currentPage];e=this._createListFragment(i.images);this.$el.find("[data-image-gallery-image-list]").prepend(e);this._updatePagination(this.$el,i.firstDisplayNum,i.lastDisplayNum,i.totalImageCount)}},__setters:{savingEl:function(e,t){if(t!==null){t.addClass("is-saving");e.$el.addClass("is-saving")}else{e.$el.removeClass("is-saving");if(e.__settings.savingEl){e.__settings.savingEl.removeClass("is-saving")}}e.__settings.savingEl=t}},_updatePagination:function(e,t,i,n){var a=this.stockAssets.getButtonStates(),o=e.find("#image-gallery-pagination-info"),s=e.find("#image-gallery-pagination-buttons");o.find("#first-num").html(t);o.find("#last-num").html(i);o.find("#total-num").html(n);s.find(".skip-to-first").prop("disabled",!a.first);s.find(".skip-to-prev").prop("disabled",!a.prev);s.find(".skip-to-next").prop("disabled",!a.next);s.find(".skip-to-last").prop("disabled",!a.last)},_requestMoreImages:function(e){var t=e.data.self;t.stockAssets.fetchNextImagePage()},_createListFragment:function(e){var t=document.createDocumentFragment();$.each(e,function(e,i){var n=SM.Template.renderHTML("add-image-gallery-image-item-template",i);t.appendChild(n)});return t},_onPageLoaded:function(e){var t=e.data.self,i=e.loadedPage,n=t._createListFragment(i.images);t.$el.find(".image-gallery-image-list").html(n)},_onDoneClick:function(e){var t=e.data.self,i=t.get("newSelection"),n,a,o,s,r,l,d;if(i===undefined){t.$el.trigger({type:"noImageUploaded"})}else{n=i.find(".image-preview-container").find("div");o=i.attr("data-image-id");$.each(t.stockAssets.pages[t.stockAssets.currentPage].images,function(e,t){if(t.id.toString()===o){r=t.s3Key;s=t.full_url;if(t.thumb60S3Key!==undefined){l=t.thumb60S3Key}if(t.thumb140S3Key!==undefined){d=t.thumb140S3Key}}});a=n.css("background-repeat")==="no-repeat";e.preventDefault();if(t.get("savingEl")){return}t.set("savingEl",i);t._hideErrorMessage();t.$el.trigger({type:"imageUploaded",imageData:{s3Key:r,url:s,thumb60S3Key:l,thumb140S3Key:d,imageId:o,source:"imageGallery",isFullScreen:a}})}},_onItemClick:function(e){var t=e.data.self,i=$(this);e.preventDefault();if(i.hasClass("selected")){return}else{t.set("newSelection",i);$(".image-gallery-image-item").removeClass("selected");i.addClass("selected")}},_onPaginationClick:function(e){var t=$(e.target),i=e.data.self;if(t.hasClass("skip-to-first")){i.stockAssets.getFirstPage(i.get("newSelection"))}else if(t.hasClass("skip-to-prev")){i.stockAssets.getPrevPage(i.get("newSelection"))}else if(t.hasClass("skip-to-next")){i.stockAssets.getNextPage(i.get("newSelection"))}else if(t.hasClass("skip-to-last")){i.stockAssets.getLastPage(i.get("newSelection"))}},_showErrorMessage:function(){this.$el.find("[data-library-item-error-msg-display]").show()},_hideErrorMessage:function(){this.$el.find("[data-library-item-error-msg-display]").hide()}});SM.FromLibraryPanelView=SM.Views.register({__NAME:"fromLibraryPanelView",__templateID:"from-library-panel-template",__model:"assetLibrary",__defaults:{loaderID:"load-more-images",savingEl:null},__init:function(){if(this.assetLibrary.imageCount>0){this.$el.infiniteScroll({markerID:this.get("loaderID")}).on("infiniteScroll.reachedEnd",{self:this},this._requestMoreImages);this._infiniteScroll=this.$el.data("infiniteScroll");this.assetLibrary.on("nextImagePageLoaded",{self:this},this._onNextPageLoaded)}this.$el.on("click","[data-library-image-item]",{self:this},this._onItemClick)},__beforeRender:function(){return{loaderID:this.get("loaderID"),hasUnloadedImages:this.assetLibrary.hasUnloadedImages(),imagesFailed:this.assetLibrary.imagesFailed,hasImages:this.assetLibrary.imageCount>0}},__afterRender:function(){var e;if(this.assetLibrary.imageCount>0){e=this._createListFragment(this.assetLibrary.loadedImages);this.$el.find("[data-library-image-list]").prepend(e)}},__setters:{savingEl:function(e,t){if(t!==null){t.addClass("is-saving");e.$el.addClass("is-saving")}else{e.$el.removeClass("is-saving");if(e.__settings.savingEl){e.__settings.savingEl.removeClass("is-saving")}}e.__settings.savingEl=t}},_requestMoreImages:function(e){var t=e.data.self;t.assetLibrary.fetchNextImagePage()},_createListFragment:function(e){var t=document.createDocumentFragment();$.each(e,function(e,i){var n=SM.Template.renderHTML("add-library-image-item-template",i);t.appendChild(n)});return t},_onNextPageLoaded:function(e){var t=e.data.self,i=t._createListFragment(e.loadedImages);t.$el.find("[data-library-image-item]").last().after(i);if(!t.assetLibrary.hasUnloadedImages()){t._infiniteScroll.removeMarker()}else{t._infiniteScroll.set("isActive",true)}},_onItemClick:function(e){var t=e.data.self,i=$(this),n=i.data("imageId"),a;e.preventDefault();if(t.get("savingEl")){return}t.set("savingEl",i);t._hideErrorMessage();if(t.get("source")==="backgroundImage"){a=CREATE.Ajax.copyGroupImageToTheme(n,{theme_id:CREATE.survey.get("theme").theme_id})}else{a=CREATE.Ajax.copyGroupImageToSurvey(n,{survey_id:CREATE.survey.id})}a.done(function(e){var i=e.new_key,n=[__UPLOADER.s3_url,"/",i].join(""),a=new Image;a.onload=function(){t.$el.trigger({type:"imageUploaded",imageData:{s3Key:i,url:n,source:"library",width:a.width,height:a.height}});t.set("savingEl",null)};a.onerror=function(){t._showErrorMessage();t.set("savingEl",null)};a.src=n}).fail(function(e,i){if(i!=="abort"){t._showErrorMessage()}t.set("savingEl",null)});t.set("copyImageRequest",a)},_showErrorMessage:function(){this.$el.find("[data-library-item-error-msg-display]").show()},_hideErrorMessage:function(){this.$el.find("[data-library-item-error-msg-display]").hide()}});CREATE.Rte=function(){var e,t=false,i=false,n=["da","de","es","fi","fr","it","ja","ko","nl","no","pt-BR","pt-PT","ru","sv","tr","zh"],a=Globalize.getSmartlingCulture(),o=$.inArray(a,n)>-1?a:"en",s="ltrClick",r="rtlClick",l="<div style='direction: rtl; padding-right: 5px'  data-mce-style='direction: rtl; padding-right: 5px' ></div>";e={main:"bold underline italic link forecolor image media undo redo advanced",advanced:["bold underline italic strikethrough link forecolor image media superscript subscript "+"alignleft aligncenter alignright alignjustify","fontselect fontsizeselect "+"table bullist numlist undo redo removeformat"],advancedSimple:["superscript subscript alignleft aligncenter alignright alignjustify","fontselect fontsizeselect table bullist numlist undo redo removeformat"],textSimple:"bold underline italic link undo redo",textOnly:false};$("#simpleEditorContainer").on("click","a",function(t){var i=$("#simpleEditorContainer"),n=i.parent(),a=n.data("rteoptions"),o=a.toolbar,s,r;t.preventDefault();if(o&&o.indexOf("advanced")>0){o=o.replace("undo redo advanced","");o=o.replace("bold underline italic","bold underline italic strikethrough");s=o+e.advancedSimple[0];r=e.advancedSimple[1];a.toolbar=[s,r]}m(t,n.data("toolbar"),a);$("#graveyard").append($("#simpleEditorContainer"))}).on("mousedown","a",function(){i=true});if($("#simpleEditorContainer").length>0){$("#livePreview").on("closeEditMode",function(){$("#graveyard").append($("#simpleEditorContainer"))})}$(window).on("scroll",_.debounce(function(){if(window.tinymce){tinymce.ui.FloatPanel.hideAll()}},200,true));function d(){return $.trim($.getRangeText($.selectedRange())).length>0}function u(e,i){var n=e.settings.charLimit,a=i.keyCode,o=SM.KeyCodes.getEscapedHtmlContentCharLength(a),s=e.settings.is_textonly?e.getContent():$.trim(CREATE.utils.stripTags(e.getContent())),r=s.length;if(e.settings.is_textonly){if(o){r=r+(o-1)}else if(a===SM.KeyCodes.ENTER){r+=4}}if(n===0||SM.KeyCodes.isNonAdditiveKey(a)||a===SM.KeyCodes.TAB){return true}if(t&&(a===SM.KeyCodes.A||a===SM.KeyCodes.X||a===SM.KeyCodes.C||a===SM.KeyCodes.V)){return true}if(d()){return true}if(r>=n){i.preventDefault()}else{return true}}function c(e){return e===17||e===224}function f(e,i){if(c(i.keyCode)){t=false}h(e)}function p(e,i){if(C(i)){return}else if(i.keyCode===13&&i.shiftKey){i.shiftKey=false}if((i.keyCode===SM.KeyCodes.DELETE||i.keyCode===SM.KeyCodes.BACKSPACE)&&CREATE.Rte.hasOnlyDirectionalWrapper($(i.target))){i.preventDefault();return}if(c(i.keyCode)){t=true}if(e.settings.charLimit){u(e,i)}}function g(e,t){var i=tinymce.get(e),n=i.getContent().replace(/&nbsp;/g," "),a=i.settings.charLimit,o=$.trim(CREATE.utils.stripTags(n)).length+$.trim(CREATE.utils.stripTags(t)).length;if(a===0||o<=a){return t}else{return t.substring(0,a-n.length)}}function h(e){var t=$(e.bodyElement);t.closest(".rteToolbarContainer").toggleClass("empty",e.getContent().length===0||CREATE.Rte.hasOnlyDirectionalWrapper(t))}function m(t,i,n){var a=CREATE.Rte.HTMLMarkupDialog,o=CREATE.survey.hasRtlLanguage(),s=CREATE.Rte.getContent(i),l=$("<div>"+s+"</div>"),d=CREATE.Rte.hasRtlDirection(l),u=o||d,c;if(!a){a=CREATE.Rte.HTMLMarkupDialog=SM.Views.create(SM.ConfirmDialogView,{isModal:true,width:u?596:569,height:500,html:SM.Template.render("html-markup-dialog-template")})}a.$el.addClass("dialog-a").off("confirmDialog.confirm").on("confirmDialog.confirm",function(){var e=tinymce.activeEditor.getContent(),t=$("<div>"+e+"</div>");CREATE.Rte.setContent(i,t.html());a.close()}).off("confirmDialog.beforeClose").on("confirmDialog.beforeClose",function(){CREATE.Rte.destroyRTE("markup-dialog-textarea");CREATE.Rte.focusRTE(i)}).off("confirmDialog.cancel").on("confirmDialog.cancel",function(){a.close()});a.open();t.preventDefault();c={font_formats:"Andale Mono=andale mono,monospace;"+"Arial=arial,helvetica,sans-serif;"+"Arial Black=arial black,sans-serif;"+"Book Antiqua=book antiqua,palatino,serif;"+"Comic Sans MS=comic sans ms,sans-serif;"+"Courier New=courier new,courier,monospace;"+"Georgia=georgia,palatino,serif;"+"Helvetica=helvetica,arial,sans-serif;"+"Impact=impact,sans-serif;"+"Tahoma=tahoma,arial,helvetica,sans-serif;"+"Terminal=terminal,monaco,monospace;"+"Times New Roman=times new roman,times,serif;"+"Trebuchet MS=trebuchet ms,geneva,sans-serif;"+"Verdana=verdana,geneva,sans-serif;",auto_focus:"markup-dialog-textarea",selector:"#markup-dialog-textarea",forced_root_block:false,menubar:false,statusbar:false,paste_as_text:true,browser_spellcheck:true,relative_urls:false,convert_urls:false,skin:"smcustom",plugins:"media link image paste textcolor lists colorpicker table",media_alt_source:false,media_poster:false,link_title:false,toolbar:e.advanced,table_default_attributes:{border:"1"},setup:function(e){e.on("init",function(){e.setContent(l.html());if(CREATE.Rte.hasRtlDirection(l)){e.fire(r)}});e.on("keydown",function(t){p(e,t)});b(e);if(u){T(e,true)}}};$.extend(c,n);if(c.toolbar&&u){if(c.toolbar[0].indexOf("removeformat")<0){c.toolbar[0]=c.toolbar[0]+" removeformat"}c.toolbar[1]=c.toolbar[1].replace("removeformat","")+"dirltr dirrtl"}tinymce.init(c)}function v(e){return"#editQuestion [data-toolbar="+e.attr("id")+"]"}function E(e,t){var i=null;if(t==="title"){i=4e3}else if(e.family==="matrix"){if(t==="answer"){i=250}else if(t==="column"){i=100}}else if(t==="answer"){i=3e3}return i}function C(e){var t=$(e.target);if(e.keyCode===13&&t.closest("tbody.singleLine").closest(".qn.question-single-choice-select").length){e.preventDefault();e.stopImmediatePropagation();return true}return false}function q(e){var t=/^\s*(?:(\"|\')?\w+\:(\/){0,2})/i,i,n,a,o;if(e.indexOf("<a href=")!==-1){i=e.split("<a href=");for(o=1;o<i.length;o++){n=i[o];a=n[0];if(!t.test(n)){n=n.replace(a,a+"http://");i[o]=n}}e=i.join("<a href=")}return e}function b(e){var t=window["js/create/step2/accordion/accordion"],i={title:CREATE.Translations.get("rte_theme")["default"],classes:"widget btn customBtn active",onclick:function(){var e=$("#themeSettings");if(CREATE.Rte.HTMLMarkupDialog){CREATE.Rte.HTMLMarkupDialog.close()}t.openThemesAccordion();$("#accThemes").find('[data-tab-name="custom"]').click();e.removeClass("s1 s2 s3 s4");if($("#customThemeList").find(".selected").length>0){e.addClass("s3").find('a[rel="themeTypography"]').trigger("click");e.find('a[rel="question_header"]').trigger("click")}else{e.addClass("s1")}}};e.addButton("themebold",$.extend({},i,{icon:"bold"}));e.addButton("themeitalic",$.extend({},i,{icon:"italic"}));e.addButton("themeunderline",$.extend({},i,{icon:"underline"}))}function y(e,t,i,n){e.on(i,function(){t.active(true)});e.on(n,function(){t.active(false)})}function T(e,t){var i="#"+e.id,n="#markup-dialog-textarea_ifr",a=t?$(n).contents().find("body"):$(i);e.addButton("dirltr",{title:CREATE.Translations.get("directionality").ltr["default"],classes:"widget btn customBtn",icon:"ltr",onclick:function(){var i,o;if(t){a=$(n).contents().find("body")}if(CREATE.Rte.hasRtlDirection(a)){i=a.children(0);o=i.contents();if(o.length){o.unwrap()}else{i.remove()}h(e)}e.fire(s)},onPostRender:function(){var i=this;if(t||!CREATE.Rte.hasRtlDirection(a)){this.active(true)}e.on("Undo Redo",function(){i.active(!CREATE.Rte.hasRtlDirection(a))});y(e,this,s,r)}});e.addButton("dirrtl",{title:CREATE.Translations.get("directionality").rtl["default"],classes:"widget btn customBtn",icon:"rtl",onclick:function(){var i=false;e.fire(r);if(t){a=$(n).contents().find("body")}if(CREATE.Rte.hasRtlDirection(a)){return}a.wrapInner(l);if(SM.Browser.isIE){i=CREATE.Rte.hasOnlyDirectionalWrapper(a);if(i){a.children(0).html(" ")}a.blur();tinymce.activeEditor.focus();if(i){a.children(0).empty()}}},onPostRender:function(){var i=this;if(!t&&CREATE.Rte.hasRtlDirection(a)){this.active(true)}e.on("Undo Redo",function(){i.active(CREATE.Rte.hasRtlDirection(a))});y(e,this,r,s)}})}return{initRTE:function(t,i){var n=CREATE.survey.hasRtlLanguage(),a=CREATE.Rte.hasRtlDirection(t),s=$.extend({charLimit:0,language:o,forced_root_block:false,inline:true,menubar:false,paste_as_text:true,browser_spellcheck:true,relative_urls:false,convert_urls:false,plugins:"media link image paste textcolor lists colorpicker",media_alt_source:false,media_poster:false,link_title:false,skin:"smcustom",statusbar:false,toolbar:e.main,valid_elements:"@[align|allowfullscreen|allowtransparency|border|color|frameborder|"+"height|mozallowfullscreen|scrolling|style|title|webkitallowfullscreen|width],"+"a[href|target],big,br,caption,center,code,col[span],colgroup[span],"+"div,em/i,font[face|size],iframe[src],img[alt|src],li,ol,p,pre,small,"+"span,strong/b,sub,sup,u,ul,h1,h2,h3,h4,h5,h6,"+"table[align|bgcolor|cellpadding|cellspacing],tbody[valign],"+"th[bgcolor|colspan|headers|nowrap|rowspan|scope|sorted|valign],"+"thead[valign],tr[bgcolor|valign],td[bgcolor|colspan|headers|nowrap|rowspan|valign],"+"tfoot[valign],strike,s",paste_preprocess:function(e,t){t.content=g(t.target.id,t.content)},setup:function(e){e.on("keydown",function(t){p(e,t)});e.on("keyup",function(t){f(e,t)});e.on("focus",function(){var t=$(e.bodyElement);if(CREATE.Rte.hasOnlyDirectionalWrapper(t)&&SM.Browser.isIE){t.children(0).empty()}t.trigger("rteFocused",[t])});e.on("change",function(){h(e)});e.on("blur",function(){var t=$(e.bodyElement);t.trigger("rteBlurred",[t])});e.on("init",function(){var t=$(e.bodyElement);h(e);if(t.attr("id")==="editTitle"){t.blur()}t.focus()});e.addButton("advanced",{title:CREATE.Translations.get("advanced_editor")["default"],text:"...",classes:"widget btn customBtn",icon:false,onclick:function(t){m(t,e.id)}});b(e);if(n||a){T(e)}}},i),r=v(t),d=$(r),u=t.attr("id");s.selector="#"+u;t.data("originalHtml",t.html());if(s.toolbar&&!_.contains(["surveyTitle","pageTitle"],u)){if(n||a){if(s.toolbar.indexOf("dirrtl")<0){if(s.toolbar.indexOf("advanced")>=0){s.toolbar=s.toolbar.replace("advanced","dirltr dirrtl advanced")}else{s.toolbar=s.toolbar+" dirltr dirrtl"}}}if(t.html()===""&&t.text()===""&&n){t.html(l)}}s.is_textonly=s.toolbar===e.textOnly;if(!s.fixed_toolbar_container&&d.length>0){tinymce.init($.extend({},s,{fixed_toolbar_container:r}))}else{tinymce.init(s)}},initSimpleEditor:function(e,t){var i=e.closest(".rteToolbarContainer");t.language=o;if(t.toolbar){i.addClass("focused").prepend($("#simpleEditorContainer"))}i.data("rteoptions",t);e.trigger("rteFocused",[e])},removeSimpleEditor:function(e,t){if(t.toolbar){if(i){i=false}else{$("#graveyard").append($("#simpleEditorContainer"));e.parent().removeClass("focused")}}e.trigger("rteBlurred",[e])},hasOnlyDirectionalWrapper:function(e){return CREATE.Rte.hasRtlDirection(e)&&(e.children(0).is(":empty")||e.children(0).html().replace(/<[\/]*br[\/]*>/g,"").trim()===""&&e.children(0).text()==="")},hasRtlDirection:function(e){if(e.children().length!==1){return false}var t=e.children(0);return t.is("div")&&t.attr("style")&&t.attr("style").indexOf("direction: rtl")>=0},stripRtlWrapper:function(e){var t,i;if(!e){return e}t=$("<div>"+e+"</div>");i=CREATE.Rte.hasRtlDirection(t);return i?t.children(0).html():e},wrapDirectionalityDiv:function(e){e.wrapInner(l)},getDirectionalityWrappedText:function(e){return $("<div/>").html(l).children(0).text(e).parent().html()},getContent:function(e,t){var i=tinymce.get(e),n="html";if(t){n="text"}return i?i.getContent({format:n}):$("#"+e).html()},getContentForSave:function(e){var t=CREATE.Rte.getContent(e),i=/<iframe[\w\s\/=\-\?\&\;:"\.]+><\/iframe>/gi,n=t.match(i),a,o=/<img[^>]+>/gi,s;a=new RegExp('(src="(?:https?:)?\\/\\/www\\.youtube\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/player\\.vimeo\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/www\\.hulu\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/www\\.metacafe\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/cache\\.vevo\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/www\\.dailymotion\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/platform\\.twitter\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/www\\.ustream\\.tv\\/.+?"|'+'src="(?:https?:)?\\/\\/embed\\.ted\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/www\\.youtube-nocookie\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?surveymonkey(?:\\.au)?\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?research\\.net\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?monkeyscience\\.net\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?monkeytest[1-5]\\.(?:com|net)\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?wufoo\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?zoomtest1\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?zoomerang\\.com\\/.+?"|'+'src="(?:https?:)?\\/\\/(?:\\w+\\.)?svy\\.mk\\/.+?")',"ig");if(n){$.each(n,function(e,i){var n=i.match(a),o,s,r,l,d;if(n){o=i.replace(/https?:/,"");n=o.match(a);s=n[0];if(s.indexOf("youtube.com")>0&&s.indexOf("wmode=transparent")===-1){r=s.substring(5,s.length-1);d=r.indexOf("?")>0?"&":"?";l=[r,d,"wmode=transparent"].join("");o=o.replace(r,l)}t=t.replace(i,o)}else{t=t.replace(i,"")}})}s=t.match(o);if(s){$.each(s,function(e,i){var n='height="18"',a='width="25"',o;if(i.indexOf(n)>0&&i.indexOf(a)>0){o=i.replace(n,"").replace(a,"");t=t.replace(i,o)}else{o=i.replace('height="0"',"").replace('width="0"',"");if(o!==i){t=t.replace(i,o)}}})}t=q(t);return t},hasContent:function(e){var t=$("<div/>").html(e);return t.find("img, iframe").length>0||!!$.trim(t.text())},setContent:function(e,t){var i=tinymce.get(e),n=$("#"+e);if(i){i.setContent(t);if(n.length>0){if(CREATE.Rte.hasRtlDirection(n)){i.fire(r)}else{i.fire(s)}}}else{n.html(t)}n.closest(".rteToolbarContainer").toggleClass("empty",!t.length)},getThemedToolbar:function(e,t){var i,n=e,a=CREATE.survey.get("theme");if(!n){return n}switch(t){case"surveyTitle":i=a.styles.survey_title;break;case"pageTitle":i=a.styles.page_title;break;case"pageSubtitle":i=a.styles.page_description;break;case"title":i=a.styles.question_title;break;default:i=a.styles.question_body}if(i["font-weight"]==="bold"||i["font-weight"]==="700"){n=n.replace("bold","themebold")}if(i["font-style"]==="italic"){n=n.replace("italic","themeitalic")}if(i["text-decoration"]==="underline"){n=n.replace("underline","themeunderline")}return n},getRTEOptions:function(t,i){var n={charLimit:0,toolbar:e.main},a=i==="answer"&&t.family==="single_choice"&&t.subtype==="menu",o=t.family==="presentation"&&t.subtype==="descriptive_text",s=t.family==="matrix"&&t.subtype==="ranking"&&i!=="title",r;if(!o&&(i==="answer"||i==="column")){n.toolbar=n.toolbar.replace(/\badvanced\b/,"").replace(/\s\s+/," ")}if(i==="basic"){n.toolbar=e.textSimple}if(i==="other"){n.toolbar=false}if(s){n.toolbar=n.toolbar.replace(/\blink\b/,"").replace(/\s\s+/," ")}if(a){n.toolbar=e.textOnly}n.toolbar=CREATE.Rte.getThemedToolbar(n.toolbar,i);r=E(t,i);if(r){n.charLimit=r}return n},findRTEs:function(e,t){t=t||".rte";return e.find(t).not(function(){var e=$(this),t=!!e.closest("[data-template]").length,i=e.hasClass("disabled");return t||i})},getContentElements:function(e){var t=e.data("originalHtml"),i=t?$("<div>"+t+"</div>").find("*"):e.find("*");return i},containsDisallowedContent:function(e){var t=new RegExp("^(a|b|big|br|caption|center|code|col|colgroup|div|em|font|i|iframe|img|li|ol|"+"p|pre|s|small|span|strike|strong|sub|sup|u|ul|h1|h2|h3|h4|h5|h6|table|tbody|th|thead|"+"tr|td|tfoot)$","i"),i=new RegExp("www\\.youtube\\.com\\/.+?|player\\.vimeo\\.com\\/.+?|"+"www\\.hulu\\.com\\/.+?|www\\.metacafe\\.com\\/.+?|"+"cache\\.vevo\\.com\\/.+?|www\\.dailymotion\\.com\\/.+?|"+"platform\\.twitter\\.com\\/.+?|www\\.ustream\\.tv\\/.+?|"+"embed\\.ted\\.com\\/.+?|www\\.youtube-nocookie\\.com\\/.+?|"+"(?:\\w+\\.)?surveymonkey(?:\\.au)?\\.com\\/.+?|"+"(?:\\w+\\.)?research\\.net\\/.+?|"+"(?:\\w+\\.)?monkeyscience\\.net\\/.+?|"+"(?:\\w+\\.)?monkeytest[1-5]\\.(?:com|net)\\/.+?|"+"(?:\\w+\\.)?wufoo\\.com\\/.+?|"+"(?:\\w+\\.)?zoomtest1\\.com\\/.+?|"+"(?:\\w+\\.)?zoomerang\\.com\\/.+?|"+"(?:\\w+\\.)?svy\\.mk\\/.+?","i");return!e.tagName.toLowerCase().match(t)||e.tagName.toLowerCase()==="iframe"&&!e.getAttribute("src").match(i)},containsMediaTags:function(e){var t=new RegExp("www\\.youtube\\.com\\/.+?|player\\.vimeo\\.com\\/.+?|"+"www\\.hulu\\.com\\/.+?|www\\.metacafe\\.com\\/.+?|"+"cache\\.vevo\\.com\\/.+?|www\\.dailymotion\\.com\\/.+?|"+"platform\\.twitter\\.com\\/.+?|www\\.ustream\\.tv\\/.+?|"+"embed\\.ted\\.com\\/.+?|www\\.youtube-nocookie\\.com\\/.+?","i");return e.tagName.toLowerCase()==="iframe"&&e.getAttribute("src").match(t)},containsAdvancedContentTags:function(e){var t=new RegExp("^(table)$","i");return e.tagName.toLowerCase().match(t)},toggle:function(e,t,i){if(e.prop("contentEditable")&&i!==true){CREATE.Rte.destroyRTE(e.attr("id"));e.prop("contentEditable",false);e.prop("disabled",true)}else if(!e.hasClass("disabled")){CREATE.Rte.initRTE(e,t);e.prop("contentEditable",true);e.prop("disabled",false)}},openAdvancedRTE:function(e,t,i){m(e,t,i)},focusRTE:function(e){var t=tinymce.get(e),i=$("#"+e);if(t){t.focus()}else{i.focus()}},blurRTE:function(e){var t=tinymce.get(e),i;if(t){i=$(t.bodyElement);i.trigger("rteBlurred",[i])}},destroyRTE:function(e){var t=tinymce.get(e),i;if(t){t.destroy()}else if(SM.Browser.isOldIE){i=$("#"+e);if(i.closest("#editQuestion").length>0){i.off("blur").off("focus")}}}}}();CREATE.Validator={_required:function(e){var t=e.replace(/\s/g,"").replace(/(&nbsp;)+/,"");return!!t},_float:function(e){return!isNaN(parseFloat(e))},_positive:function(e){return e>=0},_gt:function(e,t){return parseFloat(e)>parseFloat(t)},_gte:function(e,t){return parseFloat(e)>=parseFloat(t)},_lt:function(e,t){return parseFloat(e)<parseFloat(t)},_lte:function(e,t){return parseFloat(e)<=parseFloat(t)},validate:function(e,t){var i=this,n=true;if(typeof t==="undefined"){t="[data-validation-parent]"}e.each(function(e,a){var o=$(a),s,r,l;if(o.closest("[data-template]").length){return}s=o.hasClass("rte")?CREATE.Rte.getContent(a.id):o.val();r=o.attr("data-validation");l=r?r.split(" "):[];$.each(l,function(e,a){var r=a.split("-"),l;if(r.length>1){l=i["_"+r[0]](s,r[1])}else{l=i["_"+a](s)}o.closest(t).toggleClass("error",!l);if(!l){n=false;return false}})});return n}};CREATE.ChoicesTable=function(e,t){var i=this,n={minChoices:1,maxChoices:500,listType:"",questionType:null},a=e.closest(".qn"),o=a.hasClass("has_responses"),s=a.hasClass("questionLogicApplied"),r=a.hasClass("hasQuota"),l=function(e){var t=e.prev(".choice:not(.hide)");if(t.length===0){t=e.next(".choice")}CREATE.Rte.findRTEs(t).each(function(e,t){if($(t).is(":visible")){CREATE.Rte.focusRTE(t.id);return false}})},d=function(t){if(!i.canAddChoices()){e.closest(".choicesTable").addClass("maxChoices").trigger("overMaxChoices");if(t){t.closest(".choice").find("[data-error=overMax"+n.maxChoices+"]").removeClass("hide")}}},u=function(){if(e.find(".choice:not(.hide)").length<n.maxChoices){e.removeClass("maxedAnswers").closest(".choicesTable").removeClass("maxChoices").trigger("underMaxChoices").find(".overMax").addClass("hide")}},c=function(){var t=e.find(".choice:not([data-template])").length;return t>n.minChoices},f=function(t){var i=$(t).closest("tr"),n,a,o;if(c()){n=CREATE.Rte.findRTEs(i);n.each(function(e,t){l(i);CREATE.Rte.destroyRTE(t.id)});a=e.find(".choice").not("[data-template]");o=a.index(i);i.remove();e.trigger("choiceRemoved",{$el:i,index:o});u();_()}p()},p=function(){var t=e.find(".choice").not("[data-visibility=false]").not("[data-template]"),i=t.length;e.toggleClass("noDelete",i<=n.minChoices)},g=function(t){var i=e.find("[data-template]").first().clone(),n=i.find('[data-var="text"]'),a=i.find('[data-var="weight"]'),l=i.find('[data-var="percent"]'),d=i.find('[data-var="label"]'),u=i.find('[data-var="score"]');i.removeClass("hide").removeAttr("data-template");if(o){i.addClass("has_responses")}else if(s){i.addClass("questionLogicApplied")}else if(r){i.addClass("hasQuota")}else if(t.visible===false){i.addClass("hasHidden")}if(t.visible===false||t.funneling){n.addClass("disabled").prop("contentEditable",false).prop("disabled",true);i.addClass("choiceDisabled")}if(t.funneling){i.addClass("isFunnelReceiverOption");n.attr({"data-sender-question-id":t.funneling.sender_question_id,"data-sender-answer-id":t.funneling.sender_answer_id,"data-is-open-ended":t.funneling.sender_answer_open_ended,"data-root-answer-open-ended":t.funneling.root_answer_open_ended,title:CREATE.Translations.get("funneled_choice_title")["default"]}).addClass("funneledAnswerOption")}if(t.visible===false){n.addClass("notVisible");i.addClass("choiceNotVisible");u.addClass("disabled").prop("disabled",true)}i.attr("data-visibility",t.visible);$.each(n.add(a).add(u).add(l).add(d),function(e,i){var n=$(i),a=n.attr("data-var"),o;if(n.hasClass("rte")){n.html(CREATE.utils.stripInvalidHtml(t[a]));if(!t[a]){n.closest(".rteToolbarContainer").addClass("empty")}}else if(a==="score"){o=n.closest(".choice").find(".quiz-radio");if(t.options&&t.options.quiz_options){n.val(t.options.quiz_options[a])}else{n.val(0)}o.toggleClass("quiz-checked",parseInt(n.val(),10)!==0)}else{n.val(t[a])}});return i},h=function(e){e.find(".rte").each(function(e,t){var i=$(t),n=("newChoice"+Math.random()).replace("0.","");i.closest("[data-toolbar]").attr("data-toolbar",n);i.attr("id",n)})},m=function(t){var i=$(t).closest("tr"),a=i.find(".input").first(),o=i.find(".quizInput"),s=a.prop("disabled"),r=o.prop("disabled"),l=a.hasClass("funneledAnswerOption"),d,u=i.attr("data-visibility")==="false",c=e.find(".choice:not([data-template])"),f=c.index(i)
;a.prop("disabled",!s||l).toggleClass("disabled",l).toggleClass("notVisible");if(o.length){o.prop("disabled",!r).toggleClass("disabled",!r);o.val(0);o.blur();$("#rows").trigger("calcMaxQuizScore")}i.toggleClass("choiceDisabled",l).toggleClass("choiceNotVisible");if(a.is(".rte")){if(u){d=CREATE.Rte.getRTEOptions(n.questionType,a.attr("data-rte"))}CREATE.Rte.toggle(a,d,u)}i.attr("data-visibility",u);e.trigger("choiceVisibilityChanged",{visibility:u,index:f});p()},_=function(){var t=e.find(".choice:not(.hide)").find(".tbPos"),i;if(n.listType==="letter"){i=65;t.each(function(e,t){t.innerHTML=String.fromCharCode(i);i++})}else if(n.listType==="number"){t.each(function(e,t){t.innerHTML=e+1})}},v=function(){$.extend(n,t);$("#livePreview").on("has_responses_trigger",function(){o=true;p()});e.off().on("click","a",function(e){var t=$(e.currentTarget);if(t.hasClass("delete")){f(t)}else if(t.hasClass("view")){m(t)}else if(t.hasClass("add")){if(i.canAddChoices()){i.addChoice({text:"",id:""},true,false,t.closest("tr"));d()}else{d(t)}}e.preventDefault()}).on("settingChanged",function(e,t){if(t==="minChoices"){p()}})};v();i.setOption=function(t,i){if(n[t]){n[t]=i;e.trigger("settingChanged",[t,i])}};i.load=function(t){var n;if(t.length>0){n=t[0].var_type}e.find("tr.choice").not("[data-template]").remove();if(n){e.data("randomAssignmentType",n)}i.addChoices(t);d()};i.canAddChoices=function(t){var i=t||1,a=e.find(".choice:not([data-template])").length+i;return a<=n.maxChoices};i.addChoice=function(t,i,n,a){var o=g(t),s,r=e.find(".choice").not("[data-template]");a=a||r.last();o.insertAfter(a);p();_();if(i){h(o);o.addClass("new");if(!n){s=o.find(".rte:visible").first().attr("id");CREATE.Rte.focusRTE(s)}e.trigger("choiceAdded",{$el:o,index:r.index(a)+1,choiceData:t})}return o};i.addChoices=function(t,i){var n=[];$.each(t,function(e,t){var i=g(t);if(!t.id){i.addClass("new")}else{i.attr("data-choice-id",t.id)}h(i);n.push(i)});e.find(".choice").last().after(n);p();_();if(i){e.trigger("choicesAdded",{choices:t})}};i.deleteChoices=function(t){var i=e.find(".choice").not("[data-template]"),n=t.closest("tr"),a=[];n.each(function(e,t){a.push(i.index(t))});n.remove();u();_();p();e.trigger("choicesRemoved",{indexes:a})}};SM.SamplePopout=SM.Widgets.deepExtend(SM.Popout,{__NAME:"samplePopout",__defaults:{showDelayTime:500,hideDelayTime:100,collision:"flip flipfit"},__init:function(e){var t=this;this.offsetMenu=e.offsetMenu;SM.Popout.__init.call(t,e);t.$el.on("samplePopout.opened",{samplePopout:t},t._positionTipY);return t},_onClick:function(e){var t=$(e.currentTarget),i=t.data("samplePopout");i._isHovered=false;if(i._$msg){i._$msg.remove()}else{SM.Logger.remoteLog({Name:"SamplePopoutRemoveError",call:"samplePopout.js::_onClick",Message:"Sample popout for "+t.attr("rel")+" is undefined"},"warning")}i._isMsgSetup=false},_beforeShow:function(){var e=this;if(this.offsetMenu){e._positionPopoutX()}SM.Popout._beforeShow.call(e);e._$msg.addClass("sample-q");return e},_show:function(){var e=this;SM.Popout._show.call(e);e._$msg.find("[data-question-slider]").sliderQuestion();e._$msg.find(".hideBuilderTooltips").on("click",function(){CREATE.user.setPreference("show_builder_tooltips_enabled",false);e._$msg.remove();$("#accBuilder li[data-help]").each(function(e,t){$(t).data("samplePopout").destroy()})});return e},_positionPopoutX:function(){var e=this.$el,t=e.position().left+e.width()+5;this.set("offsetX","+"+t);return this},_positionTipY:function(e){var t=e.data.samplePopout,i=t._$msg,n=t.$el,a=i.find(".tip");if(i.hasClass("tip-top")){a.css("top",n.offset().top-i.offset().top-a.position().top+n.height()/2)}else{a.css("top",n.offset().top-i.offset().top)}}});CREATE.EditExitLink=function(){var e="",t=$("#exitLinkForm"),i=false,n="";function a(){return{text:$("#exitText").val(),enabled:true}}function o(e){var n=t.find(".save");n.prop("disabled",!e).toggleClass("disabled",!e);i=!e}return{init:function(){if(n===""){n=CREATE.survey.get("design_settings").exit_title.text}},provideDefault:function(e){var t=n;if(!t){t=n}if(e){e.text=t;return e}return t},load:function(){e=$(".exit-survey").html();var t=CREATE.survey.get("design_settings").exit_title.text;$("#exitText").val(t)},save:function(){var e=CREATE.survey.get("design_settings"),t=a(),n=$("#exitText"),s=$.Deferred(),r;if(i){return}o(false);if(t.text){r=$.extend({},e,{exit_title:t})}else{n.parent().addClass("error");o(true);return s.reject()}return CREATE.survey.update({design_settings:r},{is_design_setting:true}).done(function(){CREATE.EditExitLink.updateUI();CREATE.EditSurvey.clearEditMode()}).always(function(){o(true)})},updateUI:function(){var e=CREATE.survey.get("design_settings").exit_title.text;$(".exit-survey").html(e)},cancel:function(){$(".exit-survey").html(e)}}}();CREATE.LivePreviewAdd=function(){var e,t=$("#livePreview"),i;function n(){if(!CREATE.survey.hasPermission("edit")){return}t.find(".questions").sortable({placeholder:"ui-state-highlight",start:a,tolerance:"pointer",items:".question-row",cancel:".editing",distance:15,stop:o,axis:"y",connectWith:"#livePreview .questions",out:function(e,t){if(t.helper){t.helper.data("overSortable",true)}}})}function a(e,t){var n=t.item.attr("rel");if(i&&n){$("body").addClass("ds"+n)}}function o(t,n){var a=n.item,o=function(){s(a)},r,l=$(document.activeElement);if(l.hasClass("rte")){l.trigger("rteBlurred",[l])}else{l.trigger("blur",[l])}if(a.parent("#livePreview .questions").length>0){a.removeAttr("style");if(i&&!a.hasClass("question-row")){e.onDragAdd(a,i)}else{if(e.isOpen()){r=e.saveEditMode({afterSaveCallback:o});if(!r){$("#livePreview .questions").sortable("cancel").find(".ui-draggable").remove()}}else{o()}}if(a.hasClass("qb-li")){SM.Logger.enqueue({action_type:"drag_accordion_qb_question",question_id:a.find("[data-quid]").attr("data-quid"),ui_trigger:"accordionQB"})}else{if($(t.toElement).hasClass("dragQuestionName")){SM.Logger.enqueue({action_type:"drag_accordion_builder_question",question_type:a.attr("rel"),ui_trigger:"accordionBuilder"})}}}else{a.remove()}i=false}function s(e){var i=e.find(".qn"),n,a,o;if($(".questions").find(e).length===0||i.length===0){SM.Logger.remoteLog({Name:"ReorderQuestionsError",Message:"Error reordering questions. Invalid drop $el.",el:e?e:"is null/undef",el_classes:e.attr("class"),el_length:e.length,el_parent_classes:e.parent().attr("class")},"info");return}n=CREATE.utils.getQuestionIdForEl(e);a=CREATE.utils.getPageIdForEl(e);o=e.prevUntil(".drag").length+1;CREATE.pages.getQuestion(n,true).done(function(e){var i=e.get("page_id").toString(),s=e.get("position");if(i===a&&o===s){return}CREATE.survey.moveQuestion(n,i,a,o).done(function(){t.trigger("previewChanged")}).fail(function(e){var t=e.appError.name,a=CREATE.pages.get(i),o=a.questions.at(s);if(t!=="QuestionPerPageLimitException"){t="Exception"}setTimeout(function(){CREATE.Notifications.showErrorNotification({messageKey:t});var e=$("#question-field-"+n).closest(".question-row"),a;e.removeAttr("style");if(o){a=$("#question-field-"+o.id).closest(".question-row");e.insertBefore(a)}else{$("#pageid-"+i+" .questions").append(e)}},1e3)})})}function r(){$("#livePreview div.addNewPage").droppable({accept:".dtap",activeClass:"ui-state-active",hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(){$(this).trigger("dragToAddPage")}})}function l(){$("#create").on("clickToAdd",function(t,i,n){CREATE.utils.handleOpenEditors(function(){e.onAdd(i,null,n)});SM.Logger.enqueue({action_type:"click_accordion_builder_question",question_type:i,ui_trigger:"accordionBuilder"})}).on("dragToAdd",function(e,t){i=t||true}).on("banked_questions_add",function(t,i){CREATE.utils.handleOpenEditors(function(){e.onAddFromQuestionBank({qbData:i.qbData,recoEnginePosition:i.recoEnginePosition,name:i.name})})});t.on("previewChanged",function(e,t){if(t&&t.actions){if(t.actions.indexOf("sort-targets")>-1){n()}if(t.actions.indexOf("sort-pages")>-1){r()}}})}return{init:function(){e=CREATE.QuestionEditor;n();r();l()}}}();CREATE.LivePreviewEdit=function(){var e=$("#graveyard .questionActions").first().clone(),t=$("#livePreview"),i=$("#create"),n;function a(e,t){var i;if(n){return}i=e.closest(".qn");i.find(".question-actions-menu-btn").removeClass("open");r(i,true);CREATE.QuestionEditor.autoSaveAndEdit(CREATE.utils.getQuestionIdForEl(i),t)}function o(){t.on("click","[data-action=question_actions]",function(e){var t=$(e.target).closest("[data-action=question_actions]");if(!t.data("actionMenu")){t.actionMenu({templateID:"question-actions-menu-template",position:{my:"center top",at:"left bottom",collision:"none none"}}).off("actionMenu.actionSelected actionMenu.menuInit actionMenu.afterOpen actionMenu.submenuOpened").on("actionMenu.actionSelected",function(e){var t=e.actionMenu.get("menuView").get("selectedAction");if(t==="Delete"){d(CREATE.utils.getQuestionIdForEl($(this)));SM.Logger.enqueue({action_type:"click_question_action_delete",ui_trigger:"editorQuestionDelete"})}else if(t==="UpgradeToEdit"){__UPGRADE.openUpgradeModal("upgradeEditQBQ");SM.Logger.enqueue({action_type:"click_question_action_edit_qbq_upgrade",ui_trigger:"upgradeEditQBQ"})}else{a($(this),t);SM.Logger.enqueue({action_type:"click_question_action_"+t.toLowerCase(),ui_trigger:"editorQuestionActions"})}});t.data("actionMenu").open();event.preventDefault()}})}function s(t){if(!t.hasClass("hvr")){t.prepend(e);l(t);t.addClass("hvr");if(t.css("margin-left")!=="0px"){t.find(".questionActions").css("margin-left","-"+t.css("margin-left"))}else{t.find(".questionActions").css("margin-left","")}}}function r(e){e.removeClass("hvr");e.children(".questionActions").remove()}function l(e){var t=e.attr("id").replace("question-field-",""),i;CREATE.pages.getQuestion(t,true).done(function(t){var n=t.get("type"),a=t.get("display_options");i=CREATE.QuestionEditor.typeHasView(n,"EditorLogic",a);if(CREATE.stepName==="draft"){e.find(".question-action-btns .logic").toggle(i)}else{e.find(".questionActions .logic").toggle(i)}})}function d(e,t){var i=$.extend({hasPermission:false,notificationKey:"delete_question",isNew:false},t);if(!n){n=true;CREATE.Ajax.deleteQuestion(e,i.hasPermission,i.notificationKey).done(function(e){if(e.question.is_slider){SM.Logger.logDeleteSlider({question:e.question})}else if(e.question.is_emoji){SM.Logger.logStarRating({question:e.question,action:"delete_star_rating_question"})}else if(e.question.is_file_upload){SM.Logger.logFileUpload({question:e.question,action:"delete_file_upload_question"})}if(e.advanced_logic){CREATE.survey.set("advanced_logic",e.advanced_logic)}if(e.quiz_options){CREATE.QuizWarning.toggleSurveyQuizMode(e.quiz_options.is_quiz_mode)}CREATE.pages.getQuestion(e.question.id,true).done(function(e){u(e,i.isNew)})}).fail(function(t){g(t,e)})}}function u(e,a){var o=1,s=CREATE.utils.getQuestionElForId(e.id),r=CREATE.utils.getQuestionContainer(s),l=[],d=[],u=CREATE.pages.get(e.get("page_id"));__UPGRADE.handleUpgradeState(-1);if(!a){if(e.get("funneled_to_questions")&&e.get("funneled_to_questions").length>0){d=CREATE.survey.getFunnelReceiverIds([e.id]);__UPGRADE.handleUpgradeState(-d.length);o+=d.length;if(!CREATE.survey.isSinglePageMode()){$.each(d,function(e,t){var i=CREATE.utils.getQuestionElForId(t),n=CREATE.pages.get(CREATE.utils.getPageIdForEl(i));n.removeQuestionLocal(t,true);CREATE.utils.getQuestionContainer(i).remove()})}else{CREATE.pages.collapsePagesAfterPage(e.get("page_id"))}}if(e.get("funneling")&&e.get("funneling").length>0){l=e.getFunnelSenderIds();if(!CREATE.survey.isSinglePageMode()){CREATE.survey.removeReceiverFromFunnelSenders(e.id,l);t.trigger("settingUpdated")}else{CREATE.pages.collapsePagesBeforePage(e.get("page_id"))}}CREATE.survey.updateLocalFunnels(e.id,l,[]);$.each(d,function(e,t){var i=CREATE.survey.get("funneling").receiver_map,n=i?i[t]:[];CREATE.survey.updateLocalFunnels(t,n,[])})}u.removeQuestionLocal(e.id,true);t.trigger("questionDeleted",[e]);i.trigger("quizWarningQuestionCheck");if(!a){i.trigger("questionsDeleted",o);r.animate({opacity:0,height:0,padding:0,border:0},200,"linear",function(){r.remove();t.trigger("previewChanged");n=false})}else{r.remove();t.trigger("previewChanged");n=false}}function c(e){var t;if(e.in_quota){t="question_in_quota"}else if(e.has_responses&&e.in_logic){t="question_in_logic_and_has_responses"}else if(e.in_logic){t="question_in_logic"}else if(e.has_responses&&e.funnels_to_questions){t="question_funnels_to_questions_and_has_responses"}else if(e.funnels_to_questions){t="question_funnels_to_questions"}else if(e.has_responses){t="question_has_responses"}return CREATE.Translations.get("delete_confirm","default")[t]["default"]}function f(e){var t;if(e.in_quota){t=CREATE.Translations.get("close","default")["default"]}else if(e.funnels_to_questions){t=CREATE.Translations.get("delete_all","default")["default"]}else{t=CREATE.Translations.get("delete_question","default")["default"]}return t}function p(e,t){var i=CREATE.survey.getFunnelReceiverIds([e]),n,a="question_funnels_to_questions";if(t.has_responses){a="question_funnels_to_questions_and_has_responses"}n=CREATE.Translations.get("delete_confirm_heading","default")[a]["default"];n=$("<div>").html(n).addClass("dialogHeading");n.find(".numQs").text(i.length+1);return n}function g(e,t){var i=e.appError.name,a,o=CREATE.utils.getQuestionElForId(t),s;if(i==="CannotDeleteQuestionException"){a=e.appError.validation;s=SM.Views.create(SM.ConfirmDialogView,{isModal:true,width:500,message:c(a),confirmText:f(a),templateID:"confirm-dialog-template"});s.$el.addClass("dialog-a");if(a.in_quota){s.$el.find(".cancel-btn").addClass("hide");s.$el.on("confirmDialog.confirm",function(){n=false;s.close()})}else{if(a.funnels_to_questions){s.$el.find("p").prepend(p(t,a))}s.$el.on("confirmDialog.confirm",function(){n=false;d(t,{hasPermission:true});s.close()})}s.$el.on("confirmDialog.cancel",function(){n=false;s.close();r(o)}).on("confirmDialog.beforeClose",function(){n=false;r(o)});s.open()}else{CREATE.Notifications.showErrorNotification({messageKey:"Exception"})}}function h(){if(!CREATE.survey.hasPermission("edit")){$(".qn").addClass("read-only");$(".qn textarea, .qn select, .qn input").prop("disabled",true);return}t.on("mouseenter",".qn",function(){var e=$(this),t=e.hasClass("editing"),i=e.hasClass("loading"),a=e.closest(".page").hasClass("inactivePage");if(!t&&!i&&!n&&!a){s($(this))}}).on("mouseleave",".qn",function(){if(!$(this).hasClass("editing")&&!n){r($(this))}}).on("click",".qn",function(e){if(!$(this).hasClass("editing")&&e.target.nodeName!=="A"&&!$(e.target).closest(".indicators").length&&!$(e.target).closest(".question-actions-menu-btn").length){$(this).find(".question-actions-menu-btn").removeClass("open");a($(this),"Edit");SM.Logger.enqueue({action_type:"click_survey_editor_edit_question",ui_trigger:"surveyEditor"})}}).on("click",".questionActions a, .question-action-btns a",function(e){$(this).closest(".question-row").find(".question-actions-menu-btn").removeClass("open");if(this.name==="Delete"){d(CREATE.utils.getQuestionIdForEl($(this)));SM.Logger.enqueue({action_type:"click_question_action_delete",ui_trigger:"editorQuestionDelete"})}else if(this.name==="UpgradeToEdit"){__UPGRADE.openUpgradeModal("upgradeEditQBQ");SM.Logger.enqueue({action_type:"click_question_action_edit_qbq_upgrade",ui_trigger:"upgradeEditQBQ"})}else{a($(this),this.name);SM.Logger.enqueue({action_type:"click_question_action_"+this.name.toLowerCase(),ui_trigger:"editorQuestionActions"})}e.stopPropagation();e.preventDefault()}).on("newQuestionCancelled",function(e){var t=e.question;if(t.isBanked()){d(e.question.id,{hasPermission:true,notificationKey:null,isNew:true})}else{u(t,true)}})}return{init:function(){if(CREATE.stepName==="draft"){o();SM.Tooltips.enable({selector:".question-action-icon",delay:300,fadeIn:false,fadeInTime:300})}h()}}}();CREATE.EditPrevDoneNext=function(){var e=$("#graveyard").find(".surveyEditActions").find('[name="Edit"]'),t=$("#livePreview"),i=$("#donePrevNextForm"),n=false;function a(){t.on("previewChanged",function(){o()})}function o(){if(!CREATE.survey.hasPermission("edit")){return}$(".survey-submit-actions").each(function(){var t=$(this);if(t.children('[name="Edit"]').length===0){t.append(e.clone())}})}function s(e){var t=i.find(".save");t.prop("disabled",!e).toggleClass("disabled",!e);n=!e}return{init:function(){o();a()},load:function(){$.each(["done","prev","next"],function(e,t){var i=$("<div/>").html(CREATE.survey.get("design_settings")[t+"_title"]).text();$("#"+t+"Text").val(i)})},save:function(){var e=true,t={},i=$.Deferred();if(n){return}s(false);$.each(["done","prev","next"],function(i,n){var a=$("#"+n+"Text"),o=$.trim(a.val());a.parent().toggleClass("error",!o);e=e&&!!o;t[n+"_title"]=o});if(!e){s(true);return i.reject()}t=$.extend({},CREATE.survey.get("design_settings"),t);return CREATE.survey.update({design_settings:t}).done(function(e){CREATE.EditPrevDoneNext.updateUI(e.survey);CREATE.EditSurvey.clearEditMode()}).always(function(){s(true)})},updateUI:function(e){$.each(["done","prev","next"],function(t,i){var n=e.design_settings[i+"_title"];$(".survey-submit-actions ."+i+"-button").text(n)})},cancel:function(){}}}();CREATE.LivePreview=function(){var e=$("#livePreview"),t=$("#create"),i=null;function n(){if(CREATE.stepName!=="theme"){CREATE.QuestionEditor.init();CREATE.LivePreviewEdit.init();CREATE.LivePreviewAdd.init();CREATE.PageAdd.init();a();s();l();m();g();d();u()}CREATE.PageControls.init();CREATE.EditSurvey.init();p()}function a(){var i=e.find(".add-question-btn"),n,a,o,s,r,l=-60,d=9;$.each(i,function(i,u){a=$(u);o=a.find("a[data-add-q-menu]");if(!CREATE.survey.hasPermission("edit")){$(u).addClass("read-only");a.find("a").removeClass("teal");return}if(!o.data("menu-added")){o.actionMenu({templateID:"add-q-action-menu-template",position:{my:"center top",offset:l+" "+d,collision:"none none"}}).on("actionMenu.afterOpen",function(t){var i=$(t.actionMenu._menu.el),n=$(window),a=$(this),o,s=n.height(),r=i.height(),l=i.offset().top;e.on("click",".questionActions a",function(){t.actionMenu.close()});a.addClass("bottom-arrow");if(n.scrollTop()+s<=l+r){o=l+a.height()+2*d-(s-r);n.scrollTop(o)}}).on("actionMenu.afterClose",function(e){$(e.actionMenu.$el).removeClass("bottom-arrow")}).on("actionMenu.actionSelected",function(e){e.preventDefault();SM.Logger.enqueue({action_type:"click_step2_add_new_question_menu",q_type:e.action});if(e.$action.hasClass("upgrade")){n=__UPGRADE.getUpgradeUrl(e.action,"add_question_menu");__UPGRADE.openUpgradeModal(e.action,n);return}if(e.$action.data("qb-name")){t.trigger("banked_questions_add",{name:e.$action.data("qb-name")})}else{r=CREATE.utils.getPageIdForEl($(e.target));t.trigger("clickToAdd",[e.action,r])}});o.data("menu-added",true);a.droppable({tolerance:"intersect",drop:function(e,i){if(i.helper&&i.helper.data("overSortable")||i.draggable.hasClass("question-row")||i.draggable.attr("rel")==="PageBreak"){i.helper.removeData("overSortable");return}SM.Logger.enqueue({action_type:"drag_step2_add_new_question_btn",q_type:i.draggable.attr("rel")});r=CREATE.utils.getPageIdForEl($(e.target));if(i.draggable.data("qb-name")){t.trigger("banked_questions_add",{name:i.draggable.data("qb-name")})}if(i.draggable.hasClass("qb-li")){s=i.draggable.find("[data-quid]").data("quid");$("#question-bank-results").find('[data-quid="'+s+'"]').click()}else{if(i.draggable.attr("rel")){t.trigger("clickToAdd",[i.draggable.attr("rel"),r])}}},over:function(e,t){if(t.helper){t.helper.removeData("overSortable")}}})}})}function o(e){var t=CREATE.utils.getPageIdForEl($(e.target));if(!CREATE.survey.hasPermission("edit")){return}if(!i){i=SM.Views.create(SM.DialogView,{isModal:true,closeBtn:true,height:562,width:864,templateID:"copyPasteModal"});i.$el.on("dialog.afterClose",function(){SM.Logger.enqueue({action_type:"copy_paste_step2_close_dialog"})});i.open();CREATE.Draft.init({currentPageId:t,dialog:i})}else{CREATE.Draft.setUserAndSurveyState(t);i.open();CREATE.Draft.toggleWarningMessage();CREATE.Draft.renderExisting()}SM.Logger.enqueue({action_type:"copy_paste_step2_open_dialog"})}function s(){e.on("click",".add-bulk-questions",function(e){CREATE.utils.handleOpenEditors(o.bind(this,e))})}function r(){var t=CREATE.pages,i=t.length,n=CREATE.survey.get("design_settings").question_numbering,a=CREATE.survey.get("design_settings").page_numbering,o=CREATE.stepName==="draft"?"page_title_displayed_short":"page_title_displayed",s=CREATE.stepName!=="theme"?CREATE.Translations.get(o,null)["default"]:"",r=1;if(CREATE.survey.isSinglePageMode()){t=new CREATE.collections.Pages(t.get(CREATE.survey.pageInView));r=t.at(0).get("first_question_number")||1}t.each(function(e){var t=CREATE.utils.getPageElementFromId(e.id),o,l;t.toggleClass("first-page",e.get("position")===1).toggleClass("last-page",e.get("position")===i);if(a){t.find(".page-number").text(e.get("position")+".")}if(CREATE.stepName==="draft"){t.toggleClass("empty",e.get("heading")==="")}if(e.get("heading")===""){t.find(".page-title").html(s)}if(e.get("sub_heading")===""){t.find(".page-subtitle").html("&nbsp;").addClass("hide")}o=t.find(".progress-bar-container tr");l=Math.round(e.get("position")*100/i)+"%";o.find("td.progress-bar-pages").html(e.get("position")+" / "+i);o.find(".progress-bar-indicator").css("width",l);o.find("td.progress-bar-percentage").html(l);if(n===1){r=1}e.questions.each(function(e){var t;if(!e.isPresentation()){t=$("#question-field-"+e.id);if(t.hasClass("editing")){$(".questionPos").text(r)}else{t.find(".question-number").html(r+'<span class="question-dot">.</span>')}e.set({display_number:r});++r}})});e.toggleClass("singleQuestion",i===1&&CREATE.survey.get("question_count")===1);e.trigger("previewUpdated")}function l(){$(".question.questionLogicApplied").removeClass("questionLogicApplied");$.each(CREATE.survey.get("question_logic"),function(e,t){$("#question-field-"+t.question_id).addClass("questionLogicApplied")})}function d(){var t=CREATE.survey.get("page_randomization"),i=t.enabled&&t.pages_applied==="all";e.toggleClass("pagesRandomized",i);CREATE.pages.each(function(e){var t=CREATE.utils.getPageElementFromId(e.id),n,a,o,s,r;if(t.length>0){n=e.get("question_randomization");a=n.enabled&&n.questions_applied==="all";o=e.getPageLogic();s=e.getAdvancedLogic();r=CREATE.survey.getBlockForPage(e.id);t.toggleClass("pageLogicApplied",!!o||!!s).toggleClass("pageRandomized",!i&&e.isRandomized()).toggleClass("questionsRandomized",a).toggleClass("pageInBlock",!!r);t.find(".qn").each(function(e,t){var i=$(t),n=CREATE.utils.getQuestionIdForEl(i);CREATE.pages.getQuestion(n,true).done(function(e){var t,n;if(e){t=e.get("funneled_to_questions")||[];n=e.get("funneling")||[];i.toggleClass("questionRandomized",!a&&e.isRandomized());i.toggleClass("isFunnelSender",t.length>0);i.toggleClass("isFunnelReceiver",n.length>0);if(e.isSlider()){if(CREATE.survey.hasPermission("edit")){i.find("[data-question-slider]").sliderQuestion()}else{i.find("[data-question-slider]").on("click","a",function(e){e.preventDefault()})}}}})})}})}function u(){e.find(".funnel-text-open-ended").text(CREATE.Translations.get("funneled_other_answer")["default"])}function c(){e.find(".survey-page").each(function(e,t){var i=$(t),n=i.find(".qn").length,a=$.trim(i.find(".page-subtitle").text());i.find(".blankPage").toggleClass("hide",n>0||a!=="")})}function f(){var e=tinycolor(this.get("theme").styles.survey_page["background-color"]),t=e.toHsv();if(t.v===1){$(".survey-page").addClass("survey-page-white");$(".survey-page").removeClass("survey-page-dark")}else if(t.v<.5){$(".survey-page").removeClass("survey-page-white");$(".survey-page").addClass("survey-page-dark")}else{$(".survey-page").removeClass("survey-page-white");$(".survey-page").removeClass("survey-page-dark")}}function p(){if(CREATE.survey.hasBrandRefreshTheme()){$("div.question-row").removeClass("overlay");$("#livePreview article").fadeTo(300,1)}CREATE.LivePreview.resetUIForBrandRefresh()}function g(){var t=CREATE.survey.isSurveyQuizMode(),i;e.find(".question.quizQuestionApplied").removeClass("quizQuestionApplied");if(!t){return}i=h();i.forEach(function(e){$("#question-field-"+e).addClass("quizQuestionApplied")})}function h(){var e=CREATE.survey.isSurveyQuizMode(),t=[];if(!e){return false}CREATE.pages.each(function(e){e.questions.each(function(e){if(e.isQuizEnabled()){t.push(e.id)}})});return t}function m(){var e=CREATE.survey.get("quota");$("#livePreview .question.hasQuota").removeClass("hasQuota");if(e&&e.questions){$.each(e.questions,function(e,t){$("#question-field-"+t.question_id).addClass("hasQuota")})}}function _(){$("#create").on("click",".preview-button",function(e){v(this.href);e.preventDefault()})}function v(e){var t=window.open(e,"preview_and_test","height=600, width=1040, toolbar=0, location=0, status=1, scrollbars=1, resizable=1");if(t){t.focus();SM.Logger.immediateLogThrottler({action_type:"click_preview_and_test",ui_trigger:"step2PreviewAndTest"})}}function E(e){var t=window.open(e,"_blank");if(t){t.focus();SM.Logger.immediateLogThrottler({action_type:"click_survey_diagnostics",ui_trigger:"step2PreviewAndTest"})}}function C(){e.on("click",".survey-footer a",function(e){e.preventDefault();if(CREATE.survey.hasBrandRefreshTheme()){$("#accOptions .press").trigger("click")}})}function q(){e.on("click","a[data-add-q-menu]",function(e){e.preventDefault()});if(!CREATE.survey.hasPermission("edit")){return}var t=$('#previewButton[data-action="preview_actions"]');if(!t.data("actionMenu")){t.actionMenu({templateID:"preview-actions-menu-template",position:{collision:"flip none"}}).on("actionMenu.actionSelected",function(e){if(e.action==="preview_survey"){v(e.$action.attr("data-target"))}else if(e.action==="survey_diagnostics"){E(e.$action.attr("data-target"))}})}}function b(){e.on("previewChanged",function(){a();c();r();l();m();d();g()});e.on("settingUpdated",function(){d()});e.on("quotaChanged",function(){m()});e.on("quizChanged",function(){g()});e.on("questionAdded questionDeleted",function(){$("#sendSurvey").toggleClass("teal",CREATE.survey.get("question_count")>0)});e.on("click",".main-add-question-cta",function(e){var i;e.preventDefault();if(!CREATE.survey.hasPermission("edit")){return}SM.Logger.enqueue({action_type:"click_step2_add_new_question_btn",q_type:$(this).data("action")});i=CREATE.utils.getPageIdForEl($(e.target));t.trigger("clickToAdd",[$(this).data("action"),i])});e.on("click mouseover mouseleave touchstart touchend",".click-blocker",function(e){e.preventDefault();e.stopPropagation();return false})}function y(){var e=CREATE.Translations.translations.defaults.feature_titles,t='ul[data-behavior=tbyb-feature-list] li strong:contains("'+e.footer_removed["default"]+'")';$("article.survey-page").addClass("brand-refresh");$("div.survey-title-container").not(".sm-header").addClass("hide");$("div.sm-header").removeClass("hide");$("div.top-logo-section").addClass("hide");$("form.logoSurveySettings select#logoSize").val("100").prop("disabled","disabled");$("form.logoSurveySettings select#logoSize option[value=100]").text("Small (35px)");$("form.logoSurveySettings select#logoPosition").val("baseline").prop("disabled","disabled");$("div.page-title-container").addClass("hide");$("section#surveyDisplaySettings li[rel=page_title_enabled], section#surveyDisplaySettings li[rel=page_numbering]").hide();$("h3.page-subtitle").addClass("hide");$($("#surveyTitleForm [data-title-configuration] select")[0]).prop("disabled","disabled");$(".sm-header .sm-exit-button").removeClass("hide");$(".sm-header .exit-button-container").addClass("hide");if($(".sm-exit-button:visible").length>0){$(".surveyEditActions").addClass("surveyEditActionsWithExit")}else{$(".surveyEditActions").removeClass("surveyEditActionsWithExit")}$("form.progressSurveySettings section:not(.toggle) input").prop("disabled","disabled");$("form.progressSurveySettings input[type=checkbox]").prop("checked",false);$(t).text(e.footer_branding_removed["default"]);$("#footer_enabledMasterToggle span.listText").text(e.footer_branding["default"]);T();$('li[rel="IntroPage"]').hide()}function T(){$('form.themeColors a[rel="styles.logo.background-color"]').hide();$('form.themeColors a[rel="styles.page_title.background-color"]').hide();$('form.themeColors a[rel="styles.page_description.color"]').hide();$('form.themeColors a[rel="styles.progress_bar_indicator.background-color"]').hide();$('form.themeColors a[rel="styles.progress_bar.border-color"]').hide();$('form.themeColors a[rel="styles.progress_bar.background-color"]').hide();$('form.themeColors a[rel="styles.page_title.color"]').hide();$('form.themeSections a[rel="themeTypography"]').hide();$('form.themeColors a[rel="styles.progress_bar.color"]').hide()}return{init:function(){n();b();q();_();C();CREATE.LivePreview.updatePageHeadings();CREATE.survey.listenTo(CREATE.survey,"change:theme",f)},updatePageHeadings:function(e){var t=CREATE.pages,i=CREATE.stepName==="draft"?"page_title_displayed_short":"page_title_displayed",n=CREATE.stepName!=="theme"?CREATE.Translations.get(i,null)["default"]:"";$(".page").each(function(i,a){var o=$(a),s;if(e){o.find(".survey-page-header").html(e[i])}s=o.find(".page-title");if(CREATE.stepName==="draft"){s.toggleClass("empty",t.at(i).get("heading")==="")}if(t.at(i).get("heading")===""){o.find(".page-title").html(n)}if(t.at(i).get("sub_heading")===""){o.find(".page-subtitle").html("&nbsp;").addClass("hide")}})},updateProgressBars:function(e){var t=CREATE.survey.get("design_settings").progress_bar,i=t.location===1,n=t.location===2,a=CREATE.survey.hasBrandRefreshTheme();$(".progress-container").each(function(o,s){var r=$(s),l=o%2===0,d=!l;if(a){r.addClass("hide")}else if(t.enabled&&(i&&l||n&&d)){r.html(e.shift()).removeClass("hide")}else{r.addClass("hide")}});if(a){$(".sm-footer .sm-footer-progress-container").each(function(e,i){$(i).toggleClass("hide",!t.enabled)})}},resetUIForBrandRefresh:function(){if(CREATE.survey.hasBrandRefreshTheme()){y()}},renumberPages:r,getQuizIds:h}}();CREATE.EditSurveyTitle=function(){var e=$("#livePreview"),t=$("#surveyTitleForm"),i=false;function n(){g()}function a(){var e=CREATE.survey.get("title");e.text=$.trim(CREATE.utils.htmlEncode(CREATE.Rte.getContent("surveyTitle",true)));e.html=CREATE.Rte.getContentForSave("surveyTitle");e.horizontal_align=$("#surveyTitleAlignment").val();return e}function o(){var e=parseInt($("#surveyCategory").val(),10)||0,t=$("#surveyCategory option:selected").text();if(e===0){return{}}return{category_id:e,name:t}}function s(){if(!$("#nickname").prop("checked")){return""}var e=$("#surveyNickname").val();return CREATE.utils.stripTags(e)}function r(){var e=CREATE.survey.get("title"),t=e.html||e.text;$("#surveyTitle").html(t)}function l(){var e=CREATE.survey.get("category");if(!$.isEmptyObject(e)){$("#surveyCategory").val(e.category_id)}}function d(){var e=CREATE.survey.hasBrandRefreshTheme()?"left":CREATE.survey.get("title").horizontal_align;$("#surveyTitleAlignment").val(e);f(e)}function u(){var e=CREATE.survey.get("nickname");if(e.length>0){$("#surveyNickname").val(CREATE.utils.htmlDecode(e));$("#nickname").prop("checked",true);$("#surveyNickname").removeClass("hide")}else{$("#surveyNickname").val("");$("#nickname").prop("checked",false)}}function c(e){var n=t.find(".save");n.prop("disabled",!e).toggleClass("disabled",!e);i=!e}function f(e){var t=e==="center",i=$(".page-title-container .exit-survey").length>0;$("#surveyTitle, .addLogoHere").toggleClass("centered",t);$(".top-logo-section").toggleClass("center-text",t);$(".survey-title-container").toggleClass("survey-title-align-center",t);$(".exit-survey").toggleClass("exit-survey-float",!t||i)}function p(e){var t=$("#surveyNickname");if(e){t.removeClass("hide").focus()}else{t.addClass("hide").val("");setTimeout(function(){$("#surveyTitle").selection("end").focus()},30)}}function g(){e.on("mousedown",".nicknameCheckbox label",function(e){e.preventDefault()}).on("change","#nickname",function(e){p(e.target.checked)}).on("rteFocused","#surveyTitle",function(){$(".surveyTitleSettings").addClass("st-active")
;if(CREATE.survey.hasRtlLanguage()||CREATE.Rte.hasRtlDirection($("#surveyTitle"))){$(".surveyTitleSettings").addClass("rtl")}}).on("rteBlurred","#surveyTitle",function(){$(".surveyTitleSettings").removeClass("st-active rtl")}).on("change","#surveyTitleAlignment",function(e){f($(e.target).val())})}return{init:n,load:function(){r();l();d();u()},save:function(){var e,t=$.Deferred();if(i){return}c(false);if($.trim(CREATE.Rte.getContent("surveyTitle",true))===""){$(".surveyTitleSettings").addClass("error");c(true);return t.reject()}e={title:a(),category:o(),nickname:s()};return CREATE.survey.update(e).done(function(e){CREATE.EditSurveyTitle.updateUI(e.survey);CREATE.EditSurvey.clearEditMode()}).always(function(){c(true)})},updateUI:function(e){var t=e.category,i=e.title;$(".survey-header-title").html(e.nickname||i.text);$(".survey-title").html(i.html||i.text);$("#qbc li").removeClass("primed");if(t){$.each($("#qbc li"),function(e,i){i=$(i);if(i.attr("data-cid")===t.category_id){i.addClass("primed")}})}f(e.title.horizontal_align)},cancel:function(){f(CREATE.survey.get("title").horizontal_align)}}}();CREATE.EditPageHeading=function(){var e="",t="",i="",n=1,a=$("#pageTitleForm"),o=false;function s(e){var t=$(i).find(".page-subtitle");if($.trim(e)===""){t.addClass("hide");t.html("&nbsp;")}else{t.html(e);t.removeClass("hide")}}function r(e){var t=e,n="page_title_displayed";if(CREATE.stepName==="draft"){n+="_short";$(i).find(".page-title").toggleClass("empty",!t)}if(CREATE.stepName!=="theme"){t=t||CREATE.Translations.get(n,null)["default"]}$(i).find(".page-title").html(t)}function l(){var e=CREATE.Rte.getContentForSave("pageSubtitle"),t=$("<div>").html(e);if($(e).html()===""){return""}else{t.children("div").each(function(){if(!$(this).html()){$(this).html("<br/>")}});e=t.html();return e}}function d(e){var t=a.find(".save");t.prop("disabled",!e).toggleClass("disabled",!e);o=!e}return{init:function(){},load:function(){var a,o=$("#pageTitle"),s=$("#pageSubtitle");i=$("#editSurvey").closest(".page");if(!i.length){SM.Logger.remoteLog({Name:"PageHeadingLoadError",Message:"Error loading page heading editor. Invalid parent.",elem_parent_id:$("#editSurvey").parent().attr("id"),elem_parent_classes:$("#editSurvey").parent().attr("class"),elem_grandparent_id:$("#editSurvey").parent().parent().attr("id"),elem_grandparent_classes:$("#editSurvey").parent().parent().attr("class")},"error")}n=CREATE.utils.getPageIdForEl(i);e=$(i).find(".page-title").html();t=$(i).find(".page-subtitle").html();a=CREATE.pages.get(n);o.html(a.get("heading"));s.html(a.get("sub_heading"))},save:function(){var e,t=$.Deferred();if(o){return}d(false);if(CREATE.Rte.getContent("pageTitle").length>350){$("#pageTitleWrapper").addClass("error");d(true);return t.reject()}e={id:n,heading:CREATE.Rte.getContentForSave("pageTitle"),sub_heading:l()};return CREATE.PageActions.doPageRequest("update_page",e).done(function(e){if(e.inPageRequest){return}$("#livePreview").trigger("pageTitleUpdated").trigger("previewChanged");s(e.page.sub_heading);r(e.page.heading);CREATE.EditSurvey.clearEditMode()}).fail(function(){CREATE.Notifications.showErrorNotification()}).always(function(){d(true)})},cancel:function(){$(i).find(".page-title-container .page-title").html(e);$(i).find(".page-subtitle").html(t)}}}();CREATE.EditSurvey=function(){var e,t="",i=$("#survey_edit").html(),n,a=$("#graveyard .surveyEditActions").clone();function o(e,i){t=i;d(e);$("#step2").attr("class",t+" clearfix");c();r();l()}function s(){var e={editTitle:CREATE.EditSurveyTitle,editPageTitle:CREATE.EditPageHeading,editPageSubtitle:CREATE.EditPageHeading},t={editExit:CREATE.EditExitLink,editDone:CREATE.EditPrevDoneNext};if(CREATE.stepName==="draft"){n=e}else if(CREATE.stepName==="theme"){n=t}else{n=$.extend(e,t)}$.each(n,function(e,t){t.init()})}function r(){var e=$(".survey-title-container").css("background-color"),i=$(".page-title-container").css("background-color"),n=CREATE.stepName!=="draft"?$(".top-logo-section").outerHeight()+"px":"0px",a="-"+$("#editSurvey").outerHeight()+"px",o="-"+$("#editSurvey").outerWidth()+"px";if(t==="editTitle"){$("#editSurvey").css({top:a,"margin-top":n}).css("background-color",e)}else if(t==="editPageTitle"||t==="editPageSubtitle"){$("#editSurvey").css({top:a,"margin-top":n}).css("background-color",i)}else if(t==="editExit"){$("#editSurvey").css("right",o).css("background-color","EEE")}else if(t==="editDone"){$("#editSurvey").css("bottom",a).css("background-color",e).css("position","absolute")}setTimeout(function(){$("#editSurvey").css({top:"",bottom:"",right:""});$(".survey-page").addClass("editingSurvey")},30)}function l(){var e={editTitle:"surveyTitle",editExit:"exitText",editDone:"doneText",editPageTitle:"pageTitle",editPageSubtitle:"pageSubtitle"};setTimeout(function(){CREATE.Rte.focusRTE(e[t])},400)}function d(e){var t=e.closest(".survey-page");t.append(i);$("#editSurvey").find(".q").popout();CREATE.LivePreview.resetUIForBrandRefresh()}function u(){var e=n[t];return e.save()}function c(){var e,i,a=$("#surveyTitle"),o=$(".rte#pageTitle"),s=$(".rte#pageSubtitle"),r=n[t],l,d,u;r.load();if(t==="editTitle"){e="bold underline italic forecolor";i=CREATE.Rte.getThemedToolbar(e,"surveyTitle");CREATE.Rte.initRTE(a,{toolbar:i,fixed_toolbar_container:'[data-toolbar="surveyTitle"]',charLimit:250})}else if(t==="editPageTitle"||t==="editPageSubtitle"){e="bold underline italic forecolor";i=CREATE.Rte.getThemedToolbar(e,"pageTitle");CREATE.Rte.initRTE(o,{toolbar:i,fixed_toolbar_container:'[data-toolbar="pageTitle"]',charLimit:100});e="bold underline italic alignleft aligncenter alignright link forecolor advanced";i=CREATE.Rte.getThemedToolbar(e,"pageSubtitle");CREATE.Rte.initRTE(s,{toolbar:i,fixed_toolbar_container:'[data-toolbar="pageSubtitle"]',forced_root_block:"div",charLimit:4e3});l=CREATE.Rte.getContentElements(o);d=CREATE.Rte.getContentElements(s);u=l.toArray().concat(d.toArray());$.each(u,function(e,t){if(CREATE.Rte.containsDisallowedContent(t)){$("#pageTitleForm [data-warning-id=stripHtml]").removeClass("hide");return false}})}}function f(e,t){e.stopPropagation();e.preventDefault();CREATE.utils.handleOpenEditors(function(){o($(e.target),t)})}function p(e,t){var i=e.closest(".page"),n=i.find("#editSurvey").length>0,a=$("#step2"),o=a.is(t);return n&&o}function g(){if(!CREATE.survey.hasPermission("edit")){$(".survey-title-container, .page-title-container, .survey-submit-actions,"+" .page-subtitle, #restoreQuestions, .survey-header-title").addClass("read-only");e.on("click",".survey-submit-actions",function(e){e.preventDefault()}).on("click",".exit-survey",function(e){e.preventDefault()});return}e.on("click",".survey-title-container",function(e){if("editTitle"in n){f(e,"editTitle")}SM.Logger.enqueue({action_type:"click_survey_editor_add_survey_title",ui_trigger:"editorSurveyTitle"})}).on("click",".exit-survey",function(e){if("editExit"in n){f(e,"editExit")}}).on("click",".survey-submit-actions",function(e){if("editDone"in n){f(e,"editDone")}SM.Logger.enqueue({action_type:"click_survey_editor_navigation_button",ui_trigger:"editorNavigation"})}).on("click",".page-title-container",function(e){var t=$(e.target);if(!t.closest(".indicators").length&&!p(t,".editPageTitle, .editPageSubtitle")&&"editPageTitle"in n){f(e,"editPageTitle")}SM.Logger.enqueue({action_type:"click_survey_editor_add_page_title",ui_trigger:"editorPageTitle"})}).on("click",".page-subtitle",function(e){var t=$(e.target);if(!p(t,".editPageTitle, .editPageSubtitle")&&"editPageSubtitle"in n){f(e,"editPageSubtitle")}SM.Logger.enqueue({action_type:"click_survey_editor_edit_page_subtitle",ui_trigger:"editorPageTitle"})}).on("click","#editSurvey .save",function(e){e.preventDefault();u()}).on("click","#editSurvey .cancel",function(e){CREATE.EditSurvey.cancel();e.preventDefault()}).on("mouseenter",".survey-title-container, .page-title-container, .page-subtitle, .progress-container",function(){if(CREATE.survey.hasPermission("edit")){h($(this))}}).on("mouseleave",".survey-title-container, .page-title-container, .page-subtitle, .progress-container",function(){m($(this))}).on("click",".surveyEditActions a",function(e){e.preventDefault()});if(CREATE.stepName!=="theme"){e.on("mouseenter",".survey-title-container, .page-title-container, .page-subtitle, .progress-container",function(){h($(this))}).on("mouseleave",".survey-title-container, .page-title-container, .page-subtitle, .progress-container",function(){m($(this))});$("body").on("click",".survey-header-title",function(){CREATE.utils.handleOpenEditors(function(){o($(".survey-page").first(),"editTitle")})})}}function h(e){if(!e.hasClass("hvr")){e.prepend(a);e.addClass("hvr");CREATE.LivePreview.resetUIForBrandRefresh()}}function m(e){e.removeClass("hvr");e.find(".surveyEditActions").remove()}return{init:function(){e=$("#livePreview");s();g()},isOpen:function(){return $("#editSurvey:visible").length>0},save:function(){return u()},cancel:function(){var e=n[t];CREATE.EditSurvey.clearEditMode();e.cancel()},clearEditMode:function(){var e=$(".survey-page.editingSurvey");CREATE.Rte.findRTEs($("#editSurvey")).each(function(e,t){CREATE.Rte.destroyRTE(t.id)});e.removeClass("editingSurvey");$("#step2").attr("class","clearfix");e.find("#editSurvey").remove()}}}();CREATE.PageControls=function(){var e;function t(){if(CREATE.stepName!=="theme"){CREATE.PageLogic.init();CREATE.PageActions.init()}CREATE.PagePagination.init()}function i(){e.on("click",".pageControls a",function(e){var t=$(e.target).closest("a"),i=t.attr("data-action");switch(i){case"logic":case"more_actions":break;case"previous":case"next":CREATE.PagePagination.navigate(i,t);break}e.preventDefault()}).on("previewChanged",function(){n();a()}).on("pageTitleUpdated",function(){a()})}function n(){var t=e.find("[data-action=selectPage]"),i=e.find("[data-action=previous]"),n=e.find("[data-action=next]");if(CREATE.pages.length<=1){t.addClass("hide");i.addClass("hide");n.addClass("hide")}else{t.removeClass("hide");i.removeClass("hide");n.removeClass("hide")}}function a(){var e=[],t=[];o();CREATE.pages.each(function(i,n){var a=$("#pageid-"+i.id),o=a.find("[data-info=pageTitle]"),s=CREATE.utils.getPageHeader(i),r=CREATE.utils.htmlDecode(i.getHeading({truncate:50,usePlaceholder:false}));e.push($("<option />",{value:n+1,text:n+1+". "+r}));t.push({text:s,action:i.id});if(CREATE.stepName!=="theme"&&CREATE.stepName!=="draft"){o.text(CREATE.utils.getSuffixedPageTitle(i))}else{o.text("")}});if(CREATE.stepName!=="theme"){CREATE.PageActions.refreshPageList(e)}CREATE.PagePagination.refreshPageList(t)}function o(){e.find(".pageControls").each(function(){var e=$(this),t=CREATE.utils.getPageIdForEl(e),i=CREATE.pages.get(t),n=i.get("position");e.find("[data-info=pagePosition]").text(n)})}return{init:function(){e=$("#livePreview");t();i();n();a()}}}();CREATE.PageLogic=function(){var e;function t(){i();CREATE.PageLogicOverlay.init()}function i(){e.find("[data-action=logic]").each(function(e,t){var i=$(t);if(!i.data("actionMenu")){i.actionMenu({templateID:"page-logic-menu-template",position:{collision:"flip none"}}).on("actionMenu.menuInit",function(e){var t=e.actionMenu.get("menuView");t.$el.find(".q").popout()}).on("actionMenu.actionSelected",function(e){var t=CREATE.utils.getPageIdForEl(i),n=e.actionMenu.get("menuView").get("selectedAction");if(n.match(/^upgrade/)){__UPGRADE.openUpgradeModal(n)}else{CREATE.PageLogicOverlay.open(t,n)}SM.Logger.enqueue({action_type:"click_"+n.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace("_panel",""),ui_trigger:"editorLogicOptions"})})}})}function n(){e.on("openSkipLogic",function(e,t){CREATE.PagePagination.loadPage(t).done(function(){CREATE.PageLogicOverlay.open(t,"pageSkipPanel")})}).on("openQuestionRandom",function(e,t){CREATE.PagePagination.loadPage(t).done(function(){CREATE.PageLogicOverlay.open(t,"questionRandomPanel")})}).on("openPageRandom",function(){var e=CREATE.survey.pageInView;CREATE.PageLogicOverlay.open(e,"pageRandomPanel")}).on("previewChanged",function(){i();if(CREATE.PageLogicOverlay.isInitialized()){CREATE.PageLogicOverlay.close(false)}else{CREATE.PageLogicOverlay.init()}}).on("pageActionsOverlayOpened",function(){CREATE.PageLogicOverlay.close(false)})}return{init:function(){e=$("#livePreview");t();n()}}}();CREATE.PageLogicOverlay=function(){var e,t,i,n,a,o,s,r,l,d,u,c;d=window["js/create/step2/page/page_advanced_logic"];function f(){r=n.tabs().data("tabs");n.find(".q").popout()}function p(){n.on("click",".buttons a",function(e){var t=$(e.target).closest("a"),i=t.attr("data-action");switch(i){case"apply":if(CREATE.survey.hasPermission("edit")){M()}break;case"cancel":D();break}e.preventDefault()}).on("click",'a[data-action="clear"]',function(e){if(CREATE.survey.hasPermission("edit")){I()}e.preventDefault()}).on("click",'[data-action="adv-add"]',function(e){e.preventDefault();if(c&&!u&&CREATE.survey.hasPermission("edit")){c.editRule()}}).on("click",".logic-rule .list-item",function(e){var t=$(e.target).closest(".logic-rule");e.preventDefault();if(c&&!u&&CREATE.survey.hasPermission("edit")){c.editRule(t)}}).on("tabs.beforeClose",function(e){var t,i=e.opening;if($("#pageLogicContainer").data("tabs")._selectedTab==="pageSkipPanel"){if(c&&!u&&c.changed){t=SM.Views.create(SM.ConfirmDialogView,{isModal:true,message:CREATE.Translations.get("advanced_logic","default").unsaved_changes["default"],easyClose:false});t.$el.on("confirmDialog.confirm",function(){c.changed=false;$("#pageLogicContainer").data("tabs").open(i.key);t.close()}).on("confirmDialog.cancel",function(){t.close()});t.open();e.preventDefault()}}});n.find("input[name=questionRandom]").on("change",C);n.find("input[name=questionsAffected]").on("change",b);n.find("input[name=pageRandom]").on("change",function(){S();w();R()});n.find("input[name=pagesAffected]").on("change",function(){k();w()});n.on("change","input[name=randomizePage]",function(){w();R()});r.$el.on("tabs.beforeOpen",m);t.on("settingUpdated",function(){if(!n.hasClass("hide")){m()}})}function g(e){var a=m();a.always(function(){i.find(".pageControls").after(n);r.open(e);n.removeClass("hide");t.trigger("pageLogicOverlayOpened")});return a}function h(e){n.addClass("hide");if(e){t.trigger("showLogicAccordion")}}function m(){P();v();T();return _()}function _(){var t=e.get("page_logic")&&e.get("page_logic").enabled,i=e.get("page_logic")?e.get("page_logic").destination_page_id:null;if(t&&i){a.val(i)}else{U()}$("#excludeRandomPages").toggleClass("hide",!CREATE.survey.get("page_randomization").enabled);$("#excludeBlockPages").toggleClass("hide",CREATE.survey.get("blocks").length===0);if(d){c=new d.AdvancedLogic(e,$(".logic-rule-list",n));u=$(".logic-rule-list",n).hasClass("locked");return c.loadReferencedQuestions().always(function(){var t=c.renderRules(e);c.renderNoConditionSkipText();c.renderActionMenu();$("#advancedBranchingRules").toggleClass("hide",!t&&u)})}else{$(".skip-text",n).text(CREATE.Translations.get("advanced_logic","default").labels.no_condition_skip["default"]["default"]);$("#advancedBranchingRules").toggleClass("hide",u);return $.Deferred().resolve()}}function v(){n.find('[data-value="position"]').text(e.get("position"));E();C();q();o.closest(".panel").removeClass("error")}function E(){var t=e.get("question_randomization");if(t.enabled){$("input[name=questionRandom][value="+t.type+"]",n).prop("checked",true)}else{$("input[name=questionRandom][value=none]",n).prop("checked",true)}}function C(){var e=n.find("input[name=questionRandom]:checked").val();o.toggleClass("hide",e==="none")}function q(){var t=e.get("question_randomization").questions_applied,i={};if(t===null||t==="all"){o.find("input[name=questionsAffected][value=all]").prop("checked",true).trigger("change")}else{o.find("input[name=questionsAffected][value=questionList]").prop("checked",true).trigger("change");$.each(t,function(e,t){i[t]=true})}$("#questionRandomList label").remove();e.getQuestions().done(function(e){e.each(function(e){var t=y(e,i);$("#questionRandomList").append(t)})});b()}function b(){var e=n.find("input[name=questionsAffected]:checked").val();$("#questionRandomList").toggleClass("hide",e!=="questionList");if(!CREATE.survey.hasPermission("edit")){$("#questionRandomList").find("input").prop("disabled",true)}}function y(e,t){var i=t[e.id]?true:false,n=$($.trim($("#questionRandomMarkup").html())),a=n.find("input[name=randomizeQuestion]"),o=e.getDisplayNumber(true),s=e.getHeading({truncate:150});a.attr("value",e.id).prop("checked",i);o+=s;if(e.isLogicTarget()){o+=" ("+CREATE.Translations.get("has_skip_logic","default")["default"]+")";a.prop("disabled",true);n.addClass("disabled")}n.find("span").html(o).attr("title",e.get("heading").length>150?CREATE.utils.stripTags(e.get("heading")):"");return n}function T(){A();S();x();s.closest(".panel").removeClass("error");w();R()}function w(){var e=false,t=!$("input[name=pageRandom][value=none]",n).prop("checked"),i=n.find("input[name=pagesAffected]:checked").val();if(t){if(i==="all"){CREATE.pages.each(function(t){var i=t.isLogicDestination();if(i){e=true}})}else{$.each(B(),function(t,i){var n=CREATE.pages.get(i),a=n.isLogicDestination();if(a){e=true;return}})}}$("#randomizeWithLogicAlert").toggleClass("hide",!e)}function R(){var e=CREATE.survey.get("blocks").length>0||CREATE.survey.get("funneling").has_funnels;$("#randomizeWithExclusionAlert").toggleClass("hide",!e);if(CREATE.survey.hasPermission("edit")){$("[name=pagesAffected][value=all]").prop("disabled",e).closest("label").toggleClass("disabled",e)}if(e){$("[name=pagesAffected][value=pageList]").prop("checked",true).trigger("change")}}function A(){var e=CREATE.survey.get("page_randomization");if(e.enabled){$("input[name=pageRandom][value="+e.type+"]",n).prop("checked",true)}else{$("input[name=pageRandom][value=none]",n).prop("checked",true)}if(l.length===0){$("input[name=pageRandom]:not([value=none])").prop("disabled",true).closest("label").addClass("disabled")}else{if(CREATE.survey.hasPermission("edit")){$("input[name=pageRandom]").prop("disabled",false).closest("label").removeClass("disabled")}}}function S(){var e=n.find("input[name=pageRandom]:checked").val();s.toggleClass("hide",e==="none")}function x(){var e=CREATE.survey.get("page_randomization").pages_applied;if(e===null||e==="all"){s.find("input[name=pagesAffected][value=all]").prop("checked",true).trigger("change")}else{s.find("input[name=pagesAffected][value=pageList]").prop("checked",true).trigger("change");$.each(e,function(e,t){$("#pageRandomOption-"+t).prop("checked",true)})}k()}function k(){var e=n.find("input[name=pagesAffected]:checked").val();$("#pageRandomList").toggleClass("hide",e!=="pageList");if(!CREATE.survey.hasPermission("edit")){$("#pageRandomList").find("input").prop("disabled",true)}}function P(){var t=e.id,i=a.find("[data-marker]").first();l=[];a.find("option:not(.static_option)").remove();$("#pageRandomList label").remove();CREATE.pages.each(function(e,n){var a,o,s,r=CREATE.survey.getBlockForPage(e.id),d=e.getQuestionIdsWithFunneling("both");if(t!==e.id&&!e.isRandomized()&&!r){a=CREATE.utils.getPageHeader(e,n+1);o=$("<option />",{value:e.id,text:a});o.insertBefore(i)}if(!r&&d.length===0){s=$($.trim($("#pageRandomMarkup").html()));s.children("input").attr("id","pageRandomOption-"+e.id).attr("data-pageid",e.id);s.children("span").text(CREATE.utils.getPageHeader(e));$("#pageRandomList").append(s);l.push(e.id)}})}function M(){var e=r.get("selectedTab"),t=$.Deferred();switch(e){case"pageSkipPanel":return L();case"questionRandomPanel":return F();case"pageRandomPanel":return N()}return t.resolve()}function D(){h(true)}function I(){var e=r.get("selectedTab");switch(e){case"pageSkipPanel":U();break;case"questionRandomPanel":O();break;case"pageRandomPanel":z();break}}function L(){var t=a.val(),i=t===null||t==="description"?false:true,n,o,s={id:e.id,page_logic:{enabled:i,destination_page_id:t===null?null:parseInt(t,10)}};if(c&&!u){n=c.serialize();o=CREATE.survey.get("advanced_logic")||{};if(n.length){o[e.id]=n}else{delete o[e.id]}CREATE.survey.set("advanced_logic",n);s.page_logic.advanced=n}return CREATE.PageActions.doPageRequest("update_page",s).done(function(){if(s.inPageRequest){return}CREATE.PageLogicOverlay.close(true);$("#livePreview").trigger("settingUpdated");if(!i){CREATE.survey.removePageFromLogic(e.id)}else{CREATE.survey.updatePageLogic(e.id,t)}if(s.page_logic&&s.page_logic.advanced&&s.page_logic.advanced.length){$("#create").trigger("newCreateFeatureAdded",["advancedLogic"])}$("#progressBarWithLogicAlert").trigger("toggleLogicApplied")}).fail(function(e){var t,i={};try{t=JSON.parse(e.responseText);if(t.error.message.indexOf("advanced_logic too large")>0){i.messageKey="AdvancedLogicSizeLimitException"}}catch(e){}CREATE.Notifications.showErrorNotification(i)})}function F(){var t={},i={id:e.id},a=n.find("input[name=questionsAffected]:checked").val(),s=n.find("input[name=questionRandom]:checked").val(),r=$.Deferred(),l;if(s!=="none"){t.enabled=true;if(a==="all"){t.questions_applied=a}else{t.questions_applied=Q()}t.type=s}else{t={enabled:false,questions_applied:null,type:null}}l=!t.enabled||t.questions_applied.length>0;if(l){i.question_randomization=t;r=CREATE.PageActions.doPageRequest("update_page",i).done(function(){if(i.inPageRequest){return}CREATE.PageLogicOverlay.close(true);$("#livePreview").trigger("settingUpdated").trigger("questionRandomizationUpdated")}).fail(function(){CREATE.Notifications.showErrorNotification()})}else{r.reject()}o.closest(".panel").toggleClass("error",!l);return r}function Q(){var e=[],t=$("#questionRandomList input[name=randomizeQuestion]:checked");$.each(t,function(t,i){e.push($(i).val())});return e}function N(){var e={},t=n.find("input[name=pagesAffected]:checked").val(),i=n.find("input[name=pageRandom]:checked").val(),a=$.Deferred(),o;if(i!=="none"){e.enabled=true;if(t==="all"){e.pages_applied=t}else{e.pages_applied=B()}e.type=i}else{e={enabled:false,pages_applied:null,type:null}}o=!e.enabled||e.pages_applied.length>0;if(o){a=CREATE.survey.update({page_randomization:e}).done(function(){CREATE.PageLogicOverlay.close(true);$("#livePreview").trigger("settingUpdated")})}else{a.reject()}s.closest(".panel").toggleClass("error",!o);return a}function B(){var e=$("#pageRandomList input[name=randomizePage]:checked");return $.map(e,function(e){return parseInt($(e).attr("data-pageid"),10)})}function U(){a.val("description")}function O(){$("input[name=questionRandom][value=none]",n).prop("checked",true).trigger("change");o.find("input[name=questionsAffected][value=all]").prop("checked",true).trigger("change");$("#questionRandomList").find("input[name=randomizeQuestion]").each(function(e,t){$(t).prop("checked",false)});o.removeClass("error")}function z(){$("input[name=pageRandom][value=none]",n).prop("checked",true).trigger("change");s.find("input[name=pagesAffected][value=all]").prop("checked",true).trigger("change");$("#pageRandomList").find("input[name=randomizePage]").each(function(e,t){$(t).prop("checked",false)});s.removeClass("error")}return{init:function(){var e=$.trim($("#pageLogicTabbedViewMarkup").html()),i=$("#pageLogicViewContainer");t=$("#livePreview");i.html(e);CREATE.utils.addIds(i);n=$("#pageLogicContainer");if(n.length){a=$("#pageSkipTarget");o=$("#questionsAffectedControls");s=$("#pagesAffectedControls");f();p();if(!CREATE.survey.hasPermission("edit")){$(n).addClass("read-only");n.find(".buttons a").removeClass("teal");n.find("select, input").prop("disabled",true)}}},open:function(t,n){e=CREATE.pages.get(t);i=CREATE.utils.getPageElementFromId(t);CREATE.utils.handleOpenEditors(function(){g(n).then(function(){__UI.scrollToElement(CREATE.utils.getPageElementFromId(t))})})},isOpen:function(){return $("#pageLogicContainer:visible").length>0},save:function(){return M()},close:function(e){h(e)},isInitialized:function(){return $("#pageLogicContainer").length>0}}}();CREATE.PageActions=function(){var e,t,i,n,a=false;function o(){s();CREATE.PageActionsOverlay.init()}function s(){i.find("[data-action=more_actions]").each(function(e,t){var i=$(t);if(!i.data("actionMenu")){i.actionMenu({templateID:"page-actions-menu-template",position:{collision:"flip none"}}).on("actionMenu.menuInit",function(e){var t=e.actionMenu.get("menuView");t.$el.find(".q").popout()}).on("actionMenu.beforeOpen",function(e){var t=e.actionMenu.get("menuView"),i=CREATE.pages.length<=1;t.$el.find("[data-multi-page-option]").toggleClass("hide",i)}).on("actionMenu.afterOpen",function(){if(!CREATE.survey.hasPermission("edit")){$(".action-menu").find("a.option").addClass("disabled")}}).on("actionMenu.actionSelected",function(e){var t=e.actionMenu.get("menuView").get("selectedAction");l(t,i)})}})}function r(){i.on("pageAction",function(e,t){if(t){d(t);CREATE.PageActionsOverlay.hide()}}).on("rerenderPage",function(e,t){g(t)}).on("splitPage",function(e,t,i){CREATE.utils.handleOpenEditors(function(){c(t,i)});$("#dragLoading").remove()}).on("pageLogicOverlayOpened",function(){CREATE.PageActionsOverlay.hide()}).on("previewChanged",function(){s()})}function l(t,i){var a=function(){var n=CREATE.utils.getPageIdForEl(i),a,o;e=CREATE.pages.get(n);o=CREATE.utils.getPageElementFromId(n);if(CREATE.survey.hasPermission("edit")){switch(t){case"delete_page":if(e.questionCount()===0){i.closest(".page").addClass("inactivePage");d("delete_page");return}CREATE.PageActionsOverlay.show(n,t);break;case"copy_page":case"move_page":CREATE.PageActionsOverlay.show(n,t);SM.Logger.enqueue({action_type:"click_"+t,ui_trigger:"editorMovePage"});break;case"edit_page":o.find(".page-title-container").click();break;case"require_qs":a=$("#graveyard [data-id=editReqtext]").text();e.requireQuestions(a).done(function(){o.find(".question").not(".question-presentation-text, .question-presentation-image").addClass("question-required")});break}}};if(n.isOpen()){n.saveEditMode({afterSaveCallback:a})}else{a()}}function d(e,i){var n=i?i:u(e),a,o,s,r=[],l;if(!n){return}l=CREATE.pages.get(n.id);if(e==="delete_page"){s=l.getFunnelSenderQuestions();$.each(s,function(e,t){r=r.concat(CREATE.survey.getFunnelReceiverIds([t.id]))})}if(e==="copy_page"){a=l.questionCount();if(!__UI.handleQuestionLimit(t,a)){return}}o=CREATE.PageActions.doPageRequest(e,n);o.done(function(e){if(e.inPageRequest){return false}__UPGRADE.handleUpgradeState();g(e,n,l.get("position"),r);if(CREATE.survey.isSurveyQuizMode()){$("#create").trigger("quizWarningQuestionCheck")}});if(e==="delete_page"){o.fail(function(t){var i=t.appError.name,a,o,s,r,l;if(i!=="CannotDeletePageException"){CREATE.Notifications.showErrorNotification({messageKey:"Exception"});CREATE.utils.getPageElementFromId(n.id).removeClass("inactivePage");return}s=t.appError.validation;if(s.has_quota_questions){a=CREATE.Translations.get("delete_confirm","default").page_has_quota_questions["default"];o=CREATE.Translations.get("close","default")["default"]}else{r=[];if(s.has_questions_with_responses){r.push("delete-page-has-response")}if(s.is_page_logic_target){r.push("delete-page-page-logic")}if(s.is_question_logic_target){r.push("delete-page-question-logic")}a=$("#delete-page-confirm").html().replace("dummy-class",r.join(" "));o=CREATE.Translations.get("delete_page","default")["default"]}l=SM.Views.create(SM.ConfirmDialogView,{isModal:true,width:500,html:a,confirmText:o,templateID:"confirm-dialog-template"});l.$el.addClass("dialog-a");if(s.has_quota_questions){l.$el.find(".cancel-btn").addClass("hide");l.$el.on("confirmDialog.confirm",function(){CREATE.utils.getPageElementFromId(n.id).removeClass("inactivePage");l.close()})}else{l.$el.on("confirmDialog.confirm",function(){l.close();n.has_permission=true;d(e,n)})}l.$el.on("confirmDialog.cancel",function(){CREATE.utils.getPageElementFromId(n.id).removeClass("inactivePage");l.close()});l.open()})}else{o.fail(function(t){var i=t.appError.name,n=[],a;if(e==="copy_page"){n=["QuestionPerSurveyLimitException","PageLimitException","FileUploadQuestionPerSurveyLimitException"]}else if(e==="split_page"){n=["PageLimitException"]}if($.inArray(i,n)===-1){i="Exception"}else{a=CREATE.limitErrorNotificationDuration}CREATE.Notifications.showErrorNotification({messageKey:i,showErrorDuration:a})})}}function u(t){var i={survey_id:CREATE.survey.id,id:e.id},n=$("#pageAction_relativePos").val()==="after",a=parseInt($("#pageAction_pageList").val(),10)+(n?1:0),o=e.get("position");switch(t){case"delete_page":i.num_questions=e.questionCount();if(i.num_questions===0){i.move_questions="delete"}else{i.move_questions=$('input[name="deletePageQuestions"]:checked').val()}break;case"copy_page":i.position=a;break;case"move_page":if(a>o){--a}if(a===o){i=null}else{i.position=a}break}return i}function c(e,t){var i=CREATE.pages.get(e),n={survey_id:CREATE.survey.id,id:e,position:i.get("position")+1,question_split_position:t,heading:CREATE.Translations.get("page_title","defaults")["default"],sub_heading:CREATE.Translations.get("page_description","defaults")["default"]};d("split_page",n)}function f(e){var t=e.page2.id,n;if(CREATE.survey.isSinglePageMode()){i.find(".page").replaceWith(e.page2.markup)}else{n=CREATE.pages.get(t).get("position");if(n===1){i.find(".page").first().before(e.page2.markup)}else{CREATE.pages.find(function(t){if(t.get("position")===n-1){CREATE.utils.getPageElementFromId(t.id).after(e.page2.markup);return true}})}}return t}function p(e){var t=e,n,a;if(!CREATE.survey.isSinglePageMode()){a=CREATE.utils.getPageElementFromId(t);n=CREATE.pages.get(t).get("position");if(n===1){i.find(".page").first().before(a)}else{CREATE.pages.find(function(e){if(e.get("position")===n-1){CREATE.utils.getPageElementFromId(e.id).after(a);return true}})}}return t}function g(e,t,n,a){var o=e.page.id,s=null,r="sort-targets sort-pages",l,d,u,c;switch(e.page_action){case"copy":s=f(e);break;case"move":s=p(o);break;case"delete":d=CREATE.pages;s=d.at(Math.min(n,d.length)-1).id;if(t.move_questions==="delete"&&t.num_questions>0){u=t.num_questions+a.length;__UPGRADE.handleUpgradeState();$("#create").trigger("questionsDeleted",u)}if(CREATE.survey.isSinglePageMode()){CREATE.PagePagination.loadPage(s);return}if(!CREATE.survey.isSinglePageMode()){if(t.move_questions==="delete"&&t.num_questions>0){$.each(a,function(e,t){var i=CREATE.utils.getQuestionElForId(t);CREATE.utils.getQuestionContainer(i).remove()})}l=CREATE.utils.getPageElementFromId(o);l.addClass("deletingPage").css("height",l.height()+"px");l.find(".survey-page").animate({opacity:0,height:0,border:0},200,"linear",function(){setTimeout(function(){l.remove();if(e.page2.id>0){CREATE.utils.getPageElementFromId(e.page2.id).replaceWith(e.page2.markup)}CREATE.survey.pageInView=s;i.trigger("previewChanged",{actions:r}).trigger("settingUpdated")},200)});return}break;case"split":if(CREATE.QuestionEditor.isOpen()){CREATE.QuestionEditor.cancelEditMode(false)}s=o;l=CREATE.utils.getPageElementFromId(o);c=l.find("[data-question-slider]");_.each(c,function(e){var t=$(e).data("sliderQuestion");if(t){t.deactivate()}});l.replaceWith(e.page.markup);l.find("[data-question-slider]").sliderQuestion();if(!CREATE.survey.isSinglePageMode()){l=CREATE.utils.getPageElementFromId(o);l.after(e.page2.markup);s=e.page2.id}r+=" new-page";break;default:return}if(s){CREATE.survey.pageInView=s;__UI.scrollToElement(CREATE.utils.getPageElementFromId(s));i.trigger("previewChanged",{actions:r})}}return{init:function(){t=CREATE.user;n=CREATE.QuestionEditor;i=$("#livePreview");o();r()},refreshPageList:function(e){CREATE.PageActionsOverlay.refreshPageList(e)},doPageRequest:function(e,t){var i={update_page:"update",delete_page:"remove",copy_page:"copy",move_page:"move",split_page:"split"},n=i[e],o=$.Deferred();if(a){return o.resolve({inPageRequest:true})}a=true;t.need_question_number=CREATE.survey.isSinglePageMode()&&CREATE.survey.get("design_settings").question_numbering===2;if(e==="add_page"){o=CREATE.pages.addNew(t)}else{if(e==="delete_page"&&t.has_permission===undefined){t.has_permission=false}o=CREATE.pages.get(t.id)[n](t)}return o.always(function(){a=false})}}}();CREATE.PageActionsOverlay=function(){
var e,t,i,n,a,o,s,r,l,d,u;function c(){$(window).resize(function(){p()});n.on("click",".buttons a",function(e){var t=$(e.target).closest("a"),i=t.attr("data-action");if(t.hasClass("disabled")){return false}switch(i){case"confirm":v();break;case"cancel":h();break}e.preventDefault()});$("#pageAction_relativePos").change(function(){var e=$(this),t=e.val()==="before";e.parent().toggleClass("before",t)});$("input[name=deletePageQuestions]").change(function(){var e=$(this).val(),t=m(e),i=_(e);$(".innerPanelError").toggleClass("hide",!t);$("#deletePageAction").toggleClass("disabled",t||i)});l.on("previewChanged",function(){h()})}function f(){var i=false,n;d.addClass("hide");u.addClass("hide");$("#noMoveAfterFunnelAlert, #noMoveBeforeFunnelAlert").addClass("hide");switch(t){case"copy_page":case"move_page":r.val(e.get("position"));$("#pageAction_relativePos").val("after");$("#pageActionPosition").find(".beforeAfter").removeClass("before");break;case"delete_page":$("#deletePageQuestions input").prop("checked",true);$("#moveQuestionsUp").toggleClass("hide",e.get("position")===1);$("#moveQuestionsDown").toggleClass("hide",e.get("position")===CREATE.pages.length);break}if(t==="move_page"){i=e.isRandomized()||e.isLogicDestination();n=e.getQuestionIdsWithFunneling("both");if(i||n.length>0){d.removeClass("hide")}}else if(t==="delete_page"){u.toggleClass("hide",e.getQuestionIdsWithFunneling("senders").length===0)}}function p(){n.css("width",$("#livePreview").width())}function g(){var t=CREATE.utils.getPageElementFromId(e.id),i=-10;if(CREATE.stepName==="draft"){i*=-1}$("#pageActionsOverlay").css("top",t.position().top+i)}function h(){$(".innerPanelError").addClass("hide");n.find(".buttons a.disabled").removeClass("disabled");n.hide()}function m(t){var i=e.get("position"),n=e.questionCount();if(t==="delete"){return false}if(t==="before"){i-=1}else{i+=1}CREATE.pages.find(function(e){if(e.get("position")===i){n+=e.questionCount();return true}});return n>100}function _(t){var i=CREATE.survey.get("funneling"),n=e.questionIds(),a,o=e.get("position"),s,r=false,l;$("#noMoveAfterFunnelAlert, #noMoveBeforeFunnelAlert, #deleteWithFunnelAlert").addClass("hide");if(!i.has_funnels||t==="delete"){u.toggleClass("hide",CREATE.utils.getPageElementFromId(e.id).find(".isFunnelSender").length===0);return false}if(t==="after"){a=i.sender_map;l=$("#noMoveAfterFunnelAlert")}else{a=i.receiver_map;o-=2;l=$("#noMoveBeforeFunnelAlert")}s=CREATE.pages.at(o).questionIds();$.each(n,function(e,t){var i=a[t];if(!i||i.length<1){return true}$.each(i,function(e,t){if($.inArray(t,s)!==-1){r=true;l.removeClass("hide");return false}});if(r){return false}});return r}function v(){if(t==="delete_page"){CREATE.utils.getPageElementFromId(e.id).addClass("inactivePage")}l.trigger("pageAction",[t])}return{init:function(){l=$("#livePreview");n=$("#pageActionsOverlay");a=n.find(".actionSpecific");o=n.find("[data-info=pagePosition]");s=n.find("[data-info=pageTitle]");r=$("#pageAction_pageList");d=$("#moveWithLogicWarning");u=$("#deleteWithFunnelAlert");i={copy_page:n.find(".copyPage"),move_page:n.find(".movePage"),delete_page:n.find(".deletePage")};c()},show:function(r,d){CREATE.utils.handleOpenEditors(function(){e=CREATE.pages.get(r);o.text(e.get("position"));s.text(CREATE.utils.getSuffixedPageTitle(e));t=d;if(t==="delete_page"&&e.questionCount()===0){v()}else{a.hide();i[t].show();g();n.show();p();f();l.trigger("pageActionsOverlayOpened")}})},isOpen:function(){return $("#pageActionsOverlay:visible").length>0},hide:function(){h()},refreshPageList:function(e){r.html("");r.append(e)}}}();CREATE.PagePagination=function(){var e,t=250,i=10;function n(){var t=$("#create");e.on("previewChanged",function(){s()}).on("previewUpdated",function(){a();s()});t.on("afterScroll",function(){r()})}function a(){var t=e.find(".page");t.each(function(e,t){var i=$(t),n=i.find("[data-action=previous]"),a=i.find("[data-action=next]");n.toggleClass("disabled",i.hasClass("first-page"));a.toggleClass("disabled",i.hasClass("last-page"))})}function o(e){var t;$("#create").toggleClass("singlePage",e===CREATE.Enums.ViewMode.single);if(e===CREATE.survey.viewMode){return}CREATE.survey.viewMode=e;t=CREATE.survey.pageInView;u(t,true)}function s(){var e=CREATE.survey.getSavedQuestionCount(),i;if(e>t){i=CREATE.Enums.ViewMode.single}else{i=CREATE.Enums.ViewMode.multi}o(i)}function r(){var e=-1,t=$(window).scrollTop(),i=$(window).height();if(!CREATE.survey.isSinglePageMode()){CREATE.pages.find(function(n){var a=$("#pageid-"+n.id),o;if(a&&a.offset()){o=a.offset().top-t;if(o<i*.4){e=n.id}else{return true}}});CREATE.survey.pageInView=e}}function l(e){var t=f(e);if(t){u(t.id)}}function d(e){var t=f(e);if(t){u(t.id)}}function u(t,i){var n="#pageid-"+t,a=CREATE.survey.isSinglePageMode(),o,s=$.Deferred();if(!a&&!i){__UI.scrollToElement($(n));return s.resolve()}if(CREATE.QuestionEditor.isOpen()){CREATE.QuestionEditor.cancelEditMode(false)}if(a){o=CREATE.pages.get(t);return o.fetch({loadPages:false}).done(function(i){e.find(".page").remove();e.append(i.markup);$(window).scrollTop(0);CREATE.survey.pageInView=parseInt(t,10);e.trigger("previewChanged",{actions:"sort-targets sort-pages"})})}else{return CREATE.pages.fetch(null,{render:true,notificationKey:"load_page"}).done(function(i){e.find(".page").remove();e.append(i.markup);CREATE.survey.pageInView=t;__UI.scrollToElement($(n));e.trigger("previewChanged",{actions:"sort-targets sort-pages"})})}}function c(t){var n,a=e.find(".page");n={actions:[{text:CREATE.Translations.get("loading","default")["default"],action:0}],saveState:true};a.each(function(e,a){var o=$(a),s=o.find("[data-action=selectPage]"),r=CREATE.pages.length,l,d,c;if(!SM.Browser.isIE){n.parentEl=o.find(".pageControls")}d=s.data("actionMenu");if(d){d.set("actions",t)}else{l=s.actionMenu({templateID:"page-selection-dropdown-menu-template",actions:t,position:{collision:"flip none"}}).on("actionMenu.menuInit",function(e){var t=e.actionMenu,i=t.get("menuView");i.$el.on("click",".btn",function(e){var i=$(e.target),n=i.parent().find("input"),a=n.val(),o;e.preventDefault();if(a&&a>0&&a<=CREATE.pages.length){o=f(a);u(o.id)}n.val("");t.close()})}).on("actionMenu.actionSelected",function(e){var t,i=e.actionMenu.get("menuView").get("selectedAction");t=parseInt(i,10);if(t>0){u(t)}else{CREATE.survey.pageInView=0}});d=l.data("actionMenu")}c=d.get("menuView").$el;c.find("[data-type=goToPage]").toggleClass("hide",r<=i);c.find("[data-value=numPages]").text(r);c.addClass("long")})}function f(e){var t=e-1;if(t<0||t>=CREATE.pages.length){return undefined}else{return CREATE.pages.at(t)}}return{init:function(){e=$("#livePreview");CREATE.survey.pageInView=CREATE.pages.at(0).id;n();a();s()},navigate:function(e,t){var i=CREATE.utils.getPageIdForEl(t),n=CREATE.pages.get(i);if(t.hasClass("disabled")){return}switch(e){case"previous":l(n.get("position")-1);break;case"next":d(n.get("position")+1);break}},refreshPageList:function(e){c(e)},loadPage:function(e){return u(e)}}}();CREATE.PageAdd=function(){var e=this,t,i=false,n=$("#livePreview");function a(e){var t={IntroPage:{heading:CREATE.Translations.get("intro_page_title")["default"],sub_heading:CREATE.Translations.get("intro_page_description")["default"],position:1},NewPage:{heading:"",sub_heading:""}};return t[e]}function o(e,t){var o,s,r;if(!i){i=true;if(e==="IntroPage"||t===0){o=1}else if(!t){o=false}else{o=CREATE.pages.get(t).get("position")+1}s=a(e);s.position=o||CREATE.pages.length+1;r={family:"presentation",subtype:e==="IntroPage"?"intro":"page",options:s,is_brand_refresh:CREATE.survey.hasBrandRefreshTheme()};CREATE.PageActions.doPageRequest("add_page",r).done(function(e){var a=$(e.markup),s=e.page;if(e.inPageRequest){return}i=false;if(CREATE.survey.isSinglePageMode()){n.find(".page").replaceWith(a)}else{if(o===1){n.find(".page").first().before(a)}else if(!o){n.append(a)}else{CREATE.utils.getPageElementFromId(t).after(a)}}if(CREATE.stepName==="draft"){a.find(".page-title").toggleClass("empty",s.heading==="")}CREATE.survey.pageInView=s.id;__UI.scrollToElement(CREATE.utils.getPageElementFromId(s.id));n.trigger("previewChanged",{actions:"sort-targets sort-pages new-page"});if(CREATE.survey.getBlockForPage(s.id)){n.trigger("settingUpdated")}CREATE.LivePreview.resetUIForBrandRefresh()}).fail(function(e){var t=e.appError.name;if(t!=="PageLimitException"){t="Exception"}CREATE.Notifications.showErrorNotification({messageKey:t})})}}function s(e){var i=$(e.target).closest(".page"),n=i.length?CREATE.utils.getPageIdForEl(i):0,a=function(){o("NewPage",n)};e.preventDefault();if(t.isOpen()){t.saveEditMode({afterSaveCallback:a})}else{a()}}function r(){if(CREATE.survey.hasPermission("edit")){$("#create").on("clickToAddPage",function(e,i){var n=function(){o(i)};if(t.isOpen()){t.saveEditMode({afterSaveCallback:n})}else{n()}SM.Logger.enqueue({action_type:"click_accordion_builder_page",page_type:i,ui_trigger:"accordionBuilder"})});n.on("click",".addNewPage a",s).on("dragToAddPage",function(e){s(e);SM.Logger.enqueue({action_type:"drag_accordion_builder_question",page_type:"NewPage",ui_trigger:"accordionBuilder"})})}else{$(".addNewPage").addClass("read-only");n.on("click",".addNewPage a",function(e){e.preventDefault()})}}return{init:function(){t=CREATE.QuestionEditor;r()}}}();(function(e,t){var i=$("#createAccordion");function n(e){var t=$(e.target).closest("li");return $("#ds"+t.attr("rel")).clone()}function a(){var e={cursor:"move",appendTo:"body",helper:n,connectToSortable:"#livePreview .questions",start:function(){$("#create").trigger("dragToAdd")},stop:function(){$("#create").trigger("dragStop")}},t;i.find(".dta").draggable(e);t=$("#livePreview .addNewPage").first();e={cursor:"move",appendTo:"body",helper:n,start:function(){t.removeClass("hide")},stop:function(){t.addClass("hide")}};i.find(".dtap").draggable(e)}function o(){i.on("click",".cta",function(e){$("#create").trigger("clickToAdd",[$(this).attr("rel")]);e.preventDefault()}).on("click",".ctaQB",function(e){$("#create").trigger("banked_questions_add",{name:$(this).data("qb-name")});e.preventDefault()}).on("click",".ctap",function(e){var t=$(this);e.preventDefault();t.toggleClass("added");$("#create").trigger("clickToAddPage",[t.attr("rel")])}).on("click",".cpb",function(e){e.preventDefault()})}_.extend(t,{init:function(){if(CREATE.survey.hasPermission("edit")){o();a()}else{i.on("click",".cta, .ctaQB, .ctap, .cpb",function(e){e.preventDefault()})}if(CREATE.user.get("preferences").show_builder_tooltips_enabled){$("#accBuilder li[data-help]").samplePopout({offsetMenu:true,showDelayTime:5e3})}}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_add"]=window["js/create/step2/accordion/accordion_add"]={});(function(e,t){var i,n=$("#surveyRenderVersion").val(),a,o,s,r,l,d,u=12,c=36,f=1,p={min:u,max:c,step:f},g={themeName:function(){var e=a.find("form.themeName");e.find("input").val(o.name)},themeWallpaper:function(){a.find("form.themeWallpaper .colorPreview").val(o.styles.logo["background-color"])},themeColors:function(){a.find("form.themeColors .colorPreview").each(function(e,t){var i=$(t),n=i.closest("a"),a=n.attr("rel"),s=o,r;if(a==="styles.survey_page.background-color"&&o.variables.survey_page_bg_img!==undefined){n.hide()}else{n.show()}$.each(a.split("."),function(e,t){if(s&&typeof s!=="string"){s=s[t]}});r=s;if(r){i.spectrum("set",r)}else{SM.Logger.remoteLog({missing_theme_color_key:a},"warning")}})},themeTypography:function(){var e=o.styles.survey_page["font-family"],t=a.find("form.themeTypography [name=font]");if(t.find('[value="'+e+'"]').length===0){e="arial,sans-serif"}t.val(e)}};function h(){var e=CREATE.survey.get("theme");a=$("#themeSettings");i=__UPLOADER.s3_url+"/";s={};r=17;b(e);o=e;if(o.theme_template>0){y()}S()}function m(e,t,i){if(!e||e===o.theme_id){y(t)}else{e=""+e;if(l!==e){l=e;CREATE.Ajax.selectTheme(e).done(function(i){var n=i.theme,a=i.theme.variables.brand_refresh!==o.variables.brand_refresh;l=null;if(!s[e]){b(n)}o=s[n.theme_id];if(a){window.location.reload(true);return}y(t)}).fail(function(e){if(i){i(e)}if(e.appError.name==="CannotSelectDeletedGroupThemeException"){CREATE.Notifications.showErrorNotification({messageKey:e.appError.name})}else{CREATE.Notifications.showErrorNotification()}})}}}function v(e,t){var i=$("#customizeThemeWarning"),n=$(".themeSections a"),s,r=CREATE.Translations.get("copy_of")["default"],l,d=r.split("{1}"),u=[],c=true,f,p,g,h=50;if(!e){if(o.group_id){e=CREATE.user.get("default_theme_id")}else{e=o.theme_id}}l=$.trim($("[data-themeid="+e+"] .themeName").text());if(!t){t=o.theme_template}i.addClass("hide");n.removeClass("disabled");if(t>0){i.removeClass("hide");n.addClass("disabled");q();if($("#accThemes").hasClass("t1")){$("#accThemes").removeClass("t1").addClass("t2")}return}_.each(d,function(e){if(e!==""){u.push(l.indexOf(e))}});for(f=0;f<u.length;f++){p=u[f];if(p===-1||f>0&&p<=u[f-1]){c=false;break}}if(c){g=l}else{g=r.replace("{1}",l)}g=g.substr(0,h);s={theme_id:e,name:g};CREATE.Ajax.copyTheme(s).done(function(e){var t=e.theme;CREATE.survey.setThemeId(t.theme_id);$("ul#customThemeList").trigger("complete_handler",e);a.find("div.s1").addClass("editTheme").find("h3 b.editTheme").html(t.name);m(t.theme_id,function(){q()})}).fail(function(){CREATE.Notifications.showErrorNotification()})}function E(e,t){var i=$("#customizeThemeWarning"),n=$(".themeSections a");if(t>0){i.removeClass("hide");n.addClass("disabled");q()}else{i.addClass("hide");n.removeClass("disabled");m(e,function(e){a.find("div.s1").addClass("editTheme").find("h3 b.editTheme").html(e.name);q()})}}function C(e,t){CREATE.Ajax.deleteTheme(e).done(function(e){var i=CREATE.survey.get("design_settings").theme_id;e.deleted_selected_theme=i===e.old_theme_id;$("ul#customThemeList").trigger("complete_handler",e);if(e.theme_id&&e.theme_id!==o.theme_id){m(e.theme_id,t)}}).fail(function(){CREATE.Notifications.showErrorNotification()})}function q(){var e=o.variables!==undefined&&o.variables.survey_container_style==="FullWidth";$("#themeBackgroundLink").toggle(!e);a.attr("class","waterpark s2 clearfix")}function b(e){e.lastChanged=(new Date).getTime();s[e.theme_id]=e}function y(e){var t=o.theme_template,i=$("#accThemes").find(".addList").find('[data-themeid="'+o.theme_id+'"]'),a=i.closest("ul").hasClass("defaultThemes"),s="themes/"+n+"_"+o.theme_id+"_"+o.file_guid+".css";$("#legacyThemeWarning").addClass("hide");$(".previewThemeWarningOld").addClass("hide");if(!t){CREATE.Ajax.getThemeCss(s).done(function(t){$("#themeCssLink").replaceWith('<style id="themeCssLink">'+t+"</style>");R();$(window).trigger("resize");if(e){e(o)}})}else if(t>r||!a){CREATE.Ajax.getThemeCss(s).done(function(t){$("#themeCssLink").replaceWith('<style id="themeCssLink">'+t+"</style>");if(e){e(o)}});i.closest("li").prev(".previewThemeWarningOld").removeClass("hide")}else{$("#legacyThemeWarning").removeClass("hide");if(e){e(o)}}CREATE.survey.set("theme",o);CREATE.survey.setThemeId(o.theme_id);$("#livePreview").trigger("customThemeUpdated")}function T(){return CREATE.Ajax.updateTheme(o).done(function(e){w(e);y()}).fail(function(){CREATE.Notifications.showErrorNotification()})}function w(e){var t=e.theme,i=$(".themes.addList").find(".selected"),n=i.find(".themeSurveyHeader"),a=i.find(".themeThumbnailPreview");o=t;b(t);i.find(".themeName").text(t.name);if(t.variables.survey_container_bg_img!==undefined){a.css("background-color","");if(t.variables.survey_container_bg_thmb_md!==undefined){a.css("background-image","url("+L(t.variables.survey_container_bg_thmb_md)+")")}else{a.css("background-image","url("+L(t.variables.survey_container_bg_img)+")")}}else{a.css("background-color",t.styles.survey_container["background-color"]);a.css("background-image","")}if(t.variables.survey_title_bg_img!==undefined){n.css("background-color","");if(t.variables.survey_title_bg_thmb_sm!==undefined){n.css("background-image","url("+L(t.variables.survey_title_bg_thmb_sm)+")")}else{n.css("background-image","url("+L(t.variables.survey_container_bg_img)+")")}}else{n.css("background-color",t.styles.survey_title["background-color"]);n.css("background-image","")}i.find(".themePageHeader").css("background-color",t.styles.page_title["background-color"]);i.find(".themeSurveyContent").css("background-color",t.styles.survey_page["background-color"]);$("ul#customThemeList").trigger("complete_handler",e)}function R(){var e;if(o.variables.survey_container_bg_thmb_md!==undefined){e=L(o.variables.survey_container_bg_thmb_md)}else if(o.variables.survey_container_bg_img!==undefined){e=L(o.variables.survey_container_bg_img)}A(e)}function A(e){var t=$("#editBackgroundImage").find("img"),i=o.styles.survey_container===undefined?undefined:o.styles.survey_container["background-repeat"],n=$("#backgroundImageScaling");if(e!==undefined){t.attr("src",e);$(".themeSections li").find('[rel="themeWallpaper"]').find("span").show();if(i!==undefined&&i==="no-repeat"){n.val("fullScreen")}else{n.val("tiled")}}else{t.attr("src","");$(".themeSections li").find('[rel="themeWallpaper"]').find("span").hide();if($("#themeSettings").hasClass("s3")&&$("#themeSettings").hasClass("themeWallpaper")){$("button.s1.done").trigger("click");n.val("fullScreen")}}}function S(){var e=true;a.on("click","form.themeSections li a",function(e){if($(e.target).hasClass("disabled")){return false}else{e.preventDefault();D(e)}CREATE.LivePreview.resetUIForBrandRefresh()}).on("click","button.done",function(e){var t=$(e.target);if(t.hasClass("s1")){q()}else if(t.hasClass("s2")){a.attr("class","waterpark s3 clearfix themeTypography")}else{a.attr("class","waterpark s1 clearfix")}return false}).on("click","#themeNameSave",function(){var e=$.trim(a.find("form.themeName input").val());a.find("form.themeName section").toggleClass("error",!e);if(e){if(e!==o.name){o.name=e;T()}q()}return false}).on("click","#themeNameCancel",function(){q();return false}).on("click","form.themeTypography .lanes a",x).on("click","#replaceBackgroundImage",function(e){e.preventDefault();F()}).on("click","#deleteBackgroundImage",function(){var e=o;if(e.styles.survey_container!==undefined){e.styles.survey_container["background-size"]=null;e.styles.survey_container["background-repeat"]=null}e.variables.survey_container_bg_img=null;e.variables.survey_container_bg_thmb_sm=null;e.variables.survey_container_bg_thmb_md=null;$("#editBackgroundImage").find("img").attr("src","");T()}).on("change","#backgroundImageScaling",M);$("#surveyThemeColors").find(".colorPreview").spectrum({showInput:true,preferredFormat:"hex",showPalette:true,maxSelectionSize:21,localStorageKey:"sm.theme.colorpicker"+CREATE.survey.id,chooseText:CREATE.Translations.get("apply","defaults")["default"],cancelText:CREATE.Translations.get("cancel","defaults")["default"],palette:[["FFFFFF","EAEAE8","CCCCCC","999999","666666","333333","000000"],["CFCEBF","B5B7A9","94938C","7F7E71","706F65","5B594A","4B4A3C"],["FFFBB9","F8F67E","E8EC75","CCD832","A7C23D","86A33B","4F7A27"],["FFCB3E","F1B12A","F19E2D","DE7E35","C65126","C6332A","FF3300"],["D9EEEC","8CC8C9","4BBFBF","42A9A8","00858B","36606E","00374A"],["A8C6FE","73A7FF","3888FE","0062FF","0042AA","002F7B","001E57"],["E392FE","D357FE","992ABD","7B219F","61187C","450E59","2E073E"]],change:function(e){var t,i=$(this).closest("a").attr("rel"),n=o;if(e.alpha===1){t=e.toHexString()}else{t=e.toRgbString()}$.each(i.split("."),function(e,i){if(typeof n[i]==="object"){n=n[i]}else{if(n[i]!==t){n[i]=t;if(i==="highlight_color"){o.styles.question_body_highlight["background-color"]=t}T();return false}}})}});function t(){if(e){$(".sp-container").not(".sp-hidden").find(".sp-cancel").click();e=false;setTimeout(function(){e=true},1e3)}}$(window).on("scroll",t);$("#themeSettings .s3.slide").on("scroll",t);a.find("form.themeTypography").on("change",'[name="font"]',function(e){o.styles.survey_page["font-family"]=$(e.target).val();T()}).on("change",'[name="sectionFont"]',function(e){var t=$(e.target).attr("data-typosection");if(t){o.styles[t]["font-family"]=$(e.target).val();T()}}).on("slider.change",'[name="size"]',function(e){var t,i;if($("#themeSettings.themeTypography").hasClass("s4")){t=parseInt(e.slider.get("value"),10);i=parseInt(o[d[0]][d[1]]["font-size"].replace("px",""),10);if(i!==t){k({"font-size":t+"px"})}}}).on("slider.slide",'[name="size"]',function(e){$(this).siblings("#display").text(e.value+"px")}).on("change",'[name="bold"]',function(e){k({"font-weight":$(e.target).is(":checked")?"bold":"normal"})}).on("change",'[name="italic"]',function(e){k({"font-style":$(e.target).is(":checked")?"italic":"normal"})}).on("change",'[name="underline"]',function(e){k({"text-decoration":$(e.target).is(":checked")?"underline":"none"})}).on("change",'[name="border_size"]',function(e){k({border_size:$(e.target).is(":checked")})}).on("change",'[name="width"]',function(e){k({width:$(e.target).is(":checked")})});$(window).on("resize",i);$("#accThemes").on("accThemesVisible",i);function i(){var e=$(".themeTypography").find('[name="size"]').data("slider");if($("#accThemes").hasClass("open")&&e&&$("#themeSettings").hasClass("s4")){e.set("constraints",p)}}}function x(e){var t=$(e.target),i=t.attr("rel").split("."),n=a.find("form.themeTypography"),s=o,r,l,u,c=n.find("[name=sectionFont]"),f=["survey_title","page_title"],p;d=i;$.each(i,function(e,t){if(s[t]){s=s[t]}else{return false}});for(u=0;u<f.length;u++){if(t.attr("rel").search(f[u])>-1){p=f[u];break}}r=i[1]===undefined||i[1]==="survey"?"survey_title":i[1];a.attr("class","waterpark s4 clearfix themeTypography "+r);$("#typographySettingTitle").text(t.html());if(p){c.attr("data-typosection",p);c.closest(".exit_link.progress_bar").show();l=o.styles[p]["font-family"];if(!l){l=o.styles.survey_page["font-family"]}if(c.find('[value="'+l+'"]').length===0){l="arial,sans-serif"}c.val(l)}else{c.closest(".exit_link.progress_bar").hide()}n.find('[name="size"]').data("slider").set("value",s["font-size"].replace("px",""));n.find('[name="bold"]').prop("checked",s["font-weight"]==="bold"||s["font-weight"]==="700");n.find('[name="italic"]').prop("checked",s["font-style"]==="italic");n.find('[name="underline"]').prop("checked",s["text-decoration"]==="underline");return false}function k(e){var t=o;$.each(d,function(e,i){if(t[i]){t=t[i]}else{return false}});$.extend(t,e);T()}function P(e){var t=e.imageData,i;i=o.variables;i.survey_container_bg_img="s3:"+t.s3Key;i.survey_container_bg_thmb_sm=t.thumb60S3Key===undefined?null:"s3:"+t.thumb60S3Key;i.survey_container_bg_thmb_md=t.thumb140S3Key===undefined?null:"s3:"+t.thumb140S3Key;if(t.isFullScreen||t.isFullScreen===undefined){$("#backgroundImageScaling").val("fullScreen")}else{$("#backgroundImageScaling").val("tiled")}M().then(function(){if($("#themeSettings").hasClass("s2")){$(".themeSections li").find('[rel="themeWallpaper"]').trigger("click")}})}function M(){var e=$("#backgroundImageScaling").val(),t,i,n=$(".themes.addList").find(".selected").find(".themeThumbnailPreview"),a="fullBackground tiledBackground",s={fullScreen:{className:"fullBackground",styles:{"background-size":"cover","background-repeat":"no-repeat","background-attachment":"fixed","background-position":"center"}},tiled:{className:"tiledBackground",styles:{"background-size":"auto","background-repeat":"repeat","background-attachment":"fixed","background-position":"initial"}}},r=s[e],l=r.styles;if(o.styles.survey_container===undefined){o.styles.survey_container={}}t=o.styles.survey_container;n.removeClass(a).addClass(r.className);for(i in l){t[i]=l[i]}return T()}function D(e){var t=$(e.currentTarget),i=t[0].rel;if(i==="themeWallpaper"){if(o.variables.survey_container_bg_img===undefined){e.preventDefault();F()}else{I(i)}}else if(i==="themeTypography"){I(i);$(".themeTypography").find('[name="size"]').css({width:"calc(100% - 40px)","background-color":"#FFFFFF"}).slider({constraints:p,value:u})}else if(i!==undefined){I(i)}return false}function I(e){a.attr("class","waterpark s3 clearfix "+e);g[e]()}function L(e){var t=e.split(":");if(t.length>0&&t[0]==="s3"){return i+e.substring(3)}else{return e}}function F(){var e;e=SM.Views.create(SM.SurveyImagesDialogView,{assetLibraryModel:CREATE.AssetLibrary.getInstance(),stockAssetsModel:CREATE.StockAssets.getInstance(),source:"backgroundImage"});e.$el.on("imageUploaded",P);e.open()}_.extend(t,{init:h,selectTheme:m,copyTheme:v,editTheme:E,deleteTheme:C})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_theme_manager"]=window["js/create/step2/accordion/accordion_theme_manager"]={});(function(e,t){var i,n,a,o,s=12;function r(e){i.find(".tabs").data("tabs").open(e)}function l(){i=$("#accThemes");n=e("js/create/step2/accordion/accordion_theme_manager");n.init();a={apply:{text:CREATE.Translations.get("apply_theme")["default"],action:"apply"},custom:{text:CREATE.Translations.get("customize_theme")["default"],action:"copy"},edit:{text:CREATE.Translations.get("edit_theme")["default"],action:"edit"},remove:{text:CREATE.Translations.get("delete_theme")["default"],action:"delete"}};i.find("#defaultThemeList span.themeActions").each(function(e,t){$(t).actionMenu({actions:[a.apply,a.custom],parentEl:i.find("[tab=t1]")}).on("actionMenu.beforeOpen",function(e){g($(e.target).closest("a").attr("data-themeid"))}).on("actionMenu.afterOpen",function(){if(!CREATE.survey.hasPermission("edit")){$(".action-menu").find("a.option").addClass("disabled")}}).on("actionMenu.actionSelected",p)});i.find(".zoomThemeList span.themeActions").each(function(e,t){$(t).actionMenu({actions:[a.apply],parentEl:i.find("[tab=t1]")}).on("actionMenu.beforeOpen",function(e){g($(e.target).closest("a").attr("data-themeid"))}).on("actionMenu.afterOpen",function(){if(!CREATE.survey.hasPermission("edit")){$(".action-menu").find("a.option").addClass("disabled")}}).on("actionMenu.actionSelected",p)});o={actions:[a.apply,a.edit,a.remove],parentEl:i.find("[tab=t2]")};i.find("#customThemeList span.themeActions").each(function(e,t){$(t).actionMenu(o).on("actionMenu.beforeOpen",function(e){g($(e.target).closest("a").attr("data-themeid"))}).on("actionMenu.afterOpen",function(){if(!CREATE.survey.hasPermission("edit")){$(".action-menu").find("a.option").addClass("disabled")}}).on("actionMenu.actionSelected",p)});h();c();d()}function d(){var e=i.find("#defaultThemeList"),t=e.find("li").last(),n=t.find("a").first().attr("data-themeid");if(CREATE.user.get("default_theme_id")!==n&&CREATE.survey.get("design_settings").theme_id!==parseInt(n,10)&&e.find("li").length>s){t.remove()}}function u(e){var t=$(e).closest("a").attr("data-themeid"),i=$(e).closest("ul");n.selectTheme(t,function(e){f(t);if(i.hasClass("defaultThemes")){SM.Logger.enqueue({action_type:"click_standard_theme",theme_id:e.theme_id,theme_name:e.name,ui_trigger:"accordionTheme"})}},function(t){var i;if(t.appError.name==="CannotSelectDeletedGroupThemeException"){i=$(e).closest("li[data-theme-list-item]");i.remove()}})}function c(){i.find(".tabs").tabs();i.on("click","ul.themes li a",function(e){var t=$(e.target).closest("li");if(!t.hasClass("selected")){if(t.hasClass("new")){if(!CREATE.survey.hasPermission("edit")){e.preventDefault();return}if(CREATE.user.hasFeature("custom_themes")){n.copyTheme();e.stopPropagation()}else{__UPGRADE.openUpgradeModal("upgradeThemes")}}else{if(!CREATE.user.hasFeature("custom_themes")&&t.closest("#customThemeList").length){__UPGRADE.openUpgradeModal("upgradeThemes");return}if(!CREATE.survey.hasPermission("edit")){e.preventDefault();return}u(e.target)}}return false}).on("dblclick","ul.themes li a",function(e){var t=$(e.target),i,a=t.closest("li"),o,s,r;e.preventDefault();if(t.closest("#groupThemesList").length||!CREATE.survey.hasPermission("edit")){return false}if(CREATE.user.hasFeature("custom_themes")){if(a.hasClass("selected")){i=t.closest("a");o=i.attr("data-themeid");s=i.attr("data-templateid");r=a.closest("ul").hasClass("defaultThemes");n[r?"copyTheme":"editTheme"](o,s)}}return false}).on("click","ul.themes li a span.themeActions",function(e){e.preventDefault();return false}).on("complete_handler","#customThemeList",function(e,t){var i=$("#customThemeList"),n,a,s,r;if(!CREATE.survey.hasPermission("edit")){return false}if(t.action==="copy"){n=t.theme.theme_id;i.find(".addNewTheme").closest("li").after(t.html);i.find('a[data-themeid="'+n+'"] span.themeActions').actionMenu(o).on("actionMenu.actionSelected",p);i.removeClass("hide");if(n){f(n)}}else if(t.action==="delete"){n=CREATE.survey.get("design_settings").theme_id;n=n===t.theme_id?null:t.theme_id;a=i.find('a[data-themeid="'+t.old_theme_id+'"]').closest("li");a.find("span.themeActions").off("actionMenu.actionSelected actionMenu.beforeOpen");a.remove();if(t.deleted_selected_theme){f(n)}}else if(t.action==="update"){r=t.theme;n=r.theme_id;s=i.find('a[data-themeid="'+n+'"]');s.find("span[data-themetitle]").text(r.name).attr("title",r.name);s.find("figure span.tSurveyTitle").css("backgroundColor",r.styles.survey_title["background-color"]);s.find("figure span.tPageTitle").css("backgroundColor",r.styles.page_title["background-color"]);s.find("figure span.tProgressBar").css("backgroundColor",r.styles.progress_bar_indicator["background-color"]);if(n){f(n)}}return false}).on("tabs.afterClose",function(e){if(e.tab.key==="t2"){$("#themeSettings").attr("class","waterpark s1 clearfix")}});f();$("#livePreview").on("previewUpdated",function(e,t){if(t&&t.actions&&t.actions.indexOf("new-page")>-1){n.selectTheme()}})}function f(e){var t=$("ul.themes li"),i=t.filter(".groupThemeDeleted"),n=i.find("a[data-themeid]").data("themeid"),a=e||CREATE.survey.get("theme").theme_id,o=t.find('a[data-themeid="'+a+'"]').closest("li"),s=a===n,l;if(!o.hasClass("selected")){$("ul.themes li.selected").removeClass("selected");o.addClass("selected")}if(!s){i.remove()}l=o.closest(".panel[tab]");if(l.length){r(l.attr("tab"))}}function p(e){var t=e.actionMenu,i=t.$el.closest("a"),a=i.attr("data-themeid"),o=i.attr("data-templateid");if(CREATE.survey.hasPermission("edit")){switch(t.get("menuView").get("selectedAction")){case"apply":u(t.$el);break;case"copy":if(CREATE.user.hasFeature("custom_themes")){n.copyTheme(a,o)}else{e.preventDefault();__UPGRADE.openUpgradeModal("upgradeThemes")}SM.Logger.enqueue({action_type:"click_customize_standard_theme",ui_trigger:"accordionTheme"});break;case"edit":if(CREATE.user.hasFeature("custom_themes")){f(a);n.editTheme(a,o)}else{e.preventDefault();__UPGRADE.openUpgradeModal("upgradeThemes")}SM.Logger.enqueue({action_type:"click_edit_custom_theme",ui_trigger:"accordionTheme"});break;case"delete":n.deleteTheme(a,function(e){f(e.theme_id)});break}}}function g(e){$("span.themeActions").each(function(t,i){var n=$(i).closest("a").attr("data-themeid");if(n!==e){$(i).data("actionMenu").close()}})}function h(){var e=i.find("[data-group-themes-panel]"),t=2;e.on("click","[data-more-themes-btn]",function(n){var o=$(this),s=e.find("[data-group-themes-loader]"),r=e.find("[data-group-themes-btn-bar]");n.preventDefault();if(!CREATE.survey.hasPermission("edit")){return}o.addClass("hide");s.spin({color:"#fff",top:"100%",length:4,width:3,radius:5});CREATE.Ajax.getGroupThemesHTML({page_index:t,action:"list_html"}).done(function(n){var s=$($.parseHTML(n.html));s.find("span.themeActions").each(function(e,t){var n=$(t);if(n.find(".addNewTheme").length===0){n.actionMenu({actions:[a.apply],parentEl:i.find("[tab=t3]")})}});e.find("[data-theme-list-item]").last().after(s);if(n.is_last_page){r.remove()}else{t++;o.removeClass("hide")}}).fail(function(){r.remove()}).always(function(){s.spin(false)})}).on("actionMenu.beforeOpen","span.themeActions",function(e){g($(e.target).closest("a").attr("data-themeid"))}).on("actionMenu.afterOpen",function(){if(!CREATE.survey.hasPermission("edit")){$(".action-menu").find("a.option").addClass("disabled")}}).on("actionMenu.actionSelected","span.themeActions",p).find("span.themeActions").each(function(e,t){$(t).actionMenu({actions:[a.apply],parentEl:i.find("[tab=t3]")})})}_.extend(t,{init:l})})(function(e){return window["createweb"+e]||window[e]
},window["createweb:js/create/step2/accordion/accordion_theme"]=window["js/create/step2/accordion/accordion_theme"]={});(function(e,t){var i,n,a,o,s,r,l,d,u,c,f,p=$("#livePreview"),g={logo:{disabledClassName:"noLogo",waterparkName:"logoSurveySettings",fetch:"header"},title:{disabledClassName:"",waterparkName:"",fetch:"header"},page_title_enabled:{disabledClassName:"hidePageTitle",waterparkName:"",fetch:"header"},footer_enabled:{disabledClassName:"hideFooter",waterparkName:""},progress_bar:{disabledClassName:"",Extra:true,waterparkName:"progressSurveySettings",fetch:"progressbar"},exit_title:{disabledClassName:"",DefaultNeeded:true,waterparkName:"exit_title",fetch:"header"},language:{Extra:true,waterparkName:"languageSurveySettings"},question_numbering:{disabledClassName:"hideQuestionNumbering",Extra:true,DefaultNeeded:true,waterparkName:"qNumbersSurveySettings"},page_numbering:{disabledClassName:"hidePageNumbering",waterparkName:"",fetch:"header"},use_asterisk_enabled:{disabledClassName:"hideRequiredAsterisk",waterparkName:""},page_randomization:{Extra:true,waterparkName:"pRandomSurveySettings"},page_logic:{waterparkName:"pLogicSurveySettings"},question_randomization:{waterparkName:"qRandomSurveySettings"},block_randomization:{waterparkName:"bRandomSurveySettings"},custom_variables:{waterparkName:"variablesSurveySettings"},quota:{waterparkName:"quotasSurveySettings"},quiz:{disabledClassName:"",waterparkName:"quizSurveySettings"}},h={qRandomSurveySettings:"question_randomization",pLogicSurveySettings:"page_logic",bRandomSurveySettings:"block_randomization",variablesSurveySettings:"custom_variables",quotasSurveySettings:"quota",logoSurveySettings:"logo",quizSurveySettings:"quiz"},m;function v(){var e={quizSurveySettings:n,pLogicSurveySettings:a,pRandomSurveySettings:o,qRandomSurveySettings:s,bRandomSurveySettings:r,variablesSurveySettings:l,quotasSurveySettings:d,languageSurveySettings:f},t={logoSurveySettings:i,progressSurveySettings:u,qNumbersSurveySettings:c,exit_title:CREATE.EditExitLink};if(CREATE.stepName==="draft"){m=e}else if(CREATE.stepName==="theme"){m=t}else{m=$.extend(e,t)}$.each(m,function(e,t){t.init()})}function E(e){var t=CREATE.survey.get("design_settings");if(e in t){return t[e]}return CREATE.survey.get(e)}function C(e){var t=null,i=false,n;if(e==="question_randomization"){CREATE.pages.each(function(t){if(t.get(e).enabled===true){i=t.get(e).enabled}})}else if(e==="page_logic"){i=CREATE.survey.hasPageLogic()}else if(e==="block_randomization"){n=E("block_randomization");i=(n?n.enabled:false)||_.any(CREATE.survey.get("blocks"),function(e){return e.page_randomization_type!=="none"})}else{t=E(e);if($.isPlainObject(t)){if("enabled"in t){i=t.enabled}else{i=!$.isEmptyObject(t)}}else if($.isArray(t)){i=t.length>0}else if(t){i=true}}return i}function q(e){var t=$(e),i=t.attr("rel"),n=b(i),a={},o={},s=CREATE.survey.get("design_settings"),r={fetch:g[i].fetch,is_design_setting:i in s};a[i]=n;if(r.is_design_setting){o.design_settings=$.extend({},s,a)}else{o=a}CREATE.survey.update(o,r).done(function(){y(e,i);if(i==="progress_bar"){u.updateProgressBar()}});if(i==="question_numbering"){$("#livePreview").trigger("settingUpdated")}}function b(e){var t=T(e),i=E(e),n=g[e].DefaultNeeded;if(typeof i==="object"&&"enabled"in i){i.enabled=t;if(e==="progress_bar"){i.location=parseInt($("input:radio[name=progressPosition]:checked").val(),10);i.type=m.progressSurveySettings.getType()}if(n){i=m[g[e].waterparkName].provideDefault(i)}}else{i=t}return i}function y(e,t){var i=C(t),n=g[t].disabledClassName||"",a=g[t].Extra,o=$();if(a){e=e.parent();o=$("li[rel="+t+"]")}if(i){e.removeClass("off");o.removeClass("off");e.find("input, select, section .btn").prop("disabled",false).removeClass("disabled");p.removeClass(n)}else{p.addClass(n);e.addClass("off");o.addClass("off");e.find("input, select, section .btn").prop("disabled",true).addClass("disabled")}if(CREATE.survey.hasBrandRefreshTheme()){if(t==="footer_enabled"&&i){$("div.sm-footer-logo").removeClass("hide")}else if(t==="footer_enabled"&&!i){$("div.sm-footer-logo").addClass("hide")}}CREATE.LivePreview.resetUIForBrandRefresh()}function T(e){var t=E(e);if(t===1||t===2){return 0}else if(e==="question_numbering"&&t===0){return parseInt($("input:radio[name=qNumbers]:checked").val(),10)}else if(t.enabled===true||t===true||t.enabled===1){return false}else if(t.enabled===false||t===false||t.enabled===0){return true}else{return 1}}function w(e){var t=e.closest(".waterpark"),i=t.closest(".key"),n;if(!e.attr("rel")){e=e.closest("[rel]")}n=e.attr("rel");if(n==="logoSurveySettings"){if($("#logoMasterToggle").hasClass("off")){$("#replaceLogo").trigger("click");return true}}if(n!=="pRandomSurveySettings"){i.find(".done").attr("data-waterpark",n);t.removeClass("s1").addClass(n).addClass("s2")}m[n].load()}function R(e){var t=$(".key.open"),i=t.find(".waterpark"),n,a,o;if(!i.hasClass("s1")){a=e?e:t.find(".s2 .done");o=a.attr("data-waterpark");if(o){a.parents("section.waterpark").attr("class","waterpark s1 clearfix");a.attr("data-waterpark","");if(o!=="languageSurveySettings"){if(o==="qRandomSurveySettings"||o==="bRandomSurveySettings"||o==="pLogicSurveySettings"||o==="variablesSurveySettings"||o==="quotasSurveySettings"||o==="logoSurveySettings"){n=$("li[rel="+h[o]+"]")}else{n=$(a).parent().parent().find("."+o+" .toggle")}y(n,n.attr("rel"))}}}}function A(){$("#createAccordion").on("click",".s1 .lane a",function(e){if(CREATE.survey.hasPermission("edit")){w($(e.target))}e.preventDefault();e.stopPropagation()}).on("click",".done",function(e){var t=$(e.target).closest(".slide");if(t.hasClass("s3")){t.closest(".waterpark").removeClass("s3").addClass("s2")}else{R($(e.target))}e.preventDefault();e.stopPropagation()}).on("click","nav.tabs",function(e){R();e.preventDefault();e.stopPropagation()}).on("click",".toggle a:not(.customToggle):not(.quiz-banner)",function(e){var t=$(this).parent();if(CREATE.survey.hasPermission("edit")){q(t)}e.preventDefault();e.stopPropagation()})}_.extend(t,{init:function(){if(CREATE.stepName!=="theme"){n=e("js/create/step2/accordion/accordion_quiz");a=e("js/create/step2/accordion/accordion_page_skip");o=e("js/create/step2/accordion/accordion_page_random");s=e("js/create/step2/accordion/accordion_question_random");r=e("js/create/step2/accordion/accordion_block_random");l=e("js/create/step2/accordion/accordion_custom_variables");d=e("js/create/step2/accordion/accordion_quota");f=e("js/create/step2/accordion/accordion_language")}if(CREATE.stepName!=="draft"){i=e("js/create/step2/accordion/accordion_logo");u=e("js/create/step2/accordion/accordion_progressbar");c=e("js/create/step2/accordion/accordion_question_number")}A();v();p.on("showLogicAccordion",function(){$("#accLogic .press").click();R($("#surveyLogicSettings .s2 .done"))})}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_display"]=window["js/create/step2/accordion/accordion_display"]={});(function(e,t){function i(){var e=$("#logoTitle").val();$("img.logo").attr("alt",e).attr("title",e)}function n(){var e=CREATE.survey.hasBrandRefreshTheme();if(!e){$("<img/>").attr("src",$("img.logo")[0].src).load(function(){var e=$("#logoSize"),t="width",i=this.width+"px";if(this.height>=this.width){t="height";i=this.height+"px"}switch(e.val()){case"-1":break;case"100":i="100px";break;case"200":i="200px";break;case"300":i="300px";break}$("img.logo").each(function(){$(this).attr("style","").css(t,i)})})}}function a(){var e={height:-1,width:-1,alt_text:"",size_type:-1,vertical_align:"top",enabled:true,s3_key:"",file_name:""},t=f(e);CREATE.survey.update({design_settings:$.extend({},CREATE.survey.get("design_settings"),{logo:t})},{fetch:"header",notificationKey:"remove_logo",is_design_setting:true}).done(function(){o();$("#surveyDisplaySettings .done").trigger("click")})}function o(){$(".logoSurveySettings").removeClass("uploaded");$("#logoPosition").val("top");$("#logoSize").val("-1");$("#logoTitle").val("");$("#editLogoImage .thumbnail").attr("src","");$("#logoFilename").html("")}function s(e){var t=e.alt_text;$("#logoTitle").val(t)}function r(e){var t=e.size_type;$("#logoSize").val(t)}function l(e){if(e.file_name){$("#logoFilename").text(e.file_name)}}function d(e){var t=e.vertical_align;$("#logoPosition").val(t)}function u(){var e=CREATE.survey.get("design_settings").logo;s(e);r(e);l(e);d(e)}function c(e){var t={alt_text:$("#logoTitle").val(),size_type:parseInt($("#logoSize").val(),10),file_name:$("#logoFilename").text(),vertical_align:$("#logoPosition").val()},i=f($.extend(t,e||{})),n=CREATE.survey.hasBrandRefreshTheme();return CREATE.survey.update({design_settings:$.extend({},CREATE.survey.get("design_settings"),{logo:i})},{fetch:"header",is_design_setting:true,is_brand_refresh:n})}function f(e){var t=CREATE.survey.get("design_settings").logo;return $.extend({},t,e)}function p(e){var t=e.imageData;c({width:t.width,height:t.height,enabled:true,s3_key:t.s3Key}).done(function(){$("#replaceLogo").prop("disabled",false);$("#logoMasterToggle").removeClass("off");$("#logoMasterToggle > a").trigger("click");$(".logoSurveySettings").addClass("uploaded");$("#editLogoImage .thumbnail").attr("src",t.url);$("#logoFilename").html("");$("#livePreview").removeClass("noLogo");n();CREATE.LivePreview.resetUIForBrandRefresh()});$("#create").trigger("newCreateFeatureAdded",["logoUpload"])}function g(){$("form.logoSurveySettings").on("change","#logoSize",function(e){c({}).done(n);e.preventDefault()}).on("change","#logoPosition",function(e){if(e.originalEvent){c({});e.preventDefault()}}).on("blur","#logoTitle",function(e){var t=CREATE.survey.get("design_settings").logo.alt_text;if(t!==$(e.target).val()){c({}).done(i)}e.preventDefault()}).on("click","#deleteLogo",function(e){a();e.preventDefault();if(e.originalEvent!==undefined){SM.Logger.enqueue({action_type:"click_accordion_options_remove_logo",ui_trigger:"accordionOptions"})}}).on("click","#replaceLogo",function(e){var t;e.preventDefault();t=SM.Views.create(SM.SurveyImagesDialogView,{assetLibraryModel:CREATE.AssetLibrary.getInstance(),source:"logo"});t.$el.on("imageUploaded",p);t.open();if(e.originalEvent!==undefined){SM.Logger.enqueue({action_type:"click_accordion_options_replace_logo",ui_trigger:"accordionOptions"})}})}_.extend(t,{init:g,load:u})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_logo"]=window["js/create/step2/accordion/accordion_logo"]={});(function(e,t){var i;function n(){CREATE.QuizWarning.updateQuizAccUI(CREATE.QuizWarning.hasAnyDisabledLogic())}function a(){var e=$(".quizSurveySettings");e.on("click",".quiz-banner",function(e){var t=$.extend({},CREATE.survey.get("quiz_options")),n;e.preventDefault();e.stopPropagation();t.is_quiz_mode=!t.is_quiz_mode;SM.Logger.quizModeToggleLogging(t.is_quiz_mode);if(!t.is_quiz_mode&&CREATE.LivePreview.getQuizIds().length>0){i.open();return}if(t.is_quiz_mode){CREATE.QuizWarning.populateDisabledLogic();n=CREATE.QuizWarning.hasAnyDisabledLogic();if(n){t.show_results_type="disabled"}else if(!CREATE.QuizWarning.firstQuizEnabled){CREATE.QuizWarning.firstQuizEnabled=true;t.show_results_type="results_and_answers"}}CREATE.survey.updateQuizMode(t).done(function(){CREATE.QuizWarning.updateSurveyQuestionQuizState(t.is_quiz_mode);CREATE.QuizWarning.updateQuizAccUI(n);$("#livePreview").trigger("quizChanged")})}).on("click","#quizResults",function(){var e=CREATE.survey.get("quiz_options"),t=$(this).prop("checked");if(!t){e.show_results_type="disabled"}else if($("#quizAnswers").prop("checked")){e.show_results_type="results_and_answers"}else{e.show_results_type="results_only"}SM.Logger.quizDisplayResultsLogging(t);CREATE.survey.updateQuizMode(e).done(function(){CREATE.QuizWarning.updateQuizAccUI(false)})}).on("click","#quizAnswers",function(){var e=CREATE.survey.get("quiz_options"),t=$(this).prop("checked");e.show_results_type=t?"results_and_answers":"results_only";SM.Logger.quizShowCorrectAnswersLogging(t);CREATE.survey.updateQuizMode(e)});i=SM.Views.create(SM.DialogView,{isModal:true,closeBtn:true,height:400,width:550,templateID:"quizWarningModal"});i.$el.on("click","#quizWarningBtn",function(e){var t=$.extend({},CREATE.survey.get("quiz_options"));e.preventDefault();e.stopPropagation();t.is_quiz_mode=false;CREATE.survey.updateQuizMode(t).done(function(){CREATE.QuizWarning.updateSurveyQuestionQuizState(false);CREATE.QuizWarning.updateQuizAccUI(false);$("#livePreview").trigger("quizChanged");if(i.isOpen()){i.close()}})})}_.extend(t,{init:a,load:n})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_quiz"]=window["js/create/step2/accordion/accordion_quiz"]={});(function(e,t){var i;function n(){var e=a();if(e===0){$("#newPageSkipLogic").trigger("click")}}function a(){var e,t=[];$("#page_list li").remove();CREATE.pages.each(function(i){if(i.hasLogic()){e=r(null,i.id);$("#page_list").append(e);t.push(i.id)}});$("#newPageSkipLogic").toggleClass("hide",t.length===CREATE.pages.length);return t.length}function o(e){var t=$("#page_source_selector").empty(),i;CREATE.pages.each(function(n,a){var o;if(e||!n.hasLogic()){i=CREATE.utils.getPageHeader(n,a+1);o=$("<option />",{value:n.id,text:i});t.append(o)}})}function s(e){if(!e){e=$("#page_source_selector").val()}$("#livePreview").trigger("openSkipLogic",[e])}function r(e,t){var i=CREATE.pages.get(t),n=$($.trim($("#pageSkipMarkup").html())),a=i.get("heading")||"";n.find("a span").replaceWith(i.get("position")+(a?": "+a:""));n.find("a:first").attr({"data-page_id":t,"data-page_number":i.get("position")});return n}function l(e){$("#page_source_selector").show(0);i.find(".paneTitle b").html("");$("#surveyLogicSettings").attr("class","waterpark s3 clearfix "+e)}function d(){i.on("click",".lanes a",function(e){e.preventDefault();s($(e.target).closest("a").data("page_id"))}).on("click","#newPageSkipLogic",function(e){e.preventDefault();o(false);l(this.rel);$("#page_target_selector").val(-3)}).on("click","#cancel_page_logic",function(e){e.preventDefault();$("#surveyLogicSettings").removeClass("s3").addClass("s2")}).on("click","#next_page_logic",function(e){e.preventDefault();s()});$("#livePreview").on("previewUpdated settingUpdated",function(){var e=$("#surveyLogicSettings");if(e.hasClass("s1")){$("#pageSkipMasterToggle").toggleClass("off",!CREATE.survey.hasPageLogic())}else if(e.hasClass("pLogicSurveySettings")){if(e.hasClass("s3")){e.removeClass("s3").addClass("s2")}if(e.hasClass("s2")){n()}}})}_.extend(t,{init:function(){i=$("#surveyLogicSettings .pLogicSurveySettings");d()},load:n})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_page_skip"]=window["js/create/step2/accordion/accordion_page_skip"]={});(function(e,t){function i(){var e=CREATE.survey.get("page_randomization");$("#page_randomizationMasterToggle").toggleClass("off",!e||!e.enabled)}function n(){$("#livePreview").on("settingUpdated",function(){i()})}_.extend(t,{init:function(){i();n()},load:function(){$("#livePreview").trigger("openPageRandom")}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_page_random"]=window["js/create/step2/accordion/accordion_page_random"]={});(function(e,t){var i;function n(e){$("#qrand_page_source_selector").removeClass("hide");a();o();if(!e){l()}}function a(){$("#qrand_page_list li").remove();CREATE.pages.each(function(e,t){var i=e.get("question_randomization"),n;if(i&&i.enabled&&i.type&&i.questions_applied){n=s(t,e);$("#qrand_page_list").append(n)}})}function o(){var e,t;$("#qrand_page_source_selector").find("option").remove();CREATE.pages.each(function(i,n){t=CREATE.utils.getPageHeader(i,n+1);e=$("<option />",{value:i.id,text:t});e.data({page_number:n+1});$("#qrand_page_source_selector").append(e)})}function s(e,t){var i=$($.trim($("#questionRandomPagesMarkup").html())),n=t.get("heading")||"";i.find("a span").replaceWith(t.get("position")+": "+n);i.find("a:first").data({page_id:t.id,page_number:t.get("position")});return i}function r(e){if(!e){e=$("#qrand_page_source_selector").val()}$("#livePreview").trigger("openQuestionRandom",[e])}function l(){var e=false;CREATE.pages.each(function(t){if(t.get("question_randomization").enabled){e=true;return false}});if(e===false){$("#newQuestionLogic").trigger("click")}return e}function d(){i.find(".paneTitle b").html("");$("#surveyLogicSettings").removeClass("s2").addClass("s3")}function u(){var e=$("#surveyLogicSettings");i.on("click",".lanes a",function(e){e.preventDefault();r($(e.target).closest("a").data("page_id"))}).on("click","#newQuestionLogic",function(e){e.preventDefault();n(true);d(this.rel)}).on("click","#cancel_qrandom_logic",function(t){t.preventDefault();e.removeClass("s3").addClass("s2");$("#questionsAffectedControls").removeClass("error")}).on("click","#next_qrandom_logic",function(e){e.preventDefault();r()});$("#livePreview").on("previewUpdated settingUpdated",function(){var t,i;if(e.hasClass("s1")){t=true;CREATE.pages.find(function(e){if(e.get("question_randomization").enabled){t=false;return true}});$("#questionRandomMasterToggle").toggleClass("off",t)}else if(e.hasClass("qRandomSurveySettings")){if(e.hasClass("s3")){i=CREATE.pages.get($("#qrand_page_source_selector").val());if(i){o();$("#qrand_page_source_selector").val(i.id)}else{e.removeClass("s3").addClass("s2");a()}}else if(e.hasClass("s2")){a()}}})}_.extend(t,{init:function(){i=$("#surveyLogicSettings .qRandomSurveySettings");u()},load:n})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_question_random"]=window["js/create/step2/accordion/accordion_question_random"]={});(function(e,t){var i,n,a,o,s,r,l,d,u,c,f,p,g,h,m,v,E,C,q,b,y,T;function w(){T.on("click",".s3 .done",function(){R()});$("#blockRandomizationHome").on("click","#newBlock",function(e){e.preventDefault();if(!$(e.target).hasClass("disabled")){j(true)}}).on("click","#editBlocks",function(e){e.preventDefault();j(false)}).on("click","#blockRandomLogic",function(e){e.preventDefault();W()}).on("click","#pageRandomLogic",function(e){e.preventDefault();G(true)});s.on("click",".pageSelection",function(e){var t=$(e.currentTarget);if(e.shiftKey){t.prevAll(".pageSelection:has(:checked):first").nextUntil(t).find("[name=addBlockPage]").prop("checked",true)}}).on("change","[name=addBlockPage]",function(){S()}).on("click","#cancelAddBlock",function(e){e.preventDefault();H(true)}).on("click","#addBlock",function(e){e.preventDefault();if(!$(e.target).hasClass("disabled")){X()}});l.on("change","[name=blockRandomType]",function(){N()}).on("change","[name=blockSelectionType]",function(){B()}).on("change","[name=blockEnableLimit]",function(){U()}).on("click","#applyBlockRandom",function(e){e.preventDefault();J()}).on("click","#cancelBlockRandom",function(e){e.preventDefault();H(false)}).on("keyup","[name=limit_number]",function(){g.removeClass("countError parseError")});m.on("change","[name=pageRandomType]",function(){O()}).on("change","[name=pageSelectionType]",function(){z()}).on("click","#applyPageRandom",function(e){e.preventDefault();Z()}).on("click","#cancelPageRandom",function(e){e.preventDefault();G(false)});o.on("click",".blockListing",function(e){var t=$(e.target);e.preventDefault();if(!t.is(".blockListing")){t=t.closest(".blockListing")}if(!t.is(".disabled")){K(t.data("blockid").toString())}});h.on("previewUpdated settingUpdated",function(){var e=CREATE.survey.get("blocks").length,t=CREATE.survey.get("block_randomization"),i=(t?t.enabled:false)||_.any(CREATE.survey.get("blocks"),function(e){return e.page_randomization_type!=="none"});if(e===0){$("#blockNumber").text("")}else{$("#blockNumber").text("("+e+")")}$("#blockRandomizationMasterToggle").toggleClass("off",!i)}).on("previewUpdated",function(){if(T.hasClass("bRandomSurveySettings")){H(true)}})}function R(){var e=CREATE.survey.get("blocks");a.html("");$.each(e,function(e,t){var i=r.find('[data-type="block"]').clone();V(t,i);i.find(".blockMenuBtn").remove();a.append(i)});$("#blockListContainer, #blockLogicContainer, #blockLogicContainerHeading").toggle(e.length>0);$("#newBlock").toggleClass("disabled",CREATE.survey.allPagesInBlocks())}function A(e){var t,a=false;i.html("");n.removeClass("error");S();T.find("[data-type=s3done]").removeClass("hide");s.find('[data-actionname="add"]').toggleClass("hide",!e);s.find('[data-actionname="edit"]').toggleClass("hide",e);t=CREATE.survey.getAllSections();$.each(t,function(e,t){var n,o,s=CREATE.utils.getPageHeader,l;if(t.position){l=CREATE.pages.get(t.id);n=r.find('[data-type="page"]').clone();if(l.isRandomized()){o=C.find("[data-type=random]").clone();a=true}else if(l.getPageLogicUsage().length>0){o=C.find("[data-type=pskip]").clone();a=true}else if(l.getQuestionLogicUsage().length>0){o=C.find("[data-type=qskip]").clone();a=true}else if(l.getQuestionIdsWithFunneling("both").length>0){o=C.find("[data-type=funnel]").clone();a=true}else{o=C.find("[data-type=pageId]").clone();o.val(t.id).attr("data-position",t.position);n.removeClass("disabled")}n.prepend(o);n.find('[data-name="pageHeading"]').text(s(l))}else if(t.block_id){n=r.find('[data-type="block"]').clone();V(t,n)}else{return}$("#randomSkipAlert").toggleClass("hide",!a);i.append(n)});x()}function S(){$("#addBlock").toggleClass("disabled",$("[name=addBlockPage]:checked").length<1)}function x(){i.find(".blockMenuBtn").each(function(e,t){var i=$(t);i.actionMenu({templateID:"block-edit-menu-template",parentEl:s}).on("actionMenu.menuInit",function(e){var t=e.actionMenu.get("menuView");t.$el.find(".q").popout();if(SM.Browser.isIE){t.$el.on("mousedown",function(e){$(e.target).trigger("click")})}}).on("actionMenu.actionSelected",function(e){var t=$(e.target),i=t.closest(".blockListing"),n=e.actionMenu.get("menuView"),a=n.get("selectedAction");switch(a){case"show":k(i,n);break;case"hide":M(i,n);break;case"break":Y(i.data("blockid")+"");break}})})}function k(e,t){var i=t.$el,n=e.find(".blockPages"),a;i.find('[data-container="show"]').addClass("hide");i.find('[data-container="hide"]').removeClass("hide");e.addClass("showDetails");if(n.children().length===0){a=e.data("blockid")+"";P(a,n)}}function P(e,t){var i=CREATE.survey.getBlock(e),n=i.pages_included;$.each(n,function(e,i){var n=CREATE.pages.get(i),a=$('<li class="blockPage">'+CREATE.utils.getPageHeader(n)+"</li>");t.append(a)})}function M(e,t){var i=t.$el;i.find('[data-container="hide"]').addClass("hide");i.find('[data-container="show"]').removeClass("hide");e.removeClass("showDetails")}function D(){var e=CREATE.survey.get("block_randomization"),t=CREATE.survey.get("blocks"),i=e?e.enabled:false,n=e?e.limit:false,a,o;p.removeClass("error");T.find("[data-type=s3done]").addClass("hide");if(i){a=e.type;u.find("[value="+a+"]").prop("checked",true);o=e.block_randomization_selection_type;p.find("[value="+o+"]").prop("checked",true)}else{u.find("[value=none]").prop("checked",true);p.find("[value=all]").prop("checked",true)}Q(e);N(e);B();if(n){g.find("[name=blockEnableLimit]").prop("checked",true);g.find("[name=limit_number]").val(n>t.length?t.length:n)}U()}function I(){var e=CREATE.survey.get("blocks");o.html("");$.each(e,function(e,t){var i=r.find('[data-type="block"]').clone();V(t,i);if(t.pages_included.length<=1){i.addClass("disabled").attr({title:CREATE.Translations.get("single_page_block_logic","defaults")["default"],"sm-tooltip-side":"top"})}else if(!_.isEmpty(t.pages_randomized)){i.find(".has-logic").removeClass("hide")}i.find(".blockMenuBtn, .blockListingIcon").remove();i.find(".arrow").removeClass("hide");o.append(i)})}function L(e){var t=e.pages_included,i=CREATE.utils.getPageAbbrev,n=i(CREATE.pages.get(t[0]))+"-"+i(CREATE.pages.get(t[t.length-1])),a=e.page_randomization_type,o=e.page_randomization_selection_type;$("#pageLogicHeading").text(CREATE.Translations.get("page_block_logic","default")["default"].replace(/\{1\}/,n));if(a!=="none"){v.find("[value="+a+"]").prop("checked",true);b.find("[value="+o+"]").prop("checked",true)}else{v.find("[value=none]").prop("checked",true);b.find("[value=all]").prop("checked",true)}F(e);O();z()}function F(e){var t=e.pages_randomized||[];q.html("");$.each(e.pages_included,function(i,n){var a,o;if(e.pages_included.length>1){a=E.clone();a.find("input").attr({value:n});o=CREATE.pages.get(n);a.find('[data-value="pageLabel"]').text(CREATE.utils.getPageAbbrev(o));a.find("input").prop("checked",$.inArray(parseInt(n,10),t)!==-1);q.append(a)}})}function Q(e){var t=e.blocks||[],i=CREATE.survey.get("blocks");f.html("");$.each(i,function(e,i){var n,a;n=c.clone();V(i,n);a=n.find("input");a.attr({id:"blockAffectedOption-"+i.block_id,value:i.block_id});a.prop("checked",$.inArray(i.block_id,t)!==-1);f.append(n)})}function N(){var e=u.find("[name=blockRandomType]:checked").val();p.toggleClass("hide",e==="none");g.toggleClass("hide",e==="none")}function B(){var e=p.find("[name=blockSelectionType]:checked").val();f.toggleClass("hide",e!=="list")}function U(){var e=g.find("[name=blockEnableLimit]").prop("checked");g.find(".limitnum").toggleClass("hide",!e)}function O(){var e=v.find("[name=pageRandomType]:checked").val();b.toggleClass("hide",e==="none");$("#pagesSettings").toggleClass("hide",e==="none")}function z(){var e=b.find("[name=pageSelectionType]:checked").val();q.toggleClass("hide",e!=="list")}function V(e,t){var i=e.pages_included,n=i.length>1,a=CREATE.utils.getPageAbbrev,o;t.attr("data-blockid",e.block_id);o=CREATE.pages.get(i[0]);t.find('[data-value="startPage"]').text(a(o));t.find('[data-value="hyphen"]').toggleClass("hide",!n);t.find('[data-value="endPage"]').toggleClass("hide",!n);if(n){o=CREATE.pages.get(i[i.length-1]);t.find('[data-value="endPage"]').text(a(o))}return t}function H(e){if(e){R()}T.removeClass("s3").addClass("s2")}function j(e){s.removeClass("hide");l.addClass("hide");d.addClass("hide");y.addClass("hide");A(e);T.removeClass("s2").addClass("s3")}function W(){s.addClass("hide");l.removeClass("hide");d.addClass("hide");y.addClass("hide");D();T.removeClass("s2").addClass("s3")}function G(e){s.addClass("hide");l.addClass("hide");d.removeClass("hide");y.removeClass("hide");if(e){I()}T.removeClass("s2 s4").addClass("s3")}function K(e){var t=CREATE.survey.getBlock(e);L(t);F(t);m.data("blockid",e);T.removeClass("s3").addClass("s4")}function X(){var e=i.find(":checked"),t=[],a=true,o;e.each(function(e,i){var n=$(i),s=n.data("position");if(o&&s!==o+1){a=false;return false}t.push(n.val());o=s});if(a){CREATE.survey.createBlock(t).done(function(){A(!s.find("[data-actionname=add]").hasClass("hide"));h.trigger("settingUpdated")}).fail(function(){CREATE.Notifications.showErrorNotification()})}else{n.addClass("error")}}function Y(e){CREATE.survey.deleteBlock(e).done(function(){A(!s.find("[data-actionname=add]").hasClass("hide"));h.trigger("settingUpdated")}).fail(function(){CREATE.Notifications.showErrorNotification()})}function J(){var e=u.find(":checked").val(),t=f.find(":checked"),i={},n=[],a=g.find("input[name=blockEnableLimit]").prop("checked"),o,s=CREATE.survey.get("blocks").length,r=p.find(":checked").val();$("#blockRandomLogic").find(".error").removeClass("error");g.find(".err").hide();if(e!=="none"){i.enabled=true;i.type=e;i.block_randomization_selection_type=r;if(a){o=parseInt(g.find("input[name=limit_number]").val(),10)}else{o=t.length}if(r==="list"){if(t.length<2){p.addClass("error");return}t.each(function(e,t){var i=$(t);n.push(parseInt(i.val(),10))});i.blocks=n;s=t.length}if(a){if(isNaN(o)){g.find(".err.nan").show();return}else if(o<=0){g.find(".err.one").show();return}else if(o>s){g.find(".err.max").show();return}}i.limit=a&&o||undefined}else{i.enabled=false}CREATE.survey.update({block_randomization:i}).done(ee)}function Z(){var e=CREATE.survey.getBlock(m.data("blockid")),t=v.find(":checked").val(),i=q.find(":checked"),n={},a=[],o=b.find(":checked").val();m.find(".error").removeClass("error");if(t!=="none"){n.page_randomization_type=t;n.page_randomization_selection_type=o;if(o==="list"){if(i.length<2){b.addClass("error");return}i.each(function(e,t){var i=$(t);a.push(parseInt(i.val(),10))});n.pages_randomized=a}else{n.pages_randomized=[]}}else{n.page_randomization_type="none";n.page_randomization_selection_type="list";n.pages_randomized=[]}CREATE.survey.updateBlock(e.block_id,n).done(te)}function ee(){H(true);h.trigger("settingUpdated")}function te(){G(true);h.trigger("settingUpdated")}_.extend(t,{init:function(){r=$("<div>"+$("#addBlockListMarkup").html()+"</div>");c=$($.trim($("#blocksAffectedListMarkup").html()));E=$($.trim($("#pagesAffectedListMarkup").html()));i=$("#addBlockList");n=$("#addBlockListContainer");a=$("#blockHomeList");o=$("#blockLogicSingleList");s=$("#blockManager");l=$("#blockRandomLogicContainer");d=$("#blockRandomLogicSingle");u=$("#blockRandomType");f=$("#blocksForRandomList");p=$("#blocksSelectionType");g=$("#blocksSettings");h=$("#livePreview");m=$("#pageRandomLogicContainer");v=$("#pageRandomType");C=r.find("#pageSelectInserts");q=$("#pagesForRandomList");b=$("#pagesSelectionType");y=$("#s3_done");T=$("#surveyLogicSettings");SM.Tooltips.enable({selector:"#blockLogicSingleList .blockListing.disabled[sm-tooltip-side]",delay:300});w()},load:function(){H(true)}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_block_random"]=window["js/create/step2/accordion/accordion_block_random"]={});(function(e,t){var i;function n(){$("#hasResponseCustomVariableWarning").addClass("hide");$("#custom_variable_list li:not(.template)").remove();var e;$.each(CREATE.survey.get("custom_variables"),function(t,i){e=p(i);$("#custom_variable_list").append(e)})}function a(){i.find("#customVariableID").val("");i.find("#customVariableLabel").val("");i.find("#customVariableName").val("");i.find("#remove_custom_variable").addClass("hide");b();m(3)}function o(){m(2)}function s(e){g(e);m(3);h();b();$("#remove_custom_variable").removeClass("hide")}function r(){var e=i.find("#customVariableID").val()||"0";e=$.trim(e);return parseInt(e,10)}function l(){var e=r(),t=$.trim(i.find("#customVariableName").val()),n=$.trim(i.find("#customVariableLabel").val())||t,a,o;if(E()){if(e===0){o={variable_name:t,variable_label:n};CREATE.Ajax.createCustomVariable(o).done(u).fail(function(){CREATE.Notifications.showErrorNotification()})}else if(e>0){a=0;$.each(CREATE.survey.get("custom_variables"),function(t,i){if(i.custom_variable_id===e){a=i.question_id}});if(a>0){o={custom_variable_id:e,variable_name:t,variable_label:n,question_id:a};CREATE.Ajax.updateCustomVariable(o).done(c).fail(function(){CREATE.Notifications.showErrorNotification()})}}}}function d(){var e=r(),t=0,i;$.each(CREATE.survey.get("custom_variables"),function(i,n){if(n.custom_variable_id===e){t=n.question_id;return false}});i={custom_variable_id:e,question_id:t};CREATE.Ajax.deleteCustomVariable(i).done(f).fail(function(e){var t=e.appError.name;if(t!=="CannotDeleteCustomVariableException"){t="Exception"}CREATE.Notifications.showErrorNotification({messageKey:t})})}function u(e){var t=_.clone(CREATE.survey.get("custom_variables"));t.push(e.new_custom_variable);CREATE.survey.set("custom_variables",t);n();m(2)}function c(e){if(e.updated_custom_variable){$.each(CREATE.survey.get("custom_variables"),function(t,i){if(i.custom_variable_id===e.updated_custom_variable.custom_variable_id){CREATE.survey.get("custom_variables")[t]=e.updated_custom_variable;return false}})}n();m(2)}function f(e){var t=_.clone(CREATE.survey.get("custom_variables"));$.each(CREATE.survey.get("custom_variables"),function(i,n){if(n.custom_variable_id===e.deleted_custom_variable_id){t.splice(i,1);return false}});CREATE.survey.set("custom_variables",t);n();m(2)}function p(e){var t=$($.trim($("#customVarMarkup").html())),i,n,a;t.removeClass("hide template");i=t.find("a:first");n=t.find("a span");a=e.hasOwnProperty("variable_label")?e.variable_label:"";n.replaceWith(a);i.data({
custom_variable_id:e.custom_variable_id,variable_name:e.variable_name,variable_label:e.variable_label});i.attr({title:a,rel:"variablesSurveySettings",href:"#"});return t}function g(e){var t=$(e).data("custom_variable_id"),n=$(e).data("variable_name"),a=$(e).data("variable_label");i.find("#customVariableID").val(t);i.find("#customVariableLabel").val(a);i.find("#customVariableName").val(n);i.find("#customVariableName").parent().removeClass("error");i.find("#customVariableLabel").parent().removeClass("error")}function h(){var e=false;$.each(CREATE.survey.get("custom_variables"),function(){e=true;return});if(e===false){$("#newCustomVariable").trigger("click")}return e}function m(e){i.find("#customVariableLabel").blur();i.find("#customVariableName").blur();$("#surveyLogicSettings").attr("class","waterpark clearfix variablesSurveySettings s"+e)}function v(){i.on("click","#newCustomVariable",function(e){e.preventDefault();a()}).on("click","#save_custom_variable",function(e){var t;e.preventDefault();t=$(this);l()}).on("click",".lanes a",function(e){e.preventDefault();s(e.target)}).on("click","#cancel_custom_variable",function(e){e.preventDefault();o()}).on("click","#remove_custom_variable",function(e){e.preventDefault();d()})}function E(){var e=true,t,n,a=i.find("#save_custom_variable");if(!a.hasClass("disabled")){t=C();n=q();e=t&&n}else{e=false}return e}function C(){var e=r(),t=$.trim(i.find("#customVariableName").val()),n=i.find("#customVariableName").next("span"),a=i.find("#customVariableName").closest("section").removeClass("error"),o=t.match(/^[a-zA-Z0-9\_]+$/g),s,l=true;if(t.length===0){s=CREATE.Translations.get("custom_variables","errors")[1].message;n.html(s);a.addClass("error");l=false}else if(t.indexOf(" ")!==-1){s=CREATE.Translations.get("custom_variables","errors")[2].message;n.html(s);a.addClass("error");l=false}else if(t.length>50){s=CREATE.Translations.get("custom_variables","errors")[3].message;n.html(s);a.addClass("error");l=false}else if(!o){s=CREATE.Translations.get("custom_variables","errors")[4].message;n.html(s);a.addClass("error");l=false}$.each(CREATE.survey.get("custom_variables"),function(i,o){if(o.variable_name===t&&o.custom_variable_id!==e){s=CREATE.Translations.get("custom_variables","errors")[5].message;n.html(s);a.addClass("error");l=false;return false}});return l}function q(){var e=$.trim(i.find("#customVariableLabel").val()),t=i.find("#customVariableLabel").closest("section").removeClass("error"),n=e.match(/^[a-zA-Z0-9\_\s]+$/g);if(!n&&e.length>0){t.addClass("error");return false}return true}function b(){i.find("#customVariableName").parent().removeClass("error");i.find("#customVariableLabel").parent().removeClass("error");i.find("#save_custom_variable").removeClass("disabled")}_.extend(t,{init:function(){i=$("#surveyLogicSettings .variablesSurveySettings");v()},load:function(){n();h()}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_custom_variables"]=window["js/create/step2/accordion/accordion_custom_variables"]={});(function(e,t){var i=false;function n(){var e;if(!i){s()}else if(CREATE.survey.get("question_logic").length>0||CREATE.survey.get("page_logic").length>0){e=$("#pagesCompletedProgressBarCheckbox").prop("checked");a();if(e){u()}}else{o()}CREATE.LivePreview.resetUIForBrandRefresh()}function a(){$("#progressBarWithLogicAlert, #progressBarPageLogicAlert").removeClass("hide");$("#pagesCompletedProgressBarCheckbox").prop("checked",false).prop("disabled",true).closest("label").addClass("disabled")}function o(){$("#progressBarWithLogicAlert, #progressBarPageLogicAlert").addClass("hide");$("#pagesCompletedProgressBarCheckbox").prop("disabled",false).closest("label").removeClass("disabled")}function s(){r();l();i=true;n()}function r(){var e=2,t=CREATE.survey.get("design_settings").progress_bar.location||e;$("#surveyDisplaySettings").find("[name=progressPosition]").filter("[value="+t+"]").prop("checked",true)}function l(){var e=parseInt(CREATE.survey.get("design_settings").progress_bar.type,10);if(CREATE.survey.get("design_settings").progress_bar.enabled===false&&CREATE.survey.get("design_settings").progress_bar.location===0){e=[1,2]}else{if(e===0){return}else if(e===3){e=[1,2]}else{e=[e]}}$.each(e,function(e,t){$("#surveyDisplaySettings").find("[name=progressFormat]").filter("[value="+t+"]").prop("checked",true)})}function d(){var e=$("#surveyDisplaySettings").find("[name=progressFormat]:checked"),t=0;if(e.length!==0){$.each(e,function(){var e=$(this).val();t+=parseInt(e,10)})}return t}function u(){var e=CREATE.survey.get("design_settings").progress_bar;e.location=parseInt($(".progressSurveySettings [name=progressPosition]:checked").val(),10);e.type=d();CREATE.survey.update({design_settings:$.extend({},CREATE.survey.get("design_settings"),{progress_bar:e})},{fetch:"progressbar",is_design_setting:true})}_.extend(t,{init:function(){$("form.progressSurveySettings").on("click",'input[name="progressPosition"]',u).on("click",'input[name="progressFormat"]',u);$("#progressBarWithLogicAlert").on("toggleLogicApplied",n)},load:s,getType:d,updateProgressBar:n})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_progressbar"]=window["js/create/step2/accordion/accordion_progressbar"]={});(function(e,t){var i=$("#livePreview");function n(){i.trigger("previewChanged")}function a(){var e=CREATE.survey.get("design_settings").question_numbering,t,i;if(e!==0){t=$("section.qNumbersSurveySettings").find("[name=qNumbers]:checked").val();if(isNaN(t)){t=1}}else{t=e}i={question_numbering:parseInt(t,10)};CREATE.survey.update({design_settings:$.extend({},CREATE.survey.get("design_settings"),i)},{is_design_setting:true}).done(function(){var e=CREATE.pages.get(CREATE.survey.pageInView);if(CREATE.survey.isSinglePageMode()){e.fetch({loadPages:false}).done(function(){n()})}else{n()}})}function o(){$("form.qNumbersSurveySettings").on("change",'input[name="qNumbers"]',a)}_.extend(t,{init:function(){o()},load:function(){var e=CREATE.survey.get("design_settings").question_numbering;if(e!==0){$("section.qNumbersSurveySettings").find("[name=qNumbers]").filter("[value="+e+"]").prop("checked",true)}},provideDefault:function(){n()}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_question_number"]=window["js/create/step2/accordion/accordion_question_number"]={});(function(e,t){function i(){var e=parseInt($("#surveyLanguage").val(),10);if(CREATE.survey.get("language").id===e){return}CREATE.survey.update({language:{id:e}}).done(function(){CREATE.Notifications.showLoadNotification();location.reload()})}function n(){$(".s2 .done").on("click",function(e){if($(e.target).attr("data-waterpark")==="languageSurveySettings"){i()}})}_.extend(t,{init:function(){var e=CREATE.survey.get("language").id;n();$("#surveyLanguage").val(e);$("#surveyLanguageDisp").html($("#surveyLanguage option:selected").text())},load:function(){}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_language"]=window["js/create/step2/accordion/accordion_language"]={});(function(e,t){var i=false,n,a,o,s,r=1,l=2,d=3,u=4,c=5;function f(){s.on("click","#createSimpleQuota",function(e){e.preventDefault();b("simple")}).on("change","[id^=pageListSelector]",function(e){w($(e.target))}).on("change","[id^=questionListSelector]",function(e){ce($(e.target))}).on("click","#setQuestionNext",function(e){e.preventDefault();H()}).on("click","#cancelSetQuestions",function(e){e.preventDefault();R()}).on("click",".saveQuotaGroupBtn",function(e){e.preventDefault();K($(e.target))}).on("click",".saveQuotaEquationBtn",function(e){e.preventDefault();ie($(e.target))}).on("click",".cancelEditQuotaGroupBtn",function(e){e.preventDefault();F()}).on("click",".addAnswerGroupSection a",function(e){e.preventDefault();I($(e.target))}).on("click",".addCombinationSection a",function(e){e.preventDefault();B(e.target)}).on("click",".quotaCollapsedGroup a, .quotaCollapsedGroup span",function(e){e.preventDefault();L($(e.target))}).on("click",".quotaEquationCollapsed a, .quotaEquationCollapsed span",function(e){e.preventDefault();U($(e.target))}).on("click",".cancelEditQuotaEquationBtn",function(e){e.preventDefault();O()}).on("click",".deleteQuotaGroupBtn",function(e){e.preventDefault();Y()}).on("click",".deleteQuotaEquationBtn",function(e){e.preventDefault();ae()}).on("click","#cancelOptionsBtn",function(e){e.preventDefault();V()}).on("change","input[name=quotaEndPageTypeRadio]",function(){Ee()}).on("blur","#overQuotaURL",function(e){e.target.value=p(e.target.value)}).on("click","#saveOptionsBtn",function(e){e.preventDefault();re()});$("body").on("click","#deleteAllQuotaBtn, #deleteAllComboQuotaBtn",function(e){e.preventDefault();ne()}).on("click","#optionsBtn",function(e){e.preventDefault();z()}).on("click","#nextEditQuotaGroupsBtn",function(e){e.preventDefault();Q()}).on("click",".comboQuotaBtn",function(e){e.preventDefault();b("combination")})}function p(e){if(e.indexOf("http://")!==0&&e.indexOf("https://")!==0){e="http://"+e}return e}function g(){$("#livePreview").on("previewUpdated",function(){n=undefined;i=false;if(o.hasClass("quotasSurveySettings")){o.removeClass("quotasSurveySettings");m(r)}})}function h(){if(!n){m(r);if(CREATE.survey.get("question_count")>100){CREATE.Ajax.getQuotaQualifiedQuestions({sorted:false}).done(function(e){var t=[10,11,12,13,14,20,21,22,23],i=[],a=1;$.each(e.qualified_questions,function(e,n){if(n.question_type<150){if($.inArray(n.question_type,t)>=0){n.question_number=a;i.push(n)}a++}});n=new CREATE.collections.Questions(i,{pageExpanded:false});v()}).fail(Ce)}else{CREATE.Ajax.getQuotaQualifiedQuestions({sorted:true}).done(function(e){n=new CREATE.collections.Questions(e.qualified_questions,{pageExpanded:false});v()}).fail(Ce)}}else{v()}}function m(e){o.removeClass("s1 s2 s3 s4 s5").addClass("s"+e)}function v(){var e=CREATE.survey.get("quota");if(e&&e.questions){E(e)}else if(a||CREATE.survey.get("question_count")===0){C()}else{q()}}function E(e){i=e.questions.length>1;if(!i){if(e.questions[0].option_groups&&e.equations){A(false,false,false)}else{b("simple")}}else{if(e.equations){N(false,false)}else{A(false,false,false)}}}function C(){if(a){s.find("#hasResponsesWarning").removeClass("hide")}else{s.find("#noQuestionsWarning").removeClass("hide")}s.find("#noQualifiedQuestionsWarning").addClass("hide");s.find("#createQuotasSplash").addClass("disabled hide");m(l)}function q(){if(!n||n.length===0){s.find("#noQuestionsWarning").addClass("hide");s.find("#noQualifiedQuestionsWarning").removeClass("hide");s.find("#createQuotasSplash").addClass("disabled hide")}else{s.find("#noQualifiedQuestionsWarning, #noQuestionsWarning").addClass("hide");s.find("#createQuotasSplash").removeClass("disabled hide")}if($("#quotasMasterToggle").hasClass("upgrade")){s.find("#createQuotasSplash").addClass("disabled")}m(l)}function b(e){var t=CREATE.survey.get("quota"),n=s.find("#quotaLabel"),a='<option value="0">'+CREATE.Translations.get("choose_question","default")["default"]+"</option>";s.find("#hidQuotaEquationID").val("");$("#quotaChooseQuestions section.error").removeClass("error");if(e==="simple"){$("#accLogic").removeClass("complexQuota").addClass("simpleQuota");n.val($("#simpleQuotaDefaultName").text());s.find(".comboSelectSection, .comboQuestionSelectLabel").addClass("hide disabled")}else if(e==="combination"){$("#accLogic").removeClass("simpleQuota").addClass("complexQuota");n.val($("#complexQuotaDefaultName").text());s.find(".comboSelectSection, .comboQuestionSelectLabel").removeClass("hide disabled");s.find(".comboSelectSection [id^=pageListSelector]").prop("disabled",true)}y();s.find("[id^=questionListSelector]").empty().prop("disabled",true).append(a).val("0");if(!$.isEmptyObject(t)&&t.questions){n.val(t.quota_name);T(t.questions)}else{i=e==="combination"}m(d)}function y(){var e=s.find("[id^=pageListSelector]");$.each(e,function(e,t){var i;$(t).empty().append('<option value="0">'+CREATE.Translations.get("choose_page","default")["default"]+"</option>");i=0;n.each(function(e){var n,a;if(e.get("section_position")>i){i=e.get("section_position");n="";CREATE.pages.each(function(e){if(e.get("position")===i){n=CREATE.utils.getPageHeader(e)}});a=$("<option/>").val(e.get("section_id")).text(n);$(t).append(a)}})})}function T(e){$.each(e,function(e,t){if(e<3){CREATE.pages.getQuestion(t.question_id,true).done(function(i){var n=s.find("#pageListSelector"+(e+1)),a=s.find("#pageListSelector"+(e+2)),o=s.find("#questionListSelector"+(e+1)),r=i.get("page_id");if(parseInt(r,10)>0){$.each(n.find("option"),function(e,t){var i=$(t);if(i.val()===r.toString()){i.prop("selected",true);n.prop("disabled",false);w(n);return false}})}$.each(o.find("option"),function(e,i){var n=$(i);if(n.val()===t.question_id.toString()){n.prop("selected",true);o.prop("disabled",false);if(a.length>0){a.prop("disabled",false)}return false}})})}})}function w(e){var t,i,a;if(e.length>0){t=parseInt(e.val(),10);i=e.parent().next().find("[id^=questionListSelector]");a=CREATE.Translations.get("question","default").abrev["default"];if(t>0){i.empty().prop("disabled",false).append('<option value="0">'+CREATE.Translations.get("choose_question","default")["default"]+"</option>");n.each(function(e){var n,o,s;if(parseInt(e.get("section_id"),10)===t){n=e.get("question_number");o=e.getHeading({truncate:50});s=$("<option/>").val(e.id).text(a.replace(/\{1\}/,n)+": "+o);i.append(s)}});ge()}else{i.prop("disabled",true).empty().append('<option value="0">'+CREATE.Translations.get("choose_question","default")["default"]+"</option>")}}}function R(){ne()}function A(e,t,n,o){var r=CREATE.survey.get("quota"),l=$("#quotaGroupsContainer1").empty(),d=r&&r.questions&&r.questions.length>0,c=d?r.questions[0]:undefined,f=1;if(a){ue()}$("#quotaGroupsContainer2, #quotaGroupsContainer3").empty().addClass("hide");if(!i){$("#accLogic").removeClass("complexQuota").addClass("simpleQuota");if(d){CREATE.pages.getQuestion(c.question_id,true).done(function(i){P(l,r,i.toJSON(),e,t,n,o)})}$("#quotaGroupsNav").toggleClass("hide",o||e);if(!t&&r){s.find("#simpleQuotaLabel").text(r.quota_name)}}else{$("#accLogic").removeClass("simpleQuota").addClass("complexQuota");s.find("#atLeastOneGroup").removeClass("show");$("#quotaGroupsNav").removeClass("hide");if(d){CREATE.pages.getQuestion(c.question_id,true).done(function(i){D(f,c,i.toJSON(),e,t,n,o)})}}m(u)}function S(e,t){var i=0,n=0,a=t.answer_options.other&&t.answer_options.other_type==="answer_option";if(e&&e.option_groups){$.each(e.option_groups,function(e,t){i+=t.options.length});n+=t.answer_options.rows.length+(a?1:0)}return i===n&&i>0&&n>0}function x(e,t,i){CREATE.pages.getQuestion(t,true).done(function(n){var o=e.find(".quotaGroupQuestionAnswers").empty(),s=[],r=[],l=CREATE.survey.get("quota"),d,u,c,f,p=n.get("answer_options");t=parseInt(t,10);if(i){i=parseInt(i,10)}if(l&&l.questions){$.each(l.questions,function(e,a){if(parseInt(n.id,10)===t&&a.option_groups){$.each(a.option_groups,function(e,t){if(i===parseInt(t.quota_question_option_group_id,10)){$.each(t.options,function(e,t){s.push(t.question_answer_id)})}else{$.each(t.options,function(e,t){r.push(t.question_answer_id)})}})}})}$.each(p.rows,function(e,t){u=s.indexOf(parseInt(t.id,10))!==-1;c=r.indexOf(parseInt(t.id,10))!==-1;f=k(e,t.id,u,c,t.text);o.append(f)});if(p.other&&p.other_type==="answer_option"){d=p.other;u=s.indexOf(parseInt(d.id,10))!==-1;c=r.indexOf(parseInt(d.id,10))!==-1;f=k("Other",d.id,u,c,d.text);o.append(f)}if(a){o.find("input[type=checkbox]").prop("disabled",true)}})}function k(e,t,i,n,a){return['<label><input type="checkbox" class="quotaQuestionAnswers',e,'" value="',t,'"',i?' checked="checked"':"",n?' disabled="disabled"':"","> <span>",a,"</span></label>"].join("")}function P(e,t,i,n,o,r,l){var d=t.questions[0],u=!S(d,i),c=de(d),f=CREATE.Translations.get("group"),p=s.find("#hidQuestionID"),g,h,m;e.append($(".quotaQuestionsLabel.template h4").html(c).parent().clone().removeClass("template hide"));if(t.equations){p.val(d.question_id);$.each(t.equations,function(t,i){var n=s.find(".quotaCollapsedGroup.template").clone().removeClass("hide template"),a=n.find("a:first"),o=n.find("a span"),u=i.display_label+" <b>"+i.current_response_count+"/"+i.max_response_count+"</b>";o.replaceWith(u);a.data("quota_equation_id",i.quota_equation_id);a.attr({rel:"quotasSurveySettings",href:"#"});e.append(n);if(r&&l&&!$.isEmptyObject(l)&&s.find("#hidQuotaEquationID").val()===i.quota_equation_id.toString()){g=i.display_label;h=i.max_response_count;m=true;M(e,g,h,m,d,i.variables[0].quota_question_option_group_id);n.addClass("hide")}})}if(n&&r){g=f.group_num["default"].replace(/\{1\}/,"1");h="100";m=false;p.val(d.question_id);M(e,g,h,m,d)}else{if(r&&l&&$.isEmptyObject(l)&&u){g=f["new"]["default"];h="100";m=false;p.val(d.question_id);M(e,g,h,m,d)}else if(u&&!a){e.append(s.find(".addAnswerGroupSection.template").clone().removeClass("hide template"))}}}function M(e,t,i,n,a,o){var r=s.find(".quotaEditableGroup.template").clone().removeClass("hide template");r.find(".quotaOptionGroupLabel").val(t);r.find(".simpleMaxQuotaValue").val(i);r.find(".deleteQuotaGroupBtn").toggleClass("hide",!n);s.find("#hidQuotaQuestionID").val(a.quota_question_id);if(!n){s.find("#hidQuotaGroupID, #hidQuotaEquationID").val("")}x(r,a.question_id,o);e.append(r)}function D(e,t,i,n,a,o,r){var l=CREATE.survey.get("quota"),d=$("#quotaGroupsContainer"+e).empty().removeClass("hide"),u=!S(t,i),c=de(t),f,p,g,h,m,_;d.append($(".quotaQuestionsLabel.template h4").html(c).parent().clone().removeClass("template hide"));if(t.option_groups){$.each(t.option_groups,function(e,i){var n=s.find(".quotaCollapsedGroup.template").clone().removeClass("hide template"),a=n.find("a:first"),l=n.find("a span"),u=i.option_group_display_label,c;l.replaceWith(u);a.data({question_id:t.question_id,quota_question_option_group_id:i.quota_question_option_group_id});a.attr({rel:"quotasSurveySettings",href:"#"});if(o&&r&&!$.isEmptyObject(r)&&i.quota_question_option_group_id.toString()===s.find("#hidQuotaGroupID").val()){c=s.find(".quotaEditableGroup.template").clone().removeClass("hide template");c.find(".quotaOptionGroupLabel").val(i.option_group_display_label);s.find("#hidQuotaQuestionID").val(t.quota_question_id);x(c,t.question_id,i.quota_question_option_group_id);d.append(c)}else{d.append(n)}})}f=s.find(".addAnswerGroupSection.template").clone().removeClass("hide template");p=f.find("a:first");p.data({question_id:t.question_id});if(e===1&&n||!n&&r&&u&&$.isEmptyObject(r)&&o&&t.question_id.toString()===s.find("#hidQuestionID").val()){g=s.find(".quotaEditableGroup.template").clone().removeClass("hide template");h=CREATE.Translations.get("group");m=t.option_groups?t.option_groups.length+1:1;_=h.group_num["default"].replace(/\{1\}/,m+"");s.find("#hidQuestionID").val(t.question_id);s.find("#hidQuotaQuestionID").val(t.quota_question_id);s.find("#hidQuotaGroupID, #hidQuotaEquationID").val("");g.find(".quotaOptionGroupLabel").val(_);g.find(".deleteQuotaGroupBtn").addClass("hide");x(g,t.question_id);d.append(g)}else if(u){d.append(f)}if(l.questions.length>e){t=l.questions[e];e++;CREATE.pages.getQuestion(t.question_id,true).done(function(i){D(e,t,i.toJSON(),n,a,o,r)})}}function I(e){if(e.length>0){if(!i){A(false,true,true,true)}else{s.find("#hidQuestionID").val(e.data("question_id"));s.find("#hidQuotaGroupID").val("");A(false,true,true,true)}}}function L(e){var t=CREATE.survey.get("quota"),n,a;if(e.length===0){return}if(!e.is("a")){e=e.closest(".quotaCollapsedGroup").find("a");if(e.length===0){return}}if(!i){n=e.data("quota_equation_id");if(n>0){$.each(t.equations,function(e,t){if(parseInt(t.quota_equation_id,10)===n){a=t;return false}});if(a){s.find("#hidQuotaEquationID").val(a.quota_equation_id);A(false,true,true,e)}}else{A(false,true,false)}}else{s.find("#hidQuestionID").val(e.data("question_id"));s.find("#hidQuotaGroupID").val(e.data("quota_question_option_group_id"));A(false,true,true,e)}}function F(){var e=CREATE.survey.get("quota");s.find("#hidQuotaEquationID").val("");if(e&&e.questions&&e.questions.length>0){if(i){A(false,true,false);return}else if(e.equations&&e.equations.length>0){A(false,true,false);return}}m(d)}function Q(){if(me()){N(true,true)}}function N(e,t){var n=CREATE.survey.get("quota"),o=$("#quotaEquationContainer").empty(),r=s.find(".quotaEquationEditableGroup").clone().removeClass("template hide"),l=r.find(".groupContentSection"),d,u;if(a){ue()}if(i&&n&&n.questions){if(!n.equations){if(e&&t){$.each(n.questions,function(e,t){var i=s.find(".questionGroupSelector.template").clone().removeClass("template hide");if(t.option_groups){d=de(t);l.append(s.find(".equationQuestionLabel.template").clone().removeClass("template hide").append(d));$.each(t.option_groups,function(e,t){i.append('<option value="'+t.quota_question_option_group_id+'">'+t.option_group_display_label+"</option>")});l.append(i)}});o.append(r)}else{o.append(s.find(".addCombinationSection.template").clone().removeClass("template hide"))}}else{d="";$.each(n.questions,function(e,t){d+="<h4>"+de(t)+"</h4>"});o.append(s.find(".equationGroupLabel.template").clone().removeClass("template hide").append(d));$.each(n.equations,function(e,i){var a=s.find(".quotaEquationCollapsed.template").clone().removeClass("hide template"),d=a.find("a:first"),u=a.find("a span"),c=i.display_label+" <b>"+i.current_response_count+"/"+i.max_response_count+"</b>",f;u.replaceWith(c);d.data({quota_equation_id:i.quota_equation_id});d.attr({rel:"quotasSurveySettings",href:"#"});if(t&&s.find("#hidQuotaEquationID").val()===i.quota_equation_id.toString()){f=[];$.each(i.variables,function(e,t){f.push(t.quota_question_option_group_id)});$.each(n.questions,function(e,t){var i,n,a;if(t.option_groups){i=de(t);l.append(s.find(".equationQuestionLabel.template").clone().removeClass("template hide").append(i));a=s.find(".questionGroupSelector.template").clone().removeClass("template hide");$.each(t.option_groups,function(e,t){var i=f.indexOf(t.quota_question_option_group_id)>-1;n=['<option value="',t.quota_question_option_group_id,'"',i?'selected="selected"':"",">",t.option_group_display_label,"</option>"].join("");a.append(n)});l.append(a)}});r.find(".quotaEquationMaxQuota").val(i.max_response_count);r.find(".deleteQuotaEquationBtn").removeClass("hide");o.append(r)}else{o.append(a)}});if(t&&s.find("#hidQuotaEquationID").val()===""){$.each(n.questions,function(e,t){var i,n;if(t.option_groups){i=de(t);l.append(s.find(".equationQuestionLabel.template").clone().removeClass("template hide").append(i));n=s.find(".questionGroupSelector.template").clone().removeClass("template hide");$.each(t.option_groups,function(e,t){n.append('<option value="'+t.quota_question_option_group_id+'">'+t.option_group_display_label+"</option>")});l.append(n)}});o.append(r)}if(!t||s.find("#hidQuotaEquationID").val()!==""){u=fe();if(!u){o.append(s.find(".addCombinationSection.template").clone().removeClass("template hide"))}}}$("#quotaEquationNav").toggleClass("hide",e);if(!$.isEmptyObject(n)){s.find("#quotaEquationSectionLabel").text(n.quota_name)}m(c)}}function B(e){if(e&&i){s.find("#hidQuotaEquationID").val("");N(true,true)}}function U(e){var t;if(e.length>0){if(!e.is("a")){e=e.closest(".quotaEquationCollapsed").find("a")}if(e.is("a")&&i){t=e.data("quota_equation_id");if(t>0){s.find("#hidQuotaEquationID").val(t);N(true,true)}else{s.find("#hidQuotaEquationID").val("");N(true,false)}}}}function O(){var e=CREATE.survey.get("quota");if(e&&e.equations){s.find("#hidQuotaEquationID").val("");N(false,false)}else{A(false,false,false)}}function z(){var e=CREATE.survey.get("quota");$(".groupsContainer").empty();$("#quotaOptions").show();$("#quotaGroupsEquations, #quotaGroupsNav").hide();if(!$.isEmptyObject(e)){s.find("[name=quotaEndPageTypeRadio][value="+e.overquota_end_page_type+"]").prop("checked",true);s.find("#overQuotaPageText").val(e.overquota_msg);s.find("#overQuotaURL").val(e.overquota_end_page_url)}Ee();m(u)}function V(){$("#quotaOptions").hide();$("#quotaGroupsEquations, #quotaGroupsNav").show();if(i){N(false,false);m(c)}else{A(false,false,false)}}function H(){var e=CREATE.survey.get("quota"),t,i,a,o;if(pe()){if(e&&e.questions){t=0;i=0;$.each(s.find("[id^=questionListSelector]"),function(n,a){var o=$(a);if(o.find(":selected").val()>0&&o.is(":visible")){i++;$.each(e.questions,function(e,i){if(o.find(":selected").val()===i.question_id.toString()){t++;return false}})}});if(!(t===i&&t===e.questions.length&&i===e.questions.length)){j()}else{if(e.questions[0].option_groups){A(false,false,false)}else{A(true,true,true)}}}else{a=[];o="";$.each(s.find("[id^=questionListSelector]"),function(e,t){var i=$(t),r,l,d;if(i.find(":selected").val()>0&&i.is(":visible")){o=s.find("#quotaLabel").val();r="";l=i.find(":selected").val();n.find(function(e){if(e.get("id").toString()===l){r=e.getHeading({truncate:47});return true}});d={question_id:l,question_display_label:r};a.push(d)}});if(a.length>0){CREATE.Ajax.saveQuotaQuestions({quota_name:o,quota_questions:a}).done(W).fail(Ce)}}}}function j(){var e=CREATE.survey.get("quota");if(!$.isEmptyObject(e)){CREATE.Ajax.deleteQuota({quota_id:e.quota_id},"clear_quota").done(G).fail(Ce)}}function W(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);i=e.new_survey_quota.questions&&e.new_survey_quota.questions.length>1;A(true,true,true)}$("#livePreview").trigger("quotaChanged")}function G(e){if(e.deleted){CREATE.survey.set("quota",{});H()}$("#livePreview").trigger("quotaChanged")}function K(e){var t,n,a,o,r,l,d,u,c,f;if(e.length===0){return}u=e.closest(".quotaEditableGroup");r=CREATE.survey.get("quota");if(u.length===0||!he(u)){return}if(!i){o=s.find("#hidQuestionID").val();f=s.find("#hidQuotaQuestionID").val();d=s.find("#hidQuotaEquationID").val();a=u.find(".quotaOptionGroupLabel").val();t=[];n=u.find(".simpleMaxQuotaValue").val();u.find(":checkbox:checked").each(function(){t.push($(this).val())});l={quota_question_id:f,answer_list:t,option_group_label:a,max_quota:n};if(parseInt(d,10)>0){c=0;$.each(r.equations,function(e,t){if(t.quota_equation_id.toString()===d){c=t.variables[0].quota_question_option_group_id;return false}});if(qe(n,d)){l.quota_equation_id=d;l.quota_question_option_group_id=c;CREATE.Ajax.updateSimpleQuota(l).done(J).fail(Ce)}}else{l.question_id=o;CREATE.Ajax.createSimpleQuota(l).done(J).fail(Ce)}}else{X(u)}}function X(e){var t=s.find("#hidQuotaQuestionID").val(),i=s.find("#hidQuotaGroupID").val(),n=e.find(".quotaOptionGroupLabel").val(),a=CREATE.survey.get("quota"),o=[],r=false,l;e.find(":checkbox:checked").each(function(){o.push($(this).val())});if(parseInt(i,10)>0){if(a&&a.questions){$.each(a.questions,function(e,n){if(n.quota_question_id.toString()===t){$.each(n.option_groups,function(e,t){var n,a;if(t.quota_question_option_group_id.toString()===i){n=0;a=t.options.length;if(a!==o.length){r=true;return false}$.each(t.options,function(e,t){if($.inArray(t.question_answer_id.toString(),o)!==-1){n++}});if(n!==a){r=true}}})}})}l={quota_question_id:t,quota_question_option_group_id:i,option_group_label:n};if(r){l.answer_list=o;CREATE.Ajax.replaceQuotaOptionGroup(l).done(Z).fail(Ce)}else{CREATE.Ajax.updateQuotaOptionGroup(l).done(Z).fail(Ce)}}else{l={quota_question_id:t,answer_list:o,option_group_label:n};CREATE.Ajax.createQuotaOptionGroup(l).done(ee).fail(Ce)}}function Y(){var e=CREATE.survey.get("quota"),t=s.find("#hidQuotaQuestionID").val(),n,a,o;if(!i){n=s.find("#hidQuotaEquationID").val();if(parseInt(n,10)>0&&parseInt(t,10)>0){a=0;$.each(e.equations,function(e,t){if(t.quota_equation_id.toString()===n){a=t.variables[0].quota_question_option_group_id;return false}});CREATE.Ajax.deleteSimpleQuota({quota_id:e.quota_id,quota_equation_id:n,quota_question_id:t,quota_question_option_group_id:a}).done(te).fail(Ce)}}else{o=s.find("#hidQuotaGroupID").val();if(o>0){CREATE.Ajax.deleteQuotaQuestionOptionGroup({quota_id:e.quota_id,quota_question_id:t,quota_question_option_group_id:o}).done(te).fail(Ce)}}}function J(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);s.find("#hidQuestionID, #hidQuotaQuestionID, #hidQuotaEquationID").val("");A(false,true,false)}$("#livePreview").trigger("quotaChanged")}function Z(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);s.find("#hidQuestionID, #hidQuotaQuestionID, #hidQuotaEquationID").val("");A(false,true,false)}$("#livePreview").trigger("quotaChanged")}function ee(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);s.find("#hidQuestionID, #hidQuotaQuestionID, #hidQuotaGroupID").val("");A(false,true,false)}$("#livePreview").trigger("quotaChanged")}function te(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);A(false,true,false)}else{CREATE.survey.set("quota",{});v();m(l)}$("#livePreview").trigger("quotaChanged")}function ie(e){var t,n=[],a="",o,r,l;if(e.length>0){t=e.closest(".quotaEquationEditableGroup");if(i&&t.length>0&&_e(t)){$.each(t.find(".questionGroupSelector"),function(e,t){var i=$(t);if(i.find(":selected").val()>0){n.push(i.find(":selected").val());if(e===0){a=i.find(":selected").text()}else{a+=" - "+i.find(":selected").text()}}else{n=[];return false}});o=t.find(".quotaEquationMaxQuota").val();r=s.find("#hidQuotaEquationID").val();l={equation_display_label:a,max_quota:o,option_group_ids:n};if(r>0){if(qe(o,r)){l.equation_id=r;CREATE.Ajax.updateQuotaEquation(l).done(se).fail(Ce)}}else{CREATE.Ajax.createQuotaEquation(l).done(se).fail(Ce)}}}}function ne(){var e=CREATE.survey.get("quota");if(!$.isEmptyObject(e)){CREATE.Ajax.deleteQuota({quota_id:e.quota_id},"delete_quota").done(oe).fail(Ce)}else{v()}}function ae(){var e=s.find("#hidQuotaEquationID").val();if(e>0){CREATE.Ajax.deleteQuotaEquation({quota_equation_id:e}).done(function(e){s.find("#hidQuotaEquationID").val("");se(e)}).fail(Ce)}}function oe(e){if(e.deleted){CREATE.survey.set("quota",{});v();m(l)}$("#livePreview").trigger("quotaChanged")}function se(e){if(e.new_survey_quota){CREATE.survey.set("quota",e.new_survey_quota);N(false,false)}$("#livePreview").trigger("quotaChanged")}function re(){var e=CREATE.survey.get("quota"),t,i;if(!$.isEmptyObject(e)&&ve()){t=s.find("input[name=quotaEndPageTypeRadio]:checked").val();switch(t){case"1":e.overquota_end_page_type=1;e.overquota_msg=s.find("#overQuotaPageText").val();e.overquota_end_page_url="";break;case"2":e.overquota_end_page_type=2;e.overquota_msg="";e.overquota_end_page_url=s.find("#overQuotaURL").val();break;case"3":e.overquota_end_page_type=3;e.overquota_msg="";e.overquota_end_page_url="";break;default:e.overquota_end_page_type=0;e.overquota_msg="";e.overquota_end_page_url="";break}i={quota_id:e.quota_id,overquota_end_page_type:e.overquota_end_page_type,overquota_msg:e.overquota_msg,overquota_end_page_url:e.overquota_end_page_url};CREATE.Ajax.updateQuotaOptions(i).done(le).fail(Ce)}}function le(e){if(e.updated){V()}$("#livePreview").trigger("quotaChanged")}function de(e){var t;CREATE.pages.getQuestion(e.question_id,true).done(function(i){var n=i.get("display_number")||"",a=CREATE.Translations.get("question","default").abrev["default"];t=a.replace(/\{1\}/,n)+": "+CREATE.utils.stripTags(e.question_display_label)});return t}function ue(){var e=o.find("#deleteAllQuotaBtn, #deleteAllComboQuotaBtn, .deleteQuotaGroupBtn, .deleteQuotaEquationBtn"),t=o.find(".quotaOptionGroupLabel, .questionGroupSelector");e.hide();t.prop("disabled",true)}function ce(e){var t;if(e.length>0){t=e.closest("section").next("section").find("[id^=pageListSelector]");if(i&&t.length>0){t.prop("disabled",e.val()==="0")}ge()}}function fe(){var e=1,t=CREATE.survey.get("quota");if(t.questions){$.each(t.questions,function(t,i){if(i.option_groups){e=e*i.option_groups.length}})}if(t.equations){return t.equations.length===e}return false}function pe(){var e=true,t=$("#quotaLabel"),n=[],a=[];$("#quotaChooseQuestions section.error").removeClass("error")
;if($.trim(t.val())===""){e=false;t.parent().addClass("error")}$.each(s.find("[id^=questionListSelector]"),function(e,t){var i=$(t),o=$("#"+t.id.replace("questionListSelector","pageListSelector"));if(i.is(":visible")&&!o.prop("disabled")){if(i.find(":selected").val()>0){if($.inArray(i.find(":selected").val(),n)!==-1){a.push(i)}else{n.push(i.find(":selected").val())}}else{a.push(i)}}});if(i&&n.length<2||!i&&n.length<1){e=false;$.each(a,function(e,t){t.closest("section").addClass("error")})}return e}function ge(){var e=[];$.each(s.find("[id^=questionListSelector]"),function(t,i){var n=$(i);if(n.find(":selected").val()>0){e.push(n.find(":selected").val())}});$.each(s.find("[id^=questionListSelector]"),function(t,i){var n=$(i),a=n.find(":selected").val();$.each(n.find("option"),function(t,i){var n=$(i);if(n.val()!==a&&e.indexOf(n.val())!==-1&&!n.prop("disabled")){n.prop("disabled",true).html(n.html()+" (in use)")}else if(n.prop("disabled")&&e.indexOf(n.val())===-1){n.prop("disabled",false).html(n.html().replace(" (in use)",""))}})})}function he(e){var t=e.closest(".quotaEditableGroup"),i=true;$(".noChoicesSelected, .noQuotaLimit, .invalidQuotaLimit, .noGroupLabel").removeClass("show");t.find(".error").removeClass("error");if(t.find(".quotaOptionGroupLabel").val().length===0){i=false;t.find(".answerGroupLabel").addClass("error");t.find(".noGroupLabel").addClass("show")}if($("#accLogic").hasClass("simpleQuota")&&(t.find(".simpleMaxQuotaValue").val().length===0||!$.isNumeric(t.find(".simpleMaxQuotaValue").val()))){i=false;t.find(".quotaMaxLabel").addClass("error");t.find(".noQuotaLimit").addClass("show")}else if(t.find(".simpleMaxQuotaValue").val()<=0){i=false;t.find(".quotaMaxLabel").addClass("error");t.find(".invalidQuotaLimit").addClass("show")}if(t.find(":checkbox:checked").length===0){i=false;t.find(".quotaGroupQuestionAnswers").addClass("error");t.find(".noChoicesSelected").addClass("show")}return i}function me(){var e=true,t=CREATE.survey.get("quota");s.find("#atLeastOneGroup").removeClass("show");if(t&&t.questions){$.each(t.questions,function(t,i){if(!i.option_groups){$(".groupsContainer").eq(t).find(".addQuotaObject a").addClass("err");e=false;$("#atLeastOneGroup").addClass("show")}})}else{return false}return e}function _e(e){var t=true,i=e.closest(".quotaEquationEditableGroup"),n=CREATE.survey.get("quota"),a=s.find("#hidQuotaEquationID").val(),o=[];s.find(".noQuotaLimit, .invalidQuotaLimit, #duplicateCombo, #groupsMissing").removeClass("show");$(i).removeClass("error");$.each(e.find(".questionGroupSelector"),function(e,i){var n=$(i);if(!n.find("option[value!=0]").is(":selected")){t=false;n.parent().addClass("error");s.find("#groupsMissing").addClass("show");return false}else{o.push(n.find("option:selected").val())}});if(e.find(".quotaEquationMaxQuota").val().length===0||!$.isNumeric(e.find(".quotaEquationMaxQuota").val())){t=false;$(i).addClass("error");i.find(".noQuotaLimit").addClass("show")}else if(e.find(".quotaEquationMaxQuota").val()<=0){t=false;$(i).addClass("error");i.find(".invalidQuotaLimit").addClass("show")}if(n&&n.equations&&t){$.each(n.equations,function(e,i){var n=[];$.each(i.variables,function(e,t){n.push(t.quota_question_option_group_id.toString())});if($(o).not(n).length===0&&$(n).not(o).length===0&&i.quota_equation_id.toString()!==a){t=false;s.find("#duplicateCombo").addClass("show")}})}return t}function ve(){var e=true,t=s.find("input[name=quotaEndPageTypeRadio]:checked").val(),i=$.trim(s.find("#overQuotaURL").val());s.find(".optionSection").removeClass("error");switch(t){case"1":if($.trim(s.find("#overQuotaPageText").val()).length===0||$.trim(s.find("#overQuotaPageText").val()).length>500){e=false;s.find(".optionSection").addClass("error")}break;case"2":if(i.length===0||i.length>250||!CREATE.utils.isValidUrl(i)){e=false;s.find(".optionSection").addClass("error")}break;default:break}return e}function Ee(){var e=s.find("input[name=quotaEndPageTypeRadio]:checked").val();s.find(".optionSection").removeClass("error");s.find("#redirectDetails").toggleClass("hide",e!=="2");s.find("#overQuotaDetails").toggleClass("hide",e!=="1")}function Ce(){CREATE.Notifications.showErrorNotification()}function qe(e,t){var i=false,n,a,o,s;a=CREATE.survey.get("quota");o=parseInt(t,10);if(a.equations){$.each(a.equations,function(e,t){if(t.quota_equation_id===o){n=t;return false}})}if(n){s=be(n.current_response_count,n.max_response_count,parseInt(e,10));if(s){i=window.confirm(s.text+CREATE.Translations.get("quota_confirm_save")["default"])}else{return true}}else{return true}return i}function be(e,t,i){var n=null,a=t!==i,o=e>=t,s=i>e,r=i<=e;if(a){if(o){if(s){n=ye("auto_reopen")}else{n=ye("stay_closed")}}else if(r){n=ye("auto_close")}}return n}function ye(e){return{text:CREATE.Translations.get("quota_"+e,"default")["default"],type:e}}_.extend(t,{init:function(){o=$("#surveyLogicSettings");s=o.find(".quotasSurveySettings");f();g();a=false},load:function(){var e=CREATE.survey.get("quota");if(e&&e.questions&&e.equations){m(r);CREATE.Ajax.getQuota(true).done(function(e){if(e.quota){CREATE.survey.set("quota",e.quota)}else{Ce()}}).fail(Ce).always(h)}else{h()}}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion_quota"]=window["js/create/step2/accordion/accordion_quota"]={});(function(e,t){var i=e("js/create/step2/accordion/accordion_add"),n=e("js/create/step2/accordion/accordion_display"),a=e("js/create/step2/accordion/accordion_theme"),o=$("#createAccordion"),s=$("#create"),r=$(".subhead"),l=$("#hd"),d=$("#ft"),u=$(window),c=$("#accBuilder"),f=$("#accQuestionBank"),p=$("#accLogic"),g=$("#accOptions"),h=$("#accThemes"),m,v={builder:false,questionbank:false,option:false,theme:false};function E(e,t){var o=e.attr("id"),s={event:"accordion_"+o,action:"open"},r=CREATE.survey.get("id");if(o==="accBuilder"&&v.builder===false){i.init();v.builder=true}if((o==="accOptions"||o==="accLogic")&&v.option===false){n.init();v.option=true}if(o==="accThemes"&&v.theme===false){a.init();v.theme=true}$(".key").css("height","");if(o!==m){if(m){$("#"+m).trigger(m+"Hidden")}m=o;$(".key.open").removeClass("open");e.addClass("open");C();e.trigger(o+"Visible");CREATE.utils.setCookie("sm_create_acc_key",r+":"+m,1);s.triggered=t;SM.Logger.remoteLog(s,"info")}}function C(){var e=u.height(),t=l.outerHeight(true),i=0,n=s.hasClass("sticky"),a=d.hasClass("fixedFooter"),o=d.offset().top-u.scrollTop()-e,c=d.outerHeight(),f=$("#restoreQuestions").outerHeight(),p=$(".key > h3"),g=p.outerHeight(),h=g*(p.length-1),_,v,E=20;if(n){t=0}if(a){i=c}_=e-t-E-r.outerHeight(true)-i;if(o<0){_+=o}v=_-f-h;$("#"+m).each(function(){var e=$(this),t=false,i=e.find(".tabs nav").outerHeight(true),n=e.find(".accordionSubsection").outerHeight(true);e.css("max-height",v);e.find(".setting").css("max-height",v-i-g-n-20).each(function(){if(this.offsetHeight<this.scrollHeight||this.offsetWidth<this.scrollWidth){t=true}});$(this).toggleClass("shadow",t)})}function q(){var e=0;$("."+m+".key .setting").each(function(){if(this.offsetHeight>e){e=this.offsetHeight;$(this).css("height",e)}})}function b(){var e=CREATE.utils.getCookie("sm_create_acc_key"),t="accQuestionBank",i=CREATE.survey.get("id"),n;if(e){if(e.split(":")[0]===i){t=e.split(":")[1];n=o.find("#"+t)}}if(CREATE.stepName==="theme"){E(o.find("#accThemes"),true)}else if(n&&n.length){E(n,true)}else{E(o.find("#accQuestionBank"),true)}$("#accThemes nav").tabs()}function y(){var e=$("#createAccordion");b();T();w();$("#"+m).trigger(m+"Visible");C();s.bind("afterScroll",C);s.bind("afterResize",C);if(!CREATE.survey.hasPermission("edit")){e.addClass("read-only");$(".upgradeBtn").remove();$(".upgrade-button").remove()}e.on("click",".tabs a",function(e){var t=$(this),i=t.closest(".key"),n={event:"accordion_"+i.attr("id")+"_"+t.attr("tab-target"),action:"open"};setTimeout(function(){C()},10);n.triggered=e.isTrigger;SM.Logger.remoteLog(n,"info")}).on("equalizeSettingHeights",function(){q()}).on("click","li.upgrade",function(e){var t=$(e.target),i=t.closest("li.upgrade").attr("rel"),n=__UPGRADE.getUpgradeUrl(i,"accordion");e.preventDefault();if(!CREATE.survey.hasPermission("edit")){return}e.stopPropagation();if(t.hasClass("upgradeBtn")){window.location=n}else{__UPGRADE.openUpgradeModal(i,n)}}).on("click","#surveyDisplaySettings li a",function(e){var t=$(e.target);if(e.originalEvent!==undefined&&(t.hasClass("optionLogo")||t.hasClass("optionFooter"))){SM.Logger.enqueue({action_type:"click_accordion_options_"+t.attr("class").replace("option","").toLowerCase(),ui_trigger:"accordionOptions"})}}).find(".setting").on("scroll",function(){$("#"+m).toggleClass("scrolling",$(this).scrollTop()>0)})}function T(){o.on("click",".press",function(e){E($(e.target).closest(".key"),e.isTrigger);e.preventDefault()})}function w(){o.on("mousewheel",".option-menu, .pagelist, .questionlist, .answerlist",function(e,t){if(t!==0){this.scrollTop+=(t<0?1:-1)*30}e.preventDefault();e.stopPropagation()});o.on("mousewheel",".setting",function(e,t){if(t!==0){this.scrollTop+=(t<0?1:-1)*30}e.preventDefault()})}_.extend(t,{init:function(){y();window.setTimeout(C,0)},openBuilderAccordion:function(){E(c,true)},openQBAccordion:function(){E(f,true)},openLogicAccordion:function(){E(p,true)},openOptionsAccordion:function(){E(g,true)},openThemesAccordion:function(){E(h,true)}})})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/accordion/accordion"]=window["js/create/step2/accordion/accordion"]={});CREATE.views.EditorBase=Backbone.View.extend({parseBulkEditItems:function(e){var t=[],i=$.trim(e.val()),n=i.replace(/(<([^>]+)>)/gi,""),a=[];if(n.length>0){t=i.replace(/^(\r\n|\r|\n)/g).split(/\r\n|\r|\n/g);$.each(t,function(e,t){if(typeof t!=="undefined"&&$.trim(t).length){a.push({id:null,text:$.trim(t),visible:true})}});t=a}return t},getDefaultValidationSettings:function(){return{text_length:{min:0,max:5e3,formatter:function(e){return e+""},parser:function(e){return Globalize.parseInt(e)}},integer:{min:0,max:100,formatter:function(e){return e+""},parser:function(e){return Globalize.parseInt(e)}},decimal:{min:0,max:100,formatter:function(e){return e+""},parser:function(e){return Globalize.parseFloat(e)}},date_us:{min:new Date,max:this.getNextMonth(),formatter:function(e){return Globalize.format(e,"MM/dd/yyyy")},parser:function(e){return Globalize.parseDate(e,"M/d/yy")||Globalize.parseDate(e,"M/d/yyyy")}},date_intl:{min:new Date,max:this.getNextMonth(),formatter:function(e){return Globalize.format(e,"dd/MM/yyyy")},parser:function(e){return Globalize.parseDate(e,"d/M/yy")||Globalize.parseDate(e,"d/M/yyyy")}},email:{min:"",max:"",formatter:function(){},parser:function(){}}}},getNextMonth:function(){var e=new Date;e.setMonth((e.getMonth()+1)%12);e.setDate(1);return e}});CREATE.views.EditorOther=CREATE.views.EditorBase.extend({el:"#otherSetting",events:{"change #toggleOtherField":"_toggleOtherField"},initialize:function(){var e=this;this._savedId=null;this.render();this.listenTo(this.model,"change:answer_options",this.render);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model})})},render:function(){var e=!$.isEmptyObject(this.model.get("answer_options").other)&&this.model.get("answer_options").other.visible,t=$("#toggleOtherField");t.prop("checked",e);this.$el.toggleClass("expand",e)},validate:function(){var e=true;if(this.model.isBanked()){return true}_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorOtherLabel:undefined,EditorOtherOptionsChoice:undefined,EditorOtherOptionsChoiceValidation:undefined,EditorOtherOptionsMatrix:undefined,EditorOtherSize:undefined,EditorOtherValidationSettings:undefined},_defaultTypeMapping:{multiple_choice_radio:"answer_option",multiple_choice_checkbox:"answer_option",dropdown:"answer_option",matrix_radio_weighted:"comment",matrix_radio_unweighted:"comment",matrix_checkbox:"comment",single_row_rating_scale:"comment",menu_matrix:"comment"},_savedId:null,_toggleOtherField:function(e){var t=$(e.target),i=t.prop("checked"),n=$.extend({},this.model.get("answer_options")),a=$.extend({},n.other);this.$el.toggleClass("expand",i);if(i){if(!n.other){a=this._getDefaultOtherValue();n.other_type=this._defaultTypeMapping[this.model.get("common_name")]}if(this._savedId){a.id=this._savedId}a.visible=true;n.other=a}else{if(n.other&&n.other.id){this._savedId=n.other.id}if(!this.model.hasResponses()&&!this.model.hasLogic()){delete n.other;delete n.other_type}else{a.visible=false;n.other=a}}this.model.set("answer_options",n);SM.Logger.enqueue({action_type:"click_other_answer_or_comment",ui_trigger:"editorOptionsOther"})},_getDefaultOtherValue:function(){var e={};_.each(this._subViews,function(t){if(!t.isHidden&&(t.defaultValues||typeof t.getDefaultValues==="function")){$.extend(e,t.defaultValues||t.getDefaultValues())}});return e},_handleCommonNameChange:function(){var e=this.$el.find(".o_amount");if(this.model.get("type").subtype==="rating"&&!$("#switchToSRRS").is(":checked")){e.removeClass("hide")}else{this.$el.find("input:radio[name=otherAmount][value=per_question]").prop(":checked",true);e.addClass("hide")}}});CREATE.views.EditorOtherLabel=CREATE.views.EditorBase.extend({el:"#otherLabelContainer",events:{"rteBlurred #otherLabel":"_updateLabelText"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options",this.render)},render:function(){var e=$("#otherLabel"),t=this.model.get("answer_options");if(t.other){e.html(t.other.text)}},validate:function(){return CREATE.Validator.validate($("#otherLabel"))},getDefaultValues:function(){return{text:$("#otherLabel").html()}},isHidden:false,_updateLabelText:function(){var e=$.trim(CREATE.Rte.getContentForSave("otherLabel")),t=$.extend({},this.model.get("answer_options"));t.other.text=e;this.model.set("answer_options",t);SM.Logger.enqueue({action_type:"update_other_label",ui_trigger:"editorOptionsOtherLabel",question_type:this.model.get("common_name")})}});CREATE.views.EditorOtherOptionsChoice=CREATE.views.EditorBase.extend({el:"#otherOptionsChoice",events:{"change input[name=otherChoice]":"_changeDisplayType"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options change:has_responses change:logic",this.render);this.listenTo(this.model,"change:common_name",this._changeDisplayType);if(this.model.allowsOtherAsAnswerOption()){this._savedOtherType=this.model.get("answer_options").other_type}this._changeDisplayType()},render:function(){var e=_.contains(this._applicableCommonNames,this.model.get("common_name")),t=this.$el.find("input:radio[name=otherChoice][value=answer_option]"),i=this.$el.find("input:radio[name=otherChoice][value=comment]"),n=this.model.get("answer_options"),a=n.other!==undefined,o=a?n.other_type==="answer_option":false,s=this.model.previousAttributes(),r=!$.isEmptyObject(s)&&s.answer_options.other,l=CREATE.QuestionEditor.isNewQuestion(this.model.id)||!(r&&(this.model.hasLogic()||this.model.hasResponses()));if(o){t.prop("checked",true)}else{i.prop("checked",true)}this._toggleOtherOptionsChoice(e&&l)},defaultValues:undefined,isHidden:false,_applicableCommonNames:["multiple_choice_radio","multiple_choice_checkbox","dropdown"],_savedOtherType:undefined,_changeDisplayType:function(e){var t=$.extend({},this.model.get("answer_options")),i=_.contains(this._applicableCommonNames,this.model.get("common_name")),n=i?this._savedOtherType||"answer_option":t.other_type||"comment",a=e&&$(e.target).val()?$(e.target).val():n,o=a==="answer_option";if(t.other===undefined){return}t.other_type=a;if(o&&!t.other.blank_error_message){t.other.blank_error_message=CREATE.utils.stripTags($("#otherBlank").val())}else if(!o){delete t.other.blank_error_message}this.model.set("answer_options",t);if(i){this._savedOtherType=t.other_type}},_toggleOtherOptionsChoice:function(e){var t=$("#otherSettingTitleAnswer"),i=$("#otherSettingTitleComment");if(e){i.hide();t.show();this.$el.show();this.isHidden=false}else{i.show();t.hide();this.$el.hide();this.isHidden=true}}});CREATE.views.EditorOtherOptionsChoiceValidation=CREATE.views.EditorBase.extend({el:"#otherOptionsChoiceValidation",events:{"blur #otherBlank":"_updateOtherBlankText"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options change:has_responses",this.render)},render:function(){var e=this.model.get("answer_options"),t=e.other_type==="answer_option",i=this.model.previousAttributes(),n=!$.isEmptyObject(i)&&i.answer_options.other,a=$("#otherBlank"),o,s=CREATE.QuestionEditor.isNewQuestion(this.model.id)||!(n&&this.model.hasResponses());if(e.other){o=e.other.blank_error_message;if(t&&s){this.$el.show();this.isHidden=false;if(o){a.val(o)}}else{this.$el.hide();this.isHidden=true}}},validate:function(){var e=true,t=this.model.get("answer_options"),i=t.other_type==="answer_option";if(i){e=CREATE.Validator.validate($("#otherBlank"))}return e},getDefaultValues:function(){return{blank_error_message:CREATE.utils.stripTags($("#otherBlank").val())}},isHidden:false,_updateOtherBlankText:function(e){var t=$.extend({},this.model.get("answer_options"));t.other.blank_error_message=CREATE.utils.stripTags($(e.target).val());this.model.set("answer_options",t)}});CREATE.views.EditorOtherOptionsMatrix=CREATE.views.EditorBase.extend({el:"#otherOptionsMatrix",events:{"change input[name=otherAmount]":"_changeMatrixCommentType"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options",this.render);this.listenTo(this.model,"change:common_name",this._onCommonNameChange)},render:function(){var e=this.model.isWeightedMatrix()&&!this.model.isStarRating(),t=this.model.get("answer_options"),i=this.$el.find("input:radio[name=otherAmount][value=per_row]"),n=this.$el.find("dt .o_amount");i.prop("checked",t.other_type==="comment_per_row");n.toggleClass("hide",!e);this.$el.toggleClass("hide",!e);this.isHidden=!e},defaultValues:{},isHidden:false,_changeMatrixCommentType:function(e){var t=$.extend({},this.model.get("answer_options")),i=$(e.target).val()==="per_row"&&$(e.target).prop("checked");t.other_type=i?"comment_per_row":"comment";t.other.apply_all_rows=i;this.model.set("answer_options",t)},_onCommonNameChange:function(){var e=_.extend({},this.model.get("answer_options")),t,i=this.model.isWeightedMatrix()&&!this.model.isStarRating();if(e.other===undefined){return}if(i&&e.other.apply_all_rows===undefined){t=this.$el.find("input").filter(function(){return $(this).is(":checked")});e.other.apply_all_rows=t.val()==="per_row"}else{delete e.other.apply_all_rows}this.model.set("answer_options",e);this.render()}});CREATE.views.EditorOtherSize=CREATE.views.EditorBase.extend({el:"#otherSizeSettings",events:{"change #otherSize":"_changeOtherSizeOption","change #otherLines":"_changeOtherLinesOption","change #otherWide":"_changeOtherWideOption"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options",this.render)},render:function(){var e=this.model.get("answer_options"),t=$("#otherSize"),i=$("#otherLines"),n=$("#otherWide");if(e.other){i.toggleClass("hide",e.other.field_size.lines<=1);if(e.other.field_size.lines>1){t.val("multi");i.val(e.other.field_size.lines)}else{t.val("single")}n.val(e.other.field_size.chars_wide)}},defaultValues:{field_size:{chars_wide:50,lines:1}},isHidden:false,_changeOtherSizeOption:function(e){var t=$.extend({},this.model.get("answer_options")),i=$(e.target).val();$("#otherLines").toggleClass("hide",i!=="multi");t.other.field_size={chars_wide:parseInt($("#otherWide").val(),10),lines:i!=="multi"?1:3};this.model.set("answer_options",t)},_changeOtherLinesOption:function(e){var t=$.extend({},this.model.get("answer_options")),i=parseInt($(e.target).val(),10);t.other.field_size.lines=i;this.model.set("answer_options",t)},_changeOtherWideOption:function(e){var t=$.extend({},this.model.get("answer_options")),i=parseInt($(e.target).val(),10);t.other.field_size.chars_wide=i;this.model.set("answer_options",t)}});CREATE.views.EditorOtherValidationSettings=CREATE.views.EditorBase.extend({el:"#otherValidationSettings",events:{"change #validateFormatOther":"_changeValidationType","change #validateMinOther":function(){this._changeValidationRange(true)},"change #validateMaxOther":function(){this._changeValidationRange(false)}},initialize:function(){var e=this;this.render();this.listenTo(this.model,"change:validation",this.render);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model})})},render:function(){var e=this.model.get("validation"),t=e&&e.type?e.type:this._noValidateValue,i=$("#validateMinOther"),n=$("#validateMaxOther"),a=$("#validateTextOther"),o=this.getDefaultValidationSettings(),s=o[t];$("#validateFormatOther").val(t);$("#otherValidationContainer").attr("class",$("option:selected","#validateFormatOther").attr("class"));if(!i.val()){if(e&&e.min){i.val(e.min)}else if(s){i.val(s.formatter(s.min))}}if(!n.val()){if(e&&e.max){n.val(e.max)}else if(s){n.val(s.formatter(s.max))}}if(e&&e.text){a.val(e.text)}},validate:function(){var e=true;if(!this.model.isSlider()){_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}})}return e},defaultValues:{},isHidden:false,_subViews:{EditorOtherValidationText:undefined},_noValidateValue:"any",_changeValidationType:function(e){var t=$(e.target).val(),i=this.model.get("validation"),n=$.extend({},i),a=$("#validateMinOther"),o=$("#validateMaxOther"),s=$("#validateTextOther"),r=this.getDefaultValidationSettings(),l=r[t];$("#otherValidationContainer").attr("class",$("option:selected",e.target).attr("class"));n.type=t;if(t!==this._noValidateValue){a.val(l.formatter(l.min));o.val(l.formatter(l.max));n.min=a.val();n.max=o.val();if(i&&i.text){s.val(i.text)}n.text=CREATE.utils.stripTags(s.val())}else{delete n.min;delete n.max;delete n.text}if(!this.model.isSlider()){this.model.set("validation",n)}},_changeValidationRange:function(e){var t=$("#validateFormatOther").val(),i=this.getDefaultValidationSettings(),n=i[t],a=$.extend({},this.model.get("validation")),o=$("#validateMinOther"),s=$("#validateMaxOther"),r=n.parser(o.val()),l=n.parser(s.val()),d=null;if(t==="text_length"){d=this._textLengthValidationRangeValue(e,r,l,n)}else if(_.contains(["integer","decimal"],t)){d=this._numberValidationRangeValue(e,r,l,n)}else if(_.contains(["date_us","date_intl"],t)){d=this._dateValidationRangeValue(e,r,l,n)}if(d!==null){if(e){o.val(n.formatter(d));a.min=o.val()}else{s.val(n.formatter(d));a.max=s.val()}}if(!this.model.isSlider()){this.model.set("validation",a)}},_textLengthValidationRangeValue:function(e,t,i,n){if(e){return Math.max(0,Math.min(isNaN(t)?n.min:t,i))}return Math.max(isNaN(i)?n.max:i,t)},_numberValidationRangeValue:function(e,t,i,n){if(e){return Math.min(isNaN(t)?n.min:t,i)}return Math.max(isNaN(i)?n.max:i,t)},_dateValidationRangeValue:function(e,t,i,n){if(e){if(!t){t=n.min}return t.getTime()<=i.getTime()?t:i}if(!i){i=n.max}return t.getTime()<=i.getTime()?i:t}});CREATE.views.EditorOtherValidationText=CREATE.views.EditorBase.extend({el:"#otherValidationTextContainer",events:{"blur #validateTextOther":"_updateOtherValidationText"},initialize:function(){this.render();this.listenTo(this.model,"change:validation",this.render)},render:function(){var e=this.model.get("validation"),t=e?e.type:this._noValidateValue,i=t!==this._noValidateValue;this.$el.toggleClass("hide",!i);this.isHidden=!i},validate:function(){var e=true,t=this.model.get("validation"),i=t?t.type:this._noValidateValue;if(i!==this._noValidateValue){e=CREATE.Validator.validate($("#validateTextOther"))}return e},defaultValues:{},isHidden:false,_noValidateValue:"any",_updateOtherValidationText:function(e){var t=$(e.target),i=CREATE.utils.stripTags(t.val()),n=$.extend({},this.model.get("validation"));if(i){n.text=i}if(!this.model.isSlider()){this.model.set("validation",n)}}});CREATE.views.EditorDemographic=CREATE.views.EditorBase.extend({el:"#editQuestion .contactTable",events:{"change #editContact":"_toggleInternational","click #demoOptions .checks input":"_handleCheckboxEvent","rteBlurred #demoOptions .input":"_handleOnBlur"},initialize:function(){this.render()},render:function(){var e=this.model.get("type").subtype==="us",t=$("#editContact"),i=this.model.get("answer_options").rows,n,a,o,s=$("#demoOptions"),r=this;s.find("input[type=checkbox]").prop("checked",false);$.each(i,function(e,t){n=s.find("tr[data-type="+t.type+"]");n.attr("data-option-id",t.id);a=n.find(".input");a.html(t.text);if(!t.visible){a.attr("contenteditable","false")}o=n.find("input[type=checkbox]");o.prop("checked",t.visible);r._toggleCheckbox(o)});t.prop("checked",e);t.closest("tr").toggleClass("checked",e)},validate:function(){var e=$("#demoOptions").find("[data-validation]");return CREATE.Validator.validate(e,"td")},_handleCheckboxEvent:function(e){var t=$(e.target);this._toggleCheckbox(t,true,true)},_toggleInternational:function(e){var t="international",i=this.model.get("type"),n=$(e.target).prop("checked");if(n){t="us"}i.subtype=t;this.model.set("type",i);this.render()},_handleOnBlur:function(e){var t=$(e.target),i=t.closest("tr"),n=$("#demoOptions").find("tr").index(i),a=$.extend({},this.model.get("answer_options"));a.rows[n].text=CREATE.Rte.getContentForSave(t.attr("id"));this.model.set("answer_options",a)},_toggleCheckbox:function(e,t,i){var n=$.extend({},this.model.get("answer_options")),a=e.prop("checked"),o=e.closest("tr"),s=o.find(".input"),r=$("#demoOptions").find("tr").index(o),l=s.attr("data-rte");s.toggleClass("disabled",!a);s.prop("disabled",!a);if(t){CREATE.Rte.toggle(s,CREATE.Rte.getRTEOptions(this.model.get("type"),l),a)}if(!i){return}n.rows[r].visible=a;this.model.set("answer_options",n)}});CREATE.views.EditorTitle=CREATE.views.EditorBase.extend({el:"#questionTitleWrap",events:{"rteFocused #editTitle":"_editTitleFocus","rteBlurred #editTitle":"_editTitleBlur"},initialize:function(){var e=this;this.actionMenus=[];$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model})});this.render();this.listenTo(this.model,"change:random_assignment",function(){this.$el.toggleClass("hide",this.model.hasRandomAssignment())})},validate:function(){var e=CREATE.Rte.getContentForSave("editTitle"),t=CREATE.Rte.hasContent(e);this.$el.toggleClass("error",!t);return t},render:function(){var e=this.model.get("heading"),t=CREATE.utils.stripInvalidHtml(e);$("#editTitle").html(t);this.$el.find(".questionPos").html(this.model.get("display_number"));this.$el.toggleClass("hide",this.model.hasRandomAssignment())},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorAutoComplete:undefined},_editTitleFocus:function(){this.$el.addClass("ac-active");if(CREATE.survey.hasRtlLanguage()||CREATE.Rte.hasRtlDirection($("#editTitle"))){this.$el.addClass("rtl")}},_editTitleBlur:function(){var e;this.$el.removeClass("ac-active rtl");e=CREATE.Rte.getContentForSave("editTitle");this.model.set({heading:e})}});CREATE.views.EditorAutoComplete=CREATE.views.EditorBase.extend({el:"#questionTitleWrap",events:{"change #suggestQ":"_changeAutocompletePref","mousedown .suggestSetting label":function(e){e.preventDefault();SM.Logger.enqueue({action_type:"click_suggested_questions",ui_trigger:"suggestedQuestions"})}},initialize:function(){var e=$("#editTitle"),t=this.model.allowsAutocomplete(),i=CREATE.user.get("preferences").show_suggested_questions_enabled,n=this;this._acEnabled=i&&t;this._autocomplete=e.autocomplete({search:function(e){n._doSearch(e)},classes:"",minLength:3,delay:300,setInputOnSelect:false,autocompleteOnPaste:false,enabled:this._acEnabled}).data("autocomplete");this._autocomplete.$el.on("autocomplete.selected",{self:this},this._selectResult);this.listenTo(this.model,"change:has_responses",this._handleHasResponses);this._handleHasResponses();this.render()},render:function(){this.$el.find(".suggestSetting").toggleClass("hide",!this.model.allowsAutocomplete());$("#suggestQ").prop("checked",this._acEnabled)},_acEnabled:undefined,_autocomplete:undefined,_chosenOptionsData:{},_doSearch:function(e){var t=this,i,n,a,o=$("#editTitle");if(!o.is(":focus")){return}i=e;n=CREATE.survey.get("language").id;a={text:i,lang_id:n};CREATE.Ajax.getAutocompleteData(a).done(function(e){var i,n,a,o,s,r;t._chosenOptionsData={};i=e.question_bank_results;n=e.question_history_results;a=CREATE.Translations.get("question_bank","default")["default"];o=CREATE.Translations.get("question_history","default")["default"];s=[];if(i.length===0&&n.length===0){t._autocomplete.set("results",s);return}r=[];if(i&&i.length>0){$.each(i,function(e,i){t._chosenOptionsData[i.value]=i.chosen_options});s.push({value:-1,isTitle:true,text:a});$.each(i,function(e,t){var i=CREATE.utils.htmlDecode(t.label);s.push({value:"qb-"+t.value,isTitle:false,text:i});r.push(i)})}if(n&&n.length>0){s.push({value:-1,isTitle:true,text:o});$.each(n,function(e,t){var i=CREATE.utils.htmlDecode(t.label);if(r.indexOf(i)>-1){return true}s.push({value:"hist-"+t.value+"-"+t.survey_id,isTitle:false,text:i})})}t._autocomplete.set("results",s)})},_selectResult:function(e){var t=e.value,i=e.data.self,n,a,o=$("#editTitle"),s;if(t===-1){return false}if(t==="autosuggest-off"){$("#suggestQ").prop("checked",false);i._changeAutocompletePref();return false}n={page_id:CREATE.utils.getPageIdForEl($("#editQuestion")),position:i.model.get("position"),question_id:i.model.get("id")};if(t.slice(0,2)==="qb"){n.type="question_bank";n.id=t.slice(3,t.length);n.chosen_options=i._chosenOptionsData[n.id]}else if(t.slice(0,4)==="hist"){n.type="question_history";s=t.split("-");n.id=s[1];n.original_survey_id=s[2]}else{return false}CREATE.Ajax.selectAutocompleteQuestion(n).done(function(e){$("#editQuestion").trigger("autocompleteElementSelected",[e]);SM.Logger.enqueue(SM.Logger.setQbqLogging(e,"autocomplete"))}).fail(function(e){var t=e.appError.name;if($.inArray(t,["QuestionPerPageLimitException","QuestionPerSurveyLimitException"])===-1){t="Exception"}CREATE.Notifications.showErrorNotification({messageKey:t})});e.preventDefault();a=o.data("pipingMenu");if(a!==undefined){a.close()}},_changeAutocompletePref:function(){var e=$("#suggestQ").prop("checked");CREATE.user.setPreference("show_suggested_questions_enabled",e,"save_preference");this._acEnabled=e;this._autocomplete.set("enabled",e)},_handleHasResponses:function(){if(this.model.hasResponses()){this._acEnabled=false;this._autocomplete.set("enabled",false);this.render()}}});CREATE.views.EditorQuestionBank=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"click a.editQBQ":"_editQuestion","click a.upgradeToEditQBQ":"_onUpgradeToEditQBTitle","actionMenu.actionSelected a[input-action-menu]":"_changeQBAction","actionMenu.menuInit a[input-action-menu]":"_initQBActionMenus"},initialize:function(){this.render()},render:function(){var e=this.model.get("heading");if(this.model.isBanked()){this.$el.addClass("qb").addClass(this._getPartnerClass());if(this.model.isBenchMarkable()){this.$el.addClass("bm question-bank-benchmarkable")}if(this.model.isNPS()){this.$el.addClass("nps")}$("#qbQuestionTitle").html(e);if(this.model.isStarRating()){this._renderStarQBOptions()}CREATE.Ajax.fetchQuestionBankQuestionEditorMarkup(this.model.get("id"),CREATE.utils.htmlDecode(e),this).done(this._renderQBHeading).fail(function(){CREATE.Notifications.showErrorNotification()});this._renderQBAnswers()}},getQuestionBankSaveData:function(){var e=[],t=[],i=[],n=this.model;this.$el.find(".qb-question a").each(function(t,i){e.push($(i).text())});$.each(this._actionMenus,function(e,i){var n=i.data("actionMenu").get("selectedAction");t.push(n)});$.each(t,function(t,n){var a=parseInt(n,10),o=e[t],s={id:a,text:o};i[t]=s});return{page_id:CREATE.utils.getPageIdForEl(this.$el),position:n.get("position")+1,question_id:n.id,
type:"question_bank",chosen_options:i,id:n.get("question_bank").lang_bank_id}},_actionMenus:[],_editQuestion:function(e){var t={is_banked:false,lang_bank_id:null,logical_bank_id:null,name:null,partner_id:null,isDisqualified:true};this.$el.removeClass("bm qb qb-certified qb-eventbrite qb-harvard qb-shrm "+"qb-audience qb-zendesk qb-bavc qb-hubspot qb-tmbc qb-leanin").addClass("qb-edit");e.preventDefault();this.model.set("question_bank",t)},_onUpgradeToEditQBTitle:function(e){__UPGRADE.openUpgradeModal("upgradeEditQBQ");e.preventDefault()},_changeQBAction:function(e){var t=e.actionMenu,i="";if(e.$action.is("a")){i=e.$action.text()}else if(e.$action.is("input")){i=CREATE.utils.stripTags(e.$action.val());e.$action.val(i)}t.$el.text(i)},_initQBActionMenus:function(e){var t=e.actionMenu,i=t.get("menuView");i.$el.on("click",".close-menu-btn",function(e){t.close();e.preventDefault()});i.$el.on("click",".save-btn",function(e){var n=CREATE.utils.stripTags(i.$el.find("input").val()),a,o;if(n===""){e.stopPropagation();t.close();return false}a=t.get("selectedAction");o=i.$el.find("input").attr("data-action");t.set("selectedAction",o);if(t.hasAction(o)){i.$el.find(".special-section").removeClass("selected")}else{i.$el.find(".special-section").addClass("selected")}if(a===o){n=CREATE.utils.stripTags($(e.target).closest("div").find("input").first().val());t.$el.text(n)}t.close();e.preventDefault()})},_renderQBHeading:function(e){var t=e.qb_data.modifiers,i=e.qb_data.chosen_options,n=this;this.$el.find(".qb-question").html(e.markup);this._actionMenus=[];this.$el.find(".qb-question a").each(function(e,a){var o=$(a),s=t[e],r=[],l=null,d,u,c,f;s.options.sort(function(e,t){return e.position-t.position});$.each(s.options,function(e,t){r.push({text:t.value,input_text:"",action:t.oid,is_input:false});$.each(i,function(e,i){if(parseInt(i.oid,10)===parseInt(t.oid,10)){l=i}})});if(s.modifier_type===3){r[r.length-1].is_input=true;d="";u=s.options[s.options.length-1];if(parseInt(u.oid,10)===parseInt(l.oid,10)){d=CREATE.utils.htmlDecode(l.value)}r[r.length-1].input_text=d}o.text(CREATE.utils.htmlDecode(l.value));SM.QBActionMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"qbActionMenuView",__templateID:"qb-action-menu-template"});c={menuView:"QBActionMenuView",saveState:true,modifierId:s.mid,selectedAction:l.oid,actions:r,preventFocusOnLeave:true};f=o.actionMenu(c);n._actionMenus.push(f)})},_getQBAnswerMarkup:function(e){var t=$("#rows"),i=t.find(".qb-answers li.hide").clone();i.removeClass("hide");i.html(e.text);return i},_renderQBAnswers:function(){var e=[],t=[],i=this.model,n=this,a=$("#rows");if(i.get("type").family==="matrix"){t=i.get("answer_options").cols}else{t=i.get("answer_options").rows}if(t){$.each(t,function(t,i){e.push(n._getQBAnswerMarkup(i))});a.find(".qb-answers ul").append(e)}},_renderStarQBOptions:function(){var e=this.model,t=e.get("display_options").display_subtype,i=e.get("answer_options").cols.length,n=$("#starShape"),a=$("#starScale"),o=$("#starInfoTable"),s=$("#starLabelTable"),r=false,l,d,u,c;n.text(t);a.text(i);d=e.get("answer_options").cols;for(u=0;u<d.length;u++){if(d[u].text.length!==0){r=true;break}}if(r){c=$("#star-rating-label-template").html();l=_.template(c,{columns:d});$("#ratingLabelTable tr:last").after(l);o.addClass("notFinal");s.show()}else{s.hide();o.addClass("final")}},_getPartnerClass:function(){var e=this.model.get("question_bank").partner_id;switch(e){case 1:return"qb-harvard";case 2:return"qb-eventbrite";case 3:return"qb-audience";case 4:return"qb-shrm";case 5:return"qb-zendesk";case 6:return"qb-bavc";case 7:return"qb-hubspot";case 9:return"qb-leanin";default:return"qb-certified"}}});CREATE.views.EditorQuestionType=CREATE.views.EditorBase.extend({el:"#changeQType",initialize:function(){this.listenTo(this.model,"change:funneling change:has_responses change:logic",this.render);this.render()},render:function(){var e=this.model,t,i=this;if(this._allowsSwitchQType()){if(!this._selectedType){t=this._getActionsData(e.get("common_name"));this.$el.actionMenu({actions:t,selectedAction:this._selectedType,saveState:true,templateID:"change-qtype-action-menu-template",position:{collision:"flip none"}}).on("actionMenu.menuInit",function(e){var t=e.actionMenu.get("menuView");t.$el.find(".q").samplePopout()}).on("actionMenu.actionSelected",this,function(e){i._selectNewQuestionType(e);SM.Logger.enqueue({action_type:"click_switch_question_type",target_question_type:e.action,ui_trigger:"switchQuestionType"})})}$("#editQuestion").addClass("canChangeQType");this.$el.find(".qType").text(CREATE.Translations.get("question_labels","default")[this._selectedType]["default"])}else{$("#editQuestion").removeClass("canChangeQType")}},_questionChangeMapping:{MultipleChoiceQuestion:{commonNames:["multiple_choice_radio","multiple_choice_checkbox"],classNames:"question-single-choice-radio vertical",popout:"qmc"},DropdownQuestion:{commonNames:["dropdown"],classNames:"question-single-choice-select menu",popout:"qdd"},StarRatingQuestion:{commonNames:["star_rating_scale"],classNames:"question-emoji-rating rating",popout:"qsr"},MatrixQuestion:{commonNames:["matrix_radio_weighted","matrix_radio_unweighted","matrix_checkbox","single_row_rating_scale"],classNames:"question-matrix rating",popout:"qmx"},MenuMatrixQuestion:{commonNames:["menu_matrix"],classNames:"question-menu-matrix menu",popout:"qmd"},RankingQuestion:{commonNames:["ranking"],classNames:"question-ranking ranking",popout:"qrk"},SliderQuestion:{commonNames:["slider"],classNames:"question-open-ended-single single",popout:"qsl"},SingleTextboxQuestion:{commonNames:["single_textbox"],classNames:"question-open-ended-single single",popout:"qst"},MultipleTextboxQuestion:{commonNames:["multiple_textboxes","multiple_textboxes_numerical"],classNames:"question-open-ended-multi multi",popout:"qmt"},CommentBoxQuestion:{commonNames:["comment_box"],classNames:"question-essay essay",popout:"qcb"},DateTimeQuestion:{commonNames:["date_time"],classNames:"question-datetime both",popout:"qdt"}},_allowsSwitchQType:function(){var e=this.model;if(e.hasResponses()||e.inQuota()||e.hasLogic()||e.isBanked()||e.isFunnelSender()||e.isFunnelReceiver()||e.isDisqualifiedQB()||e.isAdvancedBranchingSource()||e.isFileUpload()){return false}return true},_selectNewQuestionType:function(e){var t=e.action,i=e.data,n=$(".changeQTypeMenu .selected").hasClass("upgrade"),a=i._questionChangeMapping[t],o,s;if(t===i._selectedType){return}if(n){o="upgrade"+t.replace("Question","");s=__UPGRADE.getUpgradeUrl(o,"question_editor");__UPGRADE.openUpgradeModal(o,s);e.actionMenu.set("selectedAction",i._selectedType);return}i._selectedType=t;CREATE.QuestionEditor.switchQuestionType(t,a.classNames)},_getActionsData:function(e){var t=[],i=CREATE.Translations.get("question_labels","default"),n=this;$.each(this._questionChangeMapping,function(a,o){var s="";if(_.contains(o.commonNames,e)){n._selectedType=a}if($("#builderQuestionContainer [data-help="+o.popout+"]").hasClass("upgrade")){s+=" upgrade"}t.push({text:i[a]["default"],action:a,popout:o.popout,classes:s})});return t}});CREATE.views.EditorRows=CREATE.views.EditorBase.extend({initialize:function(){var e=this;$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},preSave:function(){_.each(this._subViews,function(e){if(e.preSave){e.preSave()}})},mcAndDropdownDefaultRow:function(){return{description:"",id:null,position:null,text:"",type:"row",visible:true,options:{quiz_options:{score:0}}}},matrixDefaultRow:function(){return{description:"",id:null,position:null,text:"",type:"row",visible:true}},choicesTable:undefined,_subViews:{EditorRowsTable:undefined,EditorRowsBulk:undefined}});CREATE.views.EditorRowsTable=CREATE.views.EditorBase.extend({el:"#rows",events:{"choiceAdded tbody":"_addRow","choicesAdded tbody":"_addBulkRows","choiceRemoved tbody":"_removeRow","choicesRemoved tbody":"_removeBulkRows",choiceVisibilityChanged:"_updateRowVisibility","rteBlurred [data-var=text]":"_updateRowText","rteFocused [data-var=text]":"_appendNewRow","blur .quizInput":"_updateQuizScore",toggleQuizUI:"_toggleQuizUI",calcMaxQuizScore:"_renderMaxScore"},initialize:function(e){var t=this.model;this.parent=e.parent;this._previousRows=this.model.get("answer_options").rows;this.parent.choicesTable=new CREATE.ChoicesTable(this.$el.find("tbody"),{maxChoices:t.getMaxRows(),minChoices:t.getMinRows(),listType:this._getListType(),questionType:t.get("type")});this.$el.data("choicesTable",this.parent.choicesTable);this.render();this.listenTo(this.model,"change:common_name",this._toggleSRRS);this.listenTo(this.model,"change:common_name change:required",this._renderMaxScore)},render:function(){var e=this.model.isSingleRowRatingScale(),t=this.model.isQuizEnabled();this.parent.choicesTable.load(this.model.get("answer_options").rows);this.padLastChoice();$("#rowsWrap").toggleClass("hide",e);this.$el.toggleClass("quiz-mode",t);this._initQuiz()},padLastChoice:function(){var e=this.$el.find(".choice").last();this.$el.find(".zero-bottom-padding").removeClass("zero-bottom-padding");e.children().addClass("zero-bottom-padding")},validate:function(){var e=this.model,t=this.model.isQuizEnabled(),i=e.getMinRows(),n=e.getMaxRows(),a="over_max_"+n,o=i===1?"one_choice":"multi_choice",s,r=$("#switchToSRRS").is(":checked"),l,d,u,c,f;if(e.isBanked()||r||e.isStarRating()){return true}l=this.$el.find(".choice:not([data-template])").find(".input");this.$el.removeClass("maxedAnswers");l.closest("td").removeClass("error");c=CREATE.Translations.get("question_choice","errors")[o].message.replace("{1}",i);l.closest(".choice").find(".err").not(".overMax, .quiz-text-error").text(c);this.$el.find(".quiz-value-container").removeClass("error");this.$el.find(".score-missing-err, .above-score-err, .positive-integer-error").addClass("hide");if(this._isLimitedEdit()){l.each(function(e,t){var i=$(t),n=CREATE.Rte.hasContent(CREATE.Rte.getContent(t.id));if(!n){s=true;c=CREATE.Translations.get("question_choice","errors").empty.message;i.closest("td").addClass("error");i.closest(".choice").find(".err").not(".overMax").text(c)}});if(s){return false}}if(l.length<i){l.closest("td").addClass("error");return false}else{d=this._getValidChoiceInputs();if(d.length<i){for(f=0;f<i;f++){u=l.eq(f);if(d.index(u)===-1){u.closest("td").addClass("error")}}return false}if(d.length>n){c=CREATE.Translations.get("question_choice","errors")[a].message;this.$el.addClass("maxedAnswers").find(".overMaxMessage .err").text(c);return false}}if(t&&!this.validateQuiz()){return false}return true},validateQuiz:function(){var e=this.$el.find(".choice:not([data-template])").find(".quizInput").not(".notVisible"),t=true,i=false,n=CREATE.Translations.get("question_choice","errors").quiz_empty.message,a=1e5,o=false;e.each(function(e,s){var r=$(s),l=r.closest(".choice"),d,u=true,c=parseInt(r.val(),10);if(c!==0){i=true;d=l.find(".input").attr("id");u=CREATE.Rte.hasContent(CREATE.Rte.getContent(d));if(!u){l.find(".err").not(".overMax").text(n);l.find(".choiceText").addClass("error");t=false}if(c>a){o=true}}});if(!i){this.$el.find(".score-missing-err").removeClass("hide")}if(o){this.$el.find(".above-score-err").removeClass("hide")}if(!i||o){this.$el.find(".quiz-value-container").addClass("error");return false}if(!t){return false}return true},preSave:function(){var e=$.extend({},this.model.get("answer_options")),t,i;if(this.model.isSingleRowRatingScale()){return}else if(this.model.isStarRating()){i=$.extend({},e.rows[0]);i.description="";i.text="";e.rows=[i]}else{t=_.filter(e.rows,function(e){return CREATE.Rte.hasContent(e.text)});e.rows=t;this._updatePositions(e)}if(this.model.supportsQuizMode()&&!this.model.isQuizEnabled()){e.rows.forEach(function(e){e.options.quiz_options.score=0})}this.model.set("answer_options",e)},_previousRows:[],_getRowValue:function(e){var t;if(e.is("input")){t=$.trim(e.val().replace(/(<([^>]+)>)/gi,""))}else{t=CREATE.Rte.getContentForSave(e.attr("id"))}return t},_getListType:function(){var e=this.model;if(e.get("type").family==="open_ended"||e.get("type").family==="datetime"){return"number"}return""},_getValidChoiceInputs:function(){var e=this.$el.find(".choice:not([data-template])").find(".input"),t=this.model.isSingleRowRatingScale(),i;if(t){i=e.filter(":first")}else{i=e.filter(function(e,t){return CREATE.Rte.hasContent(CREATE.Rte.getContent(t.id))})}return i},_updatePositions:function(e){_.each(e.rows,function(e,t){e.position=t+1})},_addRow:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=this.model.isMenuMatrix()?this.parent.matrixDefaultRow():this.parent.mcAndDropdownDefaultRow(),a=_.clone(i.rows);if(t.choiceData.text===""){a.splice(t.index,0,n)}else{a.splice(t.index,0,$.extend(n,t.choiceData))}i.rows=a;this._updatePositions(i);this.model.set("answer_options",i);$("#editQuestion .warnings").addClass("choicesAdded");this.padLastChoice()},_addBulkRows:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=this.$el.find(".choice:not([data-template])").find(".input"),a=this,o=[],s=0;n.each(function(e,n){var r=$(n),l=r.closest("tr"),d=a.model.isMenuMatrix()?a.parent.matrixDefaultRow():a.parent.mcAndDropdownDefaultRow(),u;if(t&&r.hasClass("funneledAnswerOption")){d=$.extend(d,t.choices[s]);s++}if(i.rows[e]){d=i.rows[e]}u=$.extend({},d,{text:a._getRowValue(r),visible:l.hasClass("new")||l.attr("data-visibility")==="true",position:e+1});o.push(u)});i.rows=o;this.padLastChoice();this.model.set("answer_options",i)},_removeRow:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=_.clone(i.rows);n.splice(t.index,1);i.rows=n;this._updatePositions(i);this.padLastChoice();this.model.set("answer_options",i);this._renderMaxScore()},_removeBulkRows:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=_.clone(i.rows),a=[];if(t.indexes.length){_.each(t.indexes,function(e){a.push(n[e])});n=_.difference(n,a);i.rows=n;this._updatePositions(i);this.padLastChoice();this.model.set("answer_options",i)}},_appendNewRow:function(e){var t=$(e.target),i=this.$el.find(".choice:not([data-template])").find(".input"),n=i.index(t),a=n===i.length-1;if(a&&i.length<this.model.getMaxRows()&&!this._isLimitedEdit()){$(this.el).data("choicesTable").addChoice({text:"",id:""},true,true)}},_isLimitedEdit:function(){var e=this.model;return e.hasResponses()||e.hasLogic()||e.inQuota()},_updateRowText:function(e){var t=$(e.target),i=this.$el.find(".choice:not([data-template])").find(".input"),n=i.index(t),a=this._getRowValue(t),o=$.extend({},this.model.get("answer_options")),s=_.clone(o.rows),r=_.clone(o.rows[n]);if(r){r.text=a;s[n]=r;o.rows=s;this.model.set("answer_options",o)}},_updateRowVisibility:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=_.clone(i.rows),a=_.clone(i.rows[t.index]);a.visible=!!t.visibility;n[t.index]=a;i.rows=n;this.model.set("answer_options",i);this._renderMaxScore()},_toggleSRRS:function(){var e,t,i=this.model,n=i.isSingleRowRatingScale(),a=i.previousAttributes();if($.isEmptyObject(a)||a.common_name!=="single_row_rating_scale"&&!n){return}if(n){this._previousRows=a.answer_options.rows}e=n?[this.parent.matrixDefaultRow()]:this._previousRows;t=$.extend({},this.model.get("answer_options"));t.rows=e;this.model.set("answer_options",t);this.render()},_initQuiz:function(){var e=this;this._renderMaxScore();this.$el.find(".positive-integer-error").addClass("hide");this.$el.on("click",".quiz-radio",function(){var t=!$(this).hasClass("quiz-checked"),i=$(this).closest(".choice").find(".quizInput"),n=$(this).closest(".choice").find(".quizInput").prop("disabled"),a;if(!n){$(this).toggleClass("quiz-checked",t);a=t?1:0;i.val(a).blur();e._renderMaxScore();SM.Logger.quizAnswerScoredLogging({isScored:a===1,uiTrigger:"checkmark",questionType:e.model.get("common_name")})}});this.$el.on("click",".quiz-arrow",function(){var t=$(this).hasClass("quiz-arrow-up"),i=$(this).closest(".choice").find(".quizInput"),n=parseInt(i.val(),10),a=t&&n===0,o=!t&&n===1;if(n===0&&!t||i.hasClass("notVisible")||i.hasClass("disabled")){return}if(t){n++}else{n--}if(a||o){SM.Logger.quizAnswerScoredLogging({isScored:a,uiTrigger:t?"up_arrow":"down_arrow",questionType:e.model.get("common_name")})}i.val(n).blur();e._renderMaxScore()});this.$el.on("keydown",".quizInput",function(e){if(e.keyCode===SM.KeyCodes.ENTER){e.preventDefault()}})},_updateQuizScore:function(e){var t=$(e.target),i=this.$el.find(".choice:not([data-template])").find(".quizInput"),n=t.closest(".choice").find(".quiz-radio"),a=i.index(t),o=this._setQuizInput(t),s=$.extend({},this.model.get("answer_options")),r=_.clone(s.rows),l=_.clone(s.rows[a]),d;if(l){t.val(o);l.options.quiz_options.score=o;r[a]=l;s.rows=r;this.model.set("answer_options",s);d=o!==0;n.toggleClass("quiz-checked",d);this._renderMaxScore();SM.Logger.quizAnswerScoredLogging({isScored:d,uiTrigger:"input_change",questionType:this.model.get("common_name")})}},_setQuizInput:function(e){var t=e.val().trim(),i=parseInt(t,10);if(isNaN(i)||i<0){this._togglePositiveIntegerWarning(e,true);return 0}else{this._togglePositiveIntegerWarning(e,false);return i}},_togglePositiveIntegerWarning:function(e,t){this.$el.find(".score-missing-err, .above-score-err").addClass("hide");this.$el.find(".positive-integer-error").toggleClass("hide",!t);e.closest(".quiz-value-container").toggleClass("error",t)},_renderMaxScore:function(){var e,t;if(!this.model.isQuizEnabled()){return}e=this.$el.find(".max-value");t=this._calcMaxQuizScore();e.text(t)},_calcMaxQuizScore:function(){var e=this.model.get("common_name")==="multiple_choice_checkbox",t=this.$el.find(".choice:not([data-template])").find(".quizInput").not(".notVisible, .disabled"),i=[],n=this.model.get("required"),a=0;t.each(function(){i.push(parseInt(this.value,10))});i.sort(function(e,t){return e-t});if(!e){a=i.pop()}else if(!n||n.type==="all"||n.type==="at_least"){a=this._getMaxScore(i)}else{n=this.model.get("required");if(n.type==="range"){i=i.splice(i.length-parseInt(n.max,10))}else{i=i.splice(i.length-parseInt(n.amount,10))}a=this._getMaxScore(i)}return a},_getMaxScore:function(e){return e.reduce(function(e,t){return e+t},0)},_toggleQuizUI:function(e,t){var i=t===true?"4":"3",n=this.$el.find(".choiceText"),a=this.$el.find(".quiz-header td:first-child");if(i==="4"){this.$el.find(".quiz-header, .quiz-score-container").hide().fadeIn("slow");this.$el.find(".quiz-ui").fadeIn("slow")}this.$el.toggleClass("quiz-mode",t);this.$el.find(".quiz-ui").toggleClass("hide",!t);this.$el.find(".radio, .checkbox").toggleClass("hide",t);this.$el.find(".multipleCheckboxes, .quizCheckbox, .row-head, #funnelingSetting").attr("colspan",i);if(this.model.isDropdown()){this.$el.find(".choiceType").toggleClass("hide",!t);if(this.model.isQuizEnabled()){a.attr("colspan",2);n.removeAttr("colspan")}else{a.attr("colspan",1);n.attr("colspan",2)}}this._renderMaxScore()}});CREATE.views.EditorRowsBulk=CREATE.views.EditorBase.extend({el:"#editQuestion .bulkAdd",events:{"click #addBulkAns":"_openBulkAddDialog"},initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:funneling",this.render);this.render()},render:function(){this.$el.toggleClass("hide",this.model.isFunnelReceiver())},_answersHaveHtml:undefined,_bulkExistingAnswers:"",_replaceAnswerOptions:undefined,_bulkAddDialog:undefined,_bulkAddStarted:false,_openBulkAddDialog:function(e){var t=this;if(!this._bulkAddDialog){this._bulkAddDialog=SM.Views.create(SM.DialogView,{isModal:true,width:800,closeBtn:true,templateID:"bulk-add-dialog-template"})}this._bulkAddDialog.$el.off("dialog.beforeOpen").on("dialog.beforeOpen",function(){if(t._bulkAddStarted===true){return}else{t._bulkAddStarted=true}}).off("dialog.afterOpen").on("dialog.afterOpen",function(){t._bulkAddInit()});this._bulkAddDialog.$el.find('[data-action="save"]').off("click").on("click",function(e){var i,n,a,o=$(this),s=t.model;e.preventDefault();if(o.hasClass("disabled")){return}o.addClass("disabled");i=s.getMaxRows();n=t._saveBulkOptions(e,i);if(n==="error"){a=CREATE.Translations.get("question_choice","errors")["over_max_"+i].message;t._bulkAddDialog.$el.find(".err").text(a);t._bulkAddDialog.$el.addClass("error");o.removeClass("disabled")}else{t._bulkAddDialog.$el.removeClass("error");t._bulkAddDialog.close()}});this._bulkAddDialog.$el.find('[data-action="cancel"]').off("click").on("click",function(e){e.preventDefault();t._bulkAddDialog.close()});this._bulkAddDialog.open();e.preventDefault();SM.Logger.enqueue({action_type:"click_add_answers_in_bulk",ui_trigger:"editorBulkAdd"})},_bulkProcessExistingAnswers:function(){var e=this.$el.closest(".choicesTable"),t=e.find(".choice").not("[data-template], [data-visibility=false], .choiceDisabled"),i=this;this._answersHaveHtml=false;this._bulkExistingAnswers="";t.find(".choiceText .rte, .choiceLabel .rte").each(function(e,t){var n=$(t),a=CREATE.Rte.getContent(n.attr("id")),o=n.text();if(i._bulkAddRequiresRtl()){if(CREATE.Rte.hasRtlDirection(n)){a=n.children(0).html()}else if(n.html()!==""){i._answersHaveHtml=true;i._bulkExistingAnswers="";return false}}if(a!==CREATE.utils.htmlEncode(o,true)){i._answersHaveHtml=true;i._bulkExistingAnswers="";return false}else if(o!==""){i._bulkExistingAnswers+=o+"\n"}})},_isLimitedState:function(){var e=this.model;return e.hasResponses()||e.hasLogic()||e.inQuota()||e.isFunnelSender()},_checkReplaceOrAppend:function(){this._bulkProcessExistingAnswers();this._replaceAnswerOptions=!(this._answersHaveHtml||this._isLimitedState())},_bulkAddInit:function(){var e=this._bulkAddDialog.$el.find("textarea"),t=this._bulkAddDialog.$el.find('[data-action="save"]'),i=this._bulkAddDialog.$el.find('[data-prompt="appendoptions"]'),n=i.find('[data-restriction="formatting"]'),a=i.find('[data-restriction="limited"]'),o=this.model.getMaxRows(),s=CREATE.Translations.get("question_choice","errors")["bulk_warning_"+o].message,r=this._isLimitedState();this._bulkAddDialog.$el.removeClass("error");e.val("");t.removeClass("disabled");if(this._bulkAddRequiresRtl()){e.addClass("rtl")}this._checkReplaceOrAppend();i.toggleClass("hide",this._replaceAnswerOptions);a.toggleClass("hide",!r);n.toggleClass("hide",r||!this._answersHaveHtml);if(this._replaceAnswerOptions){e.val(this._bulkExistingAnswers)}e.focus();this._bulkAddDialog.$el.find(".ttp").text(s);this._bulkAddDialog.$el.find(".q").popout()},_saveBulkOptions:function(e,t){var i=this._bulkAddDialog.$el.find("textarea"),n=this.parseBulkEditItems(i),a=$("#rows").find(".choice:not([data-template])").length,o=n.length,s=this._replaceAnswerOptions?o:a+o,r;if(s>t){return"error"}else{this._bulkAddToDOM(n);i.val("");this._bulkAddDialog.close();r={Name:"BulkAnswers",Message:"User used bulk add button",HasResponses:this.model.hasResponses(),IsNew:CREATE.QuestionEditor.isNewQuestion(this.model.id),BulkAddMethod:this._replaceAnswerOptions?"replace":"append",BulkExistingAnswersNum:a,BulkAddedAnswersNum:o};SM.Logger.remoteLog(r,"info")}},_bulkAddRequiresRtl:function(){return CREATE.survey.hasRtlLanguage()&&!this.model.isDropdown()},_bulkAddToDOM:function(e){var t,i=this.model.get("answer_options").rows,n=false,a,o,s,r=0,l;if(this._replaceAnswerOptions){t=$("#rows").find(".choice").not("[data-template]");while(r<e.length&&r<t.length){o=e[r].text;if(o.length){$(t[r]).find(".rteToolbarContainer").removeClass("empty")}l=$(t[r]).find("div.input[contenteditable]");l.text(o);if(this._bulkAddRequiresRtl()){CREATE.Rte.wrapDirectionalityDiv(l);i[r].text=CREATE.Rte.getDirectionalityWrappedText(o)}else{i[r].text=o}r++;n=true}if(r<e.length){s=e.slice(r).map(function(e){e.text=CREATE.utils.htmlEncode(e.text);return e});if(this._bulkAddRequiresRtl()){$.each(s,function(e,t){t.text=CREATE.Rte.getDirectionalityWrappedText(t.text)})}this.parent.choicesTable.addChoices(s,true);n=true}else if(r<t.length){this.parent.choicesTable.deleteChoices(t.slice(r))}}else{if(this._bulkAddRequiresRtl()){$.each(e,function(e,t){t.text=CREATE.Rte.getDirectionalityWrappedText(t.text)})}this.parent.choicesTable.addChoices(e,true);n=true}if(!n){a=this.model.defaults.answer_options.rows;this.parent.choicesTable.addChoices(a,true)}}});CREATE.views.EditorColumns=CREATE.views.EditorBase.extend({initialize:function(){var e=this;$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},preSave:function(){_.each(this._subViews,function(e){if(e.preSave){e.preSave()}})},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},choicesTable:undefined,getDefaultColumn:function(){return{description:"",id:null,position:null,text:"",type:"col",visible:true}},_subViews:{EditorColsTable:undefined}});CREATE.views.EditorColsTable=CREATE.views.EditorBase.extend({el:"#columnsWrap .choicesTable",events:{"choiceAdded .columnSetting":"_handleChoiceAdded","choiceRemoved .columnSetting":"_handleChoiceRemoved","choicesAdded .columnSetting":"_addBulkColumns","choicesRemoved .columnSetting":"_removeBulkColumns",bulkUpdate:"_bulkUpdateColumnsTable","choiceVisibilityChanged .columnSetting":"_handleVisibiltyChanged","blur input.weightInput":"_handleWeightBlur","change #editWeighted":"_handleWeightsChange","rteBlurred .column.choice td.choiceText .input":"_handleChoiceTextBlur"},initialize:function(e){this.parent=e.parent;this.parent.choicesTable=new CREATE.ChoicesTable(this.$el.find(".columnSetting"),{minChoices:this.model.getMinCols(),maxChoices:this.model.getMaxCols(),listType:false,questionType:this.model.get("type")});this.$el.data("choicesTable",this.parent.choicesTable);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.render();this._handleMinimumColumns();if(this.model.isStarRating()){this.listenTo(this.model,"change:display_options",this._handleDisplayOptionsChange);this._handleDisplayOptionsChange()}},render:function(){this.parent.choicesTable.load(this.model.get("answer_options").cols)},validate:function(){var e=true,t=this.model.isMenuMatrix(),i=this.model.isMatrixNotRating(),n=true,a=this.model.hasResponses(),o=this.$el.find(".columnSetting .column").not("[data-template], .notApplicable"),s=this.model.getMaxCols();o.find(".editOptions").removeClass("error");if(t){o.each(function(t,i){var o=$(i),s=o.find("[data-var=text]").first(),r=o.find("[data-var=text]").data("menuOptions")||[],l=CREATE.Rte.getContentForSave(s.attr("id"));if(r.length){n=false}else{if(a&&!o.hasClass("new")){e=false;o.find(".editOption").addClass("error")}}if(l&&!r.length){o.find(".editOptions").addClass("error");e=false}});if(n){o.first().find(".editOptions").addClass("error");e=false}}if(i){if(this.model.get("answer_options").cols.length>s){o.first().find(".editOptions").addClass("error");e=false;this.$el.find(".choice:not([data-template])").first().find("[data-error=overMax"+s+"]").removeClass("hide")}}return e},preSave:function(){var e,t;if(!this.model.isMenuMatrix()){return}e=this.model.get("answer_options");t=_.filter(e.cols,function(e){return e.col_choices.length>0});e.cols=t;this._updatePositions(e);this.model.set("answer_options",e)},_handleChoiceAdded:function(e,t){var i=_.extend({},this.model.get("answer_options")),n=_.clone(i.cols),a=this.parent.getDefaultColumn();if(this.model.isMenuMatrix()){a.col_choices=[]}this._setWeight(t.$el,a);$("#editQuestion .warnings").addClass("choicesAdded");a.position=t.index+1;n.splice(t.index,0,a);i.cols=n;this._updatePositions(i);this.model.set("answer_options",i);$("#editWeighted").trigger("columnAdded");if(this.model.isStarRating()){this._handleDisplayOptionsChange()}},_handleChoiceRemoved:function(e,t){var i=_.extend({},this.model.get("answer_options")),n=_.clone(i.cols);n.splice(t.index,1);i.cols=n;this._updatePositions(i);this.model.set("answer_options",i);$("#editWeighted").trigger("columnRemoved");if(this.model.isStarRating()){this._handleDisplayOptionsChange()}},_addBulkColumns:function(){var e=$.extend({},this.model.get("answer_options")),t=this.$el.find(".choice:not([data-template])").find(".input"),i=this,n=[];t.each(function(t,a){var o=$(a),s=o.closest("tr"),r=i.parent.getDefaultColumn(),l;if(e.cols[t]){r=e.cols[t]}l=$.extend({},r,{text:i._getColValue(o),visible:s.hasClass("new")||s.attr("data-visibility")==="true",position:t+1});if(i.model.isWeightedMatrix()){l.weight=t+1}n.push(l)});e.cols=n;this.model.set("answer_options",e);$("#editQuestion .warnings").addClass("choicesAdded")},_removeBulkColumns:function(e,t){var i=$.extend({},this.model.get("answer_options")),n=_.clone(i.cols),a=[];if(t.indexes.length){_.each(t.indexes,function(e){a.push(n[e])});n=_.difference(n,a);i.cols=n;this._updatePositions(i);this.model.set("answer_options",i)}},_bulkUpdateColumnsTable:function(e,t){var i=this.$el.find(".choice").not("[data-template]"),n=t.newCols,a=this;if(n.length>i.length){this.parent.choicesTable.addChoices(n.slice(i.length),true)}else if(n.length<i.length){this.parent.choicesTable.deleteChoices(i.slice(n.length))}if(this.model.isWeightedMatrix()){i=this.$el.find(".choice").not("[data-template]");$.each(i,function(e,t){$(t).find(".weightInput").val(a.model.get("answer_options").cols[e].weight)})}if(this.model.isStarRating()){this._handleDisplayOptionsChange()}},_handleWeightBlur:function(e){var t=this.$el.find(".columnSetting .column").not("[data-template], .notApplicable"),i=$(e.target),n=i.closest("tr"),a=t.index(n),o=parseInt(i.val(),10),s=_.extend({},this.model.get("answer_options"));if(isNaN(o)){o=0}i.val(o.toString());s.cols[a].weight=o;this.model.set("answer_options",s)},_handleWeightsChange:function(e){var t=$(e.currentTarget).is(":checked"),i=$(e.currentTarget).is(":checked")?2:1;this.parent.choicesTable.setOption("minChoices",i);if(t){this._addAllWeights()}else{this._removeAllWeights()}},_handleChoiceTextBlur:function(e){var t=$(e.target),i=this.$el.find(".columnSetting .column").not("[data-template], .notApplicable"),n=t.closest("tr"),a=i.index(n),o=_.extend({},this.model.get("answer_options")),s=CREATE.Rte.getContentForSave(t.attr("id"));o.cols[a].text=s;this.model.set("answer_options",o)},_getColValue:function(e){var t;if(e.is("input")){t=$.trim(e.val().replace(/(<([^>]+)>)/gi,""))}else{t=CREATE.Rte.getContentForSave(e.attr("id"))}return t},_handleVisibiltyChanged:function(e,t){var i=_.extend({},this.model.get("answer_options"));i.cols[t.index].visible=!!t.visibility;this.model.set("answer_options",i)},_setWeight:function(e,t){var i=parseInt(e.prev().find(".weightInput").val(),10),n=i+1;e.find(".weightInput").val(n);if($("#editWeighted").is(":checked")){t.weight=n}},_handleCommonNameChange:function(){var e=this.model.isSingleRowRatingScale();this.$el.closest(".columnFigure").toggleClass("ratingFigure",e)},_handleMinimumColumns:function(){var e=this.model.get("answer_options").cols,t=e.length,i=this.parent.getDefaultColumn(),n;if(t>=this.model.getMinCols()){return}n=this.parent.choicesTable.addChoice(i,true,true);this._handleChoiceAdded(null,{$el:n,index:1,choiceData:i})},_handleDisplayOptionsChange:function(){var e=this.model.get("display_options"),t,i,n,a;if(this.model.isStarRating()){t=e.display_subtype;a=$("#emoji-plural").find(".plural-"+t).clone();i=this.$el.find(".columnSetting .column").not("[data-template], .notApplicable");n=i.find("td.shapeLabel");$.each(n,function(e,t){$(t).empty().prepend(a[e])})}},_removeAllWeights:function(){var e=_.extend({},this.model.get("answer_options")),t=e.cols.length,i;for(i=0;i<t;i++){delete e.cols[i].weight}this.model.set("answer_options",e)},_addAllWeights:function(){var e=this.$el.find(".columnSetting .column").not("[data-template], .notApplicable"),t=_.extend({},this.model.get("answer_options")),i=e.find("td.weightValue");$.each(i,function(e){
var n=parseInt($(i[e]).find("input").val(),10);t.cols[e].weight=n});this.model.set("answer_options",t)},_updatePositions:function(e){_.each(e.cols,function(e,t){e.position=t+1})}});CREATE.views.EditorColChoices=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"click .editOptions":"_editColumnOptions"},initialize:function(){this.render();this.listenTo(this.model,"change:answer_options",this.render)},render:function(){var e=this.$el.find(".columnSetting"),t=e.find(".column").not("[data-template], .notApplicable"),i=e.closest(".choicesTable").data("choicesTable"),n=this.model.get("answer_options").cols;$.each(n,function(e,n){var a=t.eq(e),o=n.col_choices;if(a.length===0&&o.length>0){a=i.addChoice({text:"",id:""},true,true)}a.find("[data-var=text]").data("menuOptions",o)})},_optionsDialog:null,_menuDialog:null,_editColumnOptions:function(e){var t=this,i=$(e.target),n,a,o,s=[],r,l=this.model,d;e.preventDefault();this._optionsDialog=this._menuDialog;if(!this._optionsDialog){this._optionsDialog=this._menuDialog=SM.Views.create(SM.ConfirmDialogView,{isModal:true,width:450,html:SM.Template.render("menu-options-dialog-template"),confirmText:CREATE.Translations.get("save")["default"]})}this._optionsDialog.choicesTable=new CREATE.ChoicesTable(this._optionsDialog.$el.find(".menu-options-container table"),{listType:false,maxChoices:l.getMaxColChoices()});this._optionsDialog.$el.off("confirmDialog.cancel").on("confirmDialog.cancel",function(){$("#menu-options-dialog").removeClass("error");t._optionsDialog.close()}).off("confirmDialog.confirm").on("confirmDialog.confirm",function(){var e=t._optionsDialog.$el.hasClass("limitedEdit"),i=e?t._saveListMenuOptions():t._saveBulkMenuOptions(),n=$.extend({},l.get("answer_options")),a=t.$el.find(".columnSetting .column").not("[data-template], .notApplicable");if(i){t._optionsDialog.currentCol.data("menuOptions",i);t._optionsDialog.currentCol.parent().next("a.editOptions").removeClass("error").removeClass("addNew");t._optionsDialog.close()}_.each(n.cols,function(e,t){var i=a.eq(t).find("[data-var=text]").data("menuOptions")||[];e.col_choices=i});l.set("answer_options",n)});this._optionsDialog.currentCol=i.closest("td").find("div.rte");n=this._optionsDialog.currentCol.data("menuOptions");if(!n){o=this._optionsDialog.currentCol.closest(".column").attr("data-choice-id");if(o){o=parseInt(o.replace("choice",""),10);$.each(l.get("answer_options").cols,function(e,t){if(parseInt(t.id,10)===o){n=t.col_choices;return false}})}}if(n){$.each(n,function(e,t){t.text=CREATE.utils.htmlDecode(t.text);s.push(t.text)})}a=l.hasResponses();d=i.closest(".choice").hasClass("new");this._optionsDialog.$el.addClass("dialog-a").toggleClass("limitedEdit",!d&&a&&!!n);if(a&&n){this._optionsDialog.choicesTable.load(n)}r=this._optionsDialog.$el.find("textarea");r.val(s.join("\n"));this._optionsDialog.open()},_saveListMenuOptions:function(){var e=true,t=this._menuDialog.$el.find(".choice:not(.hide)").find(".input"),i=[],n=this.model;t.each(function(t,i){var n=$(i),a=$.trim(n.val());e=e&&!!a;n.closest(".choice").toggleClass("error",!a)});if(!e){return false}t.each(function(e,t){var a=$(t),o,s;o={position:e+1,question_id:n.id,text:$.trim(a.val()),visible:!a.hasClass("notVisible"),type:"col_choice"};s=a.closest(".choice").data("choice-id");if(s){o.id=s.toString()}i.push(o)});return i},_saveBulkMenuOptions:function(){var e=this.parseBulkEditItems(this._menuDialog.$el.find("textarea")),t=this.model,i=t.getMaxColChoices(),n=e.length>0&&e.length<=i,a,o,s=[];$("#menu-options-dialog").toggleClass("error",!n);if(!n){a=e.length>i?"over_max_"+i:"bulk_empty";o=CREATE.Translations.get("question_choice","errors")[a].message;$("#menu-options-dialog > .err").text(o);return false}$.each(e,function(e,i){s.push({position:e+1,question_id:t.id,text:i.text,visible:true,type:"col_choice"})});return s}});CREATE.views.EditorToggleNumerical=CREATE.views.EditorBase.extend({el:"#numericalCheckboxes",events:{"change #toggleNumerical":"_toggleNumericalAnswers","change #toggleConstantSum":"_toggleConstantSum"},initialize:function(){var e=this;this.listenTo(this.model,"change:type change:has_responses",this.render);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model})});this.render()},render:function(){var e=this.model.isNumerical(),t=this.model.get("constant_sum")!==undefined,i=this.model.hasResponses();this.$el.toggleClass("checked",e);$("#toggleNumerical").prop("checked",e);$("#editQuestion").toggleClass("editor-numerical",e).toggleClass("editor-open-ended-multi",!e).find(".constantSumToggleLabel").toggleClass("hide",!e);$("#toggleConstantSum").prop("checked",e&&t).change();if(i){this._disableEditFields()}},validate:function(){var e=true;_.each(this._subViews,function(t){e=e&&t.validate()});return e},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorConstantSum:undefined,EditorNumericalValidation:undefined},_toggleNumericalAnswers:function(e){var t=$(e.target).prop("checked"),i=this.model.get("type"),n;n={subtype:t?"numerical":"multi",name:i.name,family:i.family};this.model.set("type",n)},_toggleConstantSum:function(e){var t;if($(e.target).prop("checked")){t={error_text:CREATE.utils.stripTags($("#editSumError").val()),sum:parseInt($("#editSumAmount").val(),10)};this.model.set("constant_sum",t)}else{this.model.unset("constant_sum")}},_disableEditFields:function(){$("#toggleNumerical").prop("disabled",true);$("#toggleConstantSum").prop("disabled",true)}});CREATE.views.EditorNumericalValidation=CREATE.views.EditorBase.extend({el:"#numberValidate",events:{"blur #editNumError":"_updateNumErrorText"},initialize:function(){this.listenTo(this.model,"change:type",function(){this.render();this._toggleNumericalValidation()});this._loadFields();this.render()},render:function(){this.$el.toggleClass("hide",!this.model.isNumerical())},validate:function(){var e=true;if(this.model.isNumerical()){e=CREATE.Validator.validate($("#editNumError"),".block")}return e},_updateNumErrorText:function(e){var t=CREATE.utils.stripTags($(e.target).val());this.model.get("validation").text=t},_loadFields:function(){var e;if(this.model.isNumerical()){e=$("<div>").html(this.model.get("validation").text).text();$("#editNumError").val(e)}},_toggleNumericalValidation:function(){var e={type:"integer"};if(this.model.isNumerical()){e.text=CREATE.utils.stripTags($("#editNumError").val());this.model.set("validation",e)}else if(!$("#editValidation").prop("checked")){this.model.unset("validation")}}});CREATE.views.EditorConstantSum=CREATE.views.EditorBase.extend({el:"#sumQuestion",events:{"blur #editSumAmount":"_updateSumAmount","blur #editSumError":"_updateSumErrorText"},initialize:function(){this.listenTo(this.model,"change:constant_sum change:has_responses",this.render);this._loadFields();this.render()},render:function(){var e=this.model.get("constant_sum"),t=this.model.hasResponses();this.$el.toggleClass("hide",!e);if(t){this._disableEditFields()}},validate:function(){var e=true;if(this.model.get("constant_sum")){e=CREATE.Validator.validate($("#sumQuestion [data-validation]"),".block")}return e},_updateSumAmount:function(e){var t=parseInt($(e.target).val(),10);this.model.get("constant_sum").sum=t},_updateSumErrorText:function(e){var t=CREATE.utils.stripTags($(e.target).val());this.model.get("constant_sum").error_text=t},_loadFields:function(){var e=this.model.get("constant_sum"),t;if(e){$("#editSumAmount").val(e.sum);t=$("<div>").html(e.error_text).text();$("#editSumError").val(t)}},_disableEditFields:function(){$("#editSumAmount").prop("disabled",true)}});CREATE.views.EditorMultipleChoiceToggle=CREATE.views.EditorBase.extend({el:"#rows tfoot",events:{"change #toggleMultipleChoice":"_updateQuestion"},initialize:function(){this.listenTo(this.model,"change:common_name",this.render);this.render();$("#toggleMultipleChoice").prop("disabled",this.model.inQuota())},render:function(){var e=this.model,t=e.get("type").family==="matrix",i=$("#question-field-"+e.id),n=$("#editQuestion"),a=$("#toggleMultipleChoice"),o=e.allowsMultipleChoices();if(!t){i.toggleClass("question-multiple-choice",o).toggleClass("question-single-choice-radio",!o);n.toggleClass("editor-multiple-choice",o).toggleClass("editor-single-choice-radio",!o)}a.prop("checked",o).closest(t?".multiple":".fsMultiple").toggleClass("checked",o);i.toggleClass("mx_checks",o)},_updateQuestion:function(){var e=this.model,t=$("#toggleMultipleChoice"),i=t.is(":checked"),n=this.model.get("type").family==="matrix",a,o=$.extend({},e.get("type"));if(n){o.subtype=i?"multi":"single";a=i?"matrix_checkbox":"matrix_radio_unweighted"}else{o.family=i?"multiple_choice":"single_choice";a=i?"multiple_choice_checkbox":"multiple_choice_radio"}e.set("type",o);e.set("common_name",a)}});CREATE.views.EditorMultipleChoiceIndicators=CREATE.views.EditorBase.extend({initialize:function(){this.listenTo(this.model,"change:common_name",this.render);this.render()},render:function(){var e=this.model,t=e.get("common_name"),i=t==="multiple_choice_checkbox",n=i?"checkbox":"radio";if(e.isQuizEnabled()){return}$("#rows").find(".choiceType input").replaceWith($("<input/>",{class:n,type:n,disabled:true}))}});CREATE.views.EditorMatrix=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"change #columnsWrap tfoot input":"_handleInputChange"},initialize:function(){_.each(this._subViews,function(e,t){this._subViews[t]=new CREATE.views[t]({model:this.model,parent:this})},this);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.listenTo(this.model,"change:funneled_to_questions",this._toggleSRRSDisabled);this._toggleSRRSDisabled();this._toggleLogicMessages();this._updateMatrixOptions()},preSave:function(){var e=this.model.allowsMultipleChoices(),t=this.model.isMenuMatrix(),i=_.extend({},this.model.get("answer_options")),n=_.filter(i.cols,function(e){return e.weight!==undefined});if(e||t){_.each(n,function(e){delete e.weight});this.model.set("answer_options",i)}},remove:function(){$("#livePreview").off("previewUpdated.matrix");_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.call(this)},_subViews:{EditorSRRS:undefined,EditorWeighted:undefined,EditorForcedRanking:undefined},_matrixOptions:{editNA:false,editWeighted:false,editForcedRanking:false},_handleInputChange:function(){var e,t=$("#columnsWrap tfoot tr"),i=t.is(":checked");this._updateMatrixOptions();e=_.some(this._matrixOptions,function(e,t){return this._matrixOptions[t]},this);t.toggleClass("checked",!i&&e)},_toggleSRRSDisabled:function(){$("#ratingScaleSetting .checkboxSetting").toggleClass("disabled",this.model.isFunnelSender())},_handleCommonNameChange:function(){var e=this.model.allowsMultipleChoices();$("#columnsWrap tfoot").toggleClass("hide",e);$("#ratingScaleSetting").toggleClass("hide",e);this._toggleLogicMessages();if(e){$("#columnsWrap tfoot tr").removeClass("checked")}},_updateMatrixOptions:function(){_.each(this._matrixOptions,function(e,t){this._matrixOptions[t]=$("#"+t).is(":checked")},this)},_toggleLogicMessages:function(){var e=this.model.isSingleRowRatingScale(),t=this.model.isStarRating(),i=!e&&!t||!this.model.hasLogic();this.$el.find(".logicMessage").toggleClass("hide",i);$("#logicMatrixMessage").toggleClass("hide",e||t)}});CREATE.views.EditorSRRS=CREATE.views.EditorBase.extend({el:"#switchToSRRS",events:{change:"_toggleSRRS"},initialize:function(e){this.parent=e.parent;this.render();this.listenTo(this.model,"change:funneled_to_questions change:common_name",this.render);this.listenTo(this.model,"change:has_responses",this._handleHasResponses);this._handleHasResponses()},render:function(){var e=this.model.isSingleRowRatingScale(),t=$("#columnsWrap").find("figure"),i=this.model.allowsMultipleChoices();$("#ratingScaleSetting").toggleClass("hide",i);this.$el.prop("checked",e);$("#ratingScaleSetting").toggleClass("checked",e);t.toggleClass("ratingFigure",e);this.$el.prop("disabled",this.model.isFunnelSender())},_toggleSRRS:function(){var e=this.$el.is(":checked"),t=e?"single_row_rating_scale":"matrix_radio_weighted",i=_.extend({},this.model.get("type"));i.subtype="rating";i.family="matrix";this.model.set({common_name:t,type:i})},_handleHasResponses:function(){if(this.model.hasResponses()){this.$el.prop("disabled",true)}}});CREATE.views.EditorWeighted=CREATE.views.EditorBase.extend({el:"#editWeighted",events:{change:"_toggleWeighted",columnAdded:"_handleWeightVisibility",columnRemoved:"_handleWeightVisibility"},initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.render()},render:function(){var e=this.model.isSingleRowRatingScale(),t=this.model.isStarRating(),i=this.model.isWeightedMatrix(),n=this.model.allowsMultipleChoices(),a=i||e||t;this.$el.closest("tfoot").toggleClass("hide",n);this.$el.closest(".isWeighted").toggleClass("disabled",e||t);this.$el.prop("disabled",e||t);$("#editQuestion").toggleClass("showWeights",a);this.$el.prop("checked",a);if(e||i){this._toggleWeighted({currentTarget:null});this.parent._handleInputChange({currentTarget:this.el})}else if(n){this.parent._handleInputChange({currentTarget:this.el})}},_handleCommonNameChange:function(){var e=this.model.isSingleRowRatingScale(),t=this.model.isWeightedMatrix(),i=this.model.allowsMultipleChoices();if(e||t){this._handleTurnOnWeighted()}else if(i){this._handleTurnOffWeighted()}this.render()},_handleWeightVisibility:function(){var e=this.model.get("answer_options").cols,t=e.length<=1;this.$el.closest(".isWeighted").toggleClass("hide",t)},_handleTurnOffWeighted:function(){this.$el.prop("checked",false);this._toggleWeighted({currentTarget:null})},_handleTurnOnWeighted:function(){this.$el.prop("checked",true);this._toggleWeighted({currentTarget:null})},_toggleWeighted:function(e){var t=this.$el.is(":checked"),i=this.model.isSingleRowRatingScale(),n=this.model.isStarRating(),a=this.model.allowsMultipleChoices(),o,s;if(t||a||n){this._updateWeights()}if(!i&&!n&&e.currentTarget!==null){o=t?"matrix_radio_weighted":"matrix_radio_unweighted";s=_.extend({},this.model.get("type"));s.subtype=t?"rating":"single";s.family="matrix";this.model.set({common_name:o,type:s});this.render()}},_updateWeights:function(){var e=0,t=$("#editQuestion").find("tr").not("[data-template]").find(".weightInput"),i=_.extend({},this.model.get("answer_options")),n=_.filter(i.cols,function(e){return e.weight!==undefined});if(this.model.allowsMultipleChoices()){_.each(i.cols,function(e){delete e.weight})}else{t.each(function(t,a){var o;if(!n.length){o=e+1;$(a).val(o);i.cols[t].weight=o}else{o=parseInt($(a).val(),10);if(isNaN(o)&&i.cols[t]){o=e+1;$(a).val(o);i.cols[t].weight=o}}e=o})}this.model.set("answer_options",i,{silent:true})}});CREATE.views.EditorForcedRanking=CREATE.views.EditorBase.extend({el:"#editForcedRanking",events:{change:"_handleEditForcedRanking"},initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:common_name ",this._handleCommonNameChange);this.render()},render:function(){var e=this.model.get("forced_ranking"),t=this.model.isSingleRowRatingScale(),i=this.model.isStarRating();this.$el.closest(".forcedRanking").toggleClass("hide",t||i);this.$el.prop("checked",e.enabled);$("#editQuestion").toggleClass("mx_forced",e.enabled)},_handleEditForcedRanking:function(){var e=this.$el.is(":checked"),t=$.extend({},this.model.get("forced_ranking"));t.enabled=e;this.model.set("forced_ranking",t);this.render()},_handleCommonNameChange:function(){if(this.model.allowsMultipleChoices()||this.model.isSingleRowRatingScale()){this.model.set("forced_ranking",{enabled:false})}this.render()}});CREATE.views.EditorRequired=CREATE.views.EditorBase.extend({el:"#requireQuestion",events:{"change #toggleReq":"_toggleRequired","change #selectReqType":"_toggleRequiredType","blur #editReqamount":function(e){this._resetNumValidate(e.target,"amount",1,1,this._reqAmountMaxNum())},"blur #editReqmin":"_updateReqMin","blur #editReqmax":"_updateReqMax","change .requireDemoOption":"_updateDemoReq","blur #editReqtext":"_updateErrorText"},initialize:function(){var e=this.model.get("required");this.listenTo(this.model,"change:required",this.render);this.listenTo(this.model,"change:type",this._toggleRequired);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.listenTo(this.model,"change:answer_options",this._handleAnswerOptionsChange);if(e&&!e.text){this._updateErrorText()}if(!this.model.allowsRequiredType()&&e&&e.type){delete e.type}this.render()},render:function(){var e=this.model.get("required"),t=this.model.get("type").family==="demographic";$("#toggleReq").prop("checked",e);this.$el.toggleClass("expand",!!e);if(e){if(t){this._renderDemographic()}if(e.type){$("#selectReqType").val(e.type)}_.each(this._reqFields,function(t){var i=e[t],n=$("#editReq"+t);if(t==="amount"&&i==="0"){i=0}n.closest(".reqNumberContainer").toggleClass("hide",!i);if(i){n.val(i)}})}},validate:function(){var e=true,t=this.model.get("required"),i;if(t){i=this.model.getRowsWithTextCount();if(t.max&&t.min){t.max=i<t.max?i:t.max;t.min=t.min>t.max?t.max:t.min}else if(typeof t.amount!=="undefined"){t.amount=i<t.amount?i:t.amount}else if(_.contains(["at_least","at_most","exactly"],t.type)&&!t.amount){t.amount=1}if(!this.model.allowsRequiredType()&&t.type){delete t.type}}if($("#toggleReq").is(":checked")){e=CREATE.Validator.validate($("#editReqtext"))}return e},_reqFields:["text","amount","min","max"],_reqTypeToFields:{at_least:["amount"],at_most:["amount"],exactly:["amount"],range:["min","max"],all:[]},_reqDemoFields:["name","company","phone","email","address","address2","city","state","zip","country"],_toggleRequired:function(){var e={};if($("#toggleReq").prop("checked")){if(this.model.get("type").family==="demographic"){e.answer_ids_required=this._getRequiredIds()}e.text=this._getReqText();if(this.model.allowsRequiredType()){e=this._addReqType(e)}this.model.set("required",e)}else{this.model.unset("required")}},_toggleRequiredType:function(){var e=this.model.get("required"),t={text:e.text};t=this._addReqType(t);this.model.set("required",t);this._handleAnswerOptionsChange()},_handleCommonNameChange:function(){this.validate();this.render()},_handleAnswerOptionsChange:function(){var e=this.model.get("answer_options").rows;if(e&&e.length===0){return}if(this.model.get("required")){if(!$("#editReqamount").closest(".reqNumberContainer").hasClass("hide")){this._resetNumValidate($("#editReqamount"),"amount",1,1,this._reqAmountMaxNum())}if(!$("#editReqmax").closest(".reqNumberContainer").hasClass("hide")){this._updateReqMax({target:$("#editReqmax")})}if(!$("#editReqmin").closest(".reqNumberContainer").hasClass("hide")){this._updateReqMin({target:$("#editReqmin")},true)}}},_updateReqMin:function(e,t){var i=parseInt($("#editReqmax").val(),10),n=t?i:1;i=parseInt($("#editReqmin").val(),10)>i?n:i;this._resetNumValidate(e.target,"min",1,1,i)},_updateReqMax:function(e){var t=this.model.getVisibleRowCount();this._resetNumValidate(e.target,"max",t,parseInt($("#editReqmin").val(),10),this._reqAmountMaxNum())},_updateDemoReq:function(e){var t=$(e.target),i=t.data("reqtype"),n=this.model.get("answer_options").rows,a=this.model.get("required").answer_ids_required||[],o;if(CREATE.QuestionEditor.isNewQuestion(this.model.id)){o=i}else{$.each(n,function(e,t){if(t.type===i){o=t.id}})}if(t.prop("checked")){a.push(o)}else{a=_.filter(a,function(e){return e!==o})}this.model.get("required").answer_ids_required=a},_updateErrorText:function(){this.model.get("required").text=this._getReqText()},_addReqType:function(e){var t=$("#selectReqType").val();e.type=t;_.each(this._reqTypeToFields[t],function(t){e[t]=$("#editReq"+t).val()});return e},_resetNumValidate:function(e,t,i,n,a){var o=$(e).val(),s=parseInt(o,10)||i,r=$.extend({},this.model.get("required"));s=Math.min(Math.max(s,n),a);r[t]=s;this.model.set("required",r);if(s.toString()!==o){this.render()}},_reqAmountMaxNum:function(){var e=$("#editQuestion"),t,i=this.model.getVisibleRowCount(),n=i;if($("#editForcedRanking").prop("checked")){t=e.find(".columnSetting").find("tr").not("[data-template], .notApplicable").length;n=Math.min(i,t)}return n},_getReqText:function(){return $("<div>").html($("#editReqtext").val()).text()},_getRequiredIds:function(){var e=this,t=this.model.get("answer_options").rows,i=[];if(CREATE.QuestionEditor.isNewQuestion(this.model.id)){return this._reqDemoFields}_.each(t,function(t){if(e.$el.find("[data-reqtype="+t.type+"]").prop("checked")){i.push(t.id)}});return i},_renderDemographic:function(){var e=this,t=this.model.get("required").answer_ids_required,i=this.model.get("answer_options").rows;_.each(i,function(i){var n=i.id||i.type,a=$.inArray(n,t)>-1;e.$el.find("[data-reqtype="+i.type+"]").prop("checked",a)})}});CREATE.views.EditorSort=CREATE.views.EditorBase.extend({el:"#randomizeChoices",events:{"change #editRand":"_toggleSorting","change [name=sortRadios]":"_changeSortRatios","change #editLast":"_changeEditLast"},initialize:function(){this.render()},render:function(){if(this.model.get("sorting")&&this.model.get("sorting").type!=="default"){$("#editRand").prop("checked",true);this.$el.addClass("expand");this.$el.find('input[value="'+this.model.get("sorting").type+'"]').first().prop("checked",true);if(this.model.get("sorting").ignore_last){$("#editLast").prop("checked",true)}}},_defaultSorting:{type:"random",ignore_last:0},_toggleSorting:function(){var e=$("#editRand").is(":checked"),t;this.$el.toggleClass("expand",e);if(this.model.isBanked()){return}if(e){t=this.model.previousAttributes().sorting||this._defaultSorting;this.model.set("sorting",t)}else{this.model.unset("sorting")}},_changeSortRatios:function(e){var t=this.model.get("sorting");if(this.model.isBanked()){return}t.type=$(e.target).val();this.model.set("sorting",t)},_changeEditLast:function(){var e=this.model.get("sorting"),t=$("#editLast").is(":checked");if(this.model.isBanked()){return}e.ignore_last=t?1:0;this.model.set("sorting",e)}});CREATE.views.EditorLayout=CREATE.views.EditorBase.extend({el:"#choiceLayout",events:{"change #editLay":"_toggleLayout","change [name=structureLayout]":"_changeStructure"},initialize:function(){this.render()},render:function(){var e=this.model.get("type").subtype,t=CREATE.survey.hasBrandRefreshTheme();if(!t){this.$el.removeClass("hide")}if(e!=="vertical"){$("#editLay").prop("checked",true);this.$el.addClass("expand");$("#choiceLayout").find('input[value="'+e+'"]').prop("checked",true)}},_defaultLayout:"vertical",_toggleLayout:function(){var e=this.model.get("type"),t=$("#editLay").is(":checked");this.$el.toggleClass("expand",t);if(this.model.isBanked()){return}if(t){e.subtype=this.model.previousAttributes().type.subtype||this._defaultLayout}else{e.subtype=this._defaultLayout}this.model.set("type",e)},_changeStructure:function(e){var t=this.model.get("type");if(this.model.isBanked()){return}t.subtype=$(e.target).val();this.model.set("type",t)}});CREATE.views.EditorLogic=CREATE.views.EditorBase.extend({el:"#questionLogicSettings",initialize:function(){var e=this;this.render();this.listenTo(this.model,"change:common_name",this.render);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},render:function(){this.$el.toggleClass("disabled",this.model.isMultiRowMatrix()&&!this.model.isStarRating());this.$el.closest("#editQuestion").toggleClass("survey-quiz",CREATE.survey.isSurveyQuizMode())},validate:function(){var e=true;if(this.model.isMultiRowMatrix()&&!this.model.isStarRating()){return true}_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},preRemove:function(e){_.each(this._subViews,function(t){if(t.preRemove){t.preRemove(e)}})},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorLogicRows:undefined,EditorAutoPageBreak:undefined}});CREATE.views.EditorAutoPageBreak=CREATE.views.EditorBase.extend({el:"#autoAddPageBreaks",events:{"change #logicBreak":"_toggleAutoPageBreak"},initialize:function(){this.render();this.listenTo(this.model,"change:logic change:common_name",this.render)},render:function(){var e=false,t=CREATE.pages.get(this.model.get("page_id")).get("position"),i=$("#editQuestion");i.find(".logicRow:not(.hide)").find(".selectPage").each(function(i,n){var a=parseInt($(n).attr("data-pid"),10);if(a>0){e=CREATE.pages.get(a).get("position")<=t;if(e){return false}}});i.toggleClass("questionLogicApplied",this.model.hasLogic());$("#samePageLogicWarning").toggleClass("isCircular",e);this.$el.toggleClass("hide",!e)},_toggleAutoPageBreak:function(e){var t=$(e.target).prop("checked"),i=!this.model.isLastQuestion()&&this.model.hasLogic()&&t;this.$el.toggleClass("expand",t);this.model.set("logic_page_break",i)}});CREATE.views.EditorLogicRows=CREATE.views.EditorBase.extend({el:"#logicRows",events:{"click .clearAllLogic a":"_clearAllLogic","click .addLogic":"_addLogicRow","click .deleteLogic":"_removeLogicRow"},initialize:function(e){var t=this;this.parent=e.parent;this.render();this.listenTo(this.model,"change:answer_options",this._handleAnswerChoicesChange);this.listenTo(this.model,"change:display_options",this._handleAnswerChoicesChange);$("#livePreview").on("previewUpdated.logic settingUpdated.logic",function(){if($("#questionLogicMasterToggle").is(":visible")){t.render()}});$("#editQuestion").on("t3visible",this.render.bind(this));this.setModified(false)},render:function(){var e=this,t=this.model.get("answer_options"),i=this.model.isNPS(),n=this.model.get("type").family==="matrix",a;if(i){a=this.model.getNPSLogic()}else{a=$.merge([],n?t.cols:t.rows);if(t.other&&t.other.visible&&t.other_type==="answer_option"){a.push(t.other)}}this._populatePageProps();_.each(this._logicRowViews,function(e){e.remove()});this._logicRowViews=[];_.each(a,function(t,i){e._logicRowViews.push(new CREATE.views.EditorLogicRow({model:e.model,parent:e,logicSource:t,index:i}))})},validate:function(){var e=true,t=[];$("#editQuestion").removeClass("logic-range-overlap");if(this.model.isNPS()&&this._isLogicModified){$.each(this._logicRowViews,function(i,n){var a=n.getLogic();if(a&&a.destination_page_id){if($.inArray(a.start,t)>-1||$.inArray(a.end,t)>-1){e=false;$("#editQuestion").addClass("logic-range-overlap");return false}t=t.concat(_.range(a.start,a.end+1))}})}return e},remove:function(){$("#livePreview").off(".logic");_.each(this._logicRowViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},preRemove:function(e){var t=CREATE.QuestionEditor.originalQuestionData.logic||[],i=this;if(e==="cancel"){_.each(t,function(e){e.question_id=parseInt(i.model.id,10);e.page_id=i.model.get("page_id");e.survey_id=parseInt(CREATE.survey.id,10)});CREATE.survey.updateQuestionLogic(this.model.id,t)}},getPageProps:function(){if(!this._pageProps){this._populatePageProps()}return this._pageProps},setModified:function(e){this._isLogicModified=e;$("#editQuestion").toggleClass("logicModified")},setLogicData:function(){var e=this.model.get("id"),t=[];if(this.model.isMultiRowMatrix()&&!this.model.isStarRating()){this.model.set("logic",t)}if(this._isLogicModified){_.each(this._logicRowViews,function(e){var i=e.getLogic();if(i){t.push(i)}});if(t.length>0||this.model.getLogic().length>0){if(this.model.isNPS()){t=this.model.expandNPSLogic(t)}}this.model.set("logic",t);CREATE.survey.updateQuestionLogic(e,t);if(this.$el.closest("#editQuestion").hasClass("survey-quiz")){SM.Logger.quizShowLogicWarning()}}},_logicRowViews:[],_isLogicModified:false,_pageProps:null,_MAX_TITLE_LENGTH:50,_handleAnswerChoicesChange:function(){this.render();this.setModified(true);this.setLogicData()},_addLogicRow:function(e){e.preventDefault();if(!this.$el.hasClass("disabled")){var t=$(e.target).closest("tbody").find("tr"),i=$(e.target).closest("tr"),n=i.next("tr"),a=Math.min(11,parseInt(i.find(".answerRangeTo").val(),10)+1),o=n.length?Math.max(a,n.find(".answerRangeFrom").val()-1):11,s={start:a,end:o},r=new CREATE.views.EditorLogicRow({model:this.model,parent:this,logicSource:s,prevRow:i}),l=t.index(i);this._logicRowViews.splice(l,0,r);this.$el.removeClass("singleLogicRow");this.setModified(true);this.setLogicData()}},_removeLogicRow:function(e){e.preventDefault();if(!this.$el.hasClass("disabled")){var t=$(e.target).closest("tbody").find("tr"),i=$(e.target).closest("tr"),n=t.index(i)-1;this._logicRowViews[n].remove();this._logicRowViews.splice(n,1);this.$el.toggleClass("singleLogicRow",this.$el.find(".logicRow").length<=2);this.setModified(true);this.setLogicData()}},_clearAllLogic:function(e){e.preventDefault();if(!this.$el.hasClass("disabled")){if(!this._checkForUpgrade()){_.each(this._logicRowViews,function(t){t.clearLogic(e)})}}},_checkForUpgrade:function(){if(!CREATE.user.hasFeature("question_skip_logic")){__UPGRADE.openUpgradeModal("upgradeQuestionLogic");return true}return false},_populatePageProps:function(){var e=[],t=false;CREATE.pages.each(function(i,n){var a,o=false,s=i.isRandomized(),r=CREATE.survey.getBlockForPage(i.id),l;if(s){l=CREATE.Translations.get("randomized","default")["default"]}if(r){l=CREATE.Translations.get("in_block","default")["default"]}if(l){a=CREATE.utils.getPageHeader(i,n+1,": ["+l+"]");o=true}else{a=CREATE.utils.getPageHeader(i,n+1)}if(!t){t=s||i.get("question_randomization").enabled}e.push({text:CREATE.utils.htmlEncode(a),action:i.id,isDisabled:o})});e.push({text:CREATE.Translations.get("end_of_survey","default")["default"],action:-3});e.push({text:CREATE.Translations.get("disqualification_page","default")["default"],action:-1});this._pageProps={actions:e,isRandomized:t}}});CREATE.views.EditorLogicRow=CREATE.views.EditorBase.extend({events:{"click .clearLogic":"clearLogic","change .answerRange select":"_onAnswerRangeChange"},initialize:function(e){this.parent=e.parent;this.logicSource=e.logicSource;this.index=e.index+1;this.prevRow=e.prevRow;this.listenTo(this.model,"change:common_name",this._onCommonNameChange);this.render()},render:function(){var e=$("#editQuestion").find(".logicRow").first().clone(),t=this.model.isNPS(),i=this.model.get("type").family==="matrix",n=this.model.isStarRating(),a=this.model.isMultiRowMatrix()&&!n,o=i?"Column ":"Choice ",s,r,l,d;if(t){d=this.logicSource.logic;e.find(".answerRangeFrom").val(this.logicSource.start);e.find(".answerRangeTo").val(this.logicSource.end)}else{d=this.logicSource.id?this.model.getLogicForAnswerId(this.logicSource.id):null;if(n){r=this.model.get("display_options").display_subtype;s=$("#emoji-plural").find(".plural-"+r).clone();l=this.logicSource.text||$(s[this.index-1]).html();e.attr("id","logic-"+this.logicSource.id).find(".answerValue").html(l)}else{e.attr("id","logic-"+this.logicSource.id).find(".answerValue").html(this.logicSource.text||o+this.index)}}if(this.prevRow){e.removeClass("hide").insertAfter(this.prevRow)}else{e.removeClass("hide").insertAfter($("#editQuestion .logicRow").last())}e.toggleClass("disabled",!t&&!this.logicSource.id||a).find(".faux_dropdown").toggleClass("disabled",!t&&!this.logicSource.id||a);if(!this._hasMarkup){this.setElement(e);this._hasMarkup=true}this._setupLogicSelector(d)},getLogic:function(){var e=this.$el,t=parseInt(e.find(".selectPage:not(.disabled)").attr("data-pid"),10),i,n=this.model.get("id"),a=this.model.get("page_id"),o=null;if(t){i=parseInt(e.find(".selectQuestion").attr("data-qid"),10)||0;if(this.model.isNPS()){o={start:parseInt(e.find(".answerRangeFrom").val(),10),end:parseInt(e.find(".answerRangeTo").val(),10),destination_page_id:t,destination_question_id:i}}else{o={question_id:parseInt(n,10),page_id:a,answer_id:parseInt(e.attr("id").replace("logic-",""),10),destination_page_id:t,destination_question_id:i}}}return o},clearLogic:function(e){var t=this.$el,i=t.find(".selectPage"),n=i.data("actionMenu");e.preventDefault();if(this.$el.hasClass("disabled")){return}if(n){n.set("selectedAction",null)}this._setPageAndQuestion(0,0)},_MAX_TITLE_LENGTH:50,_hasMarkup:false,
_onCommonNameChange:function(){var e=this.model.isMultiRowMatrix()&&!this.model.isStarRating();this.$el.toggleClass("disabled",e).find(".faux_dropdown").toggleClass("disabled",e)},_onAnswerRangeChange:function(){if(!this._checkForUpgrade()){this.parent.setModified(true);this.parent.setLogicData()}},_onSelectPage:function(e){var t,i;if(!this._checkForUpgrade()){t=e.actionMenu;i=parseInt(t.get("menuView").get("selectedAction"),10);this._setPageAndQuestion(i,0);this.parent.setModified(true);this.parent.setLogicData()}},_onSelectQuestion:function(e){var t=e.actionMenu,i=parseInt(t.get("menuView").get("selectedAction"),10),n=e.$action.text();t.$el.closest("a").attr("data-qid",i).html(n).removeClass("disabled").attr("title",n);this.parent.setModified(true);this.parent.setLogicData()},_populateQuestions:function(e){var t=this,i=e.actionMenu,n=i.$el.closest("a"),a=n.closest("tr").find(".selectPage"),o=parseInt(a.attr("data-pid"),10),s=CREATE.pages.get(o),r=parseInt(n.attr("data-qid"),10)||0;i.set("actions",[{text:CREATE.Translations.get("loading","default")["default"]}]);s.getQuestions().done(function(e){var n=[{text:CREATE.Translations.get("top_of_page","default")["default"],action:0}];e.each(function(e){var i,a=e.isRandomized();i=e.getHeading({truncate:t._MAX_TITLE_LENGTH});if(a){i=">["+CREATE.Translations.get("randomized","default")["default"]+"] "+i}else{i=e.getDisplayNumber()+i}n.push({text:i,action:e.id,isDisabled:a})});i.set("actions",n).set("selectedAction",r)})},_checkForUpgrade:function(){if(!CREATE.user.hasFeature("question_skip_logic")){__UPGRADE.openUpgradeModal("upgradeQuestionLogic");return true}return false},_setupLogicSelector:function(e){var t=this,i=this.$el.find(".selectPage"),n=this.$el.find(".selectQuestion"),a=e?e.destination_page_id:"";i.actionMenu({actions:this.parent.getPageProps().actions,selectedAction:a,saveState:true}).on("actionMenu.afterOpen",function(e){e.actionMenu.get("menuView").$el.addClass("long")}).on("actionMenu.actionSelected",t._onSelectPage.bind(t));this.$el.find(".selectQuestion").addClass("disabled").actionMenu({actions:[{text:CREATE.Translations.get("loading","default")["default"]}],saveState:true}).on("actionMenu.afterOpen",function(e){e.actionMenu.get("menuView").$el.addClass("long")}).on("actionMenu.beforeOpen",t._populateQuestions.bind(t)).on("actionMenu.actionSelected",t._onSelectQuestion.bind(t));if(e){this._setPageAndQuestion(a,e.destination_question_id)}i.on("click",function(){SM.Logger.enqueue({action_type:"click_question_logic_select_page",ui_trigger:"questionLogicPageSelect"})});n.on("click",function(){SM.Logger.enqueue({action_type:"click_question_logic_select_question",ui_trigger:"questionLogicQuestionSelect"})})},_setPageAndQuestion:function(e,t){var i=this;this.$el.find(".selectPage").html(this._getPageHeading(e)).attr("data-pid",e);if(e<=0){this.$el.find(".selectQuestion").removeAttr("data-qid").html("&nbsp;").addClass("disabled")}else{this._getQuestionHeading(t).done(function(e){var n=i.$el.find(".selectPage"),a=i.$el.find(".selectQuestion"),o=e.length>i._MAX_TITLE_LENGTH?e.substring(0,i._MAX_TITLE_LENGTH)+"...":e;a.attr("data-qid",t).html(o).attr("title",e);a.toggleClass("disabled",n.hasClass("disabled"))})}},_getPageHeading:function(e){var t=null,i=this.parent.getPageProps();if(!i){return null}if(e===0){return CREATE.Translations.get("choose_page","default")["default"]}_.each(i.actions,function(i){if(parseInt(e,10)===parseInt(i.action,10)){t=i.text;return false}});return t},_getQuestionHeading:function(e){var t=$.Deferred();if(e===0){return t.resolve(CREATE.Translations.get("top_of_page","default")["default"])}else{return CREATE.pages.getQuestion(e,true).then(function(e){var t=e.getDisplayNumber()+CREATE.utils.stripTags(e.get("heading"));return t})}}});CREATE.views.EditorRandomAssignment=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"change #editRandomAssignment":"_renderTable"},initialize:function(){var e=this;$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},getDefaultRA:function(e){var t={heading:"",image:{question_id:null,s3_key:null,type:"new",url:"",visible:true},percent:50,variable_name:""};if(e){t.heading=e}return t},_subViews:{EditorRandomAssignmentTable:undefined,EditorRandomAssignmentToggle:undefined},_renderTable:function(){this._subViews.EditorRandomAssignmentTable.render()}});CREATE.views.EditorRandomAssignmentTable=CREATE.views.EditorBase.extend({el:"#editQuestion .randomAssignTable",events:{"choiceAdded tbody":"_addVariation","choiceRemoved tbody":"_removeVariation","rteBlurred [data-var=text]":"_setVarHeading","blur [data-var=percent]":"_setVarPercent","blur [data-var=label]":"_setNickname"},initialize:function(e){var t=this.model;this.parent=e.parent;this.listenTo(this.model,"change:has_responses",this._handleHasResponses);this.listenTo(this.model,"change:random_assignment",function(){this.$el.toggleClass("hide",!this.model.hasRandomAssignment())});this._choicesTable=new CREATE.ChoicesTable(this.$el.find("tbody"),{minChoices:2,maxChoices:20,listType:"letter",questionType:this.model.get("type")});if(t.get("common_name")==="image"){this.$el.data("mode","Image")}else if(t.get("common_name")==="text"){this.$el.data("mode","Text")}else{this.$el.data("mode","Question")}this.render()},validate:function(){var e=true,t=this.$el.data("mode"),i="tr:not([data-template]) .choicePercent [data-validation]",n=this.$el.find(".variation:not([data-template]) .varPercent"),a=n.closest(".choicePercent");if(this.model.isBanked()||!$("#editRandomAssignment").is(":checked")){return true}if(t==="Text"){i+=", tr:not([data-template]) .choiceText :not(.questionABContainer) [data-validation]"}else if(t==="Question"){i+=", tr:not([data-template]) .choiceText .questionABContainer [data-validation]"}e=CREATE.Validator.validate(this.$el.find(i),"td");a.find(".not100").removeClass("show");if(this._totalPercents(n)!==100){e=false;a.addClass("error percentError").last().children(".not100").addClass("show")}else{a.removeClass("percentError").last().children(".not100").removeClass("show");if(e){a.removeClass("error")}}return e},render:function(){var e=[],t=this.model,i=CREATE.user.hasFeature("random_assignment");this.$el.find(".questionPos").html(this.model.get("display_number"));if(this.model.hasRandomAssignment()&&i){$.each(t.get("random_assignment"),function(i,n){var a=n.heading_id||("newVar"+Math.random()).replace("0.",""),o={text:n.heading,el_id:a,var_type:t.get("type").subtype,percent:n.percent,answer_id:null,position:i+1,question_id:t.id,type:"row",visible:true,label:n.variable_name};if(n.image){o.el_id="var"+n.image.answer_id}e.push(o)});this._choicesTable.load(e)}else{this.$el.addClass("hide")}this._handleHasResponses()},_choicesTable:undefined,_handleHasResponses:function(){if(this.model.hasResponses()){this._disableVariations()}},_addVariation:function(e,t){var i=this.model.get("random_assignment").slice();i.splice(t.index,0,this.parent.getDefaultRA());this._setAllPercents(i,e.type);this.model.set("random_assignment",i)},_removeVariation:function(e,t){var i=this.model.get("random_assignment").slice();i.splice(t.index,1);this._setAllPercents(i,e.type);this.model.set("random_assignment",i)},_percentsEqual:function(e,t){var i=null,n=true,a,o,s,r=this;e.each(function(l,d){var u=parseFloat($(d).val());if(l===0){i=u;return}else{if(isNaN(u)){return}a=t==="choiceRemoved"?e.length+1:e.length;o=r._calculateSplitRemainder(a);s=(i*1e3-o.remainder*1e3)/1e3;if(u!==i&&u!==s){n=false;return false}}});return n},_totalPercents:function(e){var t=0;e.each(function(){var e=parseFloat($(this).val());if(!isNaN(e)){t+=e*1e3}});return t/1e3},_calculateSplitRemainder:function(e){var t=Math.round(100/e*100)/100,i=Math.round((100-t*e)*100)/100;return{split:t,remainder:i}},_setAllPercents:function(e,t){var i=this.$el.find(".variation:not([data-template])"),n=i.length,a=new Array(n),o=i.find(".varPercent"),s=this._percentsEqual(o.filter(function(){return this.value!==""}),t),r,l,d;if(!s){r=this._totalPercents(o);l=r>100?0:100-r;$.each(a,function(e){var t=parseFloat(o[e].value);if(!isNaN(t)){a[e]=t}else{a[e]=l}})}else{d=this._calculateSplitRemainder(n);$.each(a,function(e){if(e===0){a[e]=parseFloat((d.split+d.remainder).toFixed(2))}else{a[e]=d.split}})}o.each(function(t,i){var n=a[t];$(i).val(n);e[t].percent=n})},_setNickname:function(e){var t=$(e.target),i=CREATE.utils.stripTags(t.val()),n=this.$el.find(".variation:not([data-template])").find(".variationLabel"),a=n.index(t),o=this.model.get("random_assignment").slice();o[a].variable_name=i;this.model.set("random_assignment",o)},_setVarHeading:function(e){var t=$(e.target),i=this.$el.data("mode"),n=this.$el.find(".variation:not([data-template])").find(".var"+i),a=n.index(t),o=this.model.get("random_assignment").slice(),s=CREATE.Rte.getContentForSave(t.attr("id"));o[a].heading=s;if(a===0&&s.length&&i!=="Image"){this.model.set("heading",s);CREATE.Rte.setContent("editTitle",s)}this.model.set("random_assignment",o)},_setVarPercent:function(e){var t=$(e.target),i=this.$el.find(".variation:not([data-template])").find(".varPercent"),n=i.index(t),a=this.model.get("random_assignment").slice();a[n].percent=parseFloat(t.val());this.model.set("random_assignment",a)},_disableVariations:function(){var e=this.$el.find(".choice:not([data-template])");e.find(":not(.abVariationLabel, .abVariationLabel *, #pipingHolder, #pipingHolder *, .choiceText), button").addClass("disabled");e.find("input:not(.variationLabel), button").prop("disabled",true);e.find(".rte").each(function(e,t){CREATE.Rte.toggle($(t),false,false)})}});CREATE.views.EditorRandomAssignmentToggle=CREATE.views.EditorBase.extend({el:"#randomAssignmentSetting",events:{"change #editRandomAssignment":"_toggleRandomAssignment",click:"_triggerUpgrade",'click [data-action="edit"]':"_switchToEditTab"},initialize:function(e){this.parent=e.parent;this.render();this._handleHasResponses();this.listenTo(this.model,"change:has_responses",this._handleHasResponses)},render:function(){var e=this.model,t=e.hasRandomAssignment();if(e.isBanked()||e.isMenuMatrix()||e.isPresentation()||e.isFileUpload()){this.$el.hide()}else{this.$el.toggleClass("expand",t)}$("#editRandomAssignment").prop("checked",t)},_toggleRandomAssignment:function(){var e=$("#editRandomAssignment"),t=e.is(":checked"),i=this.model.previousAttributes().random_assignment;if(e.hasClass("disabled")){return}this.$el.toggleClass("expand",t);if(t){i=i.length?i:[this.parent.getDefaultRA(this.model.get("heading")),this.parent.getDefaultRA()];this.model.set("random_assignment",i)}else{this.model.set("random_assignment",[])}},_triggerUpgrade:function(e){var t=$(e.target),i=this.$el.data("feature"),n=__UPGRADE.getUpgradeUrl(i,"question_editor");if(CREATE.user.hasFeature("random_assignment")){return}e.preventDefault();e.stopPropagation();if(t.data("type")==="direct-link"){window.location=n}else{__UPGRADE.openUpgradeModal(i)}},_switchToEditTab:function(e){e.preventDefault();e.stopPropagation();$('[data-tab="edit"] [data-type="tab"]').click()},_handleHasResponses:function(){if(this.model.hasResponses()){$("#editRandomAssignment").addClass("disabled").prop("disabled",true).closest("label").addClass("disabled")}}});CREATE.views.EditorPlacement=CREATE.views.EditorBase.extend({el:"#layoutSettings",events:{"change #toggleQuestionLayout":"_toggleQuestionLayout"},layoutChecked:false,initialize:function(){var e=this,t,i=this.model.get("layout");this.layoutChecked=!$.isEmptyObject(i);this.render();this.listenTo(this.model,"change:layout",this.render);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})});if(this.layoutChecked){t=$.extend({},this._getDefaultLayoutValue(),i);this.model.set("layout",t,{silent:true})}},render:function(){var e=CREATE.survey.hasBrandRefreshTheme();$("#toggleQuestionLayout").prop("checked",this.layoutChecked);this.$el.toggleClass("expand",this.layoutChecked);this.$el.toggleClass("disabled",e);if(e){this.$el.attr("disabled","disabled")}else{this.$el.removeAttr("disabled")}},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorQuestionPlacement:undefined,EditorQuestionWidth:undefined,EditorLabelWidth:undefined,EditorTextboxWidth:undefined,EditorQuestionSpacing:undefined},_toggleQuestionLayout:function(e){var t=$(e.target),i;this.layoutChecked=t.prop("checked");if(this.layoutChecked){i=this._getDefaultLayoutValue();this.model.set("layout",i)}else{this.model.unset("layout")}},_getDefaultLayoutValue:function(){var e={},t=this._subViews;_.each(t,function(t){if(!t.isHidden||t.isRequired&&t.isRequired()){$.extend(e,t.defaultValues)}});if(this.model.isNPS()){$.extend(e,t.EditorQuestionWidth.defaultValues,t.EditorLabelWidth.defaultValues)}return e}});CREATE.views.EditorQuestionPlacement=CREATE.views.EditorBase.extend({el:"#questionPlacementSettings",events:{"change #editPosition":"_updatePosition"},initialize:function(e){this.parent=e.parent;this._handleVisibility();this.render();this.listenTo(this.model,"change:common_name",this._toggleView)},render:function(){var e=this.model,t=$.extend({},this.defaultValues,e.get("layout"));$("#editPosition").val(t.position)},defaultValues:{position:"new_row"},isHidden:false,_updatePosition:function(){var e=this.model,t=$.extend({},e.get("layout"));t.position=$("#editPosition").val();e.set("layout",t)},_toggleView:function(){var e=this.model,t=$.extend({},e.get("layout"));this._handleVisibility();if(!this.parent.layoutChecked){t=null}else{t=$.extend({},this.defaultValues,t)}e.set("layout",t)},_handleVisibility:function(){var e=this.model,t=e.isMenuMatrix()||e.isRanking();this.$el.toggleClass("hide",t);this.isHidden=t}});CREATE.views.EditorQuestionWidth=CREATE.views.EditorBase.extend({el:"#questionWidthSettings",events:{"change #widthFormat":"_updateWidthFormat","change #percentWidth, #fixedWidth":"_updateWidth"},initialize:function(e){this.parent=e.parent;this._handleVisibility();this.render();this.listenTo(this.model,"change:type",this._toggleView);this.listenTo(this.model,"change:layout",this.render)},render:function(){var e=this.model,t=$.extend({},this.defaultValues,e.get("layout")),i,n,a;if(!this.isHidden){i=t.width_format;n=$("#percentWidth");a=$("#fixedWidth");$("#widthFormat").val(i);if(i==="percent_width"){n.removeClass("hide").val(t.width);a.addClass("hide")}else{a.removeClass("hide").val(t.width);n.addClass("hide")}}},isRequired:function(){return this.model.get("type").family==="open_ended"},defaultValues:{width_format:"percent_width",width:100},isHidden:false,_defaultFixedWidth:600,_updateWidthFormat:function(e){var t=this.model,i=$.extend({},t.get("layout")),n=$(e.target);i.width_format=n.val();if(i.width_format===this.defaultValues.width_format){i.width=this.defaultValues.width}else{i.width=this._defaultFixedWidth}t.set("layout",i)},_updateWidth:function(e){var t=this.model,i=$.extend({},t.get("layout")),n=$(e.target);i.width=parseInt(n.val(),10);t.set("layout",i)},_toggleView:function(){var e=this.model,t=$.extend({},e.get("layout"));this._handleVisibility();if(!this.parent.layoutChecked){t=null}else if(this.isHidden&&!this.isRequired()){$.each(this.defaultValues,function(e){delete t[e]});if($.isEmptyObject(t)){t=null}}else{t=$.extend({},this.defaultValues,t)}e.set("layout",t)},_handleVisibility:function(){var e=this.model,t=e.get("type"),i=e.isNPS()||t.subtype!=="multi"&&t.family==="open_ended"&&!e.isFileUpload()||t.family==="presentation"&&t.subtype==="image";this.$el.toggleClass("hide",i);this.isHidden=i}});CREATE.views.EditorLabelWidth=CREATE.views.EditorBase.extend({el:"#labelWidthSettings",events:{"change #editLabelSize":"_updateLabelSize"},initialize:function(e){this.parent=e.parent;this._handleVisibility();this.render();this.listenTo(this.model,"change:common_name",this._toggleView)},render:function(){var e=this.model,t=$.extend({},this.defaultValues,e.get("layout"));if(!this.isHidden){$("#editLabelSize").val(t.label_size)}},defaultValues:{label_size:20},isHidden:false,_updateLabelSize:function(e){var t=this.model,i=$.extend({},t.get("layout")),n=$(e.target);i.label_size=parseInt(n.val(),10);t.set("layout",i)},_toggleView:function(){var e=this.model,t=$.extend({},e.get("layout"));this._handleVisibility();if(!this.parent.layoutChecked){t=null}else if(this.isHidden){$.each(this.defaultValues,function(e){delete t[e]})}else{t=$.extend({},this.defaultValues,t)}e.set("layout",t)},_handleVisibility:function(){var e=this.model,t=e.get("type"),i=!this.model.isNPS()&&!this.model.isStarRating()&&(t.family==="matrix"||t.family==="open_ended"&&t.subtype!=="single"&&t.subtype!=="essay"&&!e.isFileUpload()||t.family==="demographic"||t.family==="datetime");this.$el.toggleClass("hide",!i);this.isHidden=!i}});CREATE.views.EditorTextboxWidth=CREATE.views.EditorBase.extend({el:"#textboxWidthSettings",events:{"change #editBoxLines":"_updateBoxLines","change #editMaxChars":"_updateMaxChars"},initialize:function(e){this.parent=e.parent;this._handleVisibility();this.render();this.listenTo(this.model,"change:type",this._toggleView)},render:function(){var e=this.model,t=$.extend({},this.defaultValues,e.get("layout"));if(!this.isHidden){$("#editMaxChars").val(t.max_chars);if(!this._isBoxLinesHidden){$("#editBoxLines").val(t.num_lines)}}},defaultValues:{num_lines:3,max_chars:50},isHidden:false,_isBoxLinesHidden:false,_updateBoxLines:function(e){var t=this.model,i=$.extend({},t.get("layout")),n=$(e.target);i.num_lines=parseInt(n.val(),10);t.set("layout",i)},_updateMaxChars:function(e){var t=this.model,i=$.extend({},t.get("layout")),n=$(e.target);i.max_chars=parseInt(n.val(),10);t.set("layout",i)},_toggleView:function(){var e=this.model,t=$.extend({},e.get("layout"));this._handleVisibility();if(!this.parent.layoutChecked){t=null}else if(this.isHidden){$.each(this.defaultValues,function(e){delete t[e]});if($.isEmptyObject(t)){t=null}}else{if(this._isBoxLinesHidden){t.max_chars=this.defaultValues.max_chars}else{t=$.extend({},this.defaultValues,t)}}e.set("layout",t)},_handleVisibility:function(){var e=this.model.get("type"),t=e.family!=="open_ended"||this.model.isFileUpload(),i=e.subtype==="essay";this.$el.toggleClass("hide",t);this.isHidden=t;$("#editBoxLines").toggleClass("hide",!i);this._isBoxLinesHidden=!i}});CREATE.views.EditorQuestionSpacing=CREATE.views.EditorBase.extend({el:"#questionSpacingSettings",events:{"blur #spaceTop":"_updateSpaceTop","blur #spaceRight":"_updateSpaceRight","blur #spaceBottom":"_updateSpaceBottom","blur #spaceLeft":"_updateSpaceLeft"},initialize:function(e){this.parent=e.parent;this.render()},render:function(){var e=this.model,t=$.extend({},this.defaultValues,e.get("layout"));$("#spaceTop").val(t.top_spacing);$("#spaceRight").val(t.right_spacing);$("#spaceBottom").val(t.bottom_spacing);$("#spaceLeft").val(t.left_spacing)},validate:function(e){var t=true,i=true;if(!this.isHidden){this.$el.find('[data-setting="spacing"]').each(function(n,a){var o=$(a),s=parseInt(o.val(),10),r=!isNaN(s)&&s>=0;o.parent().toggleClass("error",!r);t=t&&r;if(e&&o.attr("id")===e.attr("id")){i=r}});this.$el.find(".err").toggle(!t)}if(e){return i}return t},defaultValues:{top_spacing:0,right_spacing:0,bottom_spacing:0,left_spacing:0},isHidden:false,_updateSpaceTop:function(e){this._updateSpace($(e.target),"top_spacing")},_updateSpaceRight:function(e){this._updateSpace($(e.target),"right_spacing")},_updateSpaceBottom:function(e){this._updateSpace($(e.target),"bottom_spacing")},_updateSpaceLeft:function(e){this._updateSpace($(e.target),"left_spacing")},_updateSpace:function(e,t){var i=this.model,n=$.extend({},i.get("layout"));if(this.validate(e)){n[t]=parseInt(e.val(),10);i.set("layout",n)}}});CREATE.views.EditorValidation=CREATE.views.EditorBase.extend({el:"#textValidate",events:{"change #editValidation":"_toggleValidation","change #validateFormat":"_toggleValidationType","blur #validateMin":"_handleValidationRangeChange","blur #validateMax":"_handleValidationRangeChange","blur #validateText":"_saveChanges"},initialize:function(){this._defaults=this.getDefaultValidationSettings();this.render()},preSave:function(){this._saveChanges()},render:function(){var e=$("#editValidation"),t=$("#validateFormat"),i,n=this.model.get("validation");if(this.model.isNumerical()){return}if(n){e.prop("checked",true);t.val(n.type);i=this._defaults[n.type];if(n.min!==undefined&&n.min!==""){$("#validateMin").val(n.min)}else if(i!==null){$("validateMin").val(i.formatter(i.min))}if(n.max!==undefined&&n.max!==""){$("#validateMax").val(n.max)}else if(i!==null){$("#validateMax").val(i.formatter(i.max))}if(n.text){$("#validateText").val(n.text);$("#editDateError").val(n.text)}t.parent().attr("class",$("option:selected",t).attr("class"))}else{i=this._defaults.text_length;$("#validateFormat").val("text_length");$("#validateMin").val(i.formatter(i.min));$("#validateMax").val(i.formatter(i.max))}this.$el.toggleClass("expand",e.prop("checked"))},_defaults:null,_toggleValidation:function(e){if(!$(e.target).is(":checked")&&!this.model.isSlider()){this.model.set("validation",null)}else{this._saveChanges()}this.render()},_toggleValidationType:function(e){var t=$(e.target),i=this._defaults[t.val()];t.parent().attr("class",$("option:selected",t).attr("class"));$("#validateMin").val(i.formatter(i.min));$("#validateMax").val(i.formatter(i.max));this._saveChanges()},_handleValidationRangeChange:function(e){var t=$(e.target).data("id");if(t==="validateMax"){this._resetValidationRange(false)}else if(t==="validateMin"){this._resetValidationRange(true)}else{return}},_resetValidationRange:function(e){var t=$("#validateFormat").val(),i=this._defaults[t],n=i.parser($("#validateMin").val()),a=i.parser($("#validateMax").val()),o=null;switch(t){case"text_length":if(e){o=Math.max(0,Math.min(isNaN(n)?i.min:n,a))}else{o=Math.max(isNaN(a)?i.max:a,n)}break;case"integer":case"decimal":o=this._assignNumberValue(n,a,i,e);break;case"date_us":case"date_intl":o=this._assignDateValue(n,a,i,e);break;default:break}if(o!==null){if(e){$("#validateMin").val(i.formatter(o))}else{$("#validateMax").val(i.formatter(o))}}this._saveChanges()},_assignNumberValue:function(e,t,i,n){if(n){return Math.min(isNaN(e)?i.min:e,t)}else{return Math.max(isNaN(t)?i.max:t,e)}},_assignDateValue:function(e,t,i,n){if(n){if(!e){e=i.min}return e.getTime()<=t.getTime()?e:t}else{if(!t){t=i.max}return e.getTime()<=t.getTime()?t:e}},_validate:function(){var e=true;if($("#editNumerical").is(":checked")){e=CREATE.Validator.validate($("#editNumError"),".block")}else if($("#editValidation").is(":checked")){e=CREATE.Validator.validate($("#validateText"),".block")}return e},_saveChanges:function(){var e;if(this.model.isNumerical()){return}else if($("#editValidation").is(":checked")){e={type:$("#validateFormat").val(),min:$("#validateMin").val(),max:$("#validateMax").val(),text:$.trim($("#validateText").val())}}this.model.set("validation",e)}});CREATE.views.EditorToggleDateTime=CREATE.views.EditorBase.extend({el:"#editQuestion .question-datetime .dateTable",events:{"change #toggleDateVisible,#toggleTimeVisible":"_changeDatetimeDisplay","change input[name=dateformat]":"_changeDateFormat"},initialize:function(){this.render()},render:function(){var e=this.model.get("type").subtype,t=this.model.get("validation").type;$("#toggleDateVisible").prop("checked",e==="both"||e==="date_only");$("#toggleTimeVisible").prop("checked",e==="both"||e==="time_only");this.$el.find("input[name=dateformat][value="+t+"]").prop("checked",true);$("#dateFormat").toggleClass("hide",e==="time_only")},_changeDatetimeDisplay:function(){var e="both",t=this.model.get("type");if($("#toggleDateVisible").not(":checked").length>0){e="time_only"}if($("#toggleTimeVisible").not(":checked").length>0){e="date_only"}t.subtype=e;this.model.set("type",t);this.render()},_changeDateFormat:function(){var e=this.$el.find("input[name=dateformat]"),t=_.find(e,function(e){if($(e).is(":checked")){return true}}),i=$(t).val(),n=$.extend({},this.model.get("validation"));n.type=i;this.model.set("validation",n)}});CREATE.views.EditorDateTimeError=CREATE.views.EditorBase.extend({el:"#dateTimeError",events:{"blur #editDateError":"_changeErrorMessage"},initialize:function(){this.render();this._changeErrorMessage()},render:function(){var e=this.model.get("validation").text;if(e){$("#editDateError").val(e)}},validate:function(){var e=$("#editDateError"),t=CREATE.utils.stripTags(e.val()),i=t.length!==0;e.closest(".block").toggleClass("error",!i);return i},_changeErrorMessage:function(){var e=$.extend({},this.model.get("validation"));e.text=CREATE.utils.stripTags($("#editDateError").val());this.model.set("validation",e)}});CREATE.views.EditorFunneling=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"change #funnelSwitch":"_toggleFunneling","click #funnelingSetting":"_checkMaxChoices","click #funnelingSetting.upgrade":"_handleUpgrade",choiceRemoved:"_handleChoiceRemoved",choicesRemoved:"_handleChoiceRemoved","overMaxChoices .choicesTable":"_handleOverMaxChoices","underMaxChoices .choicesTable":"_handleUnderMaxChoices"},initialize:function(){var e=this,t=this.model.isFunnelReceiver();this._removedSenders=[];this.$el.find(".funnelSettingsContainer .maxNum").text(this.model.getMaxRows());this._defaultText=this.$el.find("a.senderQuestionMenu").html();this._previousValue=[{condition:{type:"selected"},funnel_to:"rows",sender_question_id:null}];if(t){this._removedSenders.push(this.model.get("funneling")[0].sender_question_id)}this._setupQuestionSelector();this._loadSenderPages();this.$el.toggleClass("funnel-receiver",t);this.render();SM.Tooltips.enable({selector:"#funnelSwitchContainer.disabled[sm-tooltip-side]",delay:500});this.listenTo(this.model,"change:funneling",this.render);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.listenTo(this.model,"change:has_responses change:logic",this._handleLimitedEditState);$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})});this._handleLimitedEditState();$("#livePreview").on("previewUpdated.funnel settingUpdated.funnel",this._loadSenderPages.bind(this));$("#livePreview").on("questionDeleted.funnel",this._handleQuestionDelete.bind(this))},render:function(){var e=this,t=$("#funnelMenuContainer"),i=$("#funnelSwitch"),n=$("funnelSwitchContainer"),a=this.model.isFunnelReceiver()?this.model.get("funneling")[0]:null;this._toggleLoadingSpinner(t);if(i.closest(".choicesTable").hasClass("maxChoices")){n.addClass("maxChoices");i.prop("disabled",true).prop("checked",false)}if(a&&a.sender_question_id){CREATE.pages.getQuestion(a.sender_question_id,true).done(function(n){i.prop("checked",true);e._previousValue=e.model.get("funneling");e._showSelectedSender(t,n,a);if(!e._doFunneledAnswersMatchSender(n)){e._removeFunneledAnswers(t);if(n){e._addFunneledAnswers(t,n)}}})}else{this._removeFunneledAnswers(t,true)}this._updateFunnelingEnabledState()},validate:function(){var e=true,t,i=this.model,n=$("#funnelSwitch");if(i.isBanked()||!CREATE.user.hasFeature("funneling")||!i.isFunnelReceiver()){return true}if(i.isFunnelReceiver()&&!i.get("funneling")[0].sender_question_id){n.prop("checked",false);this._toggleFunneling({target:n});return true}t=$("#funnelMenuContainer");if(i.isFunnelReceiver()&&i.get("funneling")[0].condition.type!=="matrix_set"&&i.get("funneling")[0].condition.matrix_set){delete i.get("funneling")[0].condition.matrix_set}if(t.find(".senderQuestionMenuContainer").hasClass("error")){return false}$("#funnelMenuContainer").find(".error").removeClass("error");_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},remove:function(){$("#livePreview").off(".funnel");_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},_subViews:{EditorFunnelingAnswerType:undefined,EditorFunnelingColFilter:undefined},_MAX_TITLE_LENGTH:50,_senderPages:[],_numSenderQs:0,_removedSenders:[],_actionMenuDropDowns:[],_toggleFunneling:function(e){var t=$(e.target),i=$("#funnelMenuContainer"),n=$("#funnelSwitchContainer"),a=t.prop("checked"),o=false;if(a&&t.closest(".choicesTable").hasClass("maxChoices")){n.addClass("maxChoices");t.prop("disabled",true).prop("checked",false);i.find(".senderQuestionMenu").removeAttr("data-sender-question-id");this.model.set("funneling",[]);return}if(a&&!this._hasNoSenderQuestions()){this.model.set("funneling",this._previousValue)}else{this._removeFunneledAnswers(i,true);if(_.isEmpty(this.model.get("funneling"))){o=true}i.find(".senderQuestionMenu").removeAttr("data-sender-question-id");this.model.set("funneling",[]);if(this._removedSenders.length>0){CREATE.utils.getQuestionElForId(this.model.id).data("removedSenders",this._removedSenders)}if(o){this.render()}}this.$el.toggleClass("funnel-receiver",this.model.hasReceiverId())},_checkMaxChoices:function(){var e=$("#funnelSwitchContainer");if(e.hasClass("maxChoices")){e.addClass("error")}},_handleUpgrade:function(e){e.preventDefault();e.stopPropagation();var t=$(e.target),i=t.closest(".upgrade").data("feature"),n=__UPGRADE.getUpgradeUrl(i,"funneling");if(t.data("type")==="direct-link"){window.location=n}else{__UPGRADE.openUpgradeModal(i)}},_handleLimitedEditState:function(){var e=this.model.inQuota()||this.model.hasLogic()||this.model.hasResponses()||this._hasNoSenderQuestions(),t=$("#editQuestion");$("#funnelSwitch").prop("disabled",e);t.find(".senderQuestionMenu").toggleClass("disabled",e);t.find("[name=funnelAnswerType]").prop("disabled",e);t.find("[name=funnelColFilter]").prop("disabled",e);t.find(".funnelSettingsContainer").toggleClass("disabled",e)},_handleChoiceRemoved:function(){var e=this,t=$("#funnelMenuContainer"),i=t.find(".senderQuestionMenuContainer"),n=i.find(".senderQuestionMenu"),a=n.attr("data-sender-question-id"),o=n.actionMenu().data("actionMenu"),s=$("#funnelSwitch"),r=s.prop("checked")&&a&&!o.isOpen();if(i.hasClass("error")&&r){i.removeClass("error");CREATE.pages.getQuestion(a,true).done(function(i){e._addFunneledAnswers(t,i)})}},_showRemoveFunnelConfirm:function(){var e=this,t=SM.Views.create(SM.ConfirmDialogView,{isModal:true,width:500,templateID:"remove-funnel-matrix-dialog-template"});t.$el.on("confirmDialog.confirm",function(){e._previousValue=e.model.get("funneling");e.model.set("funneling",[]);e._updateFunnelingEnabledState();t.close()}).on("confirmDialog.cancel",function(){var i="matrix_radio_weighted";$("#switchToSRRS").prop("checked",false);e.model.set("common_name",i);e.model.set("funneling",e._previousValue);t.close()}).on("confirmDialog.afterClose",function(){var t="matrix_radio_weighted";if(e.model.isSingleRowRatingScale()&&e.model.isFunnelReceiver()){$("#switchToSRRS").prop("checked",false);e.model.set("common_name",t);e.model.set("funneling",e._previousValue)}});t.open()},_handleCommonNameChange:function(){var e=this.model;if(e.isSingleRowRatingScale()&&e.isFunnelReceiver()){this._showRemoveFunnelConfirm()}else if($("#funnelSwitch").prop("checked")){e.set("funneling",this._previousValue)}},_handleOverMaxChoices:function(){var e=$("#funnelSwitch");if(!e.prop("checked")){$("#funnelSwitchContainer").addClass("maxChoices");e.prop("disabled",true)}},_handleUnderMaxChoices:function(){$("#funnelSwitch").prop("disabled",false);$("#funnelSwitchContainer").removeClass("maxChoices error")},_handleQuestionDelete:function(e,t){var i=$("#funnelSwitch"),n=i.prop("checked"),a=this.model.isFunnelReceiver()?this.model.get("funneling")[0].sender_question_id:undefined;if(n&&a===t.id){i.prop("checked",false);if(this._previousValue[0].sender_question_id===t.id){this._previousValue[0].sender_question_id=null
;this._showSelectedSender($("#funnelMenuContainer"),null,null)}this._toggleFunneling({target:i})}},_hasNoSenderQuestions:function(){return this._numSenderQs<1&&this._actionMenuFilled},_doFunneledAnswersMatchSender:function(e){var t=this.model.getFunneledAnswersForSenderId(e.id),i;if(!e){return false}i=e.get("answer_options").rows.length;if(e.hasOtherAnswer()){i=i+1}return i===t.length},_setupQuestionSelector:function(){var e=this,t=$("#funnelMenuContainer");t.find(".senderQuestionMenu").actionMenu({actions:e._actionMenuDropDowns,saveState:true}).on("actionMenu.actionSelected",function(t){var i=t.actionMenu.get("menuView").get("selectedAction");CREATE.pages.getQuestion(i,true).done(function(t){if(!e.model.isFunnelReceiver()||e.model.get("funneling")[0].sender_question_id!==i){e._updateFunneling(t,i);e.$el.toggleClass("funnel-receiver",e.model.isFunnelReceiver())}})}).on("actionMenu.beforeOpen",function(e){var t=e.actionMenu.get("menuView").$el;t.addClass("long")})},_updateFunneling:function(e,t){var i=$("#funnelMenuContainer"),n=_.clone(this.model.get("funneling")),a=$.extend({},n[0]),o=i.find("[name=funnelAnswerType]:checked").val(),s=e.get("answer_options").cols,r,l=[],d=[],u,c=i.attr("data-matrix-set-id"),f;this._showSelectedSender(i,e);a.sender_question_id=t;this._removedSenders=$.grep(this._removedSenders,function(e){return e!==t});if(this._removedSenders.length>0){CREATE.utils.getQuestionElForId(this.model.id).data("removedSenders",this._removedSenders)}f=i.attr("data-funnel-id");if(f){a.funnel_id=f}else{delete a.funnel_id}if(s&&s.length>0&&e.isMatrixNonRankingMenu()){r="matrix_set";_.each(s,function(e){d.push(e.id)});u={condition:{type:o,operator:"or"},option_ids:d};if(c){u.matrix_set_id=c}l.push(u);a.condition.matrix_set={sets:l,operator:"or"}}else{r=o;i.attr("data-matrix-set-id","")}a.condition.type=r;n[0]=a;this.model.set("funneling",n);if(this.$el.hasClass("quiz-question")&&this.$el.hasClass("funnel-receiver")){SM.Logger.quizShowLogicWarning()}},_loadSenderPages:function(){var e=this,t=this.model,i=[],n,a,o=t.getPage();if(!CREATE.QuestionEditor.isOpen()||$("#funnelMenuContainer .senderQuestionMenu").length<1){return}this._actionMenuFilled=false;this._actionMenuDropDowns=[];this._numSenderQs=0;CREATE.pages.find(function(e){var t=false;if(o.id.toString()===e.id){t=true}if(e.canBeFunnelSender(o)){i.push(e.id)}return t});if(i.length>0){n=[];a=[];_.each(i,function(e){var t=CREATE.pages.get(e);if(t.get("expanded")){n.push(t)}else{a.push(e)}});if(a.length>0){CREATE.pages.fetch(a,{render:false}).done(function(t){_.each(t.pages,function(e){var t=CREATE.pages.get(e.id);n.splice(t.get("position")-1,0,t)});e._populateSenderMenu(n)}).fail(function(){CREATE.Notifications.showErrorNotification()})}else{this._populateSenderMenu(n)}}else{this._actionMenuFilled=true;this._resetSenderMenu()}},_populateSenderMenu:function(e){var t=this,i=new CREATE.collections.Pages(e),n=this.model;i.each(function(e){var i=false;if(n.get("page_id").toString()===e.id){i=true}e.questions.each(function(e){if(e.id===n.id){return false}if(!e.isSupportedSender()){return true}var a=false,o="";if(i){a=true;o=CREATE.Translations.get("same_page")["default"]+" "}if(!a){t._numSenderQs+=1}t._actionMenuDropDowns.push({text:t._getQuestionHeading(e,o),action:e.id,isDisabled:a})})});this._actionMenuFilled=true;this._resetSenderMenu()},_resetSenderMenu:function(){var e=this,t=$("#funnelMenuContainer").find(".senderQuestionMenu");if(this._actionMenuDropDowns.length>0){t.each(function(t,i){var n=$(i),a=n.attr("data-sender-question-id");n.data("actionMenu").set("actions",e._actionMenuDropDowns);if(a){CREATE.pages.getQuestion(a,true).done(function(t){n.html(e._getQuestionHeading(t))})}})}this._updateFunnelingEnabledState()},_updateFunnelingEnabledState:function(){var e=$("#funnelSwitch"),t=$("#funnelSwitchContainer"),i=$("#funnelMenuContainer"),n=e.prop("checked");this._handleLimitedEditState();if(this._hasNoSenderQuestions()){e.prop("checked",false);t.attr({title:CREATE.Translations.get("funnel_error","defaults")["default"],"sm-tooltip-side":"top"});i.addClass("hide")}else{this._toggleLoadingSpinner(i);t.removeAttr("title").removeAttr("sm-tooltip-side");i.toggleClass("hide",!n)}},_toggleLoadingSpinner:function(e){var t=e.find(".senderQuestionMenuContainer");e.find(".senderQuestionMenu").toggleClass("disabled",!this._actionMenuFilled);if(this._actionMenuFilled){t.spin(false)}else{t.spin({color:"#66625d",length:4,width:3,radius:5})}},_getQuestionHeading:function(e,t){var i=t||"",n=e.getHeading({truncate:this._MAX_TITLE_LENGTH,prefix:i});return e.getDisplayNumber(true,": ")+n},_showSelectedSender:function(e,t,i){var n=t?this._getQuestionHeading(t):this._defaultText,a=t?t.id:"";if(i){e.attr("data-funnel-id",i.funnel_id)}else{e.attr("data-funnel-id","")}e.find(".senderQuestionMenu").html(n).attr("data-sender-question-id",a)},_addFunneledAnswers:function(e,t){var i=t.get("answer_options"),n=e.find(".senderQuestionMenuContainer"),a=e.closest(".choicesTable").data("choicesTable"),o=[],s,r=i.rows.length+(t.hasOtherAnswer()?1:0);if(!a.canAddChoices(r)){n.addClass("error");return}else{n.removeClass("error")}$.each(i.rows,function(e,i){var n=i.funneling||{},a=n.root_answer_open_ended||false;s={text:a?CREATE.Translations.get("funneled_other_answer")["default"]:i.text,id:"",funneling:{sender_question_id:t.id,sender_answer_id:i.id,sender_answer_open_ended:false,root_answer_open_ended:a},visible:true};o.push(s)});a.addChoices(o,true);if(i.other_type==="answer_option"){s={text:CREATE.Translations.get("funneled_other_answer")["default"],id:"",funneling:{sender_question_id:t.id,sender_answer_id:i.other.id,sender_answer_open_ended:true,root_answer_open_ended:true},visible:true};a.addChoice(s,true,true)}},_removeFunneledAnswers:function(e,t){var i=e.closest(".choicesTable"),n=i.data("choicesTable"),a,o;if(t){a=i.find(".choice").not("[data-template], .isFunnelReceiverOption");if(a.length<1){n.addChoice({text:"",id:""},true,true)}}o=i.find(".isFunnelReceiverOption");n.deleteChoices(o)}});CREATE.views.EditorFunnelingAnswerType=CREATE.views.EditorBase.extend({el:"#funnelTypeContainer",events:{"change input[name=funnelAnswerType]":"_handleChangeFunnelAnswerType"},initialize:function(){this.render();this.listenTo(this.model,"change:funneling",this.render)},render:function(){var e="selected",t=this.model.isFunnelReceiver()?this.model.get("funneling")[0]:null;if(t){if(t.condition.type==="matrix_set"){e=t.condition.matrix_set.sets[0].condition.type}else{e=t.condition.type}this.$el.find(".selectorContainer").toggleClass("hide",!t.sender_question_id).find('[value="'+e+'"]').prop("checked",true)}else{this.$el.find(".selectorContainer").find('[value="'+e+'"]').prop("checked",true)}},_handleChangeFunnelAnswerType:function(e){var t=this.model.isFunnelReceiver()?this.model.get("funneling")[0]:null,i,n,a=$(e.target).val();if(t){i=t.condition;n=i.type;if(n==="matrix_set"){_.each(i.matrix_set.sets,function(e){e.condition.type=a})}else{i.type=a}}}});CREATE.views.EditorFunnelingColFilter=CREATE.views.EditorBase.extend({el:"#filterColSettings",events:{"change input[name=funnelColFilter]":"_handleChangeFunnelColFilter"},initialize:function(e){this.parent=e.parent;this.render();this.listenTo(this.model,"change:funneling",this.render)},render:function(){var e=this,t=this.model.isFunnelReceiver()?this.model.get("funneling")[0]:null,i=$("#funnelMenuContainer");if(t&&t.sender_question_id){CREATE.pages.getQuestion(t.sender_question_id,true).done(function(n){e._addFilterColumns(i,n,t)})}else{this._removeFilterColumns()}},validate:function(){var e,t=this.$el.find(".funnelColContainer"),i=true;t.removeClass("error");e=this.$el.find(".funnelInputContainer:not([data-template]) [name=funnelColFilter]");if(e.length>1&&e.filter(":checked").length<1){t.addClass("error");i=false}return i},_COLUMN_FILTER_ROW_LENGTH:5,_handleChangeFunnelColFilter:function(){var e=this.model.isFunnelReceiver()?this.model.get("funneling")[0]:null,t=this.$el.find("[name=funnelColFilter]"),i=[],n=[],a;if(e){t.each(function(e,t){var i=$(t),a;if(i.closest("[data-template=funnelSenderColumn]").length>0){return true}if(i.prop("checked")){a=i.attr("id").replace("filterCol","");n.push(a)}});a=e.condition.matrix_set.sets[0];a.option_ids=n;i.push(a);e.condition.matrix_set={sets:i,operator:"or",type:e.condition.matrix_set.type};e.condition.type="matrix_set"}},_addFilterColumns:function(e,t,i){var n=this,a=this.$el.find(".funnelCol"),o=t.get("answer_options").cols,s=[],r,l=true;this._removeFilterColumns();this.$el.find(".funnelColContainer").removeClass("error");if(!o||!t.isMatrixNonRankingMenu()){return}if(i&&i.condition.matrix_set){r=i.condition.matrix_set.sets[0];s=r.option_ids;e.attr("data-matrix-set-id",r.matrix_set_id)}else{e.attr("data-matrix-set-id","")}$.each(o,function(e,t){if(i){l=$.inArray(t.id,s)!==-1}a.append(n._makeColCheckbox(a,e,t,l))});this.$el.find(".funnelColContainer").removeClass("hide")},_removeFilterColumns:function(){this.$el.find(".funnelColContainer").addClass("hide").find(".funnelInputContainer").not("[data-template]").remove()},_makeColCheckbox:function(e,t,i,n){var a=e.find("[data-template]").clone(),o=CREATE.utils.htmlDecode(CREATE.utils.stripTags(i.text));a.removeClass("hide").removeAttr("data-template").find(".filterColLabel").text(o).attr("for","filterCol"+i.id);a.find("[name=funnelColFilter]").attr("id","filterCol"+i.id).prop("checked",n);if(t%this._COLUMN_FILTER_ROW_LENGTH===0){a.addClass("newLine")}return a}});CREATE.views.EditorPiping=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"rteFocused.piping .rte":"_handleRteFocus","rteBlurred.piping .rte":"_handleRteBlur","mousedown.piping #pipingHolder":"_handleMousedown","click.piping #pipingHolder a":"_handleClick"},initialize:function(){this.listenTo(this.model,"change:has_responses",this._handleChangeHasResponses);this._handleChangeHasResponses();$("#livePreview").on("closeEditMode.piping",this._removePiping);this.$el.toggleClass("piping-quiz-message",this.model.get("has_piping"))},remove:function(){$("#livePreview").off(".piping");Backbone.View.prototype.remove.call(this)},_pipingClicked:false,_cachedPipingData:null,_handleRteFocus:function(e,t){var i=t.parent();$(".rteToolbarContainer").removeClass("focused");i.addClass("focused").append($("#pipingHolder"))},_handleRteBlur:function(e,t){if(this._pipingClicked){this._pipingClicked=false}else{$("#graveyard").append($("#pipingHolder"));t.parent().removeClass("focused")}},_handleMousedown:function(){this._pipingClicked=true},_handleClick:function(e){var t=$(e.currentTarget),i=t.parent();e.preventDefault();if(t.data("action")==="pipingMenu"){if(!CREATE.user.hasFeature("piping")){__UPGRADE.openUpgradeModal("upgradePiping")}else if(!i.data("actionMenu")){this._initActionMenu(i)}SM.Logger.enqueue({action_type:"click_piping",ui_trigger:"editorPiping"})}},_removePiping:function(){var e=$("#pipingHolder"),t=e.data("actionMenu");if(t){e.data("actionMenu").destroy()}this._cachedPipingData=null;$("#graveyard").append($("#pipingHolder"))},_createMenu:function(e,t,i,n){var a=this,o;if(!n){n={my:"left top",at:"left bottom",collision:"none none"}}e.actionMenu({actions:t,templateID:i,position:n}).off("actionMenu.actionSelected actionMenu.menuInit actionMenu.afterOpen actionMenu.submenuOpened").on("actionMenu.actionSelected",function(e){var t;e.preventDefault();if(e.action==="more_piping_options"){if(CREATE.user.hasFeature("tbyb")||!CREATE.user.hasFeature("piping")&&!CREATE.user.hasFeature("extended_piping")){__UPGRADE.saveOpenSettingsAndRedirect(null,__UPGRADE.getUpgradeUrl("upgradeAdvancedPiping","survey_editor"))}else{__UPGRADE.openUpgradeModal("upgradeAdvancedPiping")}}else{t=e.$action.hasClass("piping-question");a._appendPipeToText(e,t);if(e.$action.not('[data-action="-1"]').length>0){a.$el.addClass("piping-quiz-message");if(a.model.isQuizEnabled()){SM.Logger.quizShowLogicWarning()}}}}).on("actionMenu.menuInit",function(e){var t=e.actionMenu.get("menuView");t.$el.find(".q").popout()}).on("actionMenu.submenuOpened",function(e){e.actionMenu.activeSubmenu.get("menuView").$el.addClass("long");e.actionMenu.activeSubmenu.position()}).on("actionMenu.afterOpen",function(e){e.actionMenu.get("menuView").$el.addClass("long");e.actionMenu.position()});o=e.data("actionMenu");o.get("menuView").$el.addClass("pipingMenuQuestions");o.open()},_appendPipeToText:function(e,t){var i,n=$("#pipingHolder").closest(".rteToolbarContainer").find(".rte"),a=this,o;setTimeout(function(){if(parseInt(e.action,10)!==-1){if(t){o=a._translatePipe();if(o.toLowerCase()==="q"){i="{{ Q"+e.action+" }}"}else{i="["+o+e.action+"]"}}else{i="{{ "+e.action+" }}"}n.focus();$.insertHtmlAtSelection(i,true);n.closest(".rteToolbarContainer").removeClass("empty")}},10)},_initActionMenu:function(e){var t=CREATE.QuestionEditor,i=this.model.get("id"),n,a,o,s=this,r=CREATE.user.hasFeature("tbyb"),l=CREATE.user.hasFeature("extended_piping"),d=CREATE.user.hasFeature("piping"),u=CREATE.Translations.get("piping_menu_options"),c="piping-action-menu-template",f={my:"left top",at:"right top",collision:"flip flip"};if(t.isNewQuestion(i)){n=[{action:-1,text:CREATE.Translations.get("piping","errors").UnsavedBeforePipingException.message}];this._createMenu(e,n)}else{n=[];a={action:"previous_questions",text:u.previous_questions["default"],classes:r||!d&&!l?"upgrade":""};if(r||!l&&!d){n.push({action:"more_piping_options",text:u.more_piping_options["default"],classes:!l?"upgrade":"",popout:"help-rte-advanced-piping"})}else if(!l&&d){n.push({action:"more_piping_options",text:u.more_piping_options["default"],classes:!l?"upgrade":""})}else{n.push({action:"piping_contacts",text:u.contacts["default"],submenu:{actions:this._getPipingContactsArray(),templateID:c,position:f}});o=this._getPipingCustomVariablesArray();n.push({action:"piping_custom",text:u.custom_variables["default"],classes:!o.length?"disabled":"",submenu:{actions:o,templateID:c,position:f}})}if(this._cachedPipingData===null){CREATE.Ajax.getPipingQuestions(i).done(function(t){s._cachedPipingData=t.piping_questions;s._onPipingDataLoaded(e,n,a)})}else{this._onPipingDataLoaded(e,n,a)}}},_onPipingDataLoaded:function(e,t,i){var n="piping-action-menu-template",a={my:"left top",at:"right top",collision:"flip flip"};i.submenu={actions:this._getPipingQuestionsArray(this._cachedPipingData),templateID:n,position:a};t.unshift(i);this._createMenu(e,t,n)},_getPipingContactsArray:function(){var e=[];_.each(CREATE.user.getCustomContactFields(),function(t,i){e.push({action:i,text:t})});return e},_getPipingCustomVariablesArray:function(){var e=[];_.each(CREATE.survey.get("custom_variables"),function(t){var i="custom."+t.variable_name;if(i.indexOf("-")>=0){return}e.push({action:i,text:t.variable_label})});return e},_translatePipe:function(){var e=CREATE.survey.get("language").id;return CREATE.Translations.get("translations","piping")[e]},_getPipingQuestionsArray:function(e){var t=[],i=this,n=CREATE.user.hasFeature("extended_piping"),a,o,s={};$.each(e,function(e,t){if(n||!t.answer_options.rows){s[e]=t}});if($.isEmptyObject(s)){t=[{action:-1,text:CREATE.Translations.get("piping","errors").CannotPipeFromAnyQuestionsException.message}]}else{$.each(s,function(e,s){if(s!==null&&typeof s==="object"){a=s.heading;o=s.answer_options.rows;if(n&&o){t.push(i._getPipingQuestionMenuItem(e,a,true));_.each(i._getPipingQuestionAnswerItems(e,s.answer_options),function(e){t.push(e)})}else if(!o){t.push(i._getPipingQuestionMenuItem(e,a))}}else{t.push(i._getPipingQuestionMenuItem(e,s))}})}return t},_getPipingQuestionMenuItem:function(e,t,i){return{action:e,text:this._translatePipe()+e+": "+t.replace(/(<([^>]+)>)/gi,""),classes:"piping-question"+(i?" disabled":"")}},_getPipingQuestionAnswerItems:function(e,t){var i=this,n=t.rows,a=t.cols,o=[];$.each(n,function(t,n){n=n.length?": "+n.replace(/(<([^>]+)>)/gi,""):"";if(a){$.each(a,function(a,s){s=s.replace(/(<([^>]+)>)/gi,"");o.push({action:e+".R"+t+".C"+a,text:i._translatePipe()+e+".R"+t+".C"+a+n+" / "+s,classes:"piping-question",indent:true})})}else{o.push({action:e+".R"+t,text:i._translatePipe()+e+".R"+t+n,classes:"piping-question",indent:true})}});return o},_handleChangeHasResponses:function(){if(this.model.hasResponses()){this._removePiping()}}});CREATE.views.EditorMove=CREATE.views.EditorBase.extend({el:'#editQuestion [data-tab-panel="move"]',events:{"change #movePage":"_setupDropDowns","click .move":"_moveQuestion"},initialize:function(){this.listenTo(CREATE.survey,"change:design_settings",this.render);this.render()},render:function(){this._setupDropDowns({pageId:this.model.getPage().id});this._toggleLogicWarning()},_setupDropDowns:function(e){var t,i;if(e.currentTarget){t=this.$el.find(e.currentTarget).val()}else{t=e.pageId}i=CREATE.pages.get(t);this._populatePageDropDown(i);this._populateQuestionDropDown(i)},_moveQuestion:function(e){var t=this._getData(),i=t.refPosition+(t.position==="after"?1:0);e.preventDefault();CREATE.survey.moveQuestion(t.questionId,t.oldPageId,t.pageId,i).done(function(){var e,n,a=CREATE.QuestionEditor.originalQuestionData;CREATE.QuestionEditor.question.set({position:i,page_id:t.pageId});a.position=i;a.page_id=t.pageId;if(CREATE.survey.isSinglePageMode()&&CREATE.survey.pageInView!==t.pageId){CREATE.PagePagination.loadPage(t.pageId)}else{e=$("#question-field-"+t.questionId);e.addClass("edited");if(t.refId===0){CREATE.utils.appendQuestionMarkup(t.pageId,e)}else{n=CREATE.utils.getQuestionContainer($("#question-field-"+t.refId));if(t.position==="after"){CREATE.utils.getQuestionContainer(e).insertAfter(n)}else{CREATE.utils.getQuestionContainer(e).insertBefore(n)}}CREATE.QuestionEditor.cancelEditMode(false);__UI.scrollToElement(e,function(){e.removeClass("edited");$("#livePreview").trigger("previewChanged")})}}).fail(function(e){var t=e.appError.name;if(t!=="QuestionPerPageLimitException"){t="Exception"}CREATE.Notifications.showErrorNotification({messageKey:t})});return this},_populatePageDropDown:function(e){var t=$("#movePage"),i=null,n;t.empty();CREATE.pages.each(function(a,o){n=CREATE.utils.htmlDecode(a.getHeading({truncate:50,usePlaceholder:false}));$("<option />",{value:a.id,text:o+1+". "+n}).appendTo(t);if(o===0||a.id===e.id){i=a.id}});t.val(i)},_populateQuestionDropDown:function(e){var t=this.$el.find(".moveTarget"),i=this.model.get("id"),n=this;t.empty();if(e.questionCount()>0){e.getQuestions().done(function(e){e.each(function(e){var n,a;if(e&&i!==e.id){n=e.getDisplayNumber();a=CREATE.utils.htmlDecode(e.getHeading({truncate:50}));$("<option />",{value:e.get("position")+"_"+e.id,text:n+a}).appendTo(t)}});n.$el.find(".moveSetting").toggleClass("noQuestions",!t.children("option").length)})}else{n.$el.find(".moveSetting").addClass("noQuestions")}},_toggleLogicWarning:function(){var e=this.model.isFunnelSender()||this.model.isFunnelReceiver(),t=this.model.isLogicTarget(),i=$("#moveQuestionWithLogicAlert"),n=e||t;i.toggleClass("hide",!n)},_getData:function(){var e=this.model.get("page_id"),t=this.$el.find(".moveTarget").val(),i=t?t.split("_"):[0,0],n=t?this.$el.find(".movePos").val():"after",a=parseInt(i[0],10),o=parseInt(this.$el.find("#movePage").val(),10);if(o===e&&this.model.get("position")<a){a--}return{questionId:this.model.get("id"),oldPageId:e,pageId:o,position:n,refPosition:a,refId:parseInt(i[1],10)}}});CREATE.views.EditorCopy=CREATE.views.EditorBase.extend({el:'#editQuestion [data-tab-panel="copy"]',events:{"change #copyPage":"_setupDropDowns","click .copy":"_copyQuestion"},initialize:function(){this.listenTo(CREATE.survey,"change:design_settings",this.render);this.listenTo(this.model,"change:heading",this.render);this.render()},render:function(){this._setupDropDowns({pageId:this.model.getPage().id})},_setupDropDowns:function(e){var t,i;if(e.currentTarget){t=this.$el.find(e.currentTarget).val()}else{t=e.pageId}i=CREATE.pages.get(t);this._populatePageDropDown(i);this._populateQuestionDropDown(i)},_copyQuestion:function(e){var t=this._getSavePosition(),i=t.refPosition+(t.position==="after"?1:0);e.preventDefault();if(!__UI.handleQuestionLimit(CREATE.user,1)){return}if($(e.target).hasClass("disabled")){return}else{$(e.target).addClass("disabled")}CREATE.survey.copyQuestion(this.model.get("id"),t.pageId,i).done(function(i){var n,a;__UPGRADE.handleUpgradeState();if(CREATE.survey.isSinglePageMode()&&CREATE.survey.pageInView!==t.pageId){CREATE.PagePagination.loadPage(t.pageId)}else{n=CREATE.utils.getQuestionElFromContainer(i.markup);n.addClass("edited");if(t.refId===0){CREATE.utils.appendQuestionMarkup(t.pageId,n)}else{a=CREATE.utils.getQuestionContainer($("#question-field-"+t.refId));if(t.position==="after"){CREATE.utils.getQuestionContainer(n).insertAfter(a)}else{CREATE.utils.getQuestionContainer(n).insertBefore(a)}}$(e.target).removeClass("disabled");CREATE.QuestionEditor.cancelEditMode(false);__UI.scrollToElement(n,function(){n.removeClass("edited");$("#livePreview").trigger("previewChanged")})}}).fail(function(t){var i=t.appError.name,n;if($.inArray(i,["QuestionPerPageLimitException","QuestionPerSurveyLimitException","FileUploadQuestionPerSurveyLimitException"])===-1){i="Exception"}else{n=CREATE.limitErrorNotificationDuration}$(e.target).removeClass("disabled");CREATE.Notifications.showErrorNotification({messageKey:i,showErrorDuration:n})})},_populatePageDropDown:function(e){var t=null,i=$("#copyPage"),n;i.empty();CREATE.pages.each(function(a,o){n=CREATE.utils.htmlDecode(a.getHeading({truncate:50,usePlaceholder:false}));$("<option />",{value:a.id,text:o+1+". "+n}).appendTo(i);if(a.id===e.id){t=a.id}});i.val(t)},_populateQuestionDropDown:function(e){var t=this.$el.find(".copyTarget"),i=this,n=e.questionCount();t.empty();if(n>0){e.getQuestions().done(function(n){n.each(function(e){var i=e.getDisplayNumber(),n,a;n=CREATE.utils.htmlDecode(e.getHeading({truncate:50}));a={value:e.get("position")+"_"+e.id,text:i+n,"data-question-id":e.id};$("<option />",a).appendTo(t)});if(i.model.get("page_id").toString()===e.id){t.val(i.model.get("position")+"_"+i.model.get("id"))}})}this.$el.find(".copySetting").toggleClass("noQuestions",n===0)},_getSavePosition:function(){var e=this.$el.find(".copyTarget").first().val(),t=e?e.split("_"):[0,0],i=e?this.$el.find(".copyPos").first().val():"after";return{questionId:this.model.get("id"),pageId:$("#copyPage").val(),position:i,refPosition:parseInt(t[0],10),refId:parseInt(t[1],10)}}});CREATE.views.EditorNickname=CREATE.views.EditorBase.extend({el:"#editQuestion .nicknameTable",events:{"blur #editNickname":"_handleOnBlur"},template:_.template($("#nicknameTemplate").html()),initialize:function(){this.render()},_handleOnBlur:function(){this.model.set({nickname:$("#editNickname").val()})},render:function(){var e=CREATE.Translations.get("nickname"),t={heading:e["default"],placeholder:e.placeholder["default"]};if(this.model.hasRandomAssignment()){t.heading=CREATE.Translations.get("ab_test")["default"]}this.$el.html(this.template({model:this.model,displayData:t}))}});CREATE.views.EditorPresentationText=CREATE.views.EditorBase.extend({el:"#editTextContent",events:{rteBlurred:"_onRteBlurred"},_onRteBlurred:function(){var e=CREATE.Rte.getContentForSave(this.$el.attr("id"));this.model.set({heading:e})},initialize:function(){this.render()},render:function(){this.$el.html(this.model.get("heading"))},validate:function(){if(this.model.hasRandomAssignment()){return true}return CREATE.Validator.validate(this.$el,"td")}});CREATE.views.EditorPresentationImage=CREATE.views.EditorBase.extend({el:"#editQuestion",events:{"change .imageSource":"_onImageSourceChange","click .uploadImageFile":"_openImageUploader","rteBlurred .varImage":"_onHeadingChange","focus .typeImageURL":"_onImageTypeURL","keyup .typeImageURL":"_onImageFieldChange","paste .typeImageURL":"_onImageFieldChange"},initialize:function(){this.render();this.listenTo(this.model,"change:random_assignment",this._onRandomAssignmentChanged)},validate:function(){var e=true,t=this,i=this._getImageContents();this.$el.find(".uploadImageFile").closest(".choiceType").removeClass("error");this.$el.find(".imageURLWrap").removeClass("error");i.each(function(i,n){var a=$(n),o=a.find(".imageSource:checked").val(),s=a.find(".imagePreview").attr("src"),r=a.find(".typeImageURL").val();a.find(".imageChoiceError").toggleClass("error",!o);if(!o){e=false}if(o==="upload"&&t._checkIfDefaultImage(a.find(".imagePreview").attr("src"))){a.find(".uploadImageFile").closest(".choiceType").addClass("error");e=false}else if(o==="url"){if(!r||$.trim(s).length===0||s.indexOf("http")===-1){a.find(".typeImageURL").closest(".imageURLWrap").addClass("error");e=false}}});return e},render:function(){var e=this.$el.find("[data-toolbar=imagetemp]"),t=this,i=this._getImageContents(),n;if(!this.model.hasRandomAssignment()){e.attr("data-toolbar","editImageContent");e.find("[data-var]").attr("id","editImageContent").html(this.model.get("heading"))}n=this._getImageData();i.each(function(e,i){var a=$(i),o=n[e];a.find(".imagePreview").attr("src",o.url);t._setRadios(a,e);a.find("input[name=imageSource"+e+"][value="+o.type+"]").prop("checked",true);if(o.type==="url"){a.find(".typeImageURL").val(o.url)}else if(o.s3_key){a.find(".imageSource[value=upload]").attr("data-s3-key",o.s3_key)}})},_defaultURL:CREATE.sample_image_url,_getImageContents:function(){if(this.model.hasRandomAssignment()){return this.$el.find(".variation").not("[data-template]").find(".imgContent")}else{return this.$el.find(".imgContent")}},_updateUrlValue:function(e,t){var i=this.model.get("random_assignment").slice(),n,a,o=$.extend({},this.model.get("answer_options"));if(this.model.hasRandomAssignment()){n=this._getImageContents().index(t);a=i[n];a.image.url=e;a.image.type="url";a.image.s3_key=null;this.model.set("random_assignment",i)}else{o.image.url=e;o.image.img_type="url";o.image.s3_key=null;this.model.set("answer_options",o)}},_updateUploadValue:function(e,t,i){var n=this.model.get("random_assignment").slice(),a,o,s=$.extend({},this.model.get("answer_options"));if(this.model.hasRandomAssignment()){a=this._getImageContents().index(i);o=n[a];o.image.s3_key=t;o.image.type="upload";o.image.url=e;this.model.set("random_assignment",n)}else{s.image.s3_key=t;s.image.img_type="upload";s.image.url=e;this.model.set("answer_options",s)}},_updateImageValues:function(e,t){var i=e.closest(".imgContent"),n=i.find(".imagePreview"),a=e.val(),o,s;if(a==="url"){if(t){i.find(".imageSource").not(e).attr("data-image-url",n.attr("src"))}o=i.find(".typeImageURL").val();this._updateUrlValue(o,i)}else{o=e.attr("data-image-url");s=e.attr("data-s3-key")||null;this._updateUploadValue(o,s,i)}n.attr("src",o||this._defaultURL)},_setRadios:function(e,t){e.find(".imageSource").attr("name",function(){return"imageSource"+t})},_checkIfDefaultImage:function(e){return e.indexOf("/assets/images/")>=0},_getImageData:function(){var e=[],t;if(this.model.hasRandomAssignment()){$.each(this.model.get("random_assignment"),function(t,i){e.push({url:i.image.url,type:i.image.type,s3_key:i.image.s3_key})})}else{t=this.model.get("answer_options").image;e.push({url:t.url,type:t.img_type,s3_key:t.s3_key})}return e},_onImageFieldChange:function(e){var t=this;if(e.type==="paste"){setTimeout(function(){t._handleInputChange(e)},0)}else{this._handleInputChange(e)}},_handleInputChange:function(e){this._updateImageValues($(e.target).closest(".enterURL").find(".imageSource"),false)},_onRandomAssignmentChanged:function(){var e=(new Date).getTime(),t=this._getImageContents(),i=this;t.each(function(t,n){var a=$(n);i._setRadios(a,e+t)})},_onImageSourceChange:function(e){this._updateImageValues($(e.target),true)},_openImageUploader:function(e){var t,i,n;e.preventDefault();i=$(e.target).closest(".imgContent");n=i.find(".imageSource[value=upload]");n.prop("checked",true);t=SM.Views.create(SM.SurveyImagesDialogView,{assetLibraryModel:CREATE.AssetLibrary.getInstance(),source:"presentationImage"});t.$el.on("imageUploaded",{$radio:n,self:this},this._onImageUploaded);t.open()},_onImageUploaded:function(e){var t=e.imageData,i=e.data.$radio,n=e.data.self;i.attr("data-image-url",t.url);i.attr("data-s3-key",t.s3Key);n._updateImageValues(i,true)},_onImageTypeURL:function(e){var t=$(e.target).closest(".enterURL").find(".imageSource[value=url]");t.prop("checked",true);this._updateImageValues(t,false)},_onHeadingChange:function(e){var t,i="",n="[Image A/B Test] ";if(this.model.hasRandomAssignment()){this.$el.find(".varImage").each(function(e,t){var n=$.trim(CREATE.Rte.getContent(t.id,true));if(n){i=n;return false}});t=n+i}else{t=CREATE.Rte.getContentForSave(e.target.id)}this.model.set("heading",t)}});CREATE.views.EditorNACol=CREATE.views.EditorBase.extend({el:"#editQuestion .columnsTable.choicesTable",initialize:function(){var e=this;this.listenTo(this.model,"change:answer_options",this.render);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.render();$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},render:function(){if(this.model.isRanking()){this.$el.find("thead").toggleClass("hide",!this.model.hasNACol())}},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},toggleNAData:function(e,t){var i;if(e){i={text:CREATE.Rte.getContentForSave("editNALabel"),type:"col",is_na:true};if(t.na_col){i.id=t.na_col.id;i.visible=!!i.visible}}else{i=null}t.na_col=i},_subViews:{EditorNATextField:undefined,EditorNAColCheckbox:undefined},_handleCommonNameChange:function(){var e;if(this.model.isUnweightedMatrix()||this.model.allowsMultipleChoices()){e=_.extend({},this.model.get("answer_options"));e.na_col=null;this.model.set("answer_options",e)}}});CREATE.views.EditorNATextField=CREATE.views.EditorBase.extend({el:"#editQuestion .column.notApplicable",events:{"rteBlurred #editNALabel":"_updateNALabel"},initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:answer_options",this.render);this.listenTo(this.model,"change:common_name",this._onChangeCommonName);this.render()},render:function(){var e=this.model.get("answer_options").na_col;this.$el.toggleClass("hide",!e);if(e){$("#editNALabel").html(e.text)}},validate:function(){if(this.model.hasNACol()){return CREATE.Validator.validate($("#editQuestion .column.notApplicable [data-validation]"),"td")}return true},_updateNALabel:function(){var e=$.extend({},this.model.get("answer_options"));e.na_col.text=CREATE.Rte.getContentForSave("editNALabel");this.model.set("answer_options",e)},_onChangeCommonName:function(){var e=this.model,t=$.extend({},e.get("answer_options"));this.parent.toggleNAData(this.model.hasNACol(),t);this.model.set("answer_options",t);this.render()}});CREATE.views.EditorNAColCheckbox=CREATE.views.EditorBase.extend({el:"#editNA",events:{change:"_onNaColToggle"},initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:has_responses change:answer_options change:common_name",this.render);this.listenTo(this.model,"change:common_name",this._handleCommonNameChange);this.render()},render:function(){var e=this.model.hasNACol();this.$el.prop({checked:e,disabled:this.model.hasResponses()});this.$el.closest("label").toggleClass("hide",!this.model.allowsNACol())},_onNaColToggle:function(){var e=$.extend({},this.model.get("answer_options"));this.parent.toggleNAData(this.$el.is(":checked"),e);this.model.set("answer_options",e);this.render()}});CREATE.views.EditorSlider=CREATE.views.EditorBase.extend({el:"#editQuestion",initialize:function(){var e=this,t=this.$el.find(".sliderTable .choiceLabel").find(".input"),i=this.model.get("validation");this._origValidation.min=CREATE.utils.toStr(i.min);this._origValidation.max=CREATE.utils.toStr(i.max);_.each(t,function(t){var i=$(t),n=i.attr("id"),a=e.model.get("display_options")[e._modelLabelMap[n]];i.text(a===""&&n!=="midLabel"?e.model.get("validation")[n.substring(0,3)]:a);if(!a&&n==="midLabel"){
i.closest(".rteToolbarContainer").addClass("empty")}});this.listenTo(this.model,"change:validation",this._syncLabelsFromValidation)},remove:function(){Backbone.View.prototype.remove.apply(this)},validate:function(){var e=this,t=true,i=this.$el.find(".sliderTable .choiceLabel").find(".input"),n=this.$el.find(".sliderTable .err");n.hide();i.parent().removeClass("error");_.each(i,function(i){var a=$(i),o=a.attr("id"),s=$.trim(a.text());if(s===""&&o!=="midLabel"){a.parent().addClass("error");n.show();t=false}e.model.get("display_options")[e._modelLabelMap[o]]=s});return t},_modelLabelMap:{minLabel:"left_label",midLabel:"middle_label",maxLabel:"right_label"},_origValidation:{min:"0",max:"100"},_syncLabelsFromValidation:function(){var e=this.$el.find(".sliderTable .choiceLabel").find(".input"),t=e.first(),i=e.last(),n=this.model.get("validation");if(this._origValidation.min===$.trim(t.text())){this._origValidation.min=n.min;t.text(n.min)}if(this._origValidation.max===$.trim(i.text())){this._origValidation.max=n.max;i.text(n.max)}}});CREATE.views.EditorSliderAdjustment=CREATE.views.EditorBase.extend({el:"#sliderAdjustment",_INPUT_MAX_LEN:8,events:{"change #toggleSlider":"_toggleLayout","blur #min":"_updateScaleRange","blur #max":"_updateScaleRange","blur #step":"_forceInteger","focus #min":"_storeOldRange","focus #max":"_storeOldRange","change #sliderStartingPos":"_setInitPos"},_defaultConfig:{min:0,max:100,stepSize:1,initPos:0},_MIN_LIMIT:-1e6,_MAX_LIMIT:1e6,toInt:CREATE.utils.toInt,toStr:CREATE.utils.toStr,initialize:function(){this._adjustedScaleKey="adjusted_scale";this._inputFix();this.render()},render:function(){var e=this.model.get("validation"),t=this.model.get("display_options"),i=this.$el.find(".adjust-slider-scale"),n=t.custom_options.option_set,a=t.custom_options.step_size,o=this.toInt(e.min),s=this.toInt(e.max),r=this.toInt(this.model.get("display_options").custom_options.starting_position,10),l=o!==this._defaultConfig.min||s!==this._defaultConfig.max||r!==this._defaultConfig.initPos||a!==this._defaultConfig.stepSize&&a!==undefined;if(n&&_.contains(n,this._adjustedScaleKey)||l){this.$el.find("#toggleSlider").prop("checked",true);this.$el.addClass("expand")}if(r===o){r="left"}else if(r===s){r="right"}else{r="center"}this.$el.removeClass("hide");i.find("#min").val(o);i.find("#max").val(s);i.find("#step").val(a?a:1);this.$el.find("#sliderStartingPos").val(r)},validate:function(){var e=true,t=$.extend({},this.model.get("validation"));if(this.$el.find("#toggleSlider").is(":checked")){e=e&&this._validateScaleRange();e=e&&this._validateStepSize()}else{t.min=this.toStr(this._defaultConfig.min);t.max=this.toStr(this._defaultConfig.max);this.model.set("validation",t);this.model.get("display_options").custom_options.step_size=this._defaultConfig.stepSize}this._setInitPos();return e},_defaultLayout:"vertical",_updateErrorMsg:function(){var e=CREATE.Translations.get("slider").error_range["default"],t=CREATE.Translations.get("slider").error_step_size["default"],i=this.model.get("validation"),n=i.max-i.min;e=e.replace("{0}",this._MIN_LIMIT.toLocaleString()).replace("{1}",this._MAX_LIMIT.toLocaleString());t=t.replace("{0}","1").replace("{1}",n.toLocaleString());$("#err_slider_range").text(e);$("#err_slider_step_size").text(t)},_showError:function(e,t){this._updateErrorMsg();e.addClass("error");t.show()},_setInitPos:function(){var e,t=this.model.get("validation"),i=this.toInt(t.min),n=this.toInt(t.max);if(this.$el.find("#toggleSlider").is(":checked")){switch(this.$el.find("#sliderStartingPos").val()){case"left":e=i;break;case"center":e=this._getMidValue(i,n);break;case"right":e=n}}else{e=this._defaultConfig.initPos}this.model.get("display_options").custom_options.starting_position=e},_toggleLayout:function(){var e=this.$el.find("#toggleSlider").is(":checked"),t=this.model.get("display_options").custom_options,i=t.option_set;this.$el.toggleClass("expand",e);if(!i){t.option_set=[]}t.option_set=_.without(i,_.findWhere(i,this._adjustedScaleKey));if(e){t.option_set.push(this._adjustedScaleKey)}},_updateScaleRange:function(e){var t=this,i=this.$el.find(".slider-range input"),n=$.extend({},this.model.get("validation"));this._forceInteger(e);_.each(i,function(e){var i=$(e),a=i.attr("id"),o=$.trim(i.val());if(a==="min"){n.min=t.toStr(o)}else if(a==="max"){n.max=t.toStr(o)}});this.model.set("validation",n)},_validateScaleRange:function(){var e=this.$el.find("#err_slider_range"),t=this.$el.find("#min"),i=this.$el.find("#max"),n=this.model.get("validation"),a=true,o,s=n.min,r=n.max;t.removeClass("error");i.removeClass("error");e.hide();if(s===""){this._showError(t,e);a=false}else{s=this.toInt(s);o=this._validateConfigRange(s);if(!o){this._showError(t,e);a=false}}if(r===""){this._showError(i,e);a=false}else{r=this.toInt(r);o=this._validateConfigRange(r);if(!o||r<=s){this._showError(i,e);a=false}}this._invalidRange=!a;return a},_validateStepSize:function(){var e=this.$el.find(".slider-step-size input"),t=this.$el.find("#err_slider_step_size"),i=this.toInt($.trim(e.val())),n=this.model.get("validation"),a=n.max-n.min,o=true;e.removeClass("error");t.hide();if(this._invalidRange){return false}if(i<1||i>a){this._showError(e,t);o=false}else{this.model.get("display_options").custom_options.step_size=this.toStr(i)}return o},_forceInteger:function(e){var t=$(e.target),i=t.attr("id"),n=this.toInt(t.val());if(n===0||n){t.val(n)}else{if(i==="min"){t.val(this._defaultConfig.min)}else if(i==="max"){t.val(this._defaultConfig.max)}else{t.val(this._defaultConfig.stepSize)}}},_validateConfigRange:function(e){return e>=this._MIN_LIMIT&&e<=this._MAX_LIMIT},_getMidValue:function(e,t){return Math.floor(e+(t-e)/2)},_inputFix:function(){var e=this,t=$("body").hasClass("ie9");this._inputEvent=t?"keyup":"input";this.$el.find("input").on(this._inputEvent,function(t){var i=$(t.target),n=$.trim(i.val());if(n.length>e._INPUT_MAX_LEN){n=n.substr(0,e._INPUT_MAX_LEN);i.val(n)}})}});CREATE.views.EditorSliderHideInputBox=CREATE.views.EditorBase.extend({el:"#sliderHideInputBox",_numericInputKey:"",events:{"change #toggleSliderHideInputBox":"_toggleInputBox"},initialize:function(){this._numericInputKey="hide_numeric_input";this.render()},render:function(){var e=this.model.get("display_options").custom_options.option_set;if(e&&_.contains(e,this._numericInputKey)){this.$el.find("#toggleSliderHideInputBox").prop("checked",true);this.$el.addClass("expand")}},_toggleInputBox:function(){var e=this.$el.find("#toggleSliderHideInputBox").is(":checked"),t=this.model.get("display_options").custom_options,i=t.option_set;this.$el.toggleClass("expand",e);if(!i){t.option_set=[]}t.option_set=_.without(i,_.findWhere(i,this._numericInputKey));if(e){t.option_set.push(this._numericInputKey)}}});CREATE.views.EditorStar=CREATE.views.EditorBase.extend({el:"#editQuestion",initialize:function(){var e=this;$.each(this._subViews,function(t){e._subViews[t]=new CREATE.views[t]({model:e.model,parent:e})})},remove:function(){_.each(this._subViews,function(e){e.remove()});Backbone.View.prototype.remove.apply(this)},preSave:function(){_.each(this._subViews,function(e){if(e.preSave){e.preSave()}})},validate:function(){var e=true;_.each(this._subViews,function(t){if(t.validate){e=e&&t.validate()}});return e},_subViews:{StarDropDowns:undefined,StarLabelCheckBox:undefined}});CREATE.views.StarDropDowns=CREATE.views.EditorBase.extend({el:"#starWrap",_scaleDropDown:null,_shapeDropDown:null,_colorPalette:["#f5a623","#d0021b","#4a90e2","#008000","#333333"],_defaultColors:{star:"#f5a623",smiley:"#333333",heart:"#d0021b",thumb:"#4a90e2",existing:"#333333"},_initDropdowns:false,initialize:function(e){this.parent=e.parent;this.listenTo(this.model,"change:answer_options",this._updateDropdownNumber);this.listenTo(this.model,"change:display_options",this._updateDropdownSubtype);this._initHandler()},_initHandler:function(){this._scaleDropDown=this.$el.find(".scale-dropdown");this._shapeDropDown=this.$el.find(".shape-dropdown");this._initActionMenu(this._scaleDropDown,"star-scale-template",this._updateCols.bind(this));this._initActionMenu(this._shapeDropDown,"star-shape-template",this._updateSubtype.bind(this));this._initColorPicker();this._initDropdowns=true},_initColorPicker:function(){var e=this,t=this.$el.find(".emoji-color-picker"),i=this.model.get("display_options").custom_options.color||this._defaultColors.existing;t.spectrum({showPalette:true,showPaletteOnly:true,hideAfterPaletteSelect:true,color:i,palette:[e._colorPalette],appendTo:e.$el,change:function(t){var i=t.toHexString();e._updateColor(i)}});this._updateColor(i)},_updateColorCSS:function(e){this.$el.find(".emoji-border, .emoji-color").attr("style","color: "+e+" !important")},_updateColor:function(e){var t=$.extend({},this.model.get("display_options")),i=e.toLowerCase();t.custom_options.color=i;this.model.set("display_options",t);this._updateColorCSS(i)},_initActionMenu:function(e,t,i){var n;if(e.data("id")==="star-scale"){n=this.model.get("answer_options").cols.length;this._updateDropdownNumber()}else{n=this.model.get("display_options").display_subtype;this._updateDropdownSubtype()}e.actionMenu({templateID:t,selectedAction:n}).on("actionMenu.actionSelected",function(e){i(e.action)})},_updateCols:function(e){var t=$.extend({},this.model.get("answer_options")),i=t.cols.length,n=[],a,o;if(parseInt(e,10)===i){return}for(o=0;o<e;o++){if(t.cols.length>o){a=t.cols[o]}else{a=this._getDefaultColumn();a.weight=o+1}n.push(a)}$("#columnsWrap .choicesTable").trigger("bulkUpdate",{newCols:n});this._updateDropdownNumber()},_updateSubtype:function(e){var t=$.extend({},this.model.get("display_options"));if(e===t.display_subtype){return}t.display_subtype=e;this.model.set("display_options",t)},_updateDropdownNumber:function(){var e=this.model.get("answer_options").cols.length;this._scaleDropDown.find(":first-child").text(e)},_updateDropdownSubtype:function(){var e=this.model.get("display_options").display_subtype,t=CREATE.Translations.get("emojis"),i=t[e].singular["default"],n=this._defaultColors[e],a=this._shapeDropDown.find("span:first-child");a.text(i);this.$el.find(".emoji-border, .emoji-color").removeClass("star smiley heart thumb").addClass(e);if(this._initDropdowns){this._updateColor(n);this.$el.find(".emoji-color-picker").spectrum("set",n)}},_getDefaultColumn:function(){return{description:"",id:null,is_na_col:false,position:null,text:"",type:"col",visible:true}}});CREATE.views.StarLabelCheckBox=CREATE.views.EditorBase.extend({el:"#ratingScaleSetting",events:{"change #ratingLabel":"_toggleRatingLabels"},initialize:function(e){this.parent=e.parent;this.render()},render:function(){if(this._hasLabelsOrCustomWeights()){this.$el.find("#ratingLabel").prop("checked",true);this._toggleRatingLabels()}},preSave:function(){var e=this.$el.find("#ratingLabel").prop("checked"),t;if(!e){t=$.extend({},this.model.get("answer_options"));t.na_col=null;t.cols.forEach(function(e,t){e.text="";e.weight=t+1});this.model.set("answer_options",t)}},_hasLabelsOrCustomWeights:function(){var e=this.model.get("answer_options"),t=false;e.cols.forEach(function(e,i){if(e.text!==""||e.weight!==i+1){t=true}});return e.na_col||t},_toggleRatingLabels:function(){var e=this.$el.find("#ratingLabel").prop("checked");this.$el.toggleClass("expand",e)}});CREATE.views.EditorDescription=CREATE.views.EditorBase.extend({el:"#editQuestion .descriptionTable",events:{"blur #editDescription":"_handleOnBlur"},template:_.template($("#descriptionTemplate").html()),initialize:function(){this.render()},_handleOnBlur:function(){this.model.set("description",CREATE.utils.stripTags($("#editDescription").val()))},render:function(){var e=CREATE.Translations.get("description"),t={heading:e["default"],placeholder:e.placeholder["default"]};this.$el.html(this.template({model:this.model,displayData:t}))}});CREATE.QuestionEditor=function(){var e,t=false,i=$("#livePreview"),n=false,a=false,o="",s=false,r=false,l,d,u=false,c=" vertical menu rating single ranking multi numerical                           essay international us date_only time_only both descriptive_text image",f={rows:undefined,cols:undefined,other:undefined,otherTypeCommentOnly:undefined,otherTypeChoice:undefined,otherValidation:undefined,naCol:undefined,required:undefined,sorting:undefined,dateTimeValidation:undefined,validation:undefined,displayOptions:undefined,type:undefined,options:undefined},p={file_upload:"fileUpload"},g={single_choice:{vertical:"multipleChoice",vertical_two_col:"multipleChoice",vertical_three_col:"multipleChoice",horiz:"multipleChoice",menu:"dropdown"},multiple_choice:{vertical:"multipleChoice",vertical_two_col:"multipleChoice",vertical_three_col:"multipleChoice",horiz:"multipleChoice"},matrix:{rating:"matrix",single:"matrix",multi:"matrix",ranking:"ranking",menu:"matrix"},open_ended:{single:"singleTextbox",essay:"commentBox",multi:"multipleTextboxes",numerical:"multipleTextboxes"},demographic:"contactInformation",datetime:"dateTime",presentation:{descriptive_text:{random_assignment_true:"textABTest",random_assignment_false:"text"},image:{random_assignment_true:"imageABTest",random_assignment_false:"image"}}},h={Edit:"t1",Options:"t2",Logic:"t3",Move:"t4",Copy:"t5"},m={EditorDemographic:undefined,EditorTitle:undefined,EditorQuestionBank:undefined,EditorMultipleChoiceToggle:undefined,EditorMultipleChoiceIndicators:undefined,EditorRows:undefined,EditorToggleNumerical:undefined,EditorToggleDateTime:undefined,EditorDateTimeError:undefined,EditorColumns:undefined,EditorColChoices:undefined,EditorMatrix:undefined,EditorRequired:undefined,EditorLayout:undefined,EditorSort:undefined,EditorPlacement:undefined,EditorValidation:undefined,EditorOther:undefined,EditorLogic:undefined,EditorRandomAssignment:undefined,EditorNickname:undefined,EditorPresentationImage:undefined,EditorPresentationText:undefined,EditorPiping:undefined,EditorNACol:undefined,EditorFunneling:undefined,EditorQuestionType:undefined,EditorSlider:undefined,EditorSliderAdjustment:undefined,EditorSliderHideInputBox:undefined,EditorStar:undefined,EditorDescription:undefined,EditorUploadFileTypes:undefined,EditorFileUploadValidation:undefined,EditorQuiz:undefined},v=["EditorTitle","EditorQuestionBank","EditorRows","EditorOther","EditorRequired","EditorLayout","EditorSort","EditorPlacement","EditorLogic","EditorMultipleChoiceToggle","EditorMultipleChoiceIndicators","EditorPiping","EditorRandomAssignment","EditorFunneling","EditorQuestionType","EditorQuiz"],E=["EditorTitle","EditorQuestionBank","EditorRows","EditorRequired","EditorPlacement","EditorToggleNumerical","EditorValidation","EditorSort","EditorPiping","EditorRandomAssignment","EditorFunneling","EditorQuestionType"],C=["EditorTitle","EditorQuestionBank","EditorRequired","EditorPlacement","EditorRows","EditorToggleDateTime","EditorSort","EditorDateTimeError","EditorPiping","EditorRandomAssignment","EditorQuestionType"],q=["EditorTitle","EditorQuestionBank","EditorRequired","EditorPlacement","EditorDemographic","EditorPiping","EditorRandomAssignment"],b=["EditorTitle","EditorQuestionBank","EditorRows","EditorColumns","EditorRequired","EditorPlacement","EditorOther","EditorSort","EditorMultipleChoiceToggle","EditorMatrix","EditorNACol","EditorPiping","EditorRandomAssignment","EditorLogic","EditorFunneling","EditorQuestionType"],y={single_choice:{vertical:v,vertical_two_col:v,vertical_three_col:v,menu:["EditorTitle","EditorQuestionBank","EditorRows","EditorOther","EditorRequired","EditorSort","EditorPlacement","EditorLogic","EditorPiping","EditorRandomAssignment","EditorFunneling","EditorQuestionType","EditorQuiz"],horiz:v},open_ended:{single:["EditorTitle","EditorQuestionBank","EditorRequired","EditorPlacement","EditorValidation","EditorPiping","EditorRandomAssignment","EditorQuestionType"],essay:["EditorTitle","EditorQuestionBank","EditorRequired","EditorPlacement","EditorPiping","EditorRandomAssignment","EditorQuestionType"],multi:E,numerical:E,file_upload:["EditorTitle","EditorRequired","EditorPlacement","EditorFileUploadValidation","EditorPiping","EditorRandomAssignment","EditorDescription","EditorUploadFileTypes"]},datetime:{date_only:C,time_only:C,both:C},demographic:{us:q,international:q},matrix:{single:b,multi:b,menu:["EditorTitle","EditorQuestionBank","EditorRows","EditorColumns","EditorColChoices","EditorRequired","EditorPlacement","EditorOther","EditorSort","EditorMatrix","EditorPiping","EditorRandomAssignment","EditorQuestionType"],rating:b,ranking:["EditorTitle","EditorQuestionBank","EditorRows","EditorRequired","EditorPlacement","EditorSort","EditorNACol","EditorPiping","EditorRandomAssignment","EditorFunneling","EditorQuestionType"],star:["EditorTitle","EditorQuestionBank","EditorRows","EditorColumns","EditorNACol","EditorPiping","EditorOther","EditorMatrix","EditorLogic","EditorStar","EditorPlacement","EditorRequired","EditorRandomAssignment","EditorQuestionType"]},multiple_choice:{vertical:v,vertical_two_col:v,vertical_three_col:v,horiz:v},presentation:{descriptive_text:["EditorPlacement","EditorRandomAssignment","EditorNickname","EditorPresentationText","EditorQuestionBank","EditorPiping"],image:["EditorPlacement","EditorRandomAssignment","EditorNickname","EditorPresentationImage","EditorPiping"]},slider:{single:["EditorTitle","EditorQuestionBank","EditorPiping","EditorSliderAdjustment","EditorRequired","EditorRandomAssignment","EditorSlider","EditorQuestionType","EditorSliderHideInputBox"]}};function T(e){var t=R(e);if(e.hasClass("disabled")){return}w(t)}function w(e){var t=$("#editQuestion");if(e===r){return}t.addClass(e).removeClass(r);if(r!==false){t.trigger(r+"hidden")}r=e;t.trigger(e+"visible")}function R(e){var t=e.attr("class");t=t.split(" ");return t[0]}function A(){var e=$("#editQuestion");if(e.hasClass("t2")){return"Options"}if(e.hasClass("t3")){return"Logic"}if(e.hasClass("t4")){return"Move"}if(e.hasClass("t5")){return"Copy"}return"Edit"}function S(){var t=$("#editQuestion"),i=$("#editTitle"),n=CREATE.Rte.findRTEs(t),a=t.find("[data-warning-id=stripHtml]"),o=$("#advancedContentMessage"),s,r=$("#htmlOptOutLink");n.each(function(e,t){CREATE.Rte.destroyRTE(t.id)});t.toggleClass("fullEditor",!SM.Browser.isOldIE);n.each(function(t,i){var n=$(i),s,l,d,u=CREATE.Rte.getContentElements(n),c=false,f=false,p=false;if(n.html().length===0){n.closest(".rteToolbarContainer").addClass("empty")}_.each(u,function(t){if(!c&&CREATE.Rte.containsDisallowedContent(t)){a.removeClass("hide");r.attr("href",r.attr("href")+"&question_id="+CREATE.QuestionEditor.question.id);c=true}if(!f&&e.get("is_in_rollout")&&CREATE.Rte.containsAdvancedContentTags(t)){o.removeClass("hide");f=true}if(!p&&CREATE.Rte.containsMediaTags(t)){s=CREATE.QuestionEditor.question.get("type");l=n.attr("data-rte");d=CREATE.Rte.getRTEOptions(s,l);CREATE.Rte.initRTE(n,d);p=true}})});s=CREATE.Rte.getRTEOptions(CREATE.QuestionEditor.question.get("type"),i.attr("data-rte"));if(!CREATE.QuestionEditor.question.isBanked()){if(SM.Browser.isOldIE){CREATE.Rte.initSimpleEditor(i,s)}else{CREATE.Rte.initRTE(i,s)}}t.on("focus",".rte",function(e){var t=$(e.target),i,n,a;if(t.hasClass("mce-content-body")||t.prop("disabled")){return}i=CREATE.QuestionEditor.question.get("type");n=t.attr("data-rte");a=CREATE.Rte.getRTEOptions(i,n);if(SM.Browser.isOldIE){CREATE.Rte.initSimpleEditor(t,a)}else{CREATE.Rte.initRTE(t,a)}}).on("blur",".rte",function(e){var t=$(e.target),i,n,a;if(SM.Browser.isOldIE){n=CREATE.QuestionEditor.question.get("type");a=t.attr("data-rte");i=CREATE.Rte.getRTEOptions(n,a);CREATE.Rte.removeSimpleEditor(t,i)}});o.on("click",function(e){e.preventDefault();CREATE.Rte.openAdvancedRTE(e,n.first().attr("id"))});t.on("click","[data-toolbar] .placeholder",function(e){var t=$(e.target).closest("[data-toolbar]").find(".rte");CREATE.Rte.focusRTE(t.attr("id"))})}function x(e){var t=$.extend({questionId:null,tab:"Edit",fromTypeSwitch:false},e),i=t.questionId?$("#question-field-"+t.questionId):$("#question-field-None"),n=$("#livePreview"),a;if(!CREATE.survey.hasPermission("edit")){return}CREATE.pages.getQuestion(t.questionId,true).done(function(e){var o=CREATE.QuestionEditor.isNewQuestion(e.id);s=P(i);i.addClass("loading");CREATE.QuestionEditor.question=e;if(!t.fromTypeSwitch){CREATE.QuestionEditor.originalQuestionData=e.toJSON();CREATE.QuestionEditor.originalElementClasses=s.attr("class")}i.removeClass("loading");M(e);O(i);a=$("#editQuestion");S();a.find('[data-root-answer-open-ended="true"]').text(CREATE.Translations.get("funneled_other_answer")["default"]);w(h[t.tab]);Q();if(o){k(a)}a.find(".q").popout();__UI.scrollToElement(i);if(!o&&!e.hasResponses()){e.getHasResponses().done(function(e){if(e.has_responses){i.addClass("has_responses");n.trigger("has_responses_trigger")}a.trigger("questionReady")})}else{a.trigger("questionReady")}})}function k(e){e.find("[data-tab=logic] a, [data-tab=move] a, [data-tab=copy] a").addClass("disabled").each(function(){var e=$(this).parent("[data-tab]").data("tab");$(this).attr({title:CREATE.Translations.get("tooltips","defaults")[e]["default"],"sm-tooltip-side":"bottom"})})}function P(e){var t=e.attr("class").match(/question-[a-zA-Z]+[\-_a-zA-Z0-9]*/g),i,n=$.trim(e.html());if(n.length){o=e.html()}e.data("questionLayout",e.attr("style")||"").attr("style","");e.removeClass("loading").removeClass("question").addClass("editing");e.find("iframe").hide();e.html($("#editQuestionFullContainer").html());CREATE.utils.addIds(e);i=$("#editQuestion");$.each(t,function(e,t){i.addClass(t.replace("question-","editor-"))});return e}function M(e){var t=D(e),i=$("#editQuestionContentContainer"),n=i.find("[data-editquestion~="+t+"]"),a;if(e.isBanked()){a=i.find("[data-editquestion~=questionBank]");$("#editQuestionContent").html(a.html());$("#editQuestion [data-id=editQuestionBankContent]").html(n.html())}else{$("#editQuestionContent").html(n.html())}CREATE.utils.addIds($("#editQuestionContent"))}function D(e){var t=e.get("type"),i=e.hasRandomAssignment(),n,a,o=e.get("display_options");n=g[t.family];if(typeof n==="string"){return n}else{a=n[t.subtype];if(o&&o.display_type){return p[o.display_type]||o.display_type}else if(typeof a==="string"){return a}else{return a["random_assignment_"+i]}}}function I(e,t){var n=$("#editQuestion").closest(".qn"),a=CREATE.QuestionEditor.question.id;CREATE.pages.getQuestion(a,true).done(function(e){var o=t.json,l=e.getFunnelSenderIds(),d=e.getPage();L(e.toJSON(),l,[]);z({mode:"cancel"});d.replaceQuestion(a,o);CREATE.utils.replaceQuestionMarkup(n,$(t.markup));i.trigger("previewChanged");s=false;r=false;CREATE.Ajax.loadQuestionHistory()})}function L(e,t,i){var n=new CREATE.models.Question(e),a=t||CREATE.utils.getQuestionElForId(n.id).data("removedSenders")||[],o=i||n.getFunnelSenderIds();if(a.length<1&&o.length<1){return}CREATE.survey.updateLocalFunnels(n.id,a,o);if(CREATE.survey.isSinglePageMode()){CREATE.pages.collapsePagesBeforePage(n.get("page_id"));return}CREATE.survey.removeReceiverFromFunnelSenders(n.id,a);CREATE.survey.addReceiverToFunnelSenders(n.id,o)}function F(e){var t=CREATE.survey.getFunnelReceiverIds([e.id]);if(t.length<1){return}if(CREATE.survey.isSinglePageMode()){CREATE.pages.collapsePagesAfterPage(e.page_id);return}CREATE.Ajax.getQuestions(t).done(function(e){var t=e.questions,n=e.markup_map;$.each(t,function(e,t){var i=CREATE.utils.getQuestionElFromContainer(n[t.id]),a=CREATE.utils.getQuestionElForId(t.id),o=a.hasClass("editing"),s,r=CREATE.pages.get(t.page_id);r.replaceQuestion(t.id,t);if(a.hasClass("has_responses")){i.addClass("has_responses")}i.find(".funnel-text-open-ended").text(CREATE.Translations.get("funneled_other_answer")["default"]);if(o){s=A();CREATE.QuestionEditor.cancelEditMode(false);CREATE.utils.replaceQuestionMarkup(a,i);x({questionId:t.id,tab:s})}else{CREATE.utils.replaceQuestionMarkup(a,i)}});i.trigger("previewChanged")}).fail(function(){CREATE.Notifications.showErrorNotification()})}function Q(){s.on("click",".tabs a",function(e){e.preventDefault();T($(this))}).on("click",".cancel",function(e){e.preventDefault();CREATE.QuestionEditor.cancelEditMode(true);if(e.originalEvent){SM.Logger.enqueue({action_type:"click_editor_option_cancel",modified_options:u,ui_trigger:"editorOptions"})}}).on("click",".save",function(e){CREATE.QuestionEditor.saveEditMode({scroll:true});e.preventDefault()}).on("click",".add-another",function(e){var t=CREATE.QuestionEditor.question,i=t.getClassName(),n=t.get("position")+1,o=t.get("page_id");e.preventDefault();a=true;SM.Logger.enqueue({action_type:"click_editor_option_saveAndAddNew",modified_options:u,ui_trigger:"editorOptions"});CREATE.QuestionEditor.onAdd(i,n,o)})}function N(){$("#editQuestion").on("autocompleteElementSelected",I).on("questionReady",function(){var e=$("#editQuestion").find(".rte").filter(":visible").first();if(e.length>0&&!s.hasClass("has_responses")){CREATE.Rte.focusRTE(e.attr("id"))}})}function B(){$("#editQuestion").on("click",'[data-tab-panel="options"] fieldset',function(e){var t=$(e.target),i;if(t.is("textarea, select, input")){u=true;i=t.attr("data-id");if(i!==undefined){i=i.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()});SM.Logger.enqueue({action_type:"click_editor_option_"+i,ui_trigger:"editorOptions"})}}})}function U(){if(s){s.find(".save").prop("disabled",false).removeClass("disabled");s.find(".add-another").prop("disabled",false).removeClass("disabled")}t=false}function O(e){var t=CREATE.QuestionEditor.question,i=CREATE.QuestionEditor.getViewsForType(t.get("type"),t.get("display_options"));if(t.isSlider()){$("#editQuestion").attr("display-type","slider");$("#editQuestion").parent().attr("display-type","slider")}N();B();$.each(i,function(e,i){CREATE[i]=new CREATE.views[i]({model:t});m[i]=CREATE[i]});l=new CREATE.views.EditorMove({model:t});d=new CREATE.views.EditorCopy({model:t});if($.inArray("EditorLogic",i)===-1){e.find("[data-tab=logic] [data-type=tab]").hide()}}function z(e){var t=CREATE.QuestionEditor.question,n=CREATE.QuestionEditor.getViewsForType(t.get("type"),t.get("display_options"));$.each(n,function(t,i){var n=m[i];if(n.preRemove){n.preRemove(e.mode)}});i.trigger("closeEditMode");$.each(n,function(e,t){m[t].remove()});l.remove();d.remove();s.off("click");CREATE.Rte.findRTEs($("#editQuestion")).each(function(e,t){CREATE.Rte.destroyRTE(t.id)});CREATE.QuestionEditor.question=undefined;if(e.mode!=="switch"){CREATE.QuestionEditor.originalQuestionData=undefined;CREATE.QuestionEditor.originalElementClasses=undefined;$.each(f,function(e){f[e]=undefined})}}function V(){var e=CREATE.QuestionEditor.question,t=CREATE.QuestionEditor.getViewsForType(e.get("type"),e.get("display_options"));$.each(t,function(e,t){var i=m[t];if(i.preSave){i.preSave()}})}function H(){var e=true,t=CREATE.QuestionEditor.question,i=CREATE.QuestionEditor.getViewsForType(t.get("type"),t.get("display_options"));$.each(i,function(t,i){var n=m[i],a;if(n&&n.validate){a=n.validate();e=a&&e}});return e}function j(t,i){var a,o=$("#dragLoading");if(!__UI.handleQuestionLimit(e,1)){o.remove();return}n=true;if(CREATE.QuestionEditor.isOpen()){a=CREATE.QuestionEditor.saveEditMode({afterSaveCallback:i});if(!a){o.remove();n=false}}else{i()}}function W(e,t,o){var s=$("#dragLoading"),r=CREATE.utils.getQuestionElFromContainer(e.markup),l=e.json;r.data("question-is-new",t);if(s.length){CREATE.utils.replaceQuestionMarkup(s,r)}else if(a){CREATE.utils.insertQuestionMarkup(l.page_id,o,r)}else{CREATE.utils.appendQuestionMarkup(l.page_id,r)}CREATE.pages.getQuestion(l.id).done(function(e){$("#livePreview").trigger("questionAdded",[e])});__UPGRADE.handleUpgradeState();i.trigger("previewChanged");if(t){CREATE.utils.handleOpenEditors(function(){x({questionId:l.id,tab:"Edit"})})}__UI.scrollToElement(r);n=false;a=false}function G(e,t){var o,s,r,l,d,u;for(u=0;u<e.length;u++){o=e[u];s=CREATE.utils.getQuestionElFromContainer(o.markup);r=o.json;d=r.page_id;l=s.closest(".question-row");if(r.position===1){$("#pageid-"+d+" .questions").prepend(l)}else{$("#pageid-"+d+" .questions .question-row").eq(r.position-2).after(l)}}if(r){CREATE.pages.getQuestion(r.id).done(function(e){$("#livePreview").trigger("questionAdded",[e])})}if(s&&r&&r.id&&t){s.data("question-is-new",true);CREATE.utils.handleOpenEditors(function(){x({questionId:r.id,tab:"Edit"})})}i.trigger("previewChanged");__UI.scrollToElement(s);n=false;a=false}function K(e,t,a){if(!CREATE.QuestionEditor.question){$("#dragLoading").remove();n=false;return}var o=CREATE.QuestionEditor.question.id,l=$("#editQuestion .pipingMessage"),d,u,c,f;l.addClass("hide");z({mode:"save"});d=CREATE.utils.getQuestionElFromContainer(e.markup);d.data("question-is-new",false);if(CREATE.stepName==="draft"&&!d.find(".question-actions").length){f=$("#graveyard").find(".question-actions").clone();f.insertBefore(d.find(".indicators"))}if(e.advanced_logic){CREATE.survey.set("advanced_logic",e.advanced_logic)}if(e.page_action==="split"){CREATE.survey.reload(e.survey_json);$("#livePreview").trigger("rerenderPage",e)}else{u=e.json;c=CREATE.pages.get(u.page_id);L(u);F(u);c.replaceQuestion(o,u);d.addClass("edited");if(s.hasClass("has_responses")){d.addClass("has_responses")}CREATE.utils.replaceQuestionMarkup(s,d);CREATE.pages.getQuestion(u.id).done(function(e){i.trigger("questionSaved",[e])})}if(e.is_quiz_mode!==undefined){CREATE.QuizWarning.toggleSurveyQuizMode(e.is_quiz_mode)}$("#create").trigger("quizWarningQuestionCheck");$("#progressBarWithLogicAlert").trigger("toggleLogicApplied");if(a&&e.page_action!=="split"){__UI.scrollToElement(d,function(){d.removeClass("edited")})}else{d.removeClass("edited")}i.trigger("previewChanged");s=false;r=false;CREATE.Ajax.loadQuestionHistory();if(t){t()}ce()}function X(e){var t=["PipeToMissingQuestionException","PipeToSelfException","PipeFromFutureQuestionException","PipeFromMultiAnswerException","PipeFromRandomizedPageException","PipeToRandomizedPageException","PipeFromSamePageException","PipeLimitException","CannotPipeFromAnyQuestionsException","MalformedAdvancedPipingExpressionException","CannotUseAdvancedPipingException","CannotUseExtendedPipingException","AdvancedPipingHasHtmlException","UnsavedBeforePipingException"],i=["QuestionPerPageLimitException","QuestionPerSurveyLimitException","FileUploadQuestionPerSurveyLimitException"],o=e.appError.name;if($.inArray(o,t)>-1){$("#editQuestion .pipingMessage").removeClass("hide").find("p").first().html(CREATE.Translations.get("piping","errors")[o].message)}else if($.inArray(o,i)>-1){CREATE.Notifications.showErrorNotification({messageKey:o,showErrorDuration:CREATE.limitErrorNotificationDuration});$("#dragLoading").remove();n=false;a=false}else{CREATE.Notifications.showErrorNotification({messageKey:"Exception"})}}function Y(e,t){t.set("heading",e.heading)}function J(e,t){var i=e.common_name,n=t.attributes.common_name,a=CREATE.models.Question.supportsQuizMode(i),o=CREATE.models.Question.supportsQuizMode(n),s=e.options,r=f.options;if(o){if(s){if("forced_ranking"in s){delete s.forced_ranking}t.set("options",s)}else if(!a&&r){if("forced_ranking"in r){delete r.forced_ranking}t.set("options",f.options)}}if(s!==undefined){f.options=s}}function Z(e,t){var i=e.answer_options,n=_.extend({},t.get("answer_options")),a=i.rows,o=f.rows,s,r=t.attributes.common_name,l;if("rows"in n){if(a!==undefined){s=$.extend(true,[],a);if(!CREATE.models.Question.supportsQuizMode(r)){s.forEach(function(e){delete e.options})}else{ee(s)}}else if(o!==undefined){s=o;if(CREATE.models.Question.supportsQuizMode(r)){ee(s)}}l=_.some(s,function(e){return e.text.length!==0});if(l){if(t.get("common_name")==="dropdown"){s=_.map(s,function(e){if(e){e.text=CREATE.Rte.stripRtlWrapper(e.text)}return e})}n.rows=s;t.set("answer_options",n)}}if(a!==undefined){f.rows=a}}function ee(e){e.forEach(function(e){if(!e.options){e.options={quiz_options:{score:0}}}})}function te(e,t){var i=e.answer_options,n=_.extend({},t.get("answer_options")),a=t.isMenuMatrix(),o=e.common_name==="ranking",s=f.cols,r,l,d;if(!o){r=i.cols}l=r!==undefined?r:s;if(l===undefined){return}d=$.extend(true,[],l);if("cols"in n){ae(a,d);n.cols=d}
if(r!==undefined&&!o){f.cols=r}t.set("answer_options",n)}function ie(e,t){var i=e.answer_options,n=_.extend({},t.get("answer_options")),a=i.other,o=i.other_type,s=e.validation,r=a!==undefined?a:f.other,l=t.allowsOtherAsAnswerOption()?f.otherTypeChoice:f.otherTypeCommentOnly,d=s&&o?s:f.otherValidation;if(t.allowsOtherOptions()&&r!==undefined){if(!t.isSlider()){t.set("validation",d)}n.other_type=l;n.other=r;if(t.get("type").family==="matrix"){delete n.other.blank_error_message;n.other_type="comment";n.other.apply_all_rows=false}t.set("answer_options",n)}if(a!==undefined){f.other=a;if(CREATE.models.Question.allowsOtherAsAnswerOption(e.common_name)){f.otherTypeChoice=o}else{f.otherTypeCommentOnly=o}if(o!==undefined){f.otherValidation=s}}}function ne(e,t){var i=e.answer_options,n=_.extend({},t.get("answer_options")),a=i.na_col,o=f.naCol,s=a!==undefined?a:o;if(s===undefined){return}if("na_col"in n){n.na_col=s;t.set("answer_options",n)}if(a!==undefined){f.naCol=a}}function ae(e,t){if(e){_.each(t,function(e){e.col_choices=[]})}else{_.each(t,function(e){delete e.col_choices})}}function oe(e,t){var i=e.required,n=t.get("required"),a=f.required,o=i,s,r,l;if(o===undefined){return}if(!t.allowsRequiredType()&&o){o={text:o.text}}else if(o&&!o.type){o.type=a&&a.type?a.type:"at_least";if(_.contains(["at_least","at_most","exactly"],o.type)){o.amount=a&&a.amount?parseInt(a.amount,10):1}if(o.type==="range"){s=t.get("answer_options").rows.length;r=s>=3?3:s;l=a&&a.max&&a.max<=r;o.min=a&&a.min?parseInt(a.min,10):1;o.max=l?parseInt(a.max,10):r}}if(n!==undefined){t.set("required",o)}if(i!==undefined){f.required=i}}function se(e,t){var i,n=e.sorting,a=t.hasSortingOption();if(a&&n){i=n}else if(!a&&n){f.sorting=n;i=null}else if(a&&!n){i=f.sorting}t.set("sorting",i)}function re(e,t){var i=e.validation,n=f.validation,a=f.sliderValidation,o=f.dateTimeValidation,s,r=e.common_name==="single_textbox"||e.common_name==="multiple_textboxes",l=t.get("common_name")==="date_time",d=e.common_name==="date_time",u=e.display_options&&e.display_options.display_type==="slider",c=t.isSlider();if(c){s=a?a:t.get("validation")}else if(l){s=o?o:t.get("validation")}else if(d){s=n}else{s=r?i:n}if(t.get("common_name")==="single_textbox"&&s&&s.type==="integer"&&s.min===undefined&&s.max===undefined){s.min="0";s.max="100"}if(r){f.validation=i}else if(d){f.dateTimeValidation=i}else if(u){f.sliderValidation=i}if(t.allowsValidation()){t.set("validation",s)}}function le(e,t){var i=e.display_options,n,a=t.get("display_options");if(i&&!f.displayOptions){f.displayOptions=i}n=f.displayOptions;if(n&&a&&n.display_type===a.display_type){t.set("display_options",n)}}function de(e,t){var i=e.type,n,a=t.get("type"),o=t.get("common_name")==="date_time",s=e.common_name==="date_time";if(!o&&!s){return}if(o){n=f.type?f.type:a;t.set("type",n)}if(s){f.type=i}}function ue(e,t){var i=CREATE.QuestionEditor.isNewQuestion(e.id),n=t.get("answer_options"),a=e.answer_options,o=a.rows&&!n.rows,s=a.cols&&!n.cols,r=a.other&&!n.other,l=a.na_col&&!n.na_col,d=e.sorting&&!t.get("sorting"),u=e.display_options&&!t.get("display_options"),c=e.validation&&!t.get("validation");if(i){return false}else if(o||s||r||l||d||u||c){return true}else if(t.isStarRating()&&a.rows){return true}else{return false}}function ce(){i.find("[data-question-slider]").sliderQuestion()}return{question:undefined,originalQuestionData:undefined,init:function(){e=CREATE.user;SM.Tooltips.enable({selector:"[data-tab] a[title][sm-tooltip-side]",delay:500})},onAdd:function(e,t,i){var o;if(!n){if(a&&CREATE.QuestionEditor.question){o=CREATE.QuestionEditor.question.get("position")}j("redirect",function(){var n=CREATE.pages.get(i||CREATE.survey.pageInView),a=e.indexOf("Question")>0?e:e+"Question",s=new CREATE.models[a];s.set({page_id:n.id,lang_id:$("#surveyLanguage :selected").val(),position:t||n.questionCount()+1});s.getRenderedHtml().done(function(e){n.addQuestionLocal(e.json,e.json.position);W(e,true,o)}).fail(X)})}},onDragAdd:function(e,t){var n=typeof t==="object"?t.type:e.attr("rel"),a,o,s=typeof t==="object"?t.question:null,r=CREATE.utils.getPageIdForEl(e),l=e.prevUntil(".drag").length+1;$("body").removeClass("ds"+n);e.replaceWith('<div id="dragLoading">'+CREATE.Translations.get("loading","default")["default"]+"</div>");if(n.indexOf("-")>-1){a=n.split("-");n=a[0];o=a[1]}if(n==="QB"){CREATE.QuestionEditor.onAddFromQuestionBank({name:o,pageId:r,position:l,qbData:s})}else if(n==="Restore"){CREATE.QuestionEditor.onAddFromDeleted(s,r,l)}else if(n==="PageBreak"){i.trigger("splitPage",[r,l])}else if(n){CREATE.QuestionEditor.onAdd(n,l,r)}},onAddFromQuestionBank:function(e){var t=(e.pageId||CREATE.survey.pageInView).toString(),i=CREATE.pages.get(t),a=e.name==="net_promoter_score"?"redirect":"QBCarousel",o=e.position||$("#pageid-"+t+" .qn").length+1;if(!n){j(a,function(){if(e.name){i.addBankedQuestionByName({name:e.name,page_id:t,position:o}).done(function(e){W(e,true);SM.Logger.enqueue(SM.Logger.setQbqLogging(e,"builder"))}).fail(X)}else{i.addBankedQuestion({questions:[e.qbData],page_id:t,position:o}).done(function(e){W(e,true);SM.Logger.enqueue(SM.Logger.setQbqLogging(e,"builder"))}).fail(X)}})}},onAddMultiFromQuestionBank:function(e){var t=CREATE.survey;j("redirect",function(){t.addMultiBankedQuestions({questions:e.qbData}).done(function(t){var i;G(t,e.edit);for(i=0;i<t.length;i++){SM.Logger.enqueue(SM.Logger.setQbqLogging(t[i],"modal"))}}).fail(X)})},onAddFromDeleted:function(e,t,i){if(!n){j("showCarousel",function(){var t=t||CREATE.survey.pageInView,n=CREATE.pages.get(t);CREATE.survey.restoreQuestion(e,t,i||n.questionCount()+1).done(function(t){var i=t.json.options;W(t,false);if(t.json.is_slider){ce()}if(i&&i.quiz_options&&i.quiz_options.scoring_enabled){CREATE.QuizWarning.toggleSurveyQuizMode(true);$("#livePreview").trigger("quizChanged")}$("#create").trigger("questionRestored",e)}).fail(function(e){X(e);$("#create").trigger("questionRestoreFailed")})})}},switchQuestionType:function(e,t){var i=CREATE.QuestionEditor.question.getPage(),n=CREATE.QuestionEditor.question.toJSON(),a=s.attr("class").match(/question-[a-zA-Z]+[\-_a-zA-Z0-9]*/g).join(" ")+c,o={page_id:n.page_id,lang_id:n.lang_id,position:n.position,display_number:n.display_number,id:n.id},l=new CREATE.models[e](o).toJSON(),d=n.id,u={heading:Y,rows:Z,cols:te,other:ie,naCol:ne,required:oe,sorting:se,displayOptions:le,validation:re,type:de,options:J};z({mode:"switch"});i.replaceQuestion(d,l);CREATE.pages.getQuestion(d,true).done(function(e){$.each(u,function(t,i){i(n,e)});s.removeClass(a).addClass(t).closest(".questionContainer").attr("data-question-type",e.get("type").family+"_"+e.get("type").subtype);r=false;x({questionId:e.id,fromTypeSwitch:true});$("#switchQuestionTypeWarning").toggleClass("hide",!ue(n,e));if(e.isSlider()){$("#editQuestion").closest(".question-open-ended-single").attr("display-type","slider")}else{$("#editQuestion").closest(".question-open-ended-single").removeAttr("display-type")}SM.Logger.remoteLog({event:"switch_qtype",switch_from:n.common_name,switch_to:e.get("common_name"),question_state:CREATE.QuestionEditor.isNewQuestion(n.id)?"new":"saved",question_id:n.id},"info")})},saveEditMode:function(e){var i=CREATE.QuestionEditor.question,n,a=i.get("id"),o=CREATE.QuestionEditor.isNewQuestion(a),r=H(),l=$("#question-field-"+a),d,u,c=false,f=$.extend({afterSaveCallback:null,scroll:false},e);if(t){return}t=true;s.find(".save").prop("disabled",true).addClass("disabled");s.find(".add-another").prop("disabled",true).addClass("disabled");l.find("div.error.prompt").addClass("hide");if(r){V();if(i.isBanked()){d=m.EditorQuestionBank.getQuestionBankSaveData();u=i.updateQBQuestion(d).done(function(e){K(e,f.afterSaveCallback,f.scroll)}).fail(X)}else if(i.get("question_bank").isDisqualified){c=true;u=i.disqualifyQBQuestion().done(function(){i.update().done(function(e){K(e,f.afterSaveCallback,f.scroll)}).fail(X).always(function(){U()})}).fail(function(){CREATE.Notifications.showErrorNotification()})}else{if(o){n=i.getPage().questions;u=n.addNew(i).done(function(e){K(e,f.afterSaveCallback,f.scroll)}).fail(X)}else{u=i.update().done(function(e){K(e,f.afterSaveCallback,f.scroll)}).fail(X)}if(i.isSlider()){SM.Logger.logSaveSlider({question:i,isNewQuestion:o,isToggled:$("#editQuestion").find("#toggleSlider").is(":checked"),initPos:$("#sliderStartingPos").val()})}else if(i.isStarRating()){SM.Logger.logStarRating({question:i,action:"save_editor_star_rating_question"})}else if(i.isFileUpload()){SM.Logger.logFileUpload({question:i,action:"save_editor_file_upload_question"})}}u.always(function(){if(!c){U()}})}else{if(CREATE.QuestionEditor.question.hasLogic()){$("#editQuestion").removeClass("logic-range-overlap")}$("#question-field-"+a+" div.generalMessage").removeClass("hide");__UI.scrollToElement($("#question-field-"+a));U()}return r},autoSaveAndEdit:function(e,t){CREATE.utils.handleOpenEditors(function(){x({questionId:e,tab:t})})},cancelEditMode:function(e){var t,n=CREATE.QuestionEditor.question.id,a=CREATE.QuestionEditor.originalQuestionData;CREATE.pages.getQuestion(n,true).done(function(l){var d=CREATE.QuestionEditor.isNewQuestion(n);if(l&&a){if(a.common_name!==l.get("common_name")){s.removeClass().addClass(CREATE.QuestionEditor.originalElementClasses).closest(".questionContainer").attr("data-question-type",a.type.family+"_"+a.type.subtype)}a.has_responses=l.hasResponses();z({mode:"cancel"});t=CREATE.pages.get(a.page_id);t.replaceQuestion(a.id,a);if(!d){s.removeClass("editing").removeClass("loading").addClass("question");s.attr("style",s.data("questionLayout"));s.html(o);i.trigger("previewChanged");if(a.is_slider){ce()}}if(e){__UI.scrollToElement(s)}s=false;r=false}if(d){$("#livePreview").trigger({type:"newQuestionCancelled",question:l})}})},isOpen:function(){return!!$("#editQuestion").length},isNewQuestion:function(e){var t=CREATE.utils.getQuestionElForId(e);return t.data("question-is-new")},getViewsForType:function(e,t){if(t){var i=t.display_type;switch(i){case"emoji":return y.matrix.star;case"slider":return y.slider.single;case"file_upload":return y.open_ended.file_upload}}return y[e.family][e.subtype]},typeHasView:function(e,t,i){var n=CREATE.QuestionEditor.getViewsForType(e,i);return $.inArray(t,n)>-1}}}();CREATE.views.EditorUploadFileTypes=CREATE.views.EditorBase.extend({el:"#editQuestion .fileUploadTypesList",events:{"change [type=checkbox]":"_onAllowedFileTypeClick"},template:_.template("<%_.forEach(fileTypes, function (v, k) {%>"+"<label class='checkboxSetting'>"+"<input type='checkbox' data-id='fileType<%=k%>' value='<%=k%>' <% if (v.selected) { %> checked <% }  %> tabindex=1><%=v.display%>"+"</label>"+"<%})%>"),_allowedFileTypes:null,initialize:function(){this._setAllowedFileTypes();this.render()},render:function(){var e=this.model.get("display_options").custom_options,t,i;if(e.option_set&&e.option_set.length>0){for(t=0;t<e.option_set.length;t++){if(this._allowedFileTypes[e.option_set[t]]){this._allowedFileTypes[e.option_set[t]].selected=true}}}else{for(i in this._allowedFileTypes){this._allowedFileTypes[i].selected=true}this._updateUploadFileTypes()}this.$el.html(this.template({fileTypes:this._allowedFileTypes}))},validate:function(){var e=this.$el.find("input:checked").length>0,t=this.$el.closest(".answerTableFooter").find(".block");t.toggleClass("hide",e).toggleClass("error",!e);return e},_setAllowedFileTypes:function(){this._allowedFileTypes={pdf:{extensions:["pdf"],display:"PDF",selected:false},doc:{extensions:["doc","docx"],display:"DOC, DOCX",selected:false},png:{extensions:["png"],display:"PNG",selected:false},jpg:{extensions:["jpg","jpeg"],display:"JPG, JPEG",selected:false},gif:{extensions:["gif"],display:"GIF",selected:false}}},_onAllowedFileTypeClick:function(e){var t=$(e.target),i=t.val();if(this._allowedFileTypes[i]){this._allowedFileTypes[i].selected=t.is(":checked");this._updateUploadFileTypes()}},_updateUploadFileTypes:function(){var e=[],t,i;_.each(this._allowedFileTypes,function(t){if(t.selected){for(i=0;i<t.extensions.length;i++){e.push(t.extensions[i])}}});t=$.extend({},this.model.get("display_options"));t.custom_options={option_set:e};this.model.set("display_options",t)}});CREATE.views.EditorFileUploadValidation=CREATE.views.EditorBase.extend({el:"#fileValidate",_$validationMsgField:null,_previousOptionSet:[],_defaultMessage:null,_fileTypeWeightMap:{pdf:1,doc:2,docx:3,png:4,jpg:5,jpeg:6,gif:7},events:{"blur #fileTypeValidationText":"_saveChanges"},initialize:function(){this._initMembers();this.render();this._initHandlers()},_initMembers:function(){this._$validationMsgField=this.$el.find("[data-id=fileTypeValidationText]");this._defaultMessage=this._$validationMsgField.attr("data-default");if(this.model.get("display_options").custom_options){this._previousOptionSet=this.model.get("display_options").custom_options.option_set}},_initHandlers:function(){this.listenTo(this.model,"change:display_options",this._saveChanges);this.listenTo(this.model,"change:validation",this.render)},render:function(){var e=this.model.get("validation");if(e&&e.text){this._$validationMsgField.val(e.text)}else{this._$validationMsgField.val(this._defaultMessage.replace("{1}",""))}},validate:function(){var e=this.$el.find("[data-id=fileTypeValidationText]"),t=CREATE.utils.stripTags(e.val()),i=t.length!==0;e.closest(".block").toggleClass("error",!i);return i},_saveChanges:function(){var e,t=this.model.get("display_options").custom_options,i,n=CREATE.utils.stripTags(this._$validationMsgField.val()).trim(),a;if(t&&$.isArray(t.option_set)){a=this._previousOptionSet.sort(this._fileTypeRankSort.bind(this)).join(", ").toUpperCase();if(n===this._defaultMessage.replace("{1}",a).trim()){i=t.option_set.sort(this._fileTypeRankSort.bind(this)).join(", ").toUpperCase();n=this._defaultMessage.replace("{1}",i)}}this._previousOptionSet=t.option_set;if(n){e={type:"file",text:n};this.model.set("validation",e)}},_fileTypeRankSort:function(e,t){return this._fileTypeWeightMap[e]-this._fileTypeWeightMap[t]}});CREATE.views.EditorQuiz=CREATE.views.EditorBase.extend({el:"#quizSetting",events:{"change #toggleQuizSetting":"_toggleQuizQuestion"},initialize:function(){var e=CREATE.survey.get("quiz_options").is_quiz_mode,t=this.model.id==="temp",i=this.model.isQuizEnabled(),n;n=e&&(t||i);this.$el.find("#toggleQuizSetting").prop("checked",n);this.$el.closest("#editQuestion").toggleClass("quiz-question",n);this._updateQuizOptions(n);$("#rows").trigger("toggleQuizUI",[n])},_updateQuizOptions:function(e){var t=$.extend({},this.model.get("options"));t.quiz_options={scoring_enabled:e};this.model.set("options",t)},_toggleQuizQuestion:function(){var e=this.$el.find("#toggleQuizSetting").prop("checked"),t=this.$el.closest("#editQuestion");this._updateQuizOptions(e);t.toggleClass("quiz-question",e);$("#rows").trigger("toggleQuizUI",[e]);SM.Logger.quizToggleScoreLogging({scoreEnabled:e,questionType:this.model.get("common_name")});if(t.hasClass("quiz-question")&&t.hasClass("piping-quiz-message")){SM.Logger.quizShowLogicWarning()}}});CREATE.Restore=function(){var e,t,i,n,a;function o(){a=true;e=$("#sidebar");t=$("#deletedQuestionList");i=$("#deletedQuestionList ul");n=$.trim(i.html());i.empty();u()}function s(){var e=$("#createAccordion").outerHeight(),i=e-41-10;t.css("height",e);t.find(".setting").css("height",i)}function r(){if(a){i.addClass("hide");t.spin({color:"#fff"});CREATE.Ajax.getDeletedQuestions().done(function(e){var t,a=new CREATE.collections.Questions(e.deleted_questions,{pageExpanded:false});f();a.each(function(e){var t=$(n).appendTo(i),a=e.get("date_modified")*1e3,o=CREATE.Date.prettyDateMessage(a,"deleted_at"),s=e.getHeading({truncate:50});t.attr("id","deleted-"+e.id);t.find("span.heading").html(s);if(o){t.find("span.date_modified var").html(o)}else{t.find("span.date_modified var").html("")}});t=$("#restoreQuestions");if(a.length>0&&t.hasClass("hide")){t.removeClass("hide").fadeIn();$("#deletedQuestionsNum").text(a.length.toString())}i.removeClass("hide");$("img.spinner").addClass("hide");c()}).fail(function(){CREATE.Notifications.showErrorNotification()}).always(function(){t.spin(false)})}}function l(e){return $(e).closest("li").attr("id").split("-")[1]}function d(e){var i=$("#deletedQuestionsNum"),n=parseInt(i.text(),10)+e;i.text(n);$("#noDeletedQuestions").toggleClass("hide",n>0);t.find(".setting").toggleClass("hide",n<=0)}function u(){$("#restoreQuestions").on("click",function(t){t.preventDefault();if(CREATE.survey.hasPermission("edit")){s();e.toggleClass("restore");if(e.hasClass("restore")){r()}else if(parseInt($("#deletedQuestionsNum").text(),10)===0){$("#restoreQuestions").fadeOut()}}});$("#closeRestore").on("click",function(t){t.preventDefault();e.removeClass("restore");if(parseInt($("#deletedQuestionsNum").text(),10)===0){$("#restoreQuestions").fadeOut()}});$("#create").on("afterResize afterScroll sticking unsticking",function(){setTimeout(function(){s()},50)}).on("refreshDeletedQuestions",function(){a=true;r()}).on("questionsDeleted",function(t,i){$("#restoreQuestions").removeClass("hide").fadeIn();d(i);if(e.hasClass("restore")){r()}}).on("questionRestored",function(e,t){var n=i.find("li#deleted-"+t).draggable("destroy");n.fadeOut(function(){$(this).remove();i.attr("data-restoring","false")});d(-1)}).on("questionRestoreFailed",function(){i.attr("data-restoring","false")});i.on("click","li",function(e){var t=l(e.target);e.preventDefault();if(i.attr("data-restoring")==="true"){return}i.attr("data-restoring","true");CREATE.utils.handleOpenEditors(function(){CREATE.QuestionEditor.onAddFromDeleted(t)})})}function c(){var e={cursor:"move",appendTo:"body",refreshPositions:false,helper:function(){return $("#dsDeletedQuestion").clone()},connectToSortable:"#livePreview .questions",start:function(e){$("#create").trigger("dragToAdd",{type:"Restore",question:l(e.target)})},stop:function(){$("#create").trigger("dragStop")}};i.find("li.dq-li").each(function(t,i){$(i).draggable(e)})}function f(){i.find("li.dq-li").draggable("destroy");i.empty()}o()}();function Create_UI(){var e=this,t,i,n=$("#create"),a=$("#sidebar"),o=$(".subhead"),s=$(".stick"),r=$("#ft"),l=$("body"),d=$(window),u=$("#scrollingNav"),c=u.offset().top,f=CREATE.utils,p,g;e.init=function(){g=CREATE.user;e.onResize();e.initIndicatorsHandler();e.initFooterHandler();e.initProgressBarHandler();e.initLogoHandler();e.footerCheck();e.sidetabs();CREATE.Keyboard.init();$(".q").popout();l.removeClass("block-ux");e.onScroll();e.onPrint();e.initSticky();e.specialBILogging();setTimeout(function(){e.initWelcome()},1e3);n.on("newCreateFeatureAdded",function(){$("#switchBack").addClass("hide")})};e.sidetabs=function(){$(".sidetab").sideTab({version:2})};e.initSticky=function(){if(s.length>0){s.each(function(e,t){$(t).data("pxWidth",Math.max(55,$(t).width()))})}e.stickyCheck()};e.stickyCheck=function(){if(d.scrollTop()>=c){s.each(function(e,t){$(t).css("width",$(t).data("pxWidth"))});l.addClass("sticky").css("margin-top","164px");$("#create").trigger("sticking")}else{l.removeClass("sticky").css("margin-top","");s.css("width","");if(s.length>0){s.each(function(e,t){$(t).data("pxWidth",Math.max(55,$(t).width()))})}$("#create").trigger("unsticking")}};e.resetStick=function(){if(s.length>0&&l.hasClass("sticky")){l.removeClass("sticky");s.each(function(e,t){$(t).attr("style","").data("pxWidth",Math.max(55,$(t).width()))});e.stickyCheck()}};e.footerCheck=function(){a.addClass("hide");if(d.height()>$("body").height()){r.addClass("fixedFooter")}else{r.removeClass("fixedFooter")}a.removeClass("hide")};e.initWelcome=function(){var e,t=f.getCookie("sm_create_tour"),i=!!t,n=g.get("preferences").hide_create_tour;if(n){return}if(i){g.setPreference("hide_create_tour",true);return}if(g.get("is_in_rollout")){e=SM.Views.create(SM.DialogView,{isModal:true,width:790,closeBtn:true,templateID:"welcome-dialog-template"});e.$el.on("dialog.afterOpen",function(){$("#btnCloseWelcomeDialog").on("click",function(){e.close()})});e.open()}g.setPreference("hide_create_tour",true)};e.scrollToElement=function(t,i){if(t){var n=false,a=false,o=false,s,r=l.hasClass("sticky")?73:102,u=d.scrollTop(),c=d.height(),f=t.offset().top+t.height(),p=c-r+u;if(f>=p){n=true;a=true;if(t.height()>=c){a=false;o=true}}if(t.offset().top-r<=u){n=true;o=true}if(a){s=f-c+(l.hasClass("sticky")?20:-10)}else if(o){s=t.offset().top-r}if(n){$("html, body").stop(true,true).animate({scrollTop:s},300,"",function(){e.footerCheck();if(i){i()}})}else{if(i){i()}}}};e.handleQuestionLimit=function(t,i){if(!t.canAddQuestions(i)){if(t.hasUpgradableQuestionLimit()){$("#deletedQuestionList ul").attr("data-restoring","false");__UPGRADE.handleUpgradeAction("showCarousel")}else{e.handleQuestionLimitDialog(i)}return false}return true};e.handleQuestionLimitDialog=function(e){var t=CREATE.survey.get("question_count");if(t+e<5e3){return}if(!p){p=SM.Views.create(SM.DialogView,{isModal:true,width:600,closeBtn:true,templateID:"question-limit-dialog-template"});p.$el.on("dialog.afterOpen",function(){$("#btnCloseQLimitDialog").on("click",function(){p.close()})})}p.open()};e.openPrintDialog=function(){if(!e.printDialog){e.printDialog=SM.Views.create(SM.DialogView,{isModal:true,width:600,closeBtn:true,templateID:"print-dialog"});if($("#printSurvey").hasClass("upgrade")){e.printDialog.$el.on("dialog.afterOpen",function(){$("#printSurveyForm").on("submit",function(t){t.preventDefault();e.printDialog.close();__UPGRADE.openUpgradeModal("upgradePrint")})});e.printDialog.$el.on("dialog.beforeClose",function(){$("#printSurveyForm").off()})}}e.printDialog.open()};e.onPrint=function(){$("#printSurvey").click(function(t){e.openPrintDialog();t.preventDefault();SM.Logger.enqueue({action_type:"click_print",ui_trigger:"printSurvey"})})};e.initIndicatorsHandler=function(){var e=$("#accLogic .press"),t=$("#livePreview");if(!CREATE.survey.hasPermission("edit")){$(".indicators").addClass("read-only")}t.on("click",".indicators > .question-random",function(e){var i=CREATE.utils.getPageIdForEl($(e.target));t.trigger("openQuestionRandom",[i])}).on("click",".indicators > .question-skip-logic",function(e){if(CREATE.survey.hasPermission("edit")){var t=$(e.target);t.closest(".qn").find("nav .btn.logic").trigger("click")}}).on("click",".indicators > .quota",function(){if(CREATE.survey.hasPermission("edit")){e.trigger("click");$("#quotasMasterToggle > a").trigger("click")}}).on("click",".indicators > .page-random",function(){t.trigger("openPageRandom")}).on("click",".indicators > .page-skip-logic",function(e){var i=CREATE.utils.getPageIdForEl($(e.target));t.trigger("openSkipLogic",[i])}).on("click",".indicators > .page-block",function(){if(CREATE.survey.hasPermission("edit")){e.trigger("click");$("#blockRandomizationMasterToggle > a").trigger("click")}}).on("click",".indicators > .quiz-question",function(){var e=$(this).closest(".qn");e.trigger("click");SM.Logger.quizIndicatorLogging()})};e.stopFooterFading=function(){$(".survey-footer").stop().removeClass("hideMessage").removeAttr("style");$(".optionFooter").off("click",e._stopFooterFading)};e.initFooterHandler=function(){if(!CREATE.survey.hasPermission("edit")){$(".survey-footer").addClass("read-only");return}$("#livePreview").on("click",".survey-footer",function(){if(!CREATE.survey.hasBrandRefreshTheme()){$("#accOptions .press").trigger("click")}}).on("click",".hideFooterBtn",function(){var t=$("#footer_enabledMasterToggle"),i=$(".survey-footer"),n=t.closest(".s1"),a;$("#createAccordion .done:visible").trigger("click");$("#accOptions .press").trigger("click");n.animate({scrollTop:t.offset().top-n.offset().top},500);t.addClass("highlight").find(".optionFooter").trigger("click");setTimeout(function(){t.removeClass("highlight")},750);i.addClass("hideMessage");setTimeout(function(){i.fadeOut(1e3,e.stopFooterFading)},9e3);$(".optionFooter").on("click",e.stopFooterFading)}).on("click",".survey-footer .closeButton",e.stopFooterFading).on("click",".survey-footer",function(e){if($(e.target).hasClass("hideFooterBtn")){SM.Logger.enqueue({action_type:"click_survey_editor_hide_footer",ui_trigger:"surveyEditorHideFooter"})}else{SM.Logger.enqueue({action_type:"click_survey_editor_edit_footer",ui_trigger:"surveyEditorEditFooter"})}})};e.initProgressBarHandler=function(){if(!CREATE.survey.hasPermission("edit")){$(".progress-container").addClass("read-only");return}$("#livePreview").on("click",".progress-container",function(){$("#accOptions .press").trigger("click");$("#progressBarMasterToggle > a").trigger("click")})};e._openLogoWaterpark=function(){$("#accOptions .press").trigger("click");$("#accOptions .optionLogo").trigger("click")};e.initLogoHandler=function(){if(!CREATE.survey.hasPermission("edit")){$(".top-logo-section, .bottom-logo-section, .logo-container, .addLogoHere").addClass("read-only");return}$("#livePreview").on("click",".addLogoHere",function(t){t.preventDefault();t.stopPropagation();if(!$(t.target).hasClass("upgrade-button")&&!$(t.target).hasClass("upgrade-logo")){e._openLogoWaterpark()}else{__UPGRADE.saveOpenSettingsAndRedirect($(t.target))}SM.Logger.enqueue({action_type:"click_survey_editor_add_logo",ui_trigger:"surveyEditorAddLogo"})}).on("click",".removeLogo",function(t){t.preventDefault();t.stopPropagation();e._openLogoWaterpark();$("#deleteLogo").trigger("click");SM.Logger.enqueue({action_type:"click_survey_editor_remove_logo",ui_trigger:"surveyEditorRemoveLogo"})}).on("click",".top-logo-section, .logo-container, .logo-cell, .editLogo, .sm-logo-container",function(t){t.preventDefault();t.stopPropagation();e._openLogoWaterpark();SM.Logger.enqueue({action_type:"click_survey_editor_edit_logo",ui_trigger:"surveyEditorEditLogo"})})};e.onResize=function(){if(SM.Browser.isIE8){d.one("resize",function(){if(d.height()!==e.winHeight||d.width()!==e.winWidth){e.winHeight=d.height();e.winWidth=d.width();e.afterResize()}setTimeout(function(){e.onResize()},100)})}else{d.resize(function(){e.afterResize()})}};e.onScroll=function(){d.scroll(function(){if(!l.hasClass("sticky")){e.stickyCheck()}e.afterScroll()})};e.afterResize=function(){clearTimeout(t);t=setTimeout(function(){e.footerCheck();e.resetStick();n.trigger("afterResize")},100)};e.afterScroll=function(){clearTimeout(i);i=setTimeout(function(){if(d.scrollTop()<=c){e.stickyCheck()}n.trigger("afterScroll");d.trigger("resize",["scroll"])},30)};e.specialBILogging=function(){$("#create").on("click","#print-dialog #printSurveyForm .dialog-body section label",function(e){var t=$(e.target);if(t.is("input")||t.is("select")){SM.Logger.enqueue({action_type:"click_print_dialog_"+$(this).find("[name]").attr("name"),ui_trigger:"printDialogOptions"})}}).on("click","#print-dialog #printSurveyForm button",function(e){var t=$(e.target).closest("form").find("section label").children(),i={action_type:"click_print_dialog_download_pdf",ui_trigger:"printDownloadPDF"};_.each(t,function(e){var t=$(e),n=t.attr("name").replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()});if(t.is("select")){i[n]=t.val().toLowerCase()}else if(t.is("input")){i[n]=t.prop("checked")}});SM.Logger.immediateLogThrottler(i)}).on("popout.opened",".q",function(e){SM.Logger.enqueue({action_type:"hover_step2_tooltip",tooltip_name:$(e.target).closest("[data-help]").attr("data-help"),ui_trigger:"step2Tooltip"})}).on("click",'.popout a[target="_blank"]',function(e){if(!$(this).closest("div").hasClass("sample-q")){SM.Logger.enqueue({action_type:"click_step2_tooltip_learn_more",tooltip_name:$(e.target).closest("[data-help]").attr("data-help"),ui_trigger:"step2TooltipLearnMore"})}}).on("click",".create-survey",function(e){SM.Logger.immediateLogThrottler({action_type:"click_step2_header_create_survey",ui_trigger:"step2HeaderCreateSurvey"})});$("#helpCenterTab").on("click",function(e){SM.Logger.enqueue({action_type:"hc_dialog_tab_click_step2",ui_trigger:"step2HelpCenterTabClick"})})}}CREATE.views.Tbyb=Backbone.View.extend({el:"#create",events:{questionSaved:"_onQuestionSettingsChange",questionDeleted:"_onQuestionSettingsChange",questionAdded:"_onQuestionSettingsChange",questionRandomizationUpdated:"_onQuestionRandomization","click #sendSurvey":"_checkStatus",'click .survey-header-tabs [data-location="collect"]':"_checkStatus",customThemeUpdated:"_onThemeChange"},initialize:function(){this._setupDialogs();this._setupQuestionLimit();this._setPaidFeaturesInfo();this._initHandlers();this._setListeners()},_initHandlers:function(){var e=location.href.indexOf("tbyb_collect=true")!==-1;this._onDesignSettingsChange();this._onPageLogicChange();this._onQuestionLogicChange();this._onPageRandom();this._onFunneling();this._onCustomVar();this._onBlockRandom();this._onQuestionSettingsChange();this._onQuestionRandomization();this._onQuotaChange();this._onThemeChange();this._onQuestionCountChange();this._initRenderFlag=true;this._previousFeatureCount=0;if(e&&this._getSpecialFeaturesCount()>0){this.render(true);this._showFinalDialog(this._finalDialog)}else{this.render()}this._previousFeatureCount=this._getSpecialFeaturesCount()},_TEMP_DIALOG_OPTIONS:{width:550,closeBtn:true,openDuration:1e4,autoClose:true,easyClose:true,isModal:true,position:{my:"top",at:"center+100 top+200"}},_FINAL_DIALOG_OPTIONS:{width:750,templateID:"tb4yb-finalnotice-template",closeBtn:true,autoClose:true,easyClose:true,isModal:true,position:{my:"top",at:"center+100 top+200"}},_UPGRADE_TRIGGERS_MAP:{random_assign:"wall_random_assignment",block_randomization:"wall_block_randomization",funneling:"wall_funneling",logo:"wall_logo",footer:"wall_footer",page_logic:"wall_pageskiplogic",page_randomization:"wall_page_randomization",question_randomization:"wall_question_randomization",quotas:"wall_quotas",custom_variables:"wall_custom_variables",custom_theme:"wall_themes",question_logic:"wall_questionskip_logic",piping:"wall_piping",matrix_menu:"wall_question_menu_matrix",question_limit:"wall_maxquestions",file_upload:"wall_question_file_upload"},_FEATURE_TO_STEP_MAP:{random_assign:"draft",block_randomization:"draft",funneling:"draft",logo:"theme",footer:"theme",page_logic:"draft",page_randomization:"draft",question_randomization:"draft",quotas:"draft",custom_variables:"draft",custom_theme:"theme",question_logic:"draft",piping:"draft",matrix_menu:"draft",question_limit:"draft",file_upload:"draft"},_initRenderFlag:false,_questionLimit:10,_previousFeatureCount:0,_paidFeaturesTried:[],_setupQuestionLimit:function(){this._questionLimit=this.attributes.questionLimit},_setPaidFeaturesInfo:function(){var e=CREATE.Translations.translations.defaults.feature_titles,t=CREATE.Translations.translations.defaults.package_titles,i=$("#softQuestionLimit").text().trim(),n=CREATE.survey.hasBrandRefreshTheme();this._paidFeatures={logo:{enabled:false,level:t["1"]["default"],featureTitle:e.logo["default"]},footer:{enabled:false,level:t["3"]["default"],featureTitle:n?e.footer_branding_removed["default"]:e.footer_removed["default"]},question_limit:{enabled:false,level:t["1"]["default"],featureTitle:i},custom_theme:{enabled:false,level:t["1"]["default"],featureTitle:e.custom_theme["default"]},page_randomization:{enabled:false,level:t["2"]["default"],featureTitle:e.page_random["default"]},page_logic:{enabled:false,level:t["1"]["default"],featureTitle:e.page_logic["default"]},question_logic:{enabled:false,level:t["1"]["default"],featureTitle:e.question_logic["default"]},funneling:{enabled:false,level:t["2"]["default"],featureTitle:e.funneling["default"]},block_randomization:{enabled:false,level:t["3"]["default"],featureTitle:e.block_random["default"]},custom_variables:{enabled:false,level:t["3"]["default"],featureTitle:e.custom_variable["default"]},piping:{enabled:false,level:t["2"]["default"],featureTitle:e.piping["default"]},random_assign:{enabled:false,level:t["2"]["default"],featureTitle:e.random_assign["default"]},matrix_menu:{enabled:false,level:t["1"]["default"],featureTitle:e.matrix_menu["default"]},quotas:{enabled:false,level:t["2"]["default"],featureTitle:e.quotas["default"]},question_randomization:{enabled:false,level:t["2"]["default"],featureTitle:e.question_random["default"]},
file_upload:{enabled:false,level:t["2"]["default"],featureTitle:e.file_upload["default"]}}},_setupDialogs:function(){var e=$("#tb4yb-temporary-template");e.notification(this._TEMP_DIALOG_OPTIONS);this._tempDialog=e.data("notification");this._finalDialog=SM.Views.create(SM.DialogView,this._FINAL_DIALOG_OPTIONS)},_setListeners:function(){this.listenTo(this.model,"change:design_settings",this._onDesignSettingsChange);this.listenTo(this.model,"change:page_logic",this._onPageLogicChange);this.listenTo(this.model,"change:question_logic",this._onQuestionLogicChange);this.listenTo(this.model,"change:page_randomization",this._onPageRandom);this.listenTo(this.model,"change:funneling",this._onFunneling);this.listenTo(this.model,"change:block_randomization",this._onBlockRandom);this.listenTo(this.model,"change:custom_variables",this._onCustomVar);this.listenTo(this.model,"change:quota",this._onQuotaChange);this.listenTo(this.model,"change:question_count",this._onQuestionCountChange);this.listenTo(CREATE.pages,"remove",this._onPageDelete)},_onDesignSettingsChange:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("logo",this.model.get("design_settings").logo.enabled);this._toggleFeature("footer",this.model.get("design_settings").footer_enabled===0);this.render()},_onThemeChange:function(){var e=CREATE.survey.get("design_settings").theme_id,t;if(CREATE.stepName==="draft"&&CREATE.customThemes){t=_.some(CREATE.customThemes,function(t){return parseInt(t.theme_id,10)===e})}else{t=$("#customThemeList").find("[data-themeid="+e+"]").length>0}this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("custom_theme",t);this.render()},_onQuotaChange:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("quotas",!$.isEmptyObject(CREATE.survey.get("quota")));this.render()},_onQuestionCountChange:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("question_limit",this.model.get("question_count")>this._questionLimit);this.render()},_onQuestionRandomization:function(){var e=false;this._previousFeatureCount=this._getSpecialFeaturesCount();CREATE.pages.each(function(t){if(t.get("question_randomization").enabled){e=true}});this._toggleFeature("question_randomization",e);this.render()},_onQuestionSettingsChange:function(){var e=false,t=false,i=false,n=false;this._previousFeatureCount=this._getSpecialFeaturesCount();CREATE.pages.each(function(a){a.questions.each(function(a){if(a.get("has_piping")){e=true}if(a.hasRandomAssignment()){t=true}if(a.isMenuMatrix()){i=true}if(a.isFileUpload()){n=true}})});this._toggleFeature("piping",e);this._toggleFeature("random_assign",t);this._toggleFeature("matrix_menu",i);this._toggleFeature("file_upload",n);this.render()},_onPageRandom:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("page_randomization",CREATE.survey.get("page_randomization").enabled);this.render()},_onFunneling:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("funneling",CREATE.survey.get("funneling").has_funnels);this.render()},_onBlockRandom:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("block_randomization",CREATE.survey.get("block_randomization").enabled);this.render()},_onCustomVar:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("custom_variables",CREATE.survey.get("custom_variables").length);this.render()},_onPageLogicChange:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("page_logic",CREATE.survey.get("page_logic").length>=1);this.render()},_onQuestionLogicChange:function(){this._previousFeatureCount=this._getSpecialFeaturesCount();this._toggleFeature("question_logic",CREATE.survey.get("question_logic").length!==0);this.render()},_onPageDelete:function(){this._onQuestionRandomization();this._onQuestionSettingsChange()},_showFinalDialog:function(e){var t=_.template($("#featuresTemplate").html(),{features:this._paidFeatures}),i=this._constructUpgradeUrl(true),n=$("<ul/>").attr({id:"final-features-tb4yb","data-behavior":"tbyb-feature-list"}).append(t);e.$el.find("#tbybUpgradeLink").attr("href",i);e.$el.find("#final-features-tb4yb").html(n);if(!this._finalDialog.isOpen()){this._finalDialog.open()}},_getDialogHeader:function(){var e=this._getSpecialFeaturesCount(),t;if(e===1){if(this._previousFeatureCount>e){t=CREATE.Translations.get("pro_features_change").one_remaining["default"]}else{t=CREATE.Translations.get("pro_features_change").added["default"]}}else{t=CREATE.Translations.get("pro_features_change").plural_remaining["default"].replace(/\{1\}/,e)}return t},render:function(e){var t,i,n,a,o={};if(this._shouldRender()){t=this._getDialogHeader();o=$.extend(true,{},this._paidFeatures);for(a in o){o[a].enabled=o[a].enabled&&this._isAvailable(a)}i=_.template($("#featuresTemplate").html(),{features:o});$(".tbyb-dialog-header").empty().html(t);n=this._constructUpgradeUrl();this._tempDialog.$el.find("#tbybUpgradeLink").attr("href",n);this._tempDialog.$el.find("[data-behavior=tbyb-feature-list]").empty().html(i);this._tempDialog.$el.removeClass("hide");if(!this._tempDialog.isOpen&&!e){this._tempDialog.open()}}},_constructUpgradeUrl:function(e){var t="/pricing/upgrade/?ut_source=",i=e?"tbyb_final_dialog":"tbyb_feature_notification",n=this._getFeaturesString();return t+n+"&ut_source2="+i},_getFeaturesString:function(){var e=this,t=[];_.each(this._paidFeatures,function(i,n){if(i.enabled){t.push(e._UPGRADE_TRIGGERS_MAP[n])}});return t.join("%2C")},_isAvailable:function(e){var t=CREATE.stepName;return this._FEATURE_TO_STEP_MAP[e]===t||t!=="draft"&&t!=="theme"},_toggleFeature:function(e,t){if(t){this._paidFeatures[e].enabled=true}else{this._paidFeatures[e].enabled=false}},_getSpecialFeaturesCount:function(e){var t=0,i;for(i in this._paidFeatures){if(this._paidFeatures[i].enabled&&(this._isAvailable(i)||e)){if($.inArray(i,this._paidFeaturesTried)<0){this._paidFeaturesTried.push(i)}t++}}return t},_shouldRender:function(){var e=this._getSpecialFeaturesCount();if(e>0&&this._previousFeatureCount!==e&&this._initRenderFlag){return true}return false},_checkStatus:function(e){if(this._getSpecialFeaturesCount(true)!==0){e.preventDefault();this._showFinalDialog(this._finalDialog)}else{if(this._paidFeaturesTried.length>0){SM.Logger.immediateLogThrottler({action_type:"click_next_to_deploy",tried_tbyb:this._paidFeaturesTried.length>0,tried_tbyb_feature_count:this._paidFeaturesTried.length,tried_tbyb_feature_list:JSON.stringify(this._paidFeaturesTried),ui_trigger:"step2Deploy"})}}}});(function(e,t){var i=e("js/create/step2/accordion/accordion");function n(e){var t={},i=e.selected_modifiers||{},n=Object.keys(i),a,o,s,r;for(r=0;r<n.length;r++){a=i[n[r]];o=Object.keys(a)[0];s=a[o];t[o]=s}return t}function a(e){var t=CREATE.pages.length-1;return o([{pageIndex:t,question:e,position:CREATE.pages.at(t).questions.length}],true)}function o(e,t){var i=[],a,o;for(o=0;o<e.length;o++){a=e[o];i.push({language_question_id:a.question.question_id,chosen_modifier_options:n(a.question),page_id:CREATE.pages.at(a.pageIndex).id,position:a.position+1})}CREATE.QuestionEditor.onAddMultiFromQuestionBank({qbData:i,edit:!!t})}function s(e){e(CREATE.pages.map(function(e){return{items:e.questions.map(function(e){return{questionID:e.get("id"),text:e.get("heading")}})}}),CREATE.survey.get("title").text)}function r(e){var t=s.bind(null,e.onSurveyChange);CREATE.pages.on("reset",function(){CREATE.pages.each(function(e){e.questions.off(null,t);e.questions.on("add remove change:heading",t)});t()});CREATE.pages.on("add",function(e){e.questions.on("add remove change:heading",t);t()});CREATE.pages.each(function(e){e.questions.on("add remove change:heading",t)});CREATE.survey.on("change:category",t);t()}window.CREATE.SmlibQuestionBank={init:function(e){var t=CREATE.Translations.get("smlib_questionbank"),n="create-qb-container",s,l;$("#accQuestionBank>*").not(".accordionLabel, .q.key-help").remove();$("#accQuestionBank").append("<div id='"+n+"' class='setting'></div>");l={translations:t,hooks:{appendQuestionToSurvey:a,addMultiQuestionsToSurvey:o,onResponse:function(e,t){if(t.status===409){var i=$("#newversion-notification").notification({autoClose:false,closeBtn:false}).data("notification");setTimeout(function(){window.location.reload()},5e3);i.open()}}},hydrate:e,prerender:r};try{s=window.QUESTIONBANK.entry(document.getElementById(n),l)}catch(e){SM.Logger.remoteLog({Name:"SmlibQuestionBankInitFailure",Message:"Error trying to initalize smlib.questionbank library.",action_source:"questionbanklibrary",action_type:"library_initialization",error_message:e.message},"error");s=false}if(s===false){$("#accQuestionBank").hide();i.openBuilderAccordion()}}}})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/smlibQuestionbank"]=window["js/create/step2/smlibQuestionbank"]={});(function(e,t){var i=e("js/create/step2/accordion/accordion"),n=e("js/smlib.expr");CREATE.Step2App={init:function(e){var t,a;__UPLOADER=e.fineuploader_config;CREATE.stepName=e.step_name;SM.Logger.init({remoteErrorLoggingEnabled:e.client_logging_config.enabled,remotePath:e.client_logging_config.endpoint});CREATE.Ajax.init(e.app_version);CREATE.Translations.init(CREATE.translation_data);delete CREATE.translation_data;CREATE.Notifications.init();if(n!==undefined){n.initalizeTranslations(CREATE.Translations.get("smlib_expr"))}__UI=new Create_UI;__UPGRADE=new Create_Upgrade;CREATE.user=new CREATE.models.User(e.user);CREATE.survey=new CREATE.models.Survey(e.survey,e.view_mode,e.single_page_id);__UPGRADE.init();__UI.init({appVersion:e.app_version});CREATE.LivePreview.init();i.init();if(CREATE.stepName==="theme"){t=$("<div/>").addClass("survey-body theme-body");a=$(".bd.logged-in-bd");a.wrap(t);$(".footer-push").addClass("survey-body theme-body")}if(e.tbyb_enabled&&CREATE.survey.hasPermission("edit")){CREATE.tbyb=new CREATE.views.Tbyb({model:CREATE.survey,attributes:{questionLimit:CREATE.softQuestionLimit}})}CREATE.QuizWarning=new CREATE.views.QuizWarning({model:CREATE.survey})}}})(function(e){return window["createweb"+e]||window[e]},window["createweb:js/create/step2/app"]=window["js/create/step2/app"]={});SM.Slider=SM.Widgets.register({__NAME:"slider",__init:function(){this._cacheElements()._setLayoutData()._setValues()._bindEvents()},__defaults:{constraints:{min:0,max:100,step:1},value:0,rangeMin:0,rangeMax:100,options:{restrictStepSize:true,animateClick:false}},__setters:{constraints:function(e,t){e._setConstraints(t)},rangeMin:function(e,t){if(!e._isRange){return}e._setRangeMinView(t)._setRangeMin(t)},rangeMax:function(e,t){if(!e._isRange){return}e._setRangeMaxView(t)._setRangeMax(t)},value:function(e,t){if(e._isRange){return}e._setValueView(t)._setValue(t)},restrictStepSize:function(e,t){if(typeof t!=="boolean"){return}e._setStepSizeRestriction(t)}},_setConstraints:function(e){SM.Object.update(this.__settings.constraints,e);this._setLayoutData()._setValues().__trigger("constraintChange");return this},_setValue:function(e){var t=this.__settings,i=t.constraints;e=this._constrainValue(i.min,i.max,e);if(t.value===e){return this}t.value=e;this.__trigger("change");return this},_setRangeMax:function(e){var t=this.__settings,i=t.constraints;e=this._constrainValue(t.rangeMin+i.step,i.max,e);if(t.rangeMax===e){return this}t.rangeMax=e;this.__trigger("change");return this},_setRangeMin:function(e){var t=this.__settings,i=t.constraints;e=this._constrainValue(i.min,t.rangeMax-i.step,e);if(t.rangeMin===e){return this}t.rangeMin=e;this.__trigger("change");return this},_setStepSizeRestriction:function(e){var t=this.__settings,i=t.options.restrictStepSize;if(!i&&e&&!this._stepSizeDividePerfectly()){throw new Error("Cannot restrict the step size of a slider that previously allowed and                 had a step size that didn't divide max - min")}t.options.restrictStepSize=e;return this},_stepSizeDividePerfectly:function(){var e=this.__settings.constraints,t=e.max-e.min;return t%e.step===0},_setValueView:function(e,t){var i,n,a=this.__settings,o=a.constraints;e=this._constrainValue(o.min,o.max,e);i=this._valueToHandlePosition(e);n=parseInt(this._$handle.css("left"),10);if(this._handleLabel){this._$label.text(e)}if(!t){this.__trigger({type:"slide",value:e,$label:this._$label})}else{this.__trigger({type:"start",value:e,$label:this._$label})}if(!a.options.animateClick||!t){this._$handle.css("left",i)}else{this._$handle.stop().animate({left:i},300)}if(this._handleLabel){this._positionLabel(this._$label,this._$handle)}return this},_setRangeMaxView:function(e){var t,i=this.__settings,n,a=i.constraints;e=this._constrainValue(i.rangeMin+a.step,a.max,e);t=this._valueToHandlePosition(e);n=parseInt(this._$maxHandle.css("left"),10);this._$maxHandle.css("left",t);if(this._handleLabel){this._$maxLabel.text(e)}this.__trigger({type:"slide",value:e,$label:this._$maxLabel});if(this._handleLabel){this._positionLabel(this._$maxLabel,this._$maxHandle)}this._adjustMaxEnd(t);return this},_setRangeMinView:function(e){var t,i=this.__settings,n,a=i.constraints;e=this._constrainValue(a.min,i.rangeMax-a.step,e);t=this._valueToHandlePosition(e);n=parseInt(this._$minHandle.css("left"),10);this._$minHandle.css("left",t);if(this._handleLabel){this._$minLabel.text(e)}this.__trigger({type:"slide",value:e,$label:this._$minLabel});if(this._handleLabel){this._positionLabel(this._$minLabel,this._$minHandle)}this._adjustMinEnd(t);return this},_cacheElements:function(){this._$handle=this.$el.find("a");if(this._$handle.length>1){this._$minHandle=this._$handle.eq(0);this._$maxHandle=this._$handle.eq(1);this._$range=this.$el.find("div");this._isRange=true}this._$label=this.$el.find("span.slider-label");this._handleLabel=this._$label.length>0;if(this._$label.length>1){this._$minLabel=this._$label.eq(0);this._$maxLabel=this._$label.eq(1)}return this},_setLayoutData:function(){var e=this.__settings.constraints,t;t=e.max-e.min;if(this.__settings.options.restrictStepSize&&!this._stepSizeDividePerfectly()){throw new Error("your min - max must be divisible by your step")}this._width=this.$el.outerWidth();this._stepPixelDistance=this._width/t*e.step;return this},_setValues:function(){var e=this.__settings,t,i=e.constraints;if(!this._isRange){this._setValueView(e.value)._setValue(e.value).__trigger("change")}else{this._setRangeMinView(e.rangeMin)._setRangeMin(e.rangeMin)._setRangeMaxView(e.rangeMax)._setRangeMax(e.rangeMax).__trigger("change")}return this},_bindEvents:function(){if(this._isRange){this.$el.on("click",{slider:this},this._onRangeClick);this._$minHandle.on("mousedown",{slider:this,setter:"_setRangeMin"},this._onHandleMouseDown).on("touchstart",{slider:this,setter:"_setRangeMin"},this._onHandleMouseDown).on("keydown",{slider:this,viewSetter:"_setRangeMinView"},this._onHandleKeyDown).on("keyup",{slider:this,setter:"_setRangeMin"},this._onHandleKeyUp).on("click",this._onHandleClick);this._$maxHandle.on("mousedown",{slider:this,setter:"_setRangeMax"},this._onHandleMouseDown).on("touchstart",{slider:this,setter:"_setRangeMax"},this._onHandleMouseDown).on("keydown",{slider:this,viewSetter:"_setRangeMaxView"},this._onHandleKeyDown).on("keyup",{slider:this,setter:"_setRangeMax"},this._onHandleKeyUp).on("click",{slider:this},this._onHandleClick)}else{this.$el.on("click",{slider:this},this._onClick);this._$handle.on("mousedown",{slider:this,setter:"_setValue"},this._onHandleMouseDown).on("touchstart",{slider:this,setter:"_setValue"},this._onHandleMouseDown).on("keydown",{slider:this,viewSetter:"_setValueView"},this._onHandleKeyDown).on("keyup",{slider:this,setter:"_setValue"},this._onHandleKeyUp).on("click",{slider:this},this._onHandleClick)}if(this._handleLabel){$(window).on("resize."+this.__NAME+this.__uid,{slider:this},this._onGlobalResize)}return this},_valueToHandlePosition:function(e){var t=this.__settings.constraints,i=Math.ceil(this._width/this._stepPixelDistance),n=e-t.min,a=Math.round(n/t.step),o=e===t.max?this._width:a*this._stepPixelDistance;return o},_handlePositionToValue:function(e){var t=this.__settings.constraints,i=Math.ceil(this._width/this._stepPixelDistance),n=Math.round(e/this._stepPixelDistance),a=n*t.step,o=a+t.min,s=this._width-this._stepPixelDistance*(i-1),r=e-this._stepPixelDistance*(i-1);if(Math.ceil(e/this._stepPixelDistance)===i&&r>s/2){return t.max}return o},_adjustMinEnd:function(e){this._$range.css("left",e)},_adjustMaxEnd:function(e){this._$range.css("right",this._width-e)},_constrainValue:function(e,t,i){if(i>t){i=t}else if(i<e){i=e}return i},_positionLabel:function(e,t){var i=parseInt(t.css("left"),10),n=t.outerWidth(),a,o=e.outerWidth();if(!e.is(":visible")){o=e.appendTo(document.body).outerWidth();e.appendTo(this.$el)}a=i-(o-n)/2;e.css("left",a);return this},_onClick:function(e){var t=e.data.slider,i=e.pageX-t.$el.offset().left,n=t._handlePositionToValue(i);t._setValueView(n,true);t._setValue(n);t.__trigger("change")},_onRangeClick:function(e){var t=e.data.slider,i=e.pageX-t.$el.offset().left,n=t._handlePositionToValue(i),a=Math.abs(n-t.__settings.rangeMax),o=Math.abs(n-t.__settings.rangeMin);if(a<=o){t._setRangeMaxView(n);t._setRangeMax(n)}else{t._setRangeMinView(n);t._setRangeMin(n)}},_onHandleKeyDown:function(e){var t=$(this),i=e.data.slider,n=i.__settings.constraints,a=e.data.viewSetter,o=e.which,s=i._handlePositionToValue(parseInt(t.css("left"),10));if(!o){return}if(o===SM.KeyCodes.LEFT){i.__trigger("start");i[a](s-n.step)}else if(o===SM.KeyCodes.RIGHT){i.__trigger("start");i[a](s+n.step)}},_onHandleKeyUp:function(e){var t=$(this),i=e.data.slider,n=e.data.setter,a=e.which,o=i._handlePositionToValue(parseInt(t.css("left"),10));if(!a){return}if(a===SM.KeyCodes.LEFT){i[n](o)}else if(a===SM.KeyCodes.RIGHT){i[n](o)}},_onHandleClick:function(e){e.preventDefault()},_onHandleMouseDown:function(e){var t=$(this),i=e.data.setter+"View",n=e.data.slider;this.ondragstart=function(){return false};document.onselectstart=function(){return false};t.focus();n.__trigger("start").__subscribe("touchend",n._onGlobalMouseup,{valueSetter:e.data.setter}).__subscribe("touchmove",n._onGlobalMousemove,{viewSetter:i}).__subscribe("mouseup",n._onGlobalMouseup,{valueSetter:e.data.setter}).__subscribe("mousemove",n._onGlobalMousemove,{viewSetter:i});e.preventDefault()},_onGlobalMouseup:function(e){var t=e.data.slider,i=e.type==="touchend"?parseInt($(e.target).css("left").replace("px","")):e.pageX,n=e.type==="touchend"?i:i-t.$el.offset().left,a=e.data.valueSetter,o=t._handlePositionToValue(n);t.__unsubscribe("touchmove").__unsubscribe("touchend").__unsubscribe("mousemove").__unsubscribe("mouseup");document.onselectstart=null;t[a](o,true);t.__trigger("stop")},_onGlobalMousemove:function(e){var t=e.data.slider,i=e.data.viewSetter,n=e.type==="touchmove"?e.originalEvent.touches[0].pageX:e.pageX,a=n-t.$el.offset().left,o=t._handlePositionToValue(a);t[i](o)},_onGlobalResize:function(e){var t=e.data.slider;if(t._isRange){t._positionLabel(t._$minLabel,t._$minHandle);t._positionLabel(t._$maxLabel,t._$maxHandle)}else{t._positionLabel(t._$label,t._$handle)}}});SM.SliderQuestion=SM.Widgets.register({__NAME:"sliderQuestion",_POPOUT_LENGTH:253,_ZENKAKU:"\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19",_INPUT_MAX_LEN:8,_CLEAR_BUTTON_WIDTH:50,_defaultSliderConfig:{min:0,max:100,step:1},__init:function(){this._parseElements()._parseConfiguration()._popoutCheck();if(!this._$sliderWidget.data("slider")){this._detectTextOverflow()._initWidget()._events()._syncResponseFromInput()}},_parseElements:function(){if(!this.$el.hasClass("slider-wrapper")){throw new Error("Slider question failed to initialize.")}this._$sliderWrapper=this.$el.find(".slider-question-wrapper");this._$sliderInput=this.$el.find("input");this._$sliderClear=this.$el.find(".slider-clear");this._$sliderWidget=this._$sliderWrapper.find("[data-slider]");this._$sliderKnob=this._$sliderWidget.find("a");this._$sliderValWarning=this.$el.siblings(".slider-warning");return this},_parseConfiguration:function(){this._min=parseInt(this._$sliderWidget.attr("data-slider-min"),10);this._max=parseInt(this._$sliderWidget.attr("data-slider-max"),10);this._initPos=parseInt(this._$sliderWidget.attr("data-slider-init"),10);this._stepSize=parseInt(this._$sliderWidget.attr("data-slider-step-size"),10);this._questionId=this.$el.closest("[data-question-id]").attr("data-question-id");return this},_popoutCheck:function(){if(this._questionId==="sample_s"){this.$el.parent().addClass("force-mobile");this._isPopout=true}return this},_initWidget:function(){var e=this._initPos!==this._min&&this._initPos!==this._max,t;if(this._isPopout){this._$sliderWidget.width(this._POPOUT_LENGTH);this._$sliderKnob.removeClass("has-response")}this._$sliderWidget.slider({options:{restrictStepSize:false,animateClick:true},constraints:{min:this._min,max:this._max,step:this._stepSize},value:this._initPos!==undefined?this._initPos:this._getMidValue(this._min,this._max)});if(e){t="50%"}else if(this._initPos===this._max){t="100%"}else{t="0"}this.$el.find(".slider-init-bar").css("left",t);this._reset(this);return this},_events:function(){var e=this,t=$("body").hasClass("ie9");this._inputEvent=t?"keyup":"input";this._namespacedResize="resize.slider_"+e._questionId;this._namespacedOrientationchange="orientationchange.slider_"+e._questionId;this.$el.on("slider.change",".slider-question",function(t){e._$sliderKnob.removeClass("dragging");e._handleInput(t,e)}).on("slider.start",".slider-question",function(t){e._$sliderKnob.addClass("has-response");e._handleInput(t,e)}).on("slider.stop",".slider-question",function(t){e._$sliderKnob.removeClass("dragging");e._handleInput(t,e)}).on("slider.slide",".slider-question",function(t){e._$sliderKnob.addClass("dragging");e._updateValue(t)});this._$sliderInput.on("blur",function(t){var i=$(t.target),n=i.val(),a=$.trim(n),o=e._$sliderWidget.data("slider").get("constraints"),s,r;i.val(a);a=e._truncateInput(a);i.val(a);a=e._zenkakuToHankaku(a);if(a===""){e._reset(e)}else if(e._isLegalInput(a)){a=parseInt(a,10);if(o.min<=a&&a<=o.max){r=e._stepSizeAdjustment(a);if(r!==a){a=r;e._adjustedVal=r;e._$sliderValWarning.fadeIn()}else{e._adjustedVal=undefined;e._$sliderValWarning.hide()}if(parseInt(e._$sliderWidget.data("slider").get("value"),10)===a){e._gotResponse(e)}e._$sliderWidget.data("slider").set("value",a);e._$sliderKnob.removeClass("dragging");if(e._adjustedVal!==undefined){i.val(e._adjustedVal)}else{i.val(n)}}else{e._reset(e)}e._$sliderClear.show()}else{e._reset(e);e._$sliderClear.show()}});this._$sliderClear.find("a").on("keypress",function(t){if(t.keyCode===13){e._reset(e,true)}}).on("click",function(){e._reset(e,true)});e._freeze();if(!e._isPopout){$(window).on(e._namespacedResize+","+e._namespacedOrientationchange,function(t,i){if(i&&i==="scroll"){return}var n=e.$el.closest("[data-question-id]").attr("data-question-id"),a=$(".survey-page-body").find("[data-question-id="+n+"]");if(a.length>0){e._updateSliderConfig(e)}else{e._freeze()}})}return this},_syncResponseFromInput:function(){var e=$.trim(this._$sliderInput.val());if(e){if(this._isLegalInput(e)&&this._min<=e&&this._max>=e){e=parseInt(e,10);this._$sliderWidget.data("slider").set("value",e);this._$sliderKnob.removeClass("dragging").addClass("has-response")}this._$sliderClear.show()}return this},_detectTextOverflow:function(){var e;this._$sliderClear.css("opacity",0).show();e=this._$sliderClear[0].scrollWidth;this._$sliderClear.hide().css("opacity",1);if(e>this._CLEAR_BUTTON_WIDTH){this.$el.addClass("slider-clear-overflow")}return this},_getMidValue:function(e,t){return Math.floor(e+(t-e)/2)},_handleInput:function(e,t){this._gotResponse(t);this._updateValue(e)},_updateValue:function(e){var t=$(e.target),i=t.find("a"),n=e.value,a=e.slider.get("value"),o=n!==undefined?n:a,s=$.find("footer.persistent-footer").length==1;if((n!==undefined||e.namespace==="start")&&i.hasClass("has-response")){t.closest(".slider-wrapper").find("input").val(o);i.attr("aria-valuenow",o)}if(s){var r=t.closest(".question-row").find("button.new-button");if(r.length>0){r.removeClass("hide")}}},_updateSliderConfig:function(e){var t=e._$sliderKnob.hasClass("has-response"),i=e._$sliderWidget.data("slider").get("constraints");e._$sliderWidget.data("slider").set("constraints",i);if(!t){e._reset(e)}},_gotResponse:function(e){e._$sliderKnob.addClass("has-response");e._$sliderClear.show()},_onResponseCleared:function(e){e._$sliderKnob.removeClass("has-response");e._$sliderValWarning.hide();if($.trim(e._$sliderInput.val())===""){e._$sliderClear.hide()}},_reset:function(e,t){var i=e._$sliderWidget.data("slider").get("constraints"),n=e._$sliderInput.val();if(e._initPos>this._min&e._initPos<this._max){e._$sliderKnob.css("left",e._$sliderWidget.width()/2+"px")}else{e._$sliderWidget.data("slider").set("value",this._initPos)}if(t){e._$sliderInput.val("")}else{e._$sliderInput.val(n)}e._onResponseCleared(e);e._$sliderKnob.removeClass("has-response dragging")},_isLegalInput:function(e){return e.indexOf(".")===-1&&!isNaN(parseInt(e,10))},_freeze:function(){$(window).off(this._namespacedResize+" "+this._namespacedOrientationchange)},_stepSizeAdjustment:function(e){var t=(this._max-this._min)%this._stepSize,i=Math.ceil((this._max-this._min)/this._stepSize),n=Math.floor((e-this._min)/this._stepSize),a=Math.round((e-this._min)/this._stepSize),o=(e-this._min)%this._stepSize,s;if(o>0&&t!==0){if(n===i-1){if(o<t/2){a=n}else{a=i}}}if(a<i){s=a*this._stepSize+this._min}else{s=this._max}return s},_truncateInput:function(e){if(e.length>this._INPUT_MAX_LEN){return e.substr(0,this._INPUT_MAX_LEN)}return e},_zenkakuToHankaku:function(e){var t=e,i=0,n;for(i;i<this._ZENKAKU.length;i++){n=new RegExp(this._ZENKAKU[i],"g");t=t.replace(n,i+"")}return t},deactivate:function(){this._freeze();$(window).off(this._inputEvent);this._$sliderClear.find("a").off("keypress").off("click");this._$sliderWidget.removeData("slider")},get:function(e){if(e==="value"){return this._$sliderInput.val()}}});CREATE.Draft=function(){var e,t=false,i={family:"open_ended",subtype:"single"},n={family:"single_choice",subtype:"vertical"},a={currentPageId:null,dialog:null},o=CREATE.models.Question.defaultMaxRows,s=CREATE.models.Question.maxHeadingLength,r=CREATE.models.Question.maxAnswerTextLength,l=CREATE.models.Page.maxQuestions,d=10,u,c,f,p,g,h=true,m,v,E,C,q,b=$("#questionTemplates").find(".block-template").html();function y(){var e=v.val(),t=e.split("\n\n"),i=[],n;_.each(t,function(e){n=T(e.split("\n"));if(n){i.push(n)}});return i}function T(t){var a,o,s=/^(\s+)?((\d+(\.|\)))|\*+|\u2022+|o+|\u25cf+|\u25cb+|[a-zA-Z]+(\.|\)))?\s+/,r=_.map(t,function(e){return e.replace(s,"")}).filter(function(e){return e&&e.length>0});if(r.length<1){return null}a=(new CREATE.models.Question).toJSON();a.survey_id=e;a.heading=r.shift();a.answer_options={rows:[]};if(r.length>0){a.common_name="multiple_choice_radio";a.type=n;$.each(r,function(e,t){o={description:"",id:null,position:e+1,text:t,type:"row",visible:true};a.answer_options.rows.push(o)})}else{a.common_name="single_textbox";a.type=i}return a}function w(e){var t=C.find(".question-container"),i=F(),n=e.length,a;D(n>0);if(n<i){a=n-i;t.slice(a).remove()}$(".preview-wrapper").toggleClass("has-questions",n>0);$.each(e,function(e,t){if(t.heading.length>0){A(t,e)}})}function R(e){var t=[],i=[],n=null;Q(e);$.each(e,function(e,o){o.page_id=a.currentPageId;if(o.page_id!==n){n=o.page_id;if(i.length>0){t.push(i);i=[]}i.push(o)}else{if(i.length+1>d){t.push(i);i=[]}i.push(o)}});if(i.length>0){t.push(i)}return t}function A(e,t){var i=$("#draft-question-"+t),n,a={};e.position=t+1;if(e.common_name==="single_textbox"){a.single_text=u.single_text["default"]}else{a.hide=u.hide_answers["default"];a.show=u.show_answers["default"];a.mcHeader=u.multiple_choice_header["default"]}n=_.template(b,{variable:"question",question:e,translations:a});i.remove();C.append(n)}function S(){var e=y();j();w(e);if(g!==F()){g=F();P(g);V()}W()}function x(){var e=this.parents(".block-answer-list"),t=this.data("attr"),i=this.parent().children().not("[data-attr="+t+"]");this.addClass("hide");i.removeClass("hide");e.find(".block-answer").toggleClass("hide",t==="hide-list")}function k(){v.val("");C.empty()}function P(e){var t,i,n;E.toggleClass("teal",!!e).toggleClass("disabled",!e);switch(e){case 0:t=$(".add-btn-empty span").clone();E.html(t);break;case 1:i=$(".add-btn-singular span").clone();E.html(i);break;default:n=$(".add-btn-plural span").clone();n.eq(1).html(e);E.html(n)}$(".question-placeholder").toggleClass("hide",!!g)}function M(e){var t=!g&&e;q.toggleClass("hide",!t);v.toggleClass("hide",t)}function D(e){$("#addBulkQuestions").toggleClass("disabled",!e);$("#draftWrapper").toggleClass("block-ux",!e)}function I(){if(a.dialog){a.dialog.close()}}function L(){if(v.val().length>0){S()}else{M(true)}}function F(){return C.find(".question-container").length}function Q(e){_.each(e,function(e){e.heading=CREATE.utils.htmlEncode(e.heading);if(e.common_name==="multiple_choice_radio"){_.each(e.answer_options.rows,function(e){e.text=CREATE.utils.htmlEncode(e.text)})}})}function N(){var e,i,n;if(t){return}D(false);e=CREATE.survey.mangled_id||CREATE.Ajax.getSMParam();i=y();n=R(i);if(n.length>0){SM.Logger.copyPasteAddQuestions(n);B(n,e)}else{I()}}function B(e,t){var i=e.shift(),n=i[0].page_id,a=CREATE.pages.get(n||CREATE.survey.pageInView),o=CREATE.Ajax.addQuestions({questions:i,page_id:n},t);o.done(function(i){if(e.length>0){U(i,a);B(e,t)}else{g=0;U(i,a);k();P(0);M(true);I()}}).fail(function(){CREATE.Notifications.showErrorNotification();D(true)})}function U(e,t){var i,n;e.forEach(function(e){i=e.json.id;n=CREATE.utils.getQuestionElFromContainer(e.markup);CREATE.utils.appendQuestionMarkup(t.id,n);t.addQuestionLocal(e.json,e.position)});__UPGRADE.handleUpgradeState();$("#livePreview").trigger("previewChanged")}function O(){if(p){$("#collectorWarning").addClass("copy-paste-slider");D(false)}else if(h){h=false;$("#tbybWarning").addClass("copy-paste-slider")}}function z(){$(".copy-paste-warning").removeClass("copy-paste-slider");if(F()){D(true)}}function V(){var t;if(!c){return}t=f+F();if(t>10){if(p){O()}else{CREATE.Ajax.hasCollector(e).done(function(e){if(e.has_collector){p=true}O()}).fail(function(){O()})}}else{z()}}function H(e){var t=CREATE.pages.get(a.currentPageId).questions.length,i=l-t;return e>i}function j(){$("#draftErrors").hide();$(".question-limit, .heading-limit, .choice-limit, .label-limit").addClass("hide")}function W(){var e=y(),t,i=false;j();if(H(e.length)){$(".question-limit").removeClass("hide");i=true}_.each(e,function(e){if(e.heading.length>s){$(".heading-limit").removeClass("hide");i=true}if(e.answer_options.rows){t=e.answer_options.rows;if(t.length>o){$(".choice-limit").removeClass("hide");i=true}_.each(t,function(e){if(e.text.length>r){$(".label-limit").removeClass("hide");i=true}})}});if(i){$("#draftErrors").show()}}function G(){a.dialog.$el.on("keyup","#draft",function(){S()}).on("blur","#draft",function(){M(true)}).on("click","#addBulkQuestions",function(e){e.preventDefault();if(!$(this).hasClass("disabled")){N()}}).on("click",".dropdown-heading",function(){x.call($(this))}).on("click","#textPlaceholder",function(){M(false);v.focus()});if(c){a.dialog.$el.on("click","#collectorUpgradeBtn, #tbybUpgradeBtn",function(e){var t,i;if(this.id==="collectorUpgradeBtn"){t="copypaste_step2_collector_upgrade"}else{t="copypaste_step2_tbyb_upgrade"}SM.Logger.immediateLogThrottler({action_type:t});i=__UPGRADE.getUpgradeUrl("upgradeMaxQuestions",t);e.preventDefault();D(false);window.location=i}).on("click",".copy-paste-close-icon, .copy-paste-dismiss",function(e){e.preventDefault();$("#tbybWarning").removeClass("copy-paste-slider")})}$(".draft-title-container").find(".q").popout()}function K(t){c=CREATE.user.hasUpgradableQuestionLimit();f=CREATE.survey.get("question_count");e=CREATE.survey.get("id")
;g=$("[id^=draft-question]").length;p=!CREATE.tbyb;a.currentPageId=t}function X(){m=a.dialog.$el;v=m.find("#draft");E=m.find("#addBulkQuestions");q=m.find("#textPlaceholder");C=m.find("#questionList");u=CREATE.Translations.translations.defaults.copy_paste}return{init:function(e){if(e){$.extend(a,e)}X();K(e.currentPageId);V();G();L()},setUserAndSurveyState:K,toggleWarningMessage:V,renderExisting:L}}();CREATE.views.QuizWarning=Backbone.View.extend({el:"#create",events:{quizWarningQuestionCheck:"_onQuizQuestionChange"},initialize:function(){this._defaultQuizDisabledLogic();this.populateDisabledLogic();this._setListeners();this.firstQuizEnabled=this.model.isSurveyQuizMode()},_setListeners:function(){this.listenTo(this.model,"change:question_logic",this._onQuestionLogicChange);this.listenTo(this.model,"change:block_randomization",this._onBlockRandomChange);this.listenTo(this.model,"change:advanced_logic",this._onAdvancedLogicChange);this.listenTo(this.model,"change:page_logic",this._onPageSkipChange);this.listenTo(CREATE.pages,"remove",this._onQuizQuestionChange)},_quizDisabledLogic:{},_accordionModule:undefined,_defaultQuizDisabledLogic:function(){this._quizDisabledLogic={skip:false,block:false,funneling_receiver:false,advanced_logic:false,piping:false,page_skip:false}},firstQuizEnabled:false,_onQuizQuestionChange:function(){var e=this.hasAnyDisabledLogic();this.updateFunnelingAndPiping();this._processQuizStateChange(e,this.hasAnyDisabledLogic())},_onAdvancedLogicChange:function(){var e=this.model.get("advanced_logic"),t=e&&!$.isEmptyObject(e),i=this.hasAnyDisabledLogic();this._updateQuizDisabledLogic("advanced_logic",t);this._processQuizStateChange(i,this.hasAnyDisabledLogic())},_onPageSkipChange:function(){var e=this.model.hasPageLogic(),t=this.hasAnyDisabledLogic();this._updateQuizDisabledLogic("page_skip",e);this._processQuizStateChange(t,this.hasAnyDisabledLogic())},_onQuestionLogicChange:function(){var e=this.model.hasQuestionLogic(),t=this.hasAnyDisabledLogic();this._updateQuizDisabledLogic("skip",e);this._processQuizStateChange(t,this.hasAnyDisabledLogic())},_onBlockRandomChange:function(){var e=this.model.get("block_randomization"),t=e&&e.enabled,i=this.hasAnyDisabledLogic();this._updateQuizDisabledLogic("block",t);this._processQuizStateChange(i,this.hasAnyDisabledLogic())},_processQuizStateChange:function(e,t){var i,n=CREATE.survey.isSurveyQuizMode(),a=this;if(!(t&&n)){this.updateQuizAccUI(false)}else if(e!==t&&t){i=$.extend({},this.model.get("quiz_options"));if(i.show_results_type!=="disabled"){i.show_results_type="disabled";CREATE.survey.updateQuizMode(i).done(function(){a.updateQuizAccUI(t)})}else{a.updateQuizAccUI(t)}}},_updateQuizDisabledLogic:function(e,t){this._quizDisabledLogic[e]=t},hasAnyDisabledLogic:function(){return _.some(this._quizDisabledLogic,function(e){return!!e})},populateDisabledLogic:function(){var e=this.model;this._defaultQuizDisabledLogic();if(e.get("question_logic")&&e.get("question_logic").length>0){this._updateQuizDisabledLogic("skip",true)}if(e.get("block_randomization")&&e.get("block_randomization").enabled){this._updateQuizDisabledLogic("block",true)}if(e.get("advanced_logic")&&!$.isEmptyObject(e.get("advanced_logic"))){this._updateQuizDisabledLogic("advanced_logic",true)}if(e.hasPageLogic()){this._updateQuizDisabledLogic("page_skip",true)}this.updateFunnelingAndPiping()},updateFunnelingAndPiping:function(){var e=false,t=false;$.each(CREATE.pages.models,function(i,n){$.each(n.questions.models,function(i,n){if(n.supportsQuizMode()&&n.hasNonZeroScore()){if(n.get("has_piping")){e=true}if(n.hasReceiverId()){t=true}}});if(e&&t){return false}});this._updateQuizDisabledLogic("piping",e);this._updateQuizDisabledLogic("funneling_receiver",t)},updateSurveyQuestionQuizState:function(e){$.each(CREATE.pages.models,function(t,i){$.each(i.questions.models,function(t,i){var n;if(i.supportsQuizMode()){n=$.extend({},i.get("options"));n.quiz_options.scoring_enabled=e&&i.hasNonZeroScore();i.set("options",n)}})})},openQuizAccordion:function(){if(!this._accordionModule){this._accordionModule=window["js/create/step2/accordion/accordion"]}this._accordionModule.openOptionsAccordion();$("#quizMasterToggle > a").trigger("click")},updateQuizAccUI:function(e){var t=CREATE.survey.get("quiz_options"),i=t.is_quiz_mode,n=t.show_results_type,a=!i||i&&e,o=$("#quizResults"),s=$("#quizAnswers"),r=$(".quiz-results-text"),l=$("#quizWarning"),d=$(".quiz-answer-text");$('.quizSurveySettings, .quizSurveySettings section[rel=quiz], li[rel="quiz"]').toggleClass("off",!i);o.add(s).attr("disabled",a);r.add(d).toggleClass("quiz-opacity",a);if(n==="disabled"){s.attr("disabled",true);d.addClass("quiz-opacity")}l.toggleClass("hide",!i||!e);o.prop("checked",n!=="disabled");s.prop("checked",n==="results_and_answers")},toggleSurveyQuizMode:function(e){var t=$.extend({},CREATE.survey.get("quiz_options")),i=this,n=CREATE.QuizWarning.hasAnyDisabledLogic();if(e===t.is_quiz_mode){return}t.is_quiz_mode=e;if(!this.firstQuizEnabled){this.firstQuizEnabled=true;if(!n){t.show_results_type="results_and_answers"}}this.updateSurveyQuestionQuizState(e);CREATE.survey.updateQuizMode(t).done(function(){var e=!!CREATE.utils.getCookie("sm_create_quiz_question_added"),n=CREATE.QuizWarning.hasAnyDisabledLogic();i.openQuizAccordion();i.updateQuizAccUI(n);if(!e&&!!t.is_quiz_mode){CREATE.utils.setCookie("sm_create_quiz_question_added",true,365);i._showQuizEnabledTooltip()}})},_showQuizEnabledTooltip:function(){var e=$(".quiz-enabled-tooltip");e.popout({tipSideX:"left",tipSideY:"bottom",offsetX:5,tipOrientation:"topbottom",autoClose:false,collision:"none none",parentElement:e.closest("#createAccordion")});e.trigger("open.popout");$("#accOptions").on("accOptionsHidden",function(){e.trigger("close.popout")});$("button[data-waterpark=quizSurveySettings]").click(function(){e.trigger("close.popout")})},getDisabledLogicList:function(){return $.extend({},this._quizDisabledLogic)}});CREATE.HelpCenterDialog={__helpDialog:null,__engineKey:null,__helpCenterCSSBundle:null,__helpCenterJSBundle:null,init:function(e){var t=this,i=$(".help-dialog-trigger");t.__engineKey=e.engineKey;t.__helpCenterCSSBundle=e.cssBundle;t.__helpCenterJSBundle=e.jsBundle;t.__faqList=e.faqList;t.__openAfterInit=e.openAfterInit;i.on("click",function(e){e.preventDefault();if(!t.__helpDialog){$.ajax({url:t.__helpCenterJSBundle,dataType:"script",notificationSkip:true,success:function(){t.__helpDialog=SM.Views.create(SM.HelpCenterView,{helpCenterCSSBundle:t.__helpCenterCSSBundle,engineKey:t.__engineKey,resultsPerPage:5,fixedPosition:{bottom:"20px",right:"30px"},messages:{"no-results":CREATE.Translations.get("hc-no-results")["default"],"did-you-mean":CREATE.Translations.get("hc-did-you-mean")["default"]}});t.__helpDialog.$el.on("helpCenterDialog.close",function(){SM.Logger.enqueue({action_type:"hc_dialog_close",ui_trigger:"step2HelpCenterDialogClose"})}).on("helpCenterDialog.search-result-article-click",function(e){SM.Logger.enqueue({action_type:"hc_dialog_search_results_article_click",ui_trigger:"step2HelpCenterDialogSearchResultsArticleClick",url:e.url})}).on("helpCenterDialog.faq-article-click",function(e){SM.Logger.enqueue({action_type:"hc_dialog_faq_article_click",ui_trigger:"step2HelpCenterDialogFAQArticleClick",url:e.url})}).on("helpCenterDialog.submit-search",_.debounce(function(e){SM.Logger.enqueue({action_type:"hc_dialog_search_submit",ui_trigger:"step2HelpCenterDialogSearchSubmit",query:e.query})},900));t.__helpDialog.open()}})}else{if(!t.__helpDialog.isOpen()){t.__helpDialog.open()}else{t.__helpDialog.close();setTimeout(function(){t.__helpDialog.open()},100)}}});if(t.__openAfterInit){i.trigger("click")}}};CREATE.SurveyScore=function(){var e=null,t=null,i=0,n=null,a=null,o=null,s=[],r=500,l=250,d=50,u=r+l,c=200,f=false,p=false,g,h,m,_,v,E,C,q,b,y,T,w,R,A,S,x,k=6,P=5,M=4;function D(){SM.Logger.enqueue({action_type:"survey_score_open_modal",ui_trigger:"surveyScoreMainCTA"});CREATE.utils.handleOpenEditors(function(){if(!a){$.ajax({url:e.jsBundle,dataType:"script",notificationSkip:true,success:function(){a=SM.Views.create(SM.DialogView,{isModal:true,width:865,closeBtn:true,templateID:"surveyScoreDialog"});I()}})}else{I()}})}function I(){a.open();if(!p){g=$("#successCircle");h=$(".survey-score-dialog");v=$("#recommendationMessage");E=$(".recommendation-panel-contents");m=$(".survey-score-panel");_=$(".recommendation-panel");T=$(".tip-cta");C=$(".dialog-overlay");q=$(".dialog-close-btn");b=$("#enterCollectLogicPanel");y=$("#enterCollectMaxScorePanel");w=$("#continueEditingLogicPanel");R=$("#continueEditingMaxScorePanel");A=$("#carouselWrapper");S=$("#score");x=$(".score-number-container");p=true}L();if(CREATE.survey.get("question_count")===0){H(false)}else if(CREATE.survey.hasPageLogic()||CREATE.survey.hasQuestionLogic()||CREATE.survey.get("block_randomization").enabled){H(true)}else{j();ne()}}function L(){$("#addQuestions").unbind().click(U);$("#tryAgain").unbind().click(N);T.unbind().click(V);C.click(function(){SM.Logger.enqueue({action_type:"survey_score_close_modal",ui_trigger:"surveyScoreModalOverlay"})});q.click(function(){SM.Logger.enqueue({action_type:"survey_score_close_modal",ui_trigger:"surveyScoreModalCloseButton"})});b.click(function(){SM.Logger.enqueue({action_type:"survey_score_send_survey",ui_trigger:"surveyScoreCollectResponsesButtonLogicPanel"})});y.click(function(){SM.Logger.enqueue({action_type:"survey_score_send_survey",ui_trigger:"surveyScoreCollectResponsesButtonMaxScorePanel"})});w.click(function(){a.close();SM.Logger.enqueue({action_type:"survey_score_close_modal",ui_trigger:"surveyScoreContinueEditingLogicPanel"})});R.click(function(){a.close();SM.Logger.enqueue({action_type:"survey_score_close_modal",ui_trigger:"surveyScoreContinueEditingMaxScorePanel"})})}function F(){S.removeClass("small-font");S.toggleClass("small-font",S.width()>x.width())}function Q(){t=null;n=null}function N(){j();ne()}function B(e){var t=Math.round(e/60);if(t===0){t=1}return t}function U(){var e=CREATE.QuestionEditor,t=CREATE.survey.get("page_ids")[0];SM.Logger.enqueue({action_type:"survey_score_add_questions",ui_trigger:"surveyScoreAddQuestionsCTA"});a.close();e.onAdd("MultipleChoice",null,t)}function O(e){var t=o.score_words.ok["default"];if(e===k){t=o.score_words.perfect["default"]}else if(e===P){t=o.score_words.great["default"]}else if(e===M){t=o.score_words.good["default"]}return sanitizeHtml(t)}function z(e){if(!f||e===0){g.circleProgress({emptyFill:"#454544",animation:500,lineCap:"round",thickness:16,value:e,size:180,startAngle:-Math.PI/2,animationStartValue:0,fill:{gradient:["#A6C42F","#16BEC0"]}});f=true}else{g.circleProgress("value",e)}}function V(e){var t=e.target.classList,i=window["js/create/step2/accordion/accordion"],n,o;a.close();if(t.contains("add-another-question")){SM.Logger.enqueue({action_type:"survey_score_feature_tip",ui_trigger:"surveyScoreFeatureAddQuestion"});n=CREATE.QuestionEditor;o=CREATE.survey.get("page_ids")[CREATE.survey.get("page_ids").length-1];n.onAdd("MultipleChoice",null,o)}else if(t.contains("add-logic")){SM.Logger.enqueue({action_type:"survey_score_feature_tip",ui_trigger:"surveyScoreFeatureAddLogic"});i.openLogicAccordion()}else if(t.contains("add-logo")){SM.Logger.enqueue({action_type:"survey_score_feature_tip",ui_trigger:"surveyScoreFeatureAddLogo"});i.openOptionsAccordion();$(".optionLogo").click()}else if(t.contains("customize-theme")){SM.Logger.enqueue({action_type:"survey_score_feature_tip",ui_trigger:"surveyScoreFeatureCustomizeTheme"});i.openThemesAccordion();$('[data-tab-name="custom"]').click()}else if(t.contains("commenting")){SM.Logger.enqueue({action_type:"survey_score_feature_tip",ui_trigger:"surveyScoreFeatureCommenting"});$("#previewButton").trigger("click")}}function H(e){Q();z(0);$("#score, .completion-rate .content, .completion-time .content").text("\u2014").show();$(".minutes, .percent").hide();E.hide();if(e){$("#surveyHasLogicPanel").show()}else{$("#addQuestionsPanel").show()}}function j(){if(!n){z(0);m.addClass("loading")}E.hide();$("#loadingPanel").show()}function W(){h.addClass("error");Q();z(0);m.removeClass("loading");E.hide();$("#errorPanel").fadeIn()}function G(){m.removeClass("loading maxScore");_.removeClass("loading maxScore");h.removeClass("error")}function K(){var e,i,a,s,d,u,c,f;G();a=n.survey_score_discrete;s=n.survey_score_continuous;d=B(n.completiontime);c=n.completiontime;f=o.minutes.plural["default"].replace("{}","");if(c<30){f=o.minute_or_less["default"].replace("{1}","")}else if(d===1){f=o.minutes.singular["default"].replace("{1}","")}f=CREATE.utils.stripTags(f);if(t){u=B(t.completiontime);S.text(O(a));F();z(s);setTimeout(function(){e=new CountUp("completionRate",Math.round(t.completionrate*100),Math.round(n.completionrate*100),0,l/1e3);i=new CountUp("completionTime",u,d,0,l/1e3);i.start();$(".completion-time .minutes").text(f);e.start()},r)}else{$(".completion-rate .content, .completion-time .content, #score").text("");$(".percent, .minutes").hide();S.text(O(a));F();S.hide().fadeIn(500);z(s);setTimeout(function(){$(".completion-rate .content").text(Math.round(n.completionrate*100)).hide().fadeIn(250);$(".completion-time .content").text(d).hide().fadeIn(250);$(".completion-time .minutes").hide().text(f).fadeIn(250);$("#completionRate").css({display:"inline"});$(".percent").fadeIn(250).css({display:"inline"})},r)}if(a===k){Y()}else{X(a)}}function X(e){var t;if(i>1){t=o.recommendations[e].plural["default"].replace("{}",i)}else{t=o.recommendations[e].singular["default"]}t=sanitizeHtml(t);v.text(t);J($("#recommendationPanel"))}function Y(){J($("#maximumScorePanel"))}function J(e){if(SM.Browser.isIE9){setTimeout(function(){E.hide();e.show()},u)}else{setTimeout(function(){E.fadeOut(d);e.addClass("fadeInLeft").show()},u);setTimeout(function(){e.removeClass("fadeInLeft")},2500)}}function Z(e){var t,n,a;s=[];$(".recommendationCard").remove();t=e.question.length;n=e.survey.length;i=t+n;ee(e.question);te(e.survey);ie(e.feature);if(i>1){a=A.unslider({animation:"vertical",arrows:{prev:'<a class="arrow prev"></a>',next:'<a class="arrow next"></a>'},nav:true,speed:c,selectors:{container:"#recommendationContainer",slides:".recommendationCard"}});a.data("unslider").calculateSlides();$(".unslider-nav").show();$(".arrow.next, .arrow.prev").show()}else if(A.hasClass("unslider-vertical")){A.data("unslider").calculateSlides();$(".unslider-nav").hide();$(".arrow.next, .arrow.prev").hide()}}function ee(e){var t=e.length,i,n,a,r,l,d,u,c,f,p,g,h,m=[],_=function(e){a.push(e.display_number)},v=function(e,t){return e-t};for(i=0;i<t;i++){a=[];n=e[i];r=n.recommendation_id;s.push(r);if(r===10){l=n.recommendation_data.question_type;d=o.rec_list[r].title[l]["default"]}else{d=o.rec_list[r].title["default"]}u=o.rec_list[r].text["default"];n.recommendation_context.forEach(_);a=a.sort(v).join(o.comma["default"]+" ");c="";if(n.recommendation_context.length===1){c=o.applies_to.singular["default"].replace("{1}",a)}else if(n.recommendation_context.length>1){c=o.applies_to.plural["default"].replace("{1}",a)}f=$('<div class="recommendationCard"></div>');p=$('<div class="recommendationTitle"></div').text(d);g=$('<div class="recommendationText"></div').text(u);h=$('<div class="recommendationQNums"></div>').text(c);f.append(p).append(g).append(h);m.push(f)}$("#recommendationContainer").append(m)}function te(e){var t,i,n=e.length,a,r,l,d,u,c,f=[],p=[41,42,43];for(t=0;t<n;t++){i=e[t];a=i.recommendation_id;s.push(a);r=o.rec_list[a].title["default"];l=o.rec_list[a].text["default"];if(p.indexOf(a)!==-1){l=l.replace("{}",i.recommendation_data.survey_questiontype_max)}l=sanitizeHtml(l);d=$('<div class="recommendationCard"></div>');u=$('<div class="recommendationTitle"></div').text(r);c=$('<div class="recommendationText"></div').text(l);d.append(u).append(c);f.push(d)}$("#recommendationContainer").append(f)}function ie(e){var t,i={ADD_ANOTHER_QUESTION:1,ADD_LOGIC:2,ADD_LOGO:3,CUSTOMIZE_THEME:4,COMMENTING:5};if(e.length===0){$(".tip-container").hide()}else{t=e[0].recommendation_id;s.push(t);$(".tip-container").hide();if(t===i.ADD_ANOTHER_QUESTION){$(".tip-container.add-another-question").show()}else if(t===i.ADD_LOGIC){$(".tip-container.add-logic").show()}else if(t===i.ADD_LOGO){if(e.length>1&&e[1].recommendation_id===i.CUSTOMIZE_THEME){$(".tip-container.logo-and-theme").show()}else{$(".tip-container.add-logo").show()}}else if(t===i.CUSTOMIZE_THEME){$(".tip-container.customize-theme").show()}else if(t===i.COMMENTING){$(".tip-container.commenting").show()}}}function ne(){var e={survey_id:CREATE.survey.id},i;CREATE.Ajax.ajax("survey/surveyscore",{data:e,notificationKey:null}).done(function(e){i=e[0];if(i.ml_error){W();Q();SM.Logger.enqueue({action_type:"survey_score_ml_error",ui_trigger:"surveyScoreModal",ml_error:i.ml_error});return}if(n){t=n}Z(i.recommendations);n=i;K();SM.Logger.enqueue({action_type:"survey_score_returned",ui_trigger:"surveyScoreModal",data:{discrete_score:n.survey_score_discrete,continuous_score:n.survey_score_continuous,completion_rate:n.completionrate,completion_time:n.completiontime,recommendations:s.toString()}})}).fail(function(){SM.Logger.enqueue({action_type:"survey_score_error",ui_trigger:"surveyScoreModal"});W()})}return{init:function(t){e=t;if(CREATE.survey.hasPermission("edit")){$("#surveyScoreButton").click(D)}else{$("#surveyScoreButton").addClass("disabled")}o=CREATE.Translations.get("survey_score")}}}();